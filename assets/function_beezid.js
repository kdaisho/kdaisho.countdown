function beezDevAlert(msgError) {
    return false;
}
var i18n = {
    "beezid": {
        "currency_sign": "$",
        "currency_decimal_separator": ".",
        "currency_number_separator": ",",
        "no_bidder": "You",
        "going": "GOING",
        "you_highest_bidder": "You are currently the highest bidder!",
        "ended": "Ended",
        "stand_by": "Stand By",
        "hidden": "Hidden",
        "minute_timer": " Minute Timer",
        "second_timer": " Second Timer",
        "reminder_already_set": "This reminder has already been set.<br \/><a href=\"\/my_account\/my_reminders\">View All<\/a>",
        "reminder_set": "This reminder has been set.<br \/><a href=\"\/my_account\/my_reminders\">View All<\/a>",
        "reminder_problem": "There was a problem setting this reminder",
        "auction_not_open": "Auction Not Open",
        "need_buy_bids": "You'll need some bids to participate in this auction.",
        "need_buy_super_bids": "You'll need Super bids to participate in this auction.",
        "max_in_group": "You have reached the maximum number of wins allowed for this auction group.",
        "invalid_user_status": "You have reached your limit for this type of Auction",
        "active": "Active",
        "place_bid_error": "An error occured. We could not place your bid",
        "processing_your_bid": "Still Processing...",
        "updater_error": "<span>We were unable to update your page for a while now... Please refresh your page.<\/span>",
        "updater_connection_lost": "<span>We were unable to update your page for a while now... You may have lost your connection to internet. Please refresh your page.<\/span>",
        "register_age": "You must be at least 18 years of age or older.",
        "register_email": "Please enter a valid e-mail address.",
        "register_email_confirm": "The emails are different.",
        "register_password": "That password is too short.",
        "register_terms": "You need to agree to The Terms of Service and The Privacy Policy.",
        "different_password": "Passwords are different.",
        "error": "Something went wrong. You might want to try again.",
        "network_error": "Couldn't connect to the server.",
        "server_error": "error",
        "read_error": "Read error.",
        "form_empty_error": "You have to fill all the required fields",
        "and": "And",
        "lower": "Lower",
        "any": "Any",
        "price_edited": "Price edited",
        "remove": "Remove",
        "need_login": "You need to login to add this item to your Watchlist. Not a member yet? <a href=\"\/register\">Click here.<\/a>",
        "pin_an_auction": "Follow this auction by clicking on the Pin and adding it to <a href=\"\/auctions\/pinned\">Your Pinned Auctions<\/a>",
        "pin_an_auction_title": "Pin an auction",
        "confirmation_message": "You are leaving this page, all your unsaved data will be lost",
        "cash_money": "Cash Back",
        "you_get": "PLUS WE PAY YOU:",
        "winner_gets": "Winner Also Got",
        "get_it_for": "Get It For",
        "sold_for": "Sold For",
        "auction_related_item_title": "Other Auctions Happening",
        "store_related_item_title": "Other Store Items",
        "please_try_again": "Please Try Again",
        "see_all_auctions": "SEE ALL AUCTIONS",
        "time_ago": "ago"
    },
    "beezid_details": {
        "range_to_low": "Invalid range. The 'To' amount has to be higher than the 'From' amount.",
        "bid_to_is_too_small": "The \"Bid To\" value must be greater than the current auction price of",
        "address_confirmation": "Address Confirmation",
        "auction_id": "Auction ID",
        "and": "and",
        "promo_bids": "Promo bids",
        "explain_promo_bids": "Promo bids included with this item work exactly like Regular bids and can be used on all auctions. The only difference is that these bids expire after 7 days and will always be deployed before your Regular bids.",
        "placed_bids": "Placed Bids",
        "your_bids": "Your Bids",
        "final_auction_price": "Final Auction Price",
        "current_auction_price": "Auction Price",
        "winner_placed_bid": "** Placed Bids value for this winner is averaged at",
        "user_placed_bid": "** Placed Bids value averaged at ",
        "hash_auction": "#auction-",
        "winner": "Winner",
        "highest_bidder": "Current Highest Bidder",
        "store_id": "Store ID",
        "flip_id": "Flip ID",
        "percentoff": "% OFF",
        "priceoff": " OFF",
        "hash_flip": "#flip-",
        "hash_store": "#store-",
        "desc_notice": "Please note, the shipping charges listed are applicable to the contiguous United States only. Any orders delivered outside this area may be subject to additional fees and duties.",
        "store_savings": "You are about to save",
        "auction_claimed_title": "Claim Auction",
        "auction_claimed_text": "You already claimed this auction",
        "increases": "increases",
        "decreases": "decreases"
    },
    "ab": {
        "state_inactive": "INACTIVE",
        "state_active": "ACTIVE",
        "state_paused": "PAUSED",
        "bid_from": "BID FROM",
        "bid_num": "# OF BIDS",
        "sniper_num": "SNIPERS",
        "pause_edit": "PAUSE TO EDIT",
        "edit_tip": "You can edit your Autobeezid by pausing it or cancel it with the X",
        "booked_from": "Your Autobeezid is now booked!<br \/> {0} - {1} bids.",
        "sniper_set_for_bids": "Your Sniper is set for {0} bids.",
        "sniper_only_with_autobeezid": "You can only set your Sniper while booking an Autobeezid.",
        "range_greater_one_dollard": "Invalid range. Please make sure that the range between the 'From' and 'To' amounts is greater than one dollar.",
        "provide_range": "Enter the starting price for your Autobeezid.",
        "specify_num_bids": "Please enter the number of bids you would like to book.",
        "min_bids_two": "You need to book at least two bids.",
        "max_sniper": "Maximum number of Sniper bids is {0}.",
        "one_sniper_per_auction": "You can only book one Sniper per auction.",
        "book_only_one_autobeezid": "You can only book one Autobeezid at a time.",
        "no_auto_thriller": "Autobeezids are disabled during Thriller auctions.",
        "sniper_low": "You need to set at least one bid for your Sniper.",
        "book_only_one_sniper": "You can only book one Sniper at a time.",
        "abd_bids_exceeded": "You can place up to {0} bids every time you book your Autobeezid.",
        "abd_bin_purchased": "You can't book an Autobeezid on an auction you already purchased (BIN).",
        "inactive_auction": "You can't book an Autobeezid on an Inactive auction.",
        "reserved_bids": "All your bids are booked in Autobeezids. Click {0} to buy bids.",
        "noauto_text": "During a {0} auction, you won't be allowed to book any Autobeezids.",
        "atype_bff": "Bid For Free",
        "atype_gw": "Guaranteed Win",
        "atype_thriller": "Thriller",
        "win10": "Only users that haven't yet won 10 items are allowed to participate in these auctions."
    },
    "cart": {
        "my_cart": "My Cart",
        "reserve_expired": "This item is no longer reserved.",
        "cart_error_generic": "There was an error loading your shopping cart.",
        "timer_expired": "Timer has run out.",
        "add_again": "Add it again",
        "reserve_fail": "This item couldn't be added to your cart.",
        "item_sold": "Sorry but this item was sold and is no longer available.",
        "item_unavailable": "This item is currently in someone else's cart. Please try again shortly as it might become available.",
        "watch_item_title": "Watch Item",
        "choose_option_title": "Please Confirm",
        "quantity_label": "Quantity:",
        "view_all_watch_items": "<a href=\"\/my_account\/my_watch_list\">View all Watched items<\/a>",
        "option_label": "Option:",
        "delete_token_title": "Delete Credit Card",
        "delete_token": "Are you sure you want to delete this credit card?",
        "checkout_show": "View Cart\/Checkout",
        "continue_checkout": "<span>Continue To<\/span><br \/>Checkout",
        "continue_shipping": "<span>Continue To<\/span><br \/>Shipping Info",
        "continue_payment": "<span>Continue To<\/span><br \/>Payment Info",
        "continue_confirm": "<span>PROCEED<\/span><br \/>TO CHECKOUT",
        "checkout_now": "Checkout Now",
        "please_wait": "Please Wait",
        "login_fail": "Your login attempt failed. Make sure you're entering the correct username or password.",
        "wallet_difference": "Please select an additional method of payment to pay for the balance of your order.",
        "wallet_available": "available",
        "wallet_label": "Beezid Wallet: ",
        "cc_label": "Credit Card: ",
        "pp_label": "Payment: ",
        "cc_title_new": "Use a New Credit Card",
        "cc_title_select": "Use Your Credit Card",
        "terms_conditions": "Beezid&trade;: Terms &amp; Conditions",
        "token_remove": "Remove",
        "v_firstname": "Please enter your first name.",
        "v_lastname": "Please enter your last name.",
        "v_address": "Please enter your address.",
        "v_state": "Please enter your state.",
        "v_city": "Please enter your city.",
        "v_zip": "Please enter a valid Postal Code.",
        "v_phone": "Please enter your phone number.",
        "v_email": "Please enter your email address",
        "v_cc_type": "Please select a method of payment.",
        "v_cc_num": "Invalid credit card number.",
        "v_cc_cvv": "Please enter the 3 or 4 digit security code of your credit card.",
        "v_cc_exp": "Please enter a valid credit card expiration month.",
        "v_select_option": "You must select an option.",
        "username_available": "This username is available!",
        "warning_promo_apply": "Hey there, we just noticed that you still have a bonus offer that you may want to apply.<hr \/>Allow me to select and apply the promotion?",
        "postal_code_us": "ZIP",
        "postal_code_other": "Postal Code",
        "state_us": "State",
        "state_other": "Province",
        "back": "Back",
        "cvv_title": "Security Code",
        "find_cvv": "Find your security code",
        "enter_cvv": "Enter the security code (CVV) for this credit card.",
        "where_is_cvv": "Where do I find this?",
        "is_this_safe": "Your privacy and security are our top priority. Your credit card information will not be saved by Beezid.com rather it will be securely stored on the bank's servers in order to make it easier to process future transactions.",
        "label_promotion_info": "Promotion Information",
        "label_shipping": "<b>Shipping:<\/b>",
        "label_free_shipping": "<i>This order qualifies for <br \/><b>FREE Shipping!<\/b><\/i>",
        "item_option": "Option: ",
        "email_sent": "An e-mail was just sent to you."
    },
    "wallet": {
        "error_msg": {
            "invalid": "Please enter a valid amount.",
            "insufficient_funds": "Your cash balance is less than this amount."
        }
    },
    "watch_list": {
        "add": "Add to Watchlist",
        "need_account": "Login to add this item to your Watchlist.<br \/> Not a member yet? <a href=\"\/signup\" >Click here<\/a>",
        "hover_title": "Notify Me When Available",
        "hover_title_guest": "Login to use this feature",
        "hover_info": "Add this item to your Watchlist",
        "hover_info_watched": "This item is already in your <a href=\"\/my_account\/my_watch_list\">Watchlist<\/a>",
        "item_watched": "This item has been added to your Watchlist <a href=\"\/my_account\/my_watch_list\">See All<\/a>",
        "not_yet": "Not yet"
    },
    "store": {
        "hover_title": "Flipped Auction",
        "hover_info": "This item was Flipped by a Beezid winner. <a href=\"\/help\/store#how-to-sell\">Learn More<\/a>",
        "flip_disabled": "Flip Disabled",
        "flip_tooltip_title": "Flip & Earn!",
        "flip_tooltip_text": "Cash-in on your savings by flipping your auction to the Beezid Store! <a href=\"\/help\/store#sell-your-items\">Find out more<\/a>",
        "sold_out": "Sold Out!",
        "seller_tooltip_title": "Your Flipped Auction",
        "seller_tooltip_text": "You are the seller of this item. To view your flipped auctions <a href=\"\/my_account\/my_flipped_auctions\">click here<\/a>",
        "see_all_store_items": "SEE ALL STORE ITEMS",
        "auction_flipped_title": "Flipped Auction",
        "auction_flipped_text": "You already flipped this auction",
        "homepage_no_items": "<i class=\"emptycart\">There were no items which matched your search.<\/i>"
    },
    "dialog": {
        "title_did_you_know": "Did you know?",
        "title_buy_bids": "Buy Bids",
        "title_notice": "Notice",
        "title_complete_reg": "Confirm Registration",
        "btn_okay": "Ok",
        "btn_yes": "Yes",
        "btn_no": "No",
        "btn_cancel": "Cancel",
        "btn_buy_bids": "GET SOME NOW!",
        "btn_react_close": "CLOSE",
        "btn_got_it": "GOT IT!",
        "btn_continue": "Continue",
        "chk_remeber_skip": "Don't show this message again."
    },
    "power_item_manager": {
        "btn_help_tutorial": "HELP",
        "btn_purchase_powers": "PURCHASE",
        "max_inventory": "Looks like you already have the maximum amount of that power.",
        "wallet_money_missing": "You are short %s from your Beezid Wallet. Recharge below.",
        "about_to_buy": "%s will be deducted from your Beezid Wallet to acquire this power.",
        "select_auction": "Select an auction, then apply a power.",
        "select_power": "Select a power, then hit apply.",
        "not_available_yet": "This power isn't available yet.",
        "non_auction_power": "This power affects all auctions.",
        "only_alpha_numeric": "Only letters and numbers are allowed for the \"%s\".",
        "only_numbers": "Only numbers are allowed for the \"%s\".",
        "at_least_char": "The \"%s\" must have at least %s characters.",
        "at_most_char": "The \"%s\" must have at most %s characters.",
        "invalid_num_len": "The \"%s\" must be a number between %s and %s.",
        "pending": "Pending"
    },
    "misc": {
        "months_full": {
            "1": "January",
            "2": "February",
            "3": "March",
            "4": "April",
            "5": "May",
            "6": "June",
            "7": "July",
            "8": "August",
            "9": "September",
            "10": "October",
            "11": "November",
            "12": "December"
        },
        "required": "This field is required."
    },
    "status_manager": {
        "title": {
            "6": "Welcome %s!",
            "2": "Congratulations %s!",
            "10": "Power Bidder",
            "4": "",
            "to_power_bidder": "You're on fire, %s!",
            "from_power_bidder": "The wait is over, %s!",
            "hi_username": "Hi %s!",
            "nice_job": "Nice Job On The Win!",
            "way_to_go": "Way To Go!"
        },
        "wins": {
            "6": "%s Cherry Wins",
            "6_1": "%s Cherry Win",
            "2": "%s Advanced Wins",
            "2_1": "%s Advanced Win",
            "10": "Power Bidder",
            "4": ""
        },
        "unchanged_advanced": "Also, it won't count toward your Advanced wins, either!",
        "close_tooltip": "Next Message"
    },
    "super_mode": {
        "disabled": {
            "title": "Super Mode Disabled",
            "msg": "You need Health to do this. Click {0}."
        },
        "tutorial_tip": {
            "title": "{0}NEW!{1}",
            "msg": "{0}So you want to be{1}A SUPERHERO?{2}Click the icon below!{3}"
        }
    },
    "bid_btn": {
        "bid": "BID",
        "bids": "BIDS",
        "super_bid": "SUPER BID",
        "bff": "BID FOR FREE",
        "sign_in": "SIGN IN",
        "sold": "SOLD",
        "claim": "CLAIM",
        "remind": "REMIND"
    }
};
if (Prototype.Browser.IE && (navigator.appVersion.indexOf("MSIE 6.0") != -1 || navigator.appVersion.indexOf("MSIE 7.0") != -1 || navigator.appVersion.indexOf("MSIE 8.0") != -1) && window.location.pathname != '/update-browser') {
    window.location = '/update-browser';
}
BeezidMobile = Class.create(Abstract, {
    lastScrollTopOffset: 0,
    swipeMenuStartX: -1,
    swipeMenuStopX: -1,
    swipeMenuStartY: -1,
    swipeMenuStopY: -1,
    swipeMenuTime: -1,
    mobMenuOverlay: null,
    menuIsVisible: false,
    windowLastYOffset: 0,
    bodyWidth: null,
    initialize: function() {
        this.touches = {
            "touchstart": {
                "x": -1,
                "y": -1
            },
            "touchmove": {
                "x": -1,
                "y": -1
            },
            "touchend": {
                "x": -1,
                "y": -1
            },
            "mousedup": false,
            "mousedown": {
                "x": -1,
                "y": -1
            },
            "mousemove": {
                "x": -1,
                "y": -1
            },
            "mouseleave": {
                "x": -1,
                "y": -1
            },
            "direction": "undetermined"
        }, this.previousX = -1, this.clicked = false;
    },
    touchHandler: function(event, options) {
        if (typeof event !== 'undefined') {
            options = Object.extend({
                minSwipeDistance: 0
            }, options);
            var touch, mouse = (event.type == 'mouseleave' || event.type == 'mousemove' || event.type == 'mousedown' || event.type == 'mouseup' || event.type == 'click') ? true : false;
            if (typeof event.touches !== 'undefined' || mouse) {
                touch = mouse ? event : event.touches[0];
                switch (event.type) {
                    case 'mouseleave':
                        this.previousX = -1;
                        var retDirection = -1;
                        if (this.clicked) {
                            this.clicked = false;
                            retDirection = this.touches.mousedown.x < touch.pageX ? "right" : "left";
                        } else {
                            event.preventDefault();
                        }
                        this.touches['mousedown'].x = -1;
                        return retDirection;
                    case 'touchstart':
                    case 'touchmove':
                    case 'mousedown':
                    case 'mousemove':
                        this.touches[event.type].x = touch.pageX;
                        this.touches[event.type].y = touch.pageY;
                        var touchDistance = false;
                        if (event.type == 'mousedown') {
                            this.clicked = true;
                        }
                        if (event.type == 'touchstart') {
                            this.touches['touchmove'].x = -1;
                            this.touches['touchmove'].y = -1;
                            this.previousX = touch.pageX;
                        } else if (event.type == 'touchmove' || event.type == 'mousemove') {
                            if (this.previousX != -1 && ((mouse && this.touches['mousedown'].x != -1 && this.clicked) || !mouse)) {
                                touchDistance = touch.pageX - this.previousX;
                            }
                            this.previousX = this.touches[event.type].x;
                        } else {
                            event.preventDefault();
                        }
                        return touchDistance;
                    case 'touchend':
                    case 'mouseup':
                    case 'click':
                        if (event.type == 'mouseup' || event.type == 'click') {
                            this.clicked = false;
                        }
                        if ((mouse && this.touches.mousedown.x == touch.pageX) || (!mouse && this.touches['touchmove'].x == -1)) {
                            var slideElement = event.findElement("a");
                            if (typeof slideElement !== 'undefined') {
                                if (slideElement.hasClassName('_gaq_track_slide')) {
                                    if (!slideElement.hasClassName('_gaq_track_slide_clicked')) {
                                        slideElement.addClassName('_gaq_track_slide_clicked');
                                        var slideEl = null;
                                        if (slideElement.select('img')) {
                                            if (slideElement.select('img').first().visible()) {
                                                slideEl = slideElement.select('img').first();
                                            } else if (slideElement.select('img')[1].visible()) {
                                                slideEl = slideElement.select('img')[1];
                                            }
                                        }
                                        if (slideEl === null) {
                                            return true;
                                        } else {
                                            var slideImg = slideEl.src.split('/');
                                            slideImg = slideImg[slideImg.length - 1].gsub(/.jpg|.png/, '');
                                            trackEvent('link', 'carousel-click', slideImg, null, function() {
                                                if (slideElement.hasClassName('go_register_carousel')) {
                                                    registerFormHandler();
                                                } else {
                                                    window.location = slideElement.href;
                                                }
                                            });
                                            return false;
                                        }
                                    }
                                } else if (!empty(slideElement.href)) {
                                    window.location = slideElement.href;
                                }
                            }
                            event.preventDefault();
                            return true;
                        }
                        if (this.touches.touchstart.x > -1 && this.touches.touchmove.x > -1) {
                            event.preventDefault();
                            if (Math.abs(this.touches.touchstart.x - this.touches.touchmove.x) > options.minSwipeDistance) {
                                this.touches.direction = this.touches.touchstart.x < this.touches.touchmove.x ? "right" : "left";
                            } else {
                                this.touches.direction = false;
                            }
                        } else if (this.touches.mousedown.x > -1 && mouse) {
                            event.preventDefault();
                            if (Math.abs(this.touches.mousedown.x - touch.pageX) > options.minSwipeDistance) {
                                this.touches.direction = this.touches.mousedown.x < touch.pageX ? "right" : "left";
                            } else {
                                this.touches.direction = false;
                            }
                        }
                        return this.touches.direction;
                    default:
                        return false;
                }
            }
        }
    },
    isMobileTriggerVisible: function() {
        return $('mob-menu-trigger-b') != null && $('mob-menu-trigger-b').getStyle('display') != 'none';
    },
    initMobileMenuButtons: function() {
        ["webkitTransitionEnd", "mozTransitionEnd", "MSTransitionEnd", "oTransitionEnd", "transitionend"].each(function(transitionTarget) {
            $('cat-account-nav').observe(transitionTarget, function() {
                if ($('cat-account-nav').getStyle('right') == '0px') {
                    $('mob-account-trigger-b').addClassName('active');
                }
            });
            $('menu_wrapper').observe(transitionTarget, function() {
                if ($('menu_wrapper').getStyle('marginLeft') == '0px') {
                    $$('.common_main_container')[0].setStyle({
                        position: null
                    });
                } else {
                    $$('.common_main_container')[0].setStyle({
                        position: 'fixed'
                    });
                }
            });
        });
        $('mob-account-trigger-b') && $('mob-account-trigger-b').observe('click', function(event) {
            if ($(event.target).hasClassName('active')) {
                $('cat-account-nav').style.right = '-100%';
                this.mobMenuOverlay.hide();
                $(event.target).removeClassName('active');
                $('uCheckLogged').removeClassName('active');
            } else {
                $('cat-account-nav').style.right = '0px';
                $('uCheckLogged').addClassName('active');
                this.mobMenuOverlay.show();
            }
        }.bind(this));
        $('mob-menu-trigger-b') && $('mob-menu-trigger-b').observe('click', function(event) {
            if (this.menuIsVisible) {
                this.menuIsVisible = false;
                $('menu_wrapper').style.marginLeft = '0px';
                $('mobile_menu_bg').hide();
                this.mobMenuOverlay.hide();
                $(event.target).removeClassName('active');
                $('menu_wrapper').removeClassName('active');
                window.setTimeout(function() {
                    window.scroll(0, this.windowLastYOffset);
                }.bind(this), 200);
            } else {
                this.menuIsVisible = true;
                this.windowLastYOffset = window.pageYOffset;
                $('menu_wrapper').setStyle({
                    top: '0px'
                });
                $('menu_wrapper').style.marginLeft = '100%';
                $('mobile_menu_bg').show();
                this.mobMenuOverlay.show();
                $(event.target).addClassName('active');
                $('menu_wrapper').addClassName('active');
                window.scroll(0, 0);
            }
        }.bind(this));
        $('cart_origin').observe('click', function(event) {
            if ($(this).hasClassName('active')) {
                $(this).removeClassName('active');
            } else {
                $(this).addClassName('active');
            }
        });
    },
    addColapsibleClickHandler: function() {
        $$('.ui-collapsible').each(function(ulMenu) {
            $(ulMenu).stopObserving('click');
            $(ulMenu).observe('click', function(event) {
                var collapsibleEl = $(this).up().select('.ui-collapsible-el').first();
                if ($(ulMenu).hasClassName('active')) {
                    $(ulMenu).removeClassName('active');
                    collapsibleEl && collapsibleEl.removeClassName('active');
                } else {
                    $(ulMenu).addClassName('active');
                    collapsibleEl && collapsibleEl.addClassName('active');
                }
            });
        });
    },
    initCollapsibleElement: function() {
        if (this.isMobileTriggerVisible()) {
            if ($('mob-account-trigger-b') && $('mob-menu-trigger-b').hasClassName('active') == false) {
                $('menu_wrapper').setStyle({
                    'left': '-100%'
                });
            } else if (this.mobMenuOverlay && !this.mobMenuOverlay.__isShown) {
                this.mobMenuOverlay.show();
            }
            if ($('mob-account-trigger-b') && $('mob-account-trigger-b').hasClassName('active') && !this.mobMenuOverlay.__isShown) {
                this.mobMenuOverlay.show();
            }
            this.addColapsibleClickHandler();
        } else {
            $('menu_wrapper').setStyle({
                'left': '0px',
                'top': '0px'
            });
            this.mobMenuOverlay.hide();
            $('megadropdown') && $('megadropdown').removeClassName('active');
            $('navlink_category_browser') && $('navlink_category_browser').removeClassName('active');
        }
    },
    __setSwipeMenuCoord: function(touchArr, option) {
        if (option.event == 'touchstart') {
            this.swipeMenuStartX = touchArr.pageX;
            this.swipeMenuStartY = touchArr.pageY;
        } else if (option.event == 'touchend') {
            this.swipeMenuStopX = touchArr.pageX;
            this.swipeMenuStopY = touchArr.pageY;
        }
    },
    initSwipeMenu: function() {
        if ($('mob-account-trigger-b') == null && $('mob-menu-trigger-b') == null) {
            return;
        }
        var bodyEl = $$('body')[0];
        bodyEl.stopObserving('touchstart');
        bodyEl.stopObserving('touchend');
        $('menu_wrapper').stopObserving('touchstart');
        $('menu_wrapper').stopObserving('touchend');
        if (this.isMobileTriggerVisible()) {
            bodyEl.observe('touchstart', function(ev) {
                this.__setSwipeMenuCoord(ev.touches[0], {
                    event: 'touchstart'
                });
                this.swipeMenuTime = new Date().getTime();
            }.bind(this));
            bodyEl.observe('touchend', function(ev) {
                if ((new Date().getTime()) - this.swipeMenuTime > 500) {
                    return;
                }
                this.__setSwipeMenuCoord(ev.changedTouches[0], {
                    event: 'touchend'
                });
                var distanceX = this.swipeMenuStopX - this.swipeMenuStartX,
                    distanceY = Math.abs(this.swipeMenuStopY - this.swipeMenuStartY),
                    distanceFromRight = document.documentElement.clientWidth - this.swipeMenuStartX,
                    swipeAngle = Math.atan(distanceY / Math.abs(distanceX));
                if (swipeAngle > 0.2 || swipeAngle == NaN) {
                    return;
                }
                if (distanceY < Math.abs(distanceX) && this.swipeMenuStartX < 30 && distanceX > 30 && this.swipeMenuStopX < 300 && !$('mob-menu-trigger-b').hasClassName('active')) {
                    if ($('mob-account-trigger-b').hasClassName('active')) {
                        $('mob-account-trigger-b').click();
                    }
                    if ($('signin_box').visible()) {
                        $('login_close').click();
                    }
                    $('mob-menu-trigger-b').click();
                } else if (distanceY < Math.abs(distanceX) && distanceX < -30 && distanceFromRight < 30 && !$('mob-account-trigger-b').hasClassName('active')) {
                    if ($('mob-menu-trigger-b').hasClassName('active')) {
                        $('mob-menu-trigger-b').click();
                    }
                    if (Beezid.info.loggedIn()) {
                        $('mob-account-trigger-b').click();
                    } else {
                        $('signin_link').click();
                    }
                }
            }.bind(this));
            $('menu_wrapper').observe('touchstart', function(ev) {
                this.__setSwipeMenuCoord(ev.touches[0], {
                    event: 'touchstart'
                });
                this.swipeMenuTime = new Date().getTime();
            }.bind(this));
            $('menu_wrapper').observe('touchend', function(ev) {
                if ((new Date().getTime()) - this.swipeMenuTime > 500) {
                    return;
                }
                this.__setSwipeMenuCoord(ev.changedTouches[0], {
                    event: 'touchend'
                });
                var distanceX = this.swipeMenuStopX - this.swipeMenuStartX,
                    distanceY = Math.abs(this.swipeMenuStopY - this.swipeMenuStartY),
                    swipeAngle = Math.atan(distanceY / Math.abs(distanceX));
                if (swipeAngle > 0.2 || swipeAngle == NaN) {
                    return;
                }
                if (distanceY < Math.abs(distanceX) && distanceX < -35 && $('mob-menu-trigger-b').hasClassName('active')) {
                    $('mob-menu-trigger-b').click();
                }
            }.bind(this));
            $('cat-account-nav').observe('touchstart', function(ev) {
                this.__setSwipeMenuCoord(ev.touches[0], {
                    event: 'touchstart'
                });
                this.swipeMenuTime = new Date().getTime();
            }.bind(this));
            $('cat-account-nav').observe('touchend', function(ev) {
                if ((new Date().getTime()) - this.swipeMenuTime > 500) {
                    return;
                }
                this.__setSwipeMenuCoord(ev.changedTouches[0], {
                    event: 'touchend'
                });
                var distanceX = this.swipeMenuStopX - this.swipeMenuStartX,
                    distanceY = Math.abs(this.swipeMenuStopY - this.swipeMenuStartY),
                    swipeAngle = Math.atan(distanceY / Math.abs(distanceX));
                if (swipeAngle > 0.2 || swipeAngle == NaN) {
                    return;
                }
                if (distanceY < Math.abs(distanceX) && distanceX > 35 && $('mob-account-trigger-b').hasClassName('active')) {
                    $('mob-account-trigger-b').click();
                }
            }.bind(this));
        }
    },
    initMobileBlogUIElement: function() {
        this.addColapsibleClickHandler();
    },
    initMasterUIElements: function() {
        $('menu_wrapper').setStyle({
            'display': 'block'
        });
        this.mobMenuOverlay = new Overlay({
            'zIndex': 7
        });
        this.initMobileMenuButtons();
        this.initCollapsibleElement();
        this.initSwipeMenu();
        this.bodyWidth = $$('body')[0].getWidth();
        Event.observe(window, "resize", function() {
            if (this.bodyWidth == $$('body')[0].getWidth()) {
                return;
            }
            this.bodyWidth = $$('body')[0].getWidth();
            $('menu_wrapper').setStyle({
                'display': 'none'
            });
            $('cat-account-nav').setStyle({
                'display': 'none'
            });
            createIconTip();
            $$('.bin_icn_regular, .bin_icn_easy, .bin_icn_mine, .bin_plus_icn_regular, .bin_plus_icn_easy, .bin_plus_icn_mine, .bin_icn_details, .bin_plus_icn_details').invoke('buyItNowClick');
            window.pinManager.updateAllPinsTooltip();
            this.initCollapsibleElement();
            this.initSwipeMenu();
            if (Beezid.powerDropView) {
                Beezid.powerDropView.addClickHandlerOnPowerAuctions();
            }
            $('menu_wrapper').setStyle({
                'display': 'block'
            });
            $('cat-account-nav').setStyle({
                'display': 'block'
            });
            if ($('sh_range_slider_cntn')) {
                Beezid.rangeSelect._updateSlider();
            }
            if (window.innerHeight > $('pwr_ctn').getHeight()) {
                $('pwr_ctn').setStyle({
                    'paddingTop': '0px'
                });
            } else {
                $('pwr_ctn').setStyle({
                    'paddingTop': '197px'
                });
            }
            if (this.menuIsVisible) {
                $('mob-menu-trigger-b').click();
            }
        }.bind(this));
    }
});
window.initFuncs = [];
window.onloadFuncs = [];
window.isDevice = !!(navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i));
window.Beezid = {
    touchEnabled: !!(window.isDevice && (("ontouchstart" in window) || (window.navigator && window.navigator.msPointerEnabled && window.MSGesture) || (window.DocumentTouch && document instanceof DocumentTouch))),
    suppressAlert: false,
    mobile: new BeezidMobile()
};
Event.observe(window, 'beforeunload', function(e) {
    Beezid.suppressAlert = true;
    return false;
});
window.onload = function() {
    onloadFuncs.each(function(func) {
        func();
    });
};

function coreInit(noMaster) {
    fc = String.fromCharCode;
    _l = null;
    window.updaterManager = new UpdaterManager();
    window.idleHandler = new IdleHandler(Beezid.info.getIdleTimeout());
    if (empty(noMaster)) {
        if (!empty($$('.hdr_marquee_cntn'))) {
            Beezid.barTracker = new BarTracker({
                bar: $$('.hdr_marquee_cntn')[0],
                content: $$('.common_main_container')[0],
                vPos: $$('.hdr_marquee_cntn')[0].cumulativeOffset().top,
                barHeight: $$('.hdr_marquee_cntn')[0].offsetHeight,
                active: false
            });
        }
        if (!Beezid.info.loggedIn() && !empty($('theBar'))) {
            $('theBar').hide();
            (function() {
                updaterManager.stop(updaterManager.BAR_UPDATER);
            }).defer();
            Beezid.__st = {
                __l: function() {},
                __u: function() {}
            };
        } else {
            Beezid.__st = new BeezidSocial();
        }
        $('megadropdown') && new MenuDelay();
    } else {
        Beezid.__st = {
            __u: function() {}
        };
        Beezid.barTracker = new BarTracker({
            vPos: 0,
            barHeight: 10,
            active: false
        });
    }
    configureView();
    initFuncs.each(function(func) {
        func();
    });
    initFuncs = undefined;
    readCookie('beezid_reg_d4') && si() && createCookie('beezid_reg_d4', '', -1);
    createIconTip();
    $$('.bin_icn_regular, .bin_icn_easy, .bin_icn_mine, .bin_plus_icn_regular, .bin_plus_icn_easy, .bin_plus_icn_mine, .bin_icn_details, .bin_plus_icn_details').invoke('buyItNowClick');
    idString = $$('[id^="a_"]').pluck("id").invoke("substring", 2).invoke("gsub", 'c', '').uniq().sort().join(":");
    window.pinManager = new PinManager();
    window.notificationsManager = new NotificationsManager();
    if (Beezid.info.isSuperModeActivated()) {
        $(document.body).addClassName('super_mode');
    }
    if (!Beezid.info.loggedIn() && gup('sign-in') == 1 && typeof Beezid.loginBox != 'undefined') {
        Beezid.loginBox.open();
    }
    if (!idString.length) {
        isAnAuctionPage = false;
        return;
    }
    initializeAuctionView();
    if (typeof HomepageRefresherObj != 'undefined') {
        HomepageRefresherObj.start(homeActiveTimeout, auctionCloseTimeout, inactiveLimit);
        if (typeof homePage != 'undefined' && homePage) {
            if (readCookie('zbiddy') !== null) {
                if ($('homepage_free_bids_banner') !== null) {
                    HomepageRefresherObj.addListener('auctionsLoaded', function() {
                        $('homepage_free_bids_banner').src = '/img/pages/home/100-bids.png';
                        $('homepage_free_bids_banner').alt = '100 Free Bid';
                    });
                } else if (!Beezid.info.loggedIn() && readCookie('zbiddy_popup') === null) {
                    new UrlPopup({
                        url: '/zbiddy_users/popup',
                        id: 'read-it-dialog',
                        classNames: ["modalbox_drp"],
                        afterLoad: function() {
                            new Button({
                                elem: $('modal_close'),
                                action: function() {
                                    this.destroy();
                                }.bind(this)
                            });
                        }
                    }).run();
                }
            }
            Beezid.tlbAuction.start();
            Beezid.bffFrenzyCounter.start();
            HomepageRefresherObj.addListener('auctionsLoaded', function() {
                Beezid.tlbAuction.start();
                Beezid.bffFrenzyCounter.start();
            });
        }
    }
}

function undef(arg) {
    return (typeof arg == 'undefined');
}

function empty(arg) {
    return (undef(arg) || !arg || (typeof arg != 'string' && arg == false));
}
window.WindowSize = Class.create({
    initialize: function() {
        this.width = window.innerWidth || (window.document.documentElement.clientWidth || window.document.body.clientWidth);
        this.height = window.innerHeight || (window.document.documentElement.clientHeight || window.document.body.clientHeight);
        this.scrollTop = document.body.scrollTop || (document.documentElement.scrollTop || 0);
        this.scrollLeft = document.body.scrollLeft || (document.documentElement.scrollLeft || 0);
    }
});

function verticalAdjust(elem, height) {
    var sz = new WindowSize();
    if (undef(height)) {
        height = elem.offsetHeight;
    }
    var top = (sz.height - height) / 2.618;
    elem.style.top = top + 'px';
}

function firstElementChild(elem) {
    if (!elem) {
        return null;
    }
    if (typeof elem.firstElementChild == 'function') {
        return (elem.firstElementChild());
    }
    for (var res = null, n = elem.firstChild; n != null; n = n.nextSibling) {
        if (n.nodeType == 1) {
            res = n;
            break;
        }
    }
    return res;
}

function ayjax(url, cb, options, params) {
    if (!empty(options.lockObj)) {
        if (undef(options.lockObj.__ayBusy)) {
            options.lockObj.__ayBusy = true;
        } else {
            return;
        }
    }
    var callOpts = {};
    if (!undef(params)) {
        if (undef(options.method) || options.method == 'get') {
            if (url.substr(-1) == '/') {
                url = url.substr(0, url.length - 1);
            }
            var path = '';
            for (i in params) {
                path += '/' + i + ':' + params[i];
            }
            url += path;
        } else {
            callOpts.parameters = params;
        }
    }
    if (options.method) {
        callOpts.method = options.method;
    }
    callOpts.requestHeaders = {
        'X-Requested-With': 'XMLHttpRequest',
        'X-Prototype-Version': Prototype.Version
    };
    if (!empty(options.method)) {
        callOpts.method = options.method;
    }
    callOpts.onSuccess = function(transport) {
        try {
            if (empty(options.rawData) && empty(options.rawResponse)) {
                try {
                    var result = transport.responseText.evalJSON();
                } catch (e) {
                    throw {
                        result: 'fail',
                        msg: 'Transport error'
                    };
                }
                if (empty(options.checkStatus)) {
                    cb(result);
                } else if (result.status == 'success') {
                    cb(result.data);
                } else {
                    throw result;
                }
            } else if (empty(options.rawResponse)) {
                cb(transport.responseText);
            } else {
                cb(transport);
            }
        } catch (result) {
            if (!empty(options.onError)) {
                options.onError({
                    status: 'fail',
                    msg: i18n.beezid.network_error,
                    result: result.result
                });
            } else if (!undef(options.suppressError) && options.suppressError === false) {
                beezAlert(i18n.beezid.network_error);
            }
        }
    };
    callOpts.onFailure = function(transport) {
        if (!empty(options.onError)) {
            options.onError({
                result: 'fail',
                msg: i18n.beezid.network_error
            });
        } else if (!undef(options.suppressError) && options.suppressError === false) {
            beezDevAlert(i18n.beezid.network_error);
        }
    };
    callOpts.onComplete = function() {
        if (!empty(this.lockObj)) {
            delete this.lockObj.__ayBusy;
        }
        if (!undef(this.onComplete)) {
            this.onComplete();
        }
        if (!undef(this.busy)) {
            this.busy.off();
        }
    }.bind(options);
    if (!empty(options.busy)) {
        options.busy.on();
    }
    new Ajax.Request(url, callOpts);
}

function si() {
    var n = function(k) {
            try {
                var v = window.navigator[k];
                return v;
            } catch (e) {}
        },
        s = function(k) {
            try {
                var v = window.screen[k];
                return v;
            } catch (e) {}
        };
    var si = {
        na: n('appName'),
        nv: n('appVersion'),
        nm: n('appMinorVersion'),
        bd: n('buildID'),
        nc: n('appCodeName'),
        np: n('platform'),
        oc: n('oscpu'),
        pr: n('product'),
        vn: n('vendor'),
        sub: n('productSub'),
        cc: n('cpuClass'),
        bl: n('browserLanguage'),
        sl: n('systemLanguage'),
        npl: [],
        sw: s('width'),
        sh: s('height'),
        c: s('colorDepth')
    }
    if (n('plugins') && n('plugins').item) {
        var i, p, pp = n('plugins');
        for (i = 0, p = pp.item(i); p; ++i, p = pp.item(i)) {
            si.npl.push(p.filename);
        }
    }
    ayjax('/bar', function() {}, {
        onError: function() {},
        suppressError: true,
        method: 'post'
    }, {
        si: JSON.stringify(si)
    });
    return true;
}

function base64_decode(input) {
    var b64c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    var out = '';
    var c1, c2, c3;
    var e1, e2, e3, e4;
    var i = 0;
    do {
        e1 = b64c.indexOf(input.charAt(i++));
        e2 = b64c.indexOf(input.charAt(i++));
        e3 = b64c.indexOf(input.charAt(i++));
        e4 = b64c.indexOf(input.charAt(i++));
        c1 = (e1 << 2) | (e2 >> 4);
        c2 = ((e2 & 15) << 4) | (e3 >> 2);
        c3 = ((e3 & 3) << 6) | e4;
        out += String.fromCharCode(c1);
        if (e3 != 64) {
            out += String.fromCharCode(c2);
        }
        if (e4 != 64) {
            out += String.fromCharCode(c3);
        }
    } while (i < input.length);
    return unescape(out);
}
window.document.getCssBgCanvasContext = function(canvasId, targetId, width, height) {
    var targetEl = document.getElementById(targetId);
    if (targetEl === null) {
        return false;
    }
    if (typeof document.getCSSCanvasContext === 'function') {
        var currentColor = targetEl.getStyle('background').replace(/(none|auto|\/)/g, '');
        targetEl.setStyle({
            background: '-webkit-canvas(' + canvasId + ') ' + currentColor
        });
        return document.getCSSCanvasContext('2d', canvasId, width, height);
    } else if (typeof document.mozSetImageElement === 'function') {
        var canvas = document.createElement('canvas');
        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);
        var ctx = canvas.getContext('2d');
        document.mozSetImageElement(canvasId, canvas);
        return ctx;
    } else {
        return false;
    }
}
var BeezidObject = Class.create({
    _listeners: {},
    _overrides: {},
    __listeners: null,
    initialize: function(config) {
        this.__listeners = {};
    },
    destroy: function() {
        this.__listeners = this._listeners = this.overrides = {};
    },
    __super: function() {
        return Object.getPrototypeOf(this);
    },
    _bindParams: function(params, force) {
        for (p in params) {
            if (!undef(this[p]) || force) {
                this[p] = params[p];
            }
        }
        return this;
    },
    _bindConfig: function(config) {
        for (c in config) {
            if (!undef(this['_' + c])) {
                this['_' + c] = config[c];
            }
        }
        if (!empty(this._overrides)) {
            for (i in this._overrides) {
                if (this._overrides.hasOwnProperty(i)) {
                    this[i] = this._overrides[i];
                }
            };
        }
        if (!empty(this._listeners)) {
            for (var evt in this._listeners) {
                if (!this._listeners.hasOwnProperty(evt)) {
                    continue;
                }
                var fn, scope = null;
                if (typeof this._listeners[evt] == 'function') {
                    fn = this._listeners[evt];
                    if (!empty(this._listeners.scope)) {
                        scope = this._listeners.scope;
                    } else {
                        scope = this;
                    }
                } else if (typeof this._listeners[evt] == 'object' && !this._listeners[evt].fn) {
                    fn = scope = this._listeners[evt];
                } else if (typeof this._listeners[evt].fn == 'function') {
                    fn = this._listeners[evt].fn;
                    scope = this;
                    if (!empty(this._listeners[evt].scope)) {
                        scope = this._listeners[evt].scope;
                    } else if (!empty(this._listeners.scope)) {
                        scope = this._listeners.scope;
                    }
                } else {
                    fn = this._listeners[evt];
                }
                this.addListener(evt, fn, scope);
            }
        }
    },
    addListener: function(event, listener, scope) {
        listener = this._canonicalListener(event, listener, scope);
        if (!listener) {
            return false;
        }
        if (undef(this.__listeners[event])) {
            this.__listeners[event] = [];
        }
        this.__listeners[event].push(listener);
        return true;
    },
    removeListener: function(event, listener, scope) {
        if (!undef(this.__listeners[event])) {
            listener = this._canonicalListener(event, listener, scope);
            this.__listeners[event].each(function(l) {
                if (l.listener == listener.listener && l.scope == listener.scope) {
                    this.__listeners[event] = this.__listeners[event].without(l);
                }
            }.bind(this));
        }
    },
    fireEvent: function(event, params) {
        if (!undef(this.__listeners[event])) {
            if (undef(params)) {
                params = {
                    event: event,
                    object: this,
                    async: true
                };
            } else {
                if (undef(params.event)) {
                    params.event = event;
                }
                if (undef(params.object)) {
                    params.object = this;
                }
                if (undef(params.async)) {
                    params.async = true;
                }
            }
            if (params.async) {
                this.__listeners[event].each(function(l) {
                    l.listener.bind(l.scope).defer(params);
                });
            } else {
                var retVal = true,
                    i;
                for (i in this.__listeners[event]) {
                    if (this.__listeners[event].hasOwnProperty(i)) {
                        var l = this.__listeners[event][i];
                        if (l.listener.bind(l.scope)(params) === false) {
                            retVal = false;
                        }
                    }
                }
                return retVal;
            }
        }
        return true;
    },
    _canonicalListener: function(event, listener, scope) {
        var fn;
        if (typeof listener == 'object') {
            fn = listener['on' + event.substr(0, 1).toUpperCase() + event.substr(1)];
            if (typeof fn == 'function') {
                return {
                    listener: fn,
                    scope: listener
                };
            }
        }
        if (typeof listener == 'function') {
            return {
                listener: listener,
                scope: scope
            };
        }
        return false;
    }
});
var DataSource = Class.create(BeezidObject, {
    _url: null,
    _method: 'get',
    _postParams: null,
    _fields: null,
    _data: null,
    _autoRefresh: false,
    _pending: false,
    _objectBinding: false,
    _fn: null,
    __status: 'ok',
    __errMsg: '',
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this._configureSource();
    },
    _configureSource: function() {
        if (this._url != null) {
            this.__reload = this._loadRemote.bind(this);
        } else if (this._fn != null) {
            this.__reload = function() {
                this._data = this._fn();
                this.fireEvent('load');
            }.bind(this);
        } else if (empty(this._data)) {
            this.__status = 'nosource';
        } else {
            this.__reload = function() {
                this._pending = false;
                this.fireEvent('load');
            };
        }
        if (this._autoRefresh) {
            this.reload();
        }
    },
    setUrl: function(url) {
        this._url = url;
        this._configureSource();
    },
    fill: function(receive, cb) {
        if (!this._pending && (empty(this._data) || this._autoRefresh)) {
            this.reload();
        }
        this._send(receive, cb);
    },
    getData: function(receive) {
        if (!this._pending && (empty(this._data) || this._autoRefresh)) {
            this.reload();
        }
        this._giveData.bind(this).defer(receive);
    },
    getError: function() {
        return this.__errMsg;
    },
    isPending: function() {
        return this._pending;
    },
    _send: function(receive, cb) {
        if (this._pending) {
            this._send.bind(this).defer(receive, cb);
            return;
        }
        if (this.__status == 'error') {
            return;
        }
        if (this._objectBinding) {
            for (var d in this._data) {
                if (this._data.hasOwnProperty(d)) {
                    receive([d, this._data[d]]);
                }
            }
        } else {
            for (var datum in this._data) {
                if (!this._data.hasOwnProperty(datum)) {
                    continue;
                }
                var d = this._data[datum];
                if (!empty(this._fields)) {
                    if (this._fields.length == 1) {
                        var obj = {};
                        obj[this._fields[0]] = d;
                        d = obj;
                    } else {
                        var record = {};
                        var len = this._fields.length;
                        for (var i = 0; i < len; i++) {
                            record[this._fields[i]] = d[i];
                        }
                        d = record;
                    }
                }
                receive(d);
            }
        }
        if (!undef(cb)) {
            cb();
        }
    },
    _giveData: function(receive) {
        if (this._pending) {
            this._giveData.bind(this).defer(receive);
            return;
        }
        if (this.__status != 'error') {
            receive(this._data);
        }
    },
    reload: function() {
        this._pending = true;
        this.fireEvent('beforeLoad');
        this.__reload();
    },
    purge: function() {
        this.data = [];
    },
    _loadRemote: function() {
        var args = {
            method: this._method,
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            onComplete: function(result) {
                this._pending = false;
            }.bind(this),
            onSuccess: function(result) {
                try {
                    var res = result.responseText.evalJSON();
                    if (res.status != 'success') {
                        throw new Error('Read failed: ' + res.msg);
                    }
                    this._data = res.data;
                    this.fireEvent('load');
                    this.__status = 'ok';
                } catch (e) {
                    this.__status = 'error';
                    this.__errMsg = e.message;
                    this.fireEvent('readError');
                }
            }.bind(this),
            onFailure: function(result) {
                this.__status = 'error';
                this.__errMsg = i18n.beezid.network_error;
                this.fireEvent('readError');
                this.fireEvent('error');
            }.bind(this),
            onException: function(result) {
                this.__status = 'error';
                this.__errMsg = 'Ajax exception.';
                this.fireEvent('error');
            }.bind(this)
        };
        if (this._method == 'post' && !empty(this._postParams)) {
            args['parameters'] = this._postParams;
        }
        this._pending = true;
        this.__status = 'loading';
        new Ajax.Request(this._url, args);
    }
});
var Control = Class.create(BeezidObject, {
    _classNames: [],
    _elem: null,
    _parent: null,
    _id: '',
    _valid: true,
    _required: false,
    _edited: false,
    _name: null,
    _value: null,
    _forcedValue: null,
    _setup: function() {},
    _keepClass: false,
    _form: null,
    _tooltip: null,
    _disabled: false,
    _noPost: false,
    _hidden: false,
    _preValidate: false,
    _allowEmpty: false,
    _errorClass: null,
    _errorElem: null,
    _errorMsg: null,
    _hoverTime: 500,
    _hoverTimer: null,
    _mouseEvents: false,
    _keyEvents: false,
    _editEvents: false,
    _focusEvents: false,
    _formEvents: false,
    _transitionEvents: false,
    _mouseCapture: false,
    __initialized: false,
    __tooltip: null,
    __all: new Hash(),
    __eventMap: {
        mouse: ['click', 'mousedown', 'mouseover', 'mousemove', 'mouseout', 'mouseup', 'touch'],
        key: ['keypress', 'keydown', 'keyup'],
        edit: ['reset', 'change'],
        focus: ['focus', 'blur'],
        form: ['submit'],
        transition: ['transitionend', 'webkitTransitionEnd', 'oTransitionEnd']
    },
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        if (!this._elem) {
            this._createElement();
        } else {
            this._id = empty(this._elem.id) ? this._id : this._elem.id;
            this._name = empty(this._elem.name) ? this._name : this._elem.name;
            if (empty(this._elem.id)) {
                this._elem.id = this._id;
            }
            if (this._forcedValue !== null) {
                this._value = this._forcedValue;
            } else {
                this._value = this._value === null ? this._elem.value : this._value;
            }
        }
        this._classNames.each(function(cls) {
            $(this._elem).addClassName(cls);
        }.bind(this));
        if (!empty(this._tooltip)) {
            this._mouseEvents = true;
        }
        for (var group in this.__eventMap) {
            if (this.__eventMap.hasOwnProperty(group)) {
                if (this['_' + group + 'Events']) {
                    var handler = '__handle' + group.substr(0, 1).toUpperCase() + group.substr(1),
                        len = this.__eventMap[group].length;
                    for (var i = 0; i < len; i++) {
                        this._elem.observe(this.__eventMap[group][i], this[handler].bind(this));
                    }
                }
            }
        }
        this.__all.set(this._id, this);
        this._setup();
    },
    destroy: function($super) {
        this.fireEvent('destroy', {
            async: false
        });
        this.__all.unset(this._id);
        if (empty(this._elem)) {
            return;
        }
        var parent = this._elem.parentNode;
        if (!empty(parent)) {
            parent.removeChild(this._elem);
        }
        delete this._elem;
        $super();
    },
    _createElement: function() {
        throw new TypeError('Cannot instantiate member of abstract class Control.');
    },
    __handleMouse: function(event) {
        if (!this.__initialized || this._disabled) {
            event.preventDefault();
            return false;
        }
        var type = event.type == 'touch' ? 'click' : event.type;
        if (event.type == 'mouseover') {
            this._hoverTimer = window.setTimeout(function() {
                this._hoverTimer = null;
                if (this._tooltip && !this.__tooltip) {
                    this.__tooltip = new Tooltip(this._tooltip, event);
                }
                this.fireEvent('hover');
            }.bind(this), this._hoverTime);
        } else if (this._hoverTimer && event.type == 'mouseout') {
            window.clearTimeout(this._hoverTimer);
            this._hoverTimer = null;
        } else if (event.type == 'mouseout' && !empty(this.__tooltip)) {
            this.__tooltip.expire();
            this.__tooltip = null;
        }
        this.fireEvent(type, {
            event: event,
            async: false
        });
        if (this._mouseCapture) {
            event.preventDefault();
            return false;
        }
        return true;
    },
    __handleTouch: function(event) {
        if (!this.__initialized || this._disabled) {
            event.preventDefault();
            return false;
        }
        this.fireEvent(event.type, {
            event: event,
            async: false
        });
        return true;
    },
    __handleKey: function(event) {
        if (!this.__initialized || this._disabled) {
            event.preventDefault();
            return false;
        }
        if (this._hoverTimer) {
            this._hoverTimer.reset();
        }
        if (this._preValidate) {
            (function(x) {
                x.fireEvent('preValidate', {
                    oldValue: x._value,
                    newValue: x._elem.value
                });
            }).defer(this);
        }
        this.fireEvent(event.type, {
            event: event || window.event,
            async: false
        });
        return true;
    },
    __handleEdit: function(event) {
        if (!this.__initialized || this._disabled) {
            event.preventDefault();
            return false;
        }
        this._edited = true;
        if (this.validate()) {
            if (event.type == 'change') {
                if (this.fireEvent('change', {
                        oldValue: this._value,
                        newValue: this._elem.getValue(),
                        async: false
                    })) {
                    this._value = this._elem.value;
                    return true;
                }
            }
        }
        return false;
    },
    __handleFocus: function(event) {
        this.fireEvent(event.type, {
            event: event
        });
    },
    __handleForm: function(event) {
        this.fireEvent(event.type, {
            event: event
        });
    },
    __handleTransition: function(event) {
        this.fireEvent('transitionend', {
            event: event
        });
    },
    attach: function(elem, first) {
        if (!empty(first)) {
            elem.insertBefore(this._elem, elem.firstChild);
        } else {
            elem.appendChild(this._elem);
        }
        return this;
    },
    detach: function() {
        if (!empty(this._elem)) {
            if (this._elem.parentNode) {
                this._elem.parentNode.removeChild(this._elem);
            }
        }
        return this;
    },
    setWidth: function(w) {
        this.setStyle({
            width: w
        });
        this.fireEvent('size', {
            w: this._elem.getWidth(),
            h: this._elem.getHeight()
        });
    },
    setHeight: function(h) {
        this.setStyle({
            height: h
        });
        this.fireEvent('size', {
            w: this._elem.getWidth(),
            h: this._elem.getHeight()
        });
    },
    setSize: function(w, h) {
        this.setStyle({
            width: w,
            height: h
        });
        this.fireEvent('size', {
            w: this._elem.getWidth(),
            h: this._elem.getHeight()
        });
    },
    setStyle: function(style) {
        if (empty(this._elem)) {
            return;
        }
        for (var i in style) {
            if (style.hasOwnProperty(i)) {
                this._elem.style[i] = style[i];
            }
        }
    },
    getValue: function() {
        return this._value;
    },
    getBoundValue: function() {
        var value = {},
            index = empty(this._name) ? this._id : this._name;
        value[index] = this.getValue();
        return value;
    },
    setValue: function(val) {
        this._value = val;
        this._elem.value = this._value;
        if (this.__initialized) {
            this.validate();
        }
    },
    forceValue: function(val) {
        var init = this.__initialized;
        this.__initialized = false;
        this.setValue(val);
        this.__initialized = init;
    },
    revert: function() {
        this._elem.value = this._value;
    },
    instantiate: function(suppressEvent) {
        if (this._hidden) {
            this.hide();
        }
        if (this._disabled) {
            this._elem.disabled = true;
        }
        if (this._required && empty(this._value)) {
            this._valid = false;
        }
        if (!suppressEvent) {
            this.fireEvent('instantiate');
        }
        return this;
    },
    show: function() {
        this._elem.show();
        this.fireEvent('show');
        return this;
    },
    hide: function() {
        this._elem.hide();
        this.fireEvent('hide');
        return this;
    },
    focus: function() {
        this._elem.focus();
        this.fireEvent('focus');
        return this;
    },
    blur: function() {
        this._elem.blur();
        this.fireEvent('blur');
        return this;
    },
    disable: function() {
        this._disabled = true;
        if (typeof this._elem.disable !== 'undefined') {
            this._elem.disable();
        } else {
            this._elem.disabled = true;
        }
        this._elem.addClassName('disabled');
        this.fireEvent('disable');
    },
    enable: function() {
        if (typeof this._elem.enable !== 'undefined') {
            this._elem.enable();
        } else {
            this._elem.disabled = false;
        }
        this._elem.removeClassName('disabled');
        if (this._disabled) {
            this._disabled = false;
            this.fireEvent('enable');
        }
    },
    validate: function() {
        return this._valid;
    },
    setInvalid: function(msg, force) {
        if (this._valid || !empty(force)) {
            this._valid = false;
            this.fireEvent('invalid', {
                msg: msg
            });
        }
        if (this._errorClass) {
            this._elem.addClassName(this._errorClass);
        }
        if (this._errorElem) {
            if (!msg) {
                msg = this._errorMsg;
            }
            if (msg) {
                this._errorElem.update(msg);
            }
            this._errorElem.show();
        }
    },
    setValid: function(msg, force) {
        if (!this._valid || !empty(force)) {
            this._valid = true;
            this.fireEvent('valid', {
                msg: msg
            });
        }
        if (this._errorClass) {
            this._elem.removeClassName(this._errorClass);
        }
        if (this._errorElem) {
            this._errorElem.hide();
        }
    },
    setError: function(msg) {
        this.setInvalid(msg);
    },
    findById: function(id) {
        if (id == this._id) {
            return this;
        }
        return null;
    },
    findByName: function(name) {
        if (name == this._name) {
            return [this];
        }
        return [];
    },
    forAll: function(fn) {
        fn(this);
    },
    isValid: function() {
        return this._valid;
    }
});
var DragHandler = Class.create(BeezidObject, {
    __offsetX: 0,
    __offsetY: 0,
    __dragX: 0,
    __dragY: 0,
    __orgX: 0,
    __orgY: 0,
    _owner: null,
    _handle: null,
    _useOverlay: false,
    _constrain: false,
    _dragCursor: null,
    __mobile: false,
    __events: null,
    __dragging: false,
    __overlay: null,
    __saveP: null,
    __dFn: null,
    __uFn: null,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        if (isMobileDevice()) {
            this.__mobile = true;
            this._dragCursor = null;
            this.__events = {
                start: 'touchstart',
                end: 'touchend',
                move: 'touchmove'
            };
        } else {
            this.__events = {
                start: 'mousedown',
                end: 'mouseup',
                move: 'mousemove'
            };
        }
        this.__setCursor('default');
        this.setOrigin();
        this._handle._elem.observe(this.__events.start, this.onStartDrag.bind(this));
        this.__uFn = this.onEndDrag.bind(this);
        this.__dFn = this._drag.bind(this);
    },
    setOrigin: function() {
        this.__offsetX = this._owner._elem.offsetLeft;
        this.__offsetY = this._owner._elem.offsetTop;
    },
    setConstraint: function(constraint) {
        this._constrain = constraint;
    },
    moveTo: function(x, y) {
        this.__offsetX = parseInt(x);
        this.__offsetY = parseInt(y);
        this._owner._elem.style.left = this.__offsetX + 'px';
        this._owner._elem.style.top = this.__offsetY + 'px';
    },
    __setCursor: function(cursor) {
        if (!this.__mobile) {
            this._handle.forAll(function(ctl) {
                ctl._elem.style.cursor = cursor;
            }.bind(cursor));
        }
    },
    __eventLocation: function(event) {
        if (this.__mobile) {
            return event.changedTouches[0];
        }
        return event;
    },
    onStartDrag: function(event) {
        if (event.isLeftClick() || undef(event.button) || event.button == null) {
            var loc = this.__eventLocation(event);
            this._startDrag(loc.pageX, loc.pageY);
        }
        return true;
    },
    onEndDrag: function(event) {
        if (!(this.__dragging)) {
            return;
        }
        var loc = this.__getLocation(event);
        this._endDrag(loc[0], loc[1]);
    },
    _startDrag: function(x, y) {
        this.__dragX = this.__orgX = x;
        this.__dragY = this.__orgY = y;
        if (!this.__dragging) {
            if (this._dragCursor) {
                this.__setCursor(this._dragCursor);
            }
            if (this._useOverlay) {
                this.__overlay = new Overlay({
                    opacity: 0.0,
                    zIndex: 100000,
                    fade: 0
                });
                this.__overlay.show();
                this.__saveP = this._owner._elem.parentNode;
                this._owner.detach();
                this._owner.attach(this.__overlay.__overlay);
                this.__overlay.__overlay.observe(this.__events.move, this.__dFn, true);
            }
            this.__dragging = true;
            this.fireEvent('dragStart', {
                x: x,
                y: y,
                async: false
            });
        }
        Event.observe(document, this.__events.move, this.__dFn, true);
        Event.observe(document, this.__events.end, this.__uFn, true);
        this._handle._elem.observe(this.__events.move, this.__dFn);
        this._handle._elem.observe(this.__events.end, this.__uFn);
    },
    _endDrag: function(x, y) {
        this.__setCursor('default');
        document.onselectstart = null;
        Event.stopObserving(document, this.__events.move, this.__dFn, true);
        Event.stopObserving(document, this.__events.end, this.__uFn, true);
        this._handle._elem.stopObserving(this.__events.move, this.__dfn);
        this._handle._elem.stopObserving(this.__events.end, this.__uFn);
        if (this._useOverlay) {
            this._owner.detach();
            this._owner.attach(this.__saveP);
            this.__overlay.destroy();
            this.__overlay = null;
        }
        this.__dragging = false;
        this.fireEvent('dragStop', {
            x: x,
            y: y,
            async: false
        });
    },
    __getLocation: function(event) {
        var loc = this.__eventLocation(event);
        var x = loc.pageX,
            y = loc.pageY;
        var oX = x - this.__orgX,
            oY = y - this.__orgY
        if (this._constrain) {
            if (oX < this._constrain.x[0]) {
                x = this.__orgX + this._constrain.x[0];
            }
            if (oX > this._constrain.x[1]) {
                x = this.__orgX + this._constrain.x[1];
            }
            if (oY < this._constrain.y[0]) {
                y = this.__orgY + this._constrain.y[0];
            }
            if (oY > this._constrain.y[1]) {
                y = this.__orgY + this._constrain.y[1];
            }
        }
        return [x, y];
    },
    _drag: function(event) {
        if (!this.__dragging) {
            return;
        }
        if (!undef(event.preventDefault)) {
            event.preventDefault();
        }
        var loc = this.__getLocation(event),
            x = loc[0],
            y = loc[1];
        this.__offsetX += x - this.__dragX;
        this.__offsetY += y - this.__dragY;
        this.__dragX = x;
        this.__dragY = y;
        this._owner._elem.style.left = this.__offsetX + 'px';
        this._owner._elem.style.top = this.__offsetY + 'px';
        this.fireEvent('drag', {
            offset: {
                x: this.__dragX - this.__orgX,
                y: this.__dragY - this.__orgY
            },
            async: false
        });
    }
});
var TextField = Class.create(Control, {
    _regex: null,
    _editEvents: true,
    _keyEvents: true,
    _focusEvents: true,
    _maxLength: null,
    _autoSelect: false,
    _inputType: null,
    _inputStep: null,
    initialize: function($super, config) {
        $super(config);
        this.addListener('validate', this);
        this.addListener('change', this);
        this.addListener('blur', this.onChange, this);
        if (this._autoSelect) {
            this.addListener('focus', function(e) {
                e.object._elem.select();
            });
        }
        this.__initialized = true;
    },
    _createElement: function() {
        if (this._inputType === null) {
            this._inputType = 'text';
        }
        var inputProperties = {
            id: this._id,
            name: this._name,
            value: this._value,
            maxlength: this._maxLength,
            type: this._inputType
        };
        if (this._inputStep !== null) {
            inputProperties.step = this._inputStep;
        }
        this._elem = new Element('input', inputProperties);
    },
    validate: function() {
        var newVal = this._elem.value;
        if (typeof this._elem.validity !== 'undefined' && this._elem.type === 'number' && !this._elem.validity.valid) {
            this.setInvalid();
            return false;
        } else if ((!this._regex || (this._regex && this._regex.match(newVal))) && this.fireEvent('validate', {
                async: false,
                oldValue: this._value,
                newValue: newVal
            })) {
            this.setValid();
            return true;
        } else {
            this.setInvalid();
            return false;
        }
    },
    onChange: function(event) {
        this._value = this._elem.value;
        return true;
    },
    setValue: function($super, value) {
        $super(value !== null ? value : '');
    },
    setType: function(type) {
        this._elem.type = type;
    }
});
var SpinBox = Class.create(Control, {
    _editEvents: true,
    _step: 1,
    initialize: function($super, config) {
        $super(config);
        this.addListener('change', this);
        this.__initialized = true;
    },
    _createElement: function() {
        this._elem = new Element('input', {
            type: 'number',
            id: this._id,
            name: this._name,
            value: this._value,
            step: this._step
        });
    },
    onChange: function(event) {
        this._value = event.newValue;
        return true;
    }
});
var Static = Class.create(Control, {
    _contentType: 'text',
    _content: '',
    _link: null,
    _alt: null,
    _noPost: true,
    _wrapper: 'div',
    initialize: function($super, config) {
        $super(config);
        this.__refresh();
        this.__initialized = true;
    },
    _createElement: function() {
        if (!empty(this._link)) {
            this._elem = new Element('a', {
                id: this._id,
                href: this._link
            });
        } else {
            this._elem = new Element(this._wrapper, {
                id: this._id
            });
        }
    },
    setContent: function(content) {
        this._content = content;
        this.__refresh();
    },
    __refresh: function() {
        if (!empty(this._content)) {
            if (this._contentType == 'text') {
                this._elem.innerHTML = this._content;
            } else if (this._contentType == 'image') {
                this._elem.innerHTML = '';
                this._elem.appendChild(new Element('img', {
                    src: this._content,
                    alt: this._alt
                }));
            }
        }
    }
});
var StaticBinding = Class.create(BeezidObject, {
    _map: null,
    _source: null,
    _formatMap: {
        currency: 'formatCurrency'
    },
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this._source.addListener('load', function(e) {
            for (var d in this._map) {
                if (this._map.hasOwnProperty(d) && e.object._data.hasOwnProperty(d) && this._map[d].elem) {
                    var fmt = this._map[d].fmt && this._formatMap.hasOwnProperty(this._map[d].fmt) ? this[this._formatMap[this._map[d].fmt]](e.object._data[d]) : e.object._data[d];
                    this._map[d].elem.update(fmt);
                }
            }
            this._afterMap(e.object._data);
        }.bind(this));
    },
    _afterMap: function(data) {},
    formatCurrency: function(val) {
        return formatCurrency(val);
    }
});
var Label = Class.create(Static, {
    _for: null,
    _createElement: function() {
        this._elem = new Element('label', {
            id: this._id,
            'for': this._for
        });
    }
});
var StatusControl = Class.create(Static, {
    _status: null,
    setStatus: function(status) {
        this._status = status;
        this._setStatus(status);
    },
    _setStatus: function(status) {}
});
var Button = Class.create(Static, {
    _contentType: 'text',
    _action: null,
    _mouseEvents: true,
    _mouseCapture: true,
    _hoverClass: null,
    _normalClass: null,
    initialize: function($super, config) {
        if (empty(config.wrapper)) {
            config.wrapper = 'button';
        }
        $super(config);
        this._elem.style.cursor = 'pointer';
        this.addListener('click', this);
        if (this._hoverClass) {
            this.addListener('mouseover', this);
            this.addListener('mouseout', this);
        }
        this.__initialized = true;
    },
    onClick: function(event) {
        this._elem.focus();
        if (typeof this._action == 'function') {
            this._action.bind(this, event)();
        } else if (this._action == 'submit') {
            this._form.submit(this._value);
        }
    },
    onMouseover: function() {
        if (this._normalClass) {
            if (typeof this._normalClass == 'function') {
                var className = this._normalClass.bind(this)();
            } else {
                var className = this._normalClass;
            }
            this._elem.removeClassName(className);
        }
        if (typeof this._hoverClass == 'function') {
            var className = this._hoverClass.bind(this)();
        } else {
            var className = this._hoverClass;
        }
        this._elem.addClassName(className);
    },
    onMouseout: function() {
        if (this._normalClass) {
            if (typeof this._normalClass == 'function') {
                var className = this._normalClass.bind(this)();
            } else {
                var className = this._normalClass;
            }
            this._elem.addClassName(className);
        }
        if (typeof this._hoverClass == 'function') {
            var className = this._hoverClass.bind(this)();
        } else {
            var className = this._hoverClass;
        }
        this._elem.removeClassName(className);
    }
});
var RadioButton = Class.create(Control, {
    _editEvents: true,
    _mouseEvents: true,
    _checked: 0,
    initialize: function($super, config) {
        $super(config);
        this.addListener('change', function(event) {
            event.object.select();
        });
        this._elem.checked = this._checked;
        this.__initialized = true;
    },
    _createElement: function() {
        this._elem = new Element('input', {
            type: 'radio',
            id: this._id,
            name: this._name,
            value: this._value
        });
    },
    select: function() {
        this._elem.checked = this._checked = true;
        this._edited = true;
        this._parent.onChildSelect(this);
    }
});
var CheckBox = Class.create(Control, {
    _editEvents: true,
    _mouseEvents: true,
    initialize: function($super, config) {
        $super(config);
        this.addListener('change', function() {
            this._edited = true;
        });
        this.addListener('click', function() {
            this._edited = true;
        });
        this.__initialized = true;
    },
    _createElement: function() {
        this._elem = new Element('input', {
            type: 'checkbox',
            id: this._id,
            name: this._name,
            checked: this._value
        });
    },
    instantiate: function($super) {
        this.setValue.bind(this).defer(this._elem.checked);
        return $super();
    },
    onClick: function() {
        this._edited = true;
    },
    setValue: function(value) {
        var checked = true && value;
        this._value = checked ? 1 : 0;
        this._elem.checked = checked;
        var shadow = $$$(this._id + '_');
        if (shadow) {
            shadow.setValue(this._value);
        }
    },
    getValue: function() {
        this._value = this._elem.checked ? 1 : 0;
        var shadow = $$$(this._id + '_');
        if (shadow) {
            shadow.setValue(this._value);
        }
        return this._value;
    }
});
var Submit = Class.create(Control, {
    initialize: function($super, config) {
        $super(config);
        this.__initialized = true;
    },
    _createElement: function() {
        this._elem = new Element('button', {
            type: 'submit',
            name: this._name,
            id: this._id
        });
    }
});
var ComboBox = Class.create(Control, {
    _idField: 'id',
    _displayField: 'name',
    _source: null,
    _editEvents: true,
    __waiters: null,
    initialize: function($super, config) {
        $super(config);
        if (this._elem.selectedIndex >= 0 && !undef(this._elem[this._elem.selectedIndex])) {
            this._value = this._elem[this._elem.selectedIndex].value;
        }
        this.__waiters = [];
        if (this._source) {
            this._dataSource = new DataSource(this._source);
            this.refresh();
        } else {
            this.__initialized = true;
        }
        this.addListener('change', this);
    },
    _createElement: function() {
        this._elem = new Element('select', {
            id: this._id,
            name: this._name,
            value: this._value
        });
    },
    refresh: function() {
        this._elem.innerHTML = '';
        this._dataSource.fill(this.addItem.bind(this), this.filled.bind(this));
    },
    setDataSource: function(dataSource) {
        this._dataSource = dataSource;
        this.__initialized = false;
        this.refresh();
    },
    addItem: function(item) {
        if (item.type == 'optgroup') {
            var opt = new Element('optgroup', {
                id: item.id,
                label: item.text
            });
        } else {
            var opt = new Element('option', {
                value: item[this._idField]
            });
            if (item[this._idField] == this._value) {
                opt.setAttribute('selected', 'selected');
            }
            opt.innerHTML = item[this._displayField];
        }
        if (typeof item.optgroup !== 'undefined') {
            this._elem.select('[id=' + item.optgroup + ']').first().appendChild(opt);
        } else {
            this._elem.appendChild(opt);
        }
    },
    filled: function() {
        (function() {
            this.setValue(this._value);
            this._value = this.getValue();
            this.__initialized = true;
            if (this.__waiters.length > 0) {
                for (var i = 0; i < this.__waiters.length; i++) {
                    this.__waiters[i](this._value);
                }
                this.__waiters = [];
            }
        }).bind(this).defer();
    },
    getText: function() {
        var opt = this._elem.selectedIndex;
        if (opt >= 0) {
            return this._elem.options[opt].innerHTML;
        }
        return null;
    },
    getValue: function() {
        var opt = this._elem.selectedIndex;
        if (opt >= 0) {
            return this._elem.options[opt].value;
        }
        return null;
    },
    setValue: function($super, val) {
        var len = this._elem.childNodes.length,
            i;
        for (i = 0; i < len; i++) {
            if (this._elem.childNodes.item(i).value == val) {
                this._value = val;
                this._elem.selectedIndex = i;
                break;
            }
        }
        if (this.__initialized) {
            this.validate();
        }
    },
    getValueDeferred: function(cb) {
        if (this._dataSource.isPending()) {
            this.__waiters.push(cb);
        } else {
            cb(this.getValue());
        }
    },
    revert: function() {
        var len = this._elem.childNodes.length;
        for (var i = 0; i < len; i++) {
            if (this._elem.childNodes.item(i).value == this._value) {
                this._elem.selectedIndex = i;
                break;
            }
        }
    },
    validate: function() {
        if (this._elem.selectedIndex < 0 || empty(this._elem.options[this._elem.selectedIndex])) {
            if (!this._allowEmpty) {
                this.setInvalid();
            } else {
                this.setValid();
            }
        } else {
            var value = this._elem.options[this._elem.selectedIndex].value;
            if (!empty(value) && this.fireEvent('validate', {
                    async: false,
                    oldValue: this._value,
                    newValue: value
                })) {
                this.setValid();
            } else {
                this.setInvalid();
            }
        }
        return this._valid;
    },
    onChange: function() {
        this._edited = this.__initialized;
    }
});
var Hidden = Class.create(Control, {
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this.__initialized = true;
    },
    _createElement: function() {
        this._elem = document.createElement('input');
        this._elem.setAttribute('type', 'hidden');
        this._elem.setAttribute('name', this._name);
        this._elem.setAttribute('id', this._id);
        this._elem.setAttribute('value', this._value);
    },
    getValue: function() {
        return this._value;
    },
    setValue: function($super, val) {
        $super(val);
        this._elem.value = val;
    }
});
var Container = Class.create(Control, {
    _items: [],
    _elementType: 'div',
    _wrapperType: null,
    _isInstantiated: false,
    _breakOnInvalid: false,
    __invalidCount: 0,
    initialize: function($super, config) {
        $super(config);
    },
    destroy: function($super) {
        for (var i in this._items) {
            if (this._items.hasOwnProperty(i)) {
                if (this._items[i]._instance) {
                    this._items[i]._instance.destroy();
                }
            }
        }
        $super();
    },
    _createElement: function() {
        this._elem = new Element(this._elementType, {
            id: this._id
        });
    },
    instantiate: function($super, suppressEvent) {
        if (this.__initialized) {
            return;
        }
        $super(true);
        this._items.each(function(item) {
            if (!empty(this._wrapperType)) {
                var classNames = null;
                if (!item._keepClass) {
                    classNames = item.classNames;
                    delete item.classNames;
                }
                item._instance = ControlFactory.createInstance(item);
                var wrapper = new Element(this._wrapperType);
                if (!empty(classNames)) {
                    classNames.each(function(cls) {
                        wrapper.addClassName(cls);
                    });
                }
                item._instance.attach(wrapper);
                this._elem.appendChild(wrapper);
            } else {
                item._instance = ControlFactory.createInstance(item);
                if (!item.elem) {
                    item._instance.attach(this._elem);
                }
            }
            if (!item._instance._valid) {
                this.__invalidCount++;
                this._valid = false;
            }
            item._instance._parent = this;
            item._instance.addListener('invalid', this.onItemInvalid, this);
            item._instance.addListener('valid', this.onItemValid, this);
        }.bind(this));
        this.__initialized = true;
        this.fireEvent('instantiate');
        return this;
    },
    itemCount: function() {
        return this._items.length;
    },
    onItemInvalid: function(event) {
        this.__invalidCount++;
        this.setInvalid();
    },
    onItemValid: function(event) {
        if (this.__invalidCount > 0) {
            --this.__invalidCount;
        }
        if (this.__invalidCount === 0) {
            this.setValid();
        }
    },
    push: function(control) {
        this._items.push({
            _instance: control
        });
        control.addListener('invalid', this.onItemInvalid, this);
        control.addListener('valid', this.onItemValid, this);
        if (!control._valid) {
            this.__invalidCount++;
            this._valid = false;
        }
        control._parent = this;
        control.attach(this._elem);
    },
    pop: function() {
        var control = this._items.pop();
        if (control && !empty(control._instance)) {
            control._instance.detach();
            return control;
        }
        return null;
    },
    purge: function() {
        this._elem.update();
        this._items = [];
        this.__invalidCount = 0;
    },
    validate: function() {
        if (this.validateChildren() && this.fireEvent('validate', {
                async: false
            })) {
            if (!this._valid) {
                this._valid = true;
                this.fireEvent('valid');
            }
        } else if (this._valid) {
            this._valid = false;
            this.fireEvent('invalid');
        }
        return this._valid;
    },
    validateChildren: function() {
        var result = true;
        var len = this._items.length;
        for (var i = 0; i < len; i++) {
            if (this._items[i]._instance._disabled) {
                continue;
            }
            if (!this._items[i]._instance.validate()) {
                result = false;
                if (this._breakOnInvalid) {
                    break;
                }
            }
        }
        return result;
    },
    getValue: function() {
        var result = {};
        for (var i in this._items) {
            if (this._items.hasOwnProperty(i)) {
                var item = this._items[i]._instance,
                    value;
                if (item._noPost) {
                    continue;
                }
                if (item instanceof Container) {
                    value = item.getValue();
                } else {
                    value = item.getBoundValue();
                }
                this._bindParams.bind(result)(value, true);
            }
        }
        return result;
    },
    enable: function() {
        this._items.each(function(item) {
            item._instance.enable();
        });
    },
    disable: function() {
        this._items.each(function(item) {
            item._instance.disable();
        });
    },
    revert: function() {
        var n = this._items.length;
        for (var i = 0; i < n; i++) {
            this._items[i]._instance.revert();
        }
    },
    findById: function(id) {
        if (id == this._id) {
            return this;
        }
        var n = this._items.length;
        for (var i = 0; i < n; i++) {
            var res = this._items[i]._instance.findById(id);
            if (res != null) {
                return res;
            }
        }
        return null;
    },
    findByName: function(name) {
        if (name == this._name) {
            return [this];
        }
        var result = [];
        var n = this._items.length;
        for (var i = 0; i < n; i++) {
            var item = this._items[i];
            if (!undef(item._instance)) {
                result = result.concat(item._instance.findByName(name));
            }
        }
        return result;
    },
    forAll: function(fn) {
        this._items.each(function(item) {
            item._instance.forAll(fn);
        });
    }
});
var LinearArray = Class.create(Container, {
    _elementType: 'tr',
    _wrapperType: 'td'
});
var FieldSet = Class.create(Container, {
    _elementType: 'fieldset'
});
var RadioGroup = Class.create(Container, {
    _default: null,
    getValue: function() {
        var e = this.__findRadios(),
            len = e.length,
            value = this._default,
            index = empty(this._name) ? this._id : this._name,
            result = {};
        for (var i = 0; i < len; i++) {
            if (e[i]._elem.checked) {
                value = e[i]._elem.value;
                break;
            }
        }
        result[index] = value;
        return result;
    },
    getRawValue: function() {
        return this.getValue()[this._name];
    },
    setValue: function(val) {
        var e = this.__findRadios(),
            len = e.length;
        for (var i = 0; i < len; i++) {
            if (e[i]._elem.value == val) {
                e[i]._elem.checked = e[i]._checked = true;
                this._value = val;
            } else {
                e[i]._elem.checked = e[i]._checked = false;
            }
        }
    },
    forAll: function(fn) {
        fn(this);
    },
    instantiate: function($super) {
        $super(true);
        this.__findRadios().each(function(r) {
            r._parent = this;
        }.bind(this));
        this.setValue.bind(this).defer(this._value);
        this.fireEvent('instantiate');
        return this;
    },
    __findRadios: function() {
        var result = [];
        var n = this._items.length;
        for (var i = 0; i < n; i++) {
            result = result.concat(this._items[i]._instance.findByName(this._name));
        }
        return result;
    },
    onChildSelect: function(child) {
        this._value = child._value;
        this._edited = true;
        this.fireEvent('change', {
            value: this._value,
            selected: child
        });
    }
});
var Phorm = Class.create(Container, {
    _method: 'post',
    _action: '',
    _isAjax: false,
    __submits: null,
    _greedy: true,
    _formEvents: true,
    _skipValidation: false,
    _busyIndicator: null,
    _focusNextTabindex: false,
    __busy: false,
    initialize: function($super, config) {
        $super(config);
        $$('input').each(function(e) {
            if (e.getAttribute('autocomplete') !== 'on') {
                e.setAttribute('autocomplete', 'off');
            }
        });
    },
    _createElement: function() {
        this._elem = new Element('form', {
            id: this._id,
            name: this._name,
            action: this._action,
            method: this._method
        });
    },
    instantiate: function($super) {
        $super(true);
        if (empty(this._action)) {
            this._action = this._elem.action;
        } else {
            this._elem.action = this._action;
        }
        this.__initialized = false;
        this._items.each(function(item) {
            if (item.type == 'submit' || (item.type == 'button' && !empty(item.action) && item.action == 'submit')) {
                this.__addSubmit(item._instance);
            }
        }.bind(this));
        if (this._greedy) {
            var inputs = this._elem.getElementsByTagName('input'),
                missing = [],
                len = inputs.length,
                i;
            for (i = 0; i < len; i++) {
                var e = inputs[i];
                if (!empty(e.name) && empty(this.findByName(e.name))) {
                    missing.push(e);
                } else if (!empty(e.id) && !this.findById(e.id)) {
                    missing.push(e);
                }
            }
            len = missing.length;
            for (i = 0; i < len; i++) {
                if (missing[i].tagName.toLowerCase() == 'input' && missing[i].type == 'submit') {
                    missing[i].onclick = function() {
                        this.fireEvent('submit');
                        return false;
                    }.bind(this);
                    this.__addSubmit(missing[i]);
                } else {
                    this.push(new Hidden({
                        elem: missing[i],
                        name: missing[i].name,
                        id: missing[i].id,
                        value: missing[i].value
                    }));
                }
            }
        }
        var buttons = this._elem.getElementsByTagName('button');
        var len = buttons.length;
        for (var i = 0; i < len; i++) {
            var e = buttons.item(i);
            if (!this.findByName(e.name)) {
                if (e.type == 'submit') {
                    if (!empty(e.name) && empty(this.findByName(e.name))) {
                        this.__addSubmit(e);
                    } else if (!empty(e.id) && !this.findById(e.id)) {
                        this.__addSubmit(e);
                    }
                }
            }
            if (e.type == 'submit') {
                e.onclick = function() {
                    this.fireEvent('submit');
                    return false;
                }.bind(this);
            }
        }
        this.addListener('submit', this);
        this._elem.onsubmit = function(e) {
            e.preventDefault();
            this.fireEvent('submit');
        }
        if (this._focusNextTabindex && $(this._elem.id)) {
            var focusNextElement = new FocusNextElement();
            focusNextElement.instantiate(this._elem.id);
        }
        this.__initialized = true;
        this.fireEvent('instantiate');
        return this;
    },
    __addSubmit: function(elem) {
        if (this.__submits == null) {
            this.__submits = [];
        }
        this.__submits.push(elem);
    },
    submit: function() {
        this.validate();
        this.onSubmit();
    },
    onSubmit: function(event) {
        if ((this._valid || this._skipValidation) && this.__preSubmit()) {
            if (this._isAjax) {
                this.__doAjax();
            } else {
                this._elem.submit();
            }
            this.__postSubmit();
        } else {
            this.fireEvent('formFailure', {
                internal: true,
                result: {
                    status: 'fail',
                    msg: 'There were validation errors.'
                }
            });
        }
    },
    __preSubmit: function() {
        this.enableSubmit();
        return this.fireEvent('preSubmit', {
            async: false
        });
    },
    __postSubmit: function() {
        this.fireEvent('postSubmit', {
            async: false
        });
        this.disableSubmit();
    },
    enableSubmit: function() {
        this.forAll(function(input) {
            if (input._elem.disabled && !input._noPost && typeof input._elem.enable == 'function') {
                input._elem.enable();
            }
        });
    },
    disableSubmit: function() {
        this.forAll(function(input) {
            if (input._disabled) {
                input.disable();
            }
        });
    },
    __freeze: function() {
        this.forAll(function(input) {
            if (typeof input._elem.disable == 'function') {
                input._elem.disable();
            }
        });
    },
    __thaw: function() {
        this.forAll(function(input) {
            if (!input._disabled && typeof input._elem.enable == 'function') {
                input._elem.enable();
            }
        });
    },
    setInvalid: function($super) {
        $super();
        if (this.__submits) {
            this.__submits.each(function(ctl) {
                ctl.disable();
            });
        }
    },
    setValid: function($super) {
        $super();
        if (this.__submits) {
            this.__submits.each(function(ctl) {
                ctl.enable();
            });
        }
    },
    setUrl: function(url) {
        this._elem.action = this._action = url;
    },
    __doAjax: function() {
        var callOpts = {
            method: this._method,
            lockObj: this,
            onError: function() {
                this.fireEvent('formFailure', {
                    result: {
                        msg: i18n.beezid.network_error
                    },
                    async: false
                });
                this.__busy = false;
            }.bind(this)
        };
        if (this._busyIndicator) {
            callOpts.busy = this._busyIndicator;
        }
        this.__busy = true;
        ayjax(this._action, function(result) {
            if (empty(result.status)) {
                this.fireEvent('formFailure', {
                    result: {
                        msg: empty(e.msg) ? i18.beezid.error : e.msg
                    }
                });
            }
            if (result.status == 'success') {
                this.fireEvent('formSuccess', {
                    result: result
                });
            } else {
                this.fireEvent('formFailure', {
                    result: result
                });
            }
            this.__busy = false;
        }.bind(this), callOpts, this.getValue());
    }
});
var StatefulControl = Class.create(Container, {
    _state: null,
    initialize: function($super, config) {
        $super(config);
        this.update.bind(this).defer();
    },
    setState: function(state) {
        if (state != this._state) {
            this._state = state;
            this.update();
            this.fireEvent('stateChange', {
                to: state,
                from: this._state
            });
        }
    },
    update: function() {
        var n = this._items.length;
        for (var i = 0; i < n; i++) {
            if (!undef(this._items[i].states) && !empty(this._items[i]._instance._elem)) {
                if (this._items[i].states == '*' || this._items[i].states.indexOf(this._state) !== -1) {
                    this._items[i]._instance._elem.show();
                } else {
                    this._items[i]._instance._elem.hide();
                }
            }
        }
    },
    getState: function() {
        return this._state;
    },
    instantiate: function($super) {
        for (var i in this._items) {
            if (this._items.hasOwnProperty(i)) {
                this._items[i].hidden = true;
            }
        }
        this.update.bind(this).defer();
        return $super();
    }
});
window.OverlayManager = {
    __zIndex: 10000,
    __modalLocks: 0,
    allocateZ: function(overlay) {
        overlay._zIndex = this.__zIndex;
        this.__zIndex += 2;
        overlay.addListener('overlayClosed', this);
    },
    onOverlayClosed: function(event) {
        this.__zIndex -= 2;
    },
    lockScroll: function() {
        if (!this.__modalLocks++) {
            document.body.style.overflow = 'hidden';
        }
    },
    releaseScroll: function() {
        if (!--this.__modalLocks) {
            document.body.style.overflow = 'auto';
        }
    }
};
var Overlay = Class.create(BeezidObject, {
    _opacity: 0.6,
    _zIndex: null,
    _useFixed: true,
    _overlayClass: 'beezid_overlay_fixed',
    _shadeClass: 'beezid_overlay_shade',
    _fade: 0.2,
    _closeOnClick: false,
    _hideOnClick: false,
    __offset: {
        left: 0,
        top: 0
    },
    __overlay: null,
    __shade: null,
    __isShown: false,
    __isBusy: false,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        if (empty(this._zIndex)) {
            OverlayManager.allocateZ(this);
        }
        if (!this._useFixed) {
            this._overlayClass = 'beezid_overlay_nofixed';
        }
        this.__overlay = document.createElement('div');
        this.__overlay.setAttribute('class', this._overlayClass);
        this.__overlay.setAttribute('style', 'z-index:' + this._zIndex);
        this.__shade = new Element('div');
        this.__shade.setAttribute('class', this._shadeClass);
        this.__overlay.appendChild(this.__shade);
        if (this._closeOnClick || this._hideOnClick) {
            Element.extend(this.__shade);
            this.__shade.observe('click', this.onClick.bind(this));
        }
        document.body.appendChild(this.__overlay);
    },
    destroy: function($super) {
        this.close();
        $super();
    },
    onClick: function(event) {
        if (this._hideOnClick) {
            this.hide();
        }
        if (this._closeOnClick) {
            this.close();
        }
    },
    show: function() {
        if (!this.__isShown && !this.__isBusy) {
            this.__isBusy = true;
            var style = {
                display: 'block'
            }
            if (!this._useFixed) {
                var w = document.documentElement.clientWidth,
                    h = document.documentElement.clientHeight;
                this.__offset = {
                    left: w,
                    top: h
                };
                style['left'] = '-' + w + 'px';
                style['top'] = '-' + h + 'px';
                style['width'] = (2 * w) + 'px';
                style['height'] = (2 * h) + 'px';
            }
            this._setStyle(this.__overlay, style);
            if (this.fade) {
                this._setStyle(this.__shade, {
                    display: 'block',
                    opacity: 0,
                    filter: 'alpha(opacity=0)'
                });
                this.__shade.setOpacity(0);
                new Effect.Fade(this.__shade, {
                    from: 0,
                    to: this._opacity,
                    duration: this.fade,
                    afterFinish: function() {
                        this._setStyle(this.__shade, {
                            display: 'block',
                            opacity: this._opacity,
                            filter: 'alpha(opacity=' + (this._opacity * 100) + ')'
                        });
                        this.__isShown = true;
                        this.__isBusy = false;
                        this.fireEvent('overlayShown', {
                            offset: this.__offset
                        });
                    }.bind(this)
                });
            } else {
                this._setStyle(this.__shade, {
                    display: 'block',
                    opacity: this._opacity,
                    filter: 'alpha(opacity=' + (this._opacity * 100) + ')'
                });
                this.__isShown = true;
                this.__isBusy = false;
                this.fireEvent('overlayShown', {
                    offset: this.__offset
                });
            }
        }
    },
    hide: function() {
        if (this.__isShown && !this.__isBusy) {
            this.__isBusy = true;
            this._hide(function() {
                this.__isShown = false;
                this.__isBusy = false;
                this._setStyle(this.__overlay, {
                    display: 'none'
                });
                this.fireEvent('overlayHidden');
            }.bind(this));
        }
    },
    _hide: function(fn) {
        fn();
    },
    close: function() {
        if (this.__overlay) {
            this.__overlay.parentNode.removeChild(this.__overlay);
        }
        delete this.__shade;
        delete this.__overlay;
        this.fireEvent('overlayClosed');
    },
    attach: function(elem) {
        elem.appendChild(this.__overlay);
    },
    _setStyle: function(elem, style) {
        for (var i in style) {
            if (style.hasOwnProperty(i)) {
                elem.style[i] = style[i];
            }
        }
    }
});
var Popup = Class.create(Container, {
    _modal: false,
    _element: null,
    _parent: null,
    _classNames: ['beezid-popup'],
    _overlay: null,
    __overlay: null,
    __isShown: false,
    __isBusy: false,
    _timeout: false,
    destroy: function($super) {
        this.hide();
        this.clearTimeout();
        if (!empty(this.__overlay)) {
            this.__overlay.removeListener('overlayClosed', this);
            this.__overlay.destroy();
        }
        $super();
    },
    _createElement: function() {
        var parent = null;
        if (this._element) {
            this._elem = this._element;
            parent = this._elem.parentNode;
        } else {
            this._elem = document.createElement('div');
            if (!empty(this._id)) {
                this._elem.setAttribute('id', this._id);
            }
        }
        if (this._parent) {
            parent = this._parent;
        } else {
            this._parent = parent;
        }
        if (!empty(this._overlay)) {
            this.__overlay = new Overlay(this._overlay);
            if (parent) {
                var sib = this._elem.nextSibling;
                if (this._elem.parentNode) {
                    this._elem.parentNode.removeChild(this._elem);
                }
                parent.insertBefore(this.__overlay.__overlay, sib);
            } else {
                this.__overlay.attach(document.body);
            }
            this.attach(this.__overlay.__overlay);
            this.setStyle({
                zIndex: this.__overlay._zIndex + 1
            });
            this.show = function() {
                if (this.__isShown || this.__isBusy) {
                    return;
                }
                this.__isBusy = true;
                this.__isShown = true;
                this.__overlay.show();
                this.__show();
                return this;
            };
            this.hide = function() {
                if (!this.__isShown || this.__isBusy) {
                    return;
                }
                this.__isBusy = true;
                this.__isShown = false;
                this.__hide();
                if (this.__overlay) {
                    this.__overlay.hide();
                }
                return this;
            };
            this.__overlay.addListener('overlayShown', this);
            this.__overlay.addListener('overlayHidden', this);
            this.__overlay.addListener('overlayClosed', this);
            this.addListener('popupClosed', this._hideOverlay, this);
        } else {
            this.show = function() {
                if (!this.__isShown && !this.__isBusy) {
                    this.__isBusy = true;
                    this.__isShown = true;
                    this.__show();
                }
                return this;
            };
            this.hide = function() {
                if (this.__isShown && !this.__isBusy) {
                    this.__isBusy = true;
                    this.__isShown = false;
                    this.__hide();
                }
                return this;
            };
        }
    },
    toggle: function() {
        if (!this.__isShown) {
            this.show();
        } else {
            this.hide();
        }
    },
    __show: function() {
        if (this._modal) {
            OverlayManager.lockScroll();
        }
        if (this._timeout) {
            setTimeout(this.destroy.bind(this), this._timeout);
        }
        this._show();
        this.fireEvent('popupOpen');
    },
    __hide: function() {
        this._hide();
        if (this._modal) {
            OverlayManager.releaseScroll();
        }
        this.fireEvent('popupClosed');
    },
    _show: function() {
        this._elem.show();
        this.__isBusy = false;
    },
    _hide: function() {
        !empty(this._elem) && this._elem.hide();
        this.__isBusy = false;
    },
    onOverlayShown: function() {},
    onOverlayHidden: function() {
        if (this.__isShown) {
            this.hide();
        }
    },
    onOverlayClosed: function() {
        delete this.__overlay;
        this.destroy();
    },
    hideOverlay: function() {
        this.__overlay.hide();
    },
    clearTimeout: function() {
        if (this._timeout) {
            clearTimeout(this._timeout);
            this._timeout = null;
        }
    }
});
var Tooltip = Class.create(Popup, {
    _center: false,
    _classNames: ['beezid-tooltip'],
    _lingerTime: 200,
    _width: 300,
    __x: null,
    __y: null,
    initialize: function($super, config, event) {
        if (typeof config == 'string') {
            config = {
                items: [{
                    type: 'static',
                    content: config
                }]
            };
        }
        $super(config);
        this.__x = event.x;
        this.__y = event.y;
        this.instantiate();
        this.show();
        this._elem.hide();
        this.postLayout.bind(this).defer();
    },
    expire: function() {
        var me = this;
        window.setTimeout(function() {
            me.destroy();
        }, this._lingerTime);
    },
    postLayout: function() {
        this.setStyle({
            position: 'fixed',
            'z-index': 20000,
            width: this._width + 'px',
            left: this.__x - (this._elem.getStyle('width') / 2) + 'px',
            top: this.__y - this._elem.getStyle('height') + 'px'
        });
        this._elem.show();
    }
});
var UrlPopup = Class.create(Popup, {
    _url: null,
    _overlay: {},
    _center: true,
    _afterLoad: function() {},
    _evalScripts: false,
    initialize: function($super, config) {
        $super(config);
    },
    run: function() {
        new Ajax.Request(this._url, {
            method: 'get',
            onSuccess: function(result) {
                if (this._evalScripts) {
                    this._elem.__update(result.responseText);
                } else {
                    this._elem.innerHTML = result.responseText;
                }
                this.show();
                if (this._center) {
                    this.__setPos.bind(this).defer();
                }
                this._afterLoad();
            }.bind(this)
        });
    },
    __setPos: function() {
        var ws = new WindowSize();
        this._elem.style.left = ((ws.width - this._elem.offsetWidth) / 2) + 'px';
        verticalAdjust(this._elem);
        return this;
    }
});
var Dialog = Class.create(Popup, {
    _modal: false,
    _draggable: false,
    _overlay: {},
    _classNames: ['dialog-outer-details', 'beezid_dialog'],
    _dialogType: 'ok',
    _origin: null,
    _center: true,
    _okText: i18n.dialog.btn_okay,
    _cancelText: i18n.dialog.btn_cancel,
    _yesText: i18n.dialog.btn_yes,
    _noText: i18n.dialog.btn_no,
    _title: '',
    _text: '',
    _noClose: false,
    _defBtn: 'ok',
    _buttons: [],
    initialize: function($super, config) {
        $super(config);
        this.addListener('popupOpen', function() {
            var db = $$$(this._id + '_' + this._defBtn);
            if (db) {
                db._elem.focus();
            }
        });
    },
    run: function() {
        var preItems = [];
        var dlgContent = [];
        var postItems = [];
        if (!empty(this._title)) {
            preItems.push({
                type: 'static',
                classNames: ['dialog-title'],
                contentType: 'text',
                content: this._title
            });
        }
        if (!this._noClose) {
            preItems.push({
                type: 'button',
                classNames: ['btn', 'close'],
                contentType: 'text',
                content: '<i class="icon icon-close"></i>',
                action: function(event) {
                    this.onCancel();
                }.bind(this)
            });
        }
        if (!empty(this._text)) {
            dlgContent.push({
                type: 'static',
                classNames: ['dialog-text'],
                contentType: 'text',
                content: this._text
            });
        }
        if (this._dialogType != 'nobuttons') {
            var buttons = [];
            if (this._dialogType == 'ok' || this._dialogType == 'okcancel') {
                buttons.push({
                    type: 'button',
                    id: this._id + '_ok',
                    classNames: ['btn', 'btn-dlg', 'btn-cta', 'dlg_ok'],
                    contentType: 'text',
                    content: this._okText,
                    action: this.onOk.bind(this)
                });
                if (this._dialogType == 'okcancel') {
                    buttons.push({
                        type: 'button',
                        id: this._id + '_cancel',
                        classNames: ['btn', 'btn-dlg', 'dlg_cancel'],
                        contentType: 'text',
                        content: this._cancelText,
                        action: this.onCancel.bind(this)
                    });
                }
            } else if (this._dialogType == 'yesno') {
                buttons.push({
                    type: 'button',
                    id: this._id + '_yes',
                    classNames: ['btn', 'btn-dlg', 'btn-cta'],
                    contentType: 'text',
                    content: this._yesText,
                    action: this.onYes.bind(this)
                });
                buttons.push({
                    type: 'button',
                    id: this._id + '_no',
                    classNames: ['btn', 'btn-dlg'],
                    contentType: 'text',
                    content: this._noText,
                    action: this.onNo.bind(this)
                });
            } else if (!empty(this._buttons)) {
                buttons = this._buttons;
                buttons.each(function(b) {
                    if (empty(b.type)) {
                        b.type = 'button';
                    }
                    if (b.type == 'button') {
                        if (empty(b.classNames)) {
                            b.classNames = ['btn', 'dlg_btn', 'btn-cta'];
                        }
                        b.action = this.genericResult.bind(this).curry(b.name);
                    }
                }.bind(this));
            }
            postItems = postItems.concat([{
                type: 'container',
                id: this._id + '_buttons',
                classNames: ['btn-' + buttons.length],
                items: buttons
            }, {
                type: 'static',
                content: '&nbsp;',
                classNames: ['clear']
            }]);
        }
        this._items = [{
            type: 'container',
            classNames: ['dialog-wrapper'],
            items: [{
                type: 'container',
                classNames: ['dialog-header'],
                items: preItems,
                mouseEvents: this._draggable
            }, {
                type: 'container',
                classNames: ['dialog-body'],
                items: dlgContent.concat(this._items).concat([{
                    type: 'static',
                    classNames: ['clear']
                }])
            }, {
                type: 'container',
                classNames: ['dialog-footer'],
                items: postItems
            }]
        }];
        this.instantiate();
        this.show();
        this._elem.hide();
        this.postLayout.bind(this).defer();
        if (this._draggable) {
            new DragHandler({
                owner: this._items[0]._instance,
                handle: this._items[0]._instance._items[0]._instance,
                useOverlay: empty(this.__overlay)
            });
        }
        this.keyFunc = function(event) {
            if (event.keyCode == 27) {
                this.onCancel();
            }
        }.bind(this);
        Event.observe(document, 'keydown', this.keyFunc);
    },
    getValues: function() {
        return this._items[0]._instance._items[1]._instance.getValue();
    },
    genericResult: function(status) {
        if (this.fireEvent('dialogResult', {
                async: false,
                dialogResult: {
                    status: status,
                    values: this.getValues()
                }
            })) {
            this.close.bind(this).defer();
        }
    },
    onOk: function(event) {
        this.genericResult('ok');
    },
    onCancel: function(event) {
        this.genericResult('cancel');
    },
    onYes: function(event) {
        this.genericResult('yes');
    },
    onNo: function(event) {
        this.genericResult('no');
    },
    _show: function($super) {
        $super();
        this.fireEvent('popupOpen');
    },
    close: function() {
        Event.stopObserving(document, 'keydown', this.keyFunc);
        this.destroy();
    },
    postLayout: function() {
        this._elem.show();
        var uWidth = parseInt(this._elem.getStyle('width'));
        var uHeight = parseInt(this._elem.getStyle('height'));
        if (this._origin) {
            var oWidth = parseInt(this._origin.getStyle('width'));
            var oHeight = parseInt(this._origin.getStyle('height'));
            var x = (oWidth - uWidth) / 2;
            var y = oHeight;
            var offset = this._origin.cumulativeOffset();
            this.setStyle({
                left: (offset.left + x) + 'px',
                top: (offset.top + y) + 'px',
                marginTop: '12px'
            });
        } else if (this._center) {
            var sz = new WindowSize();
            var x = (sz.width - uWidth) / 2;
            var y = (sz.height - uHeight) / 2.618;
            this.setStyle({
                left: x + 'px',
                top: y + 'px'
            });
        }
        var defBtn = $(this._id + '_' + this._defBtn);
        if (!empty(defBtn)) {
            defBtn.activate();
        }
    }
});
var DateSelector = Class.create(Control, {
    _dateType: 'dob',
    __validationFunc: null,
    _dayElem: null,
    _monthElem: null,
    _yearElem: null,
    __dayCtl: null,
    __monthCtl: null,
    __yearCtl: null,
    _focusNext: null,
    initialize: function($super, config) {
        $super(config);
        if (this._elem) {
            this._dayElem = $(this._elem.id + 'Day');
            this._monthElem = $(this._elem.id + 'Month');
            this._yearElem = $(this._elem.id + 'Year');
        }
        var monthSrc, yearSrc, forceBlank;
        if (this._dateType == 'ccExpiry') {
            monthSrc = {
                data: [
                    [0, '--']
                ].concat($R(1, 12).map(function(m) {
                    return [m, m < 10 ? '0' + m : m.toString()];
                }))
            };
            yearSrc = {
                data: [{
                    n: '--'
                }].concat($R(0, 10).toArray().map(function(n) {
                    return {
                        n: new Date().getFullYear() + n
                    };
                }))
            };
            forceBlank = true;
        } else {
            monthSrc = {
                data: i18n.misc.months_full,
                objectBinding: true
            };
            yearSrc = {
                data: $R(0, 110).toArray().map(function(n) {
                    return {
                        n: new Date().getFullYear() - n
                    };
                })
            };
            forceBlank = false;
        }
        if (this._dayElem) {
            this.__dayCtl = new ComboBox({
                elem: this._dayElem,
                idField: 'n',
                displayField: 'n',
                value: parseInt(new Date().getDate()),
                source: {
                    data: $R(1, 31).toArray().map(function(n) {
                        return {
                            n: n
                        };
                    })
                },
                listeners: {
                    validate: this
                },
                overrides: {
                    __handleEdit: function(event) {
                        if (this.fireEvent('validate', {
                                async: false
                            })) {
                            this._value = this.getValue();
                        }
                    },
                    setValid: function() {
                        this._valid = true;
                    },
                    setInvalid: function() {
                        this._valid = false;
                    }
                }
            });
        }
        this.__monthCtl = new ComboBox({
            elem: this._monthElem,
            idField: 0,
            displayField: 1,
            value: forceBlank ? 0 : parseInt(new Date().getMonth()) + 1,
            source: monthSrc,
            listeners: {
                validate: this
            },
            overrides: {
                __handleEdit: function(event) {
                    if (this.fireEvent('validate', {
                            async: false
                        })) {
                        this._value = this.getValue();
                    }
                }
            }
        });
        var yearOpts = {
            elem: this._yearElem,
            idField: 'n',
            displayField: 'n',
            value: forceBlank ? '--' : parseInt(new Date().getYear()),
            source: yearSrc,
            listeners: {
                validate: this
            },
            overrides: {
                __handleEdit: function(event) {
                    this.fireEvent('validate');
                },
                setValid: function() {
                    this._valid = true;
                },
                setInvalid: function() {
                    this._valid = false;
                }
            }
        };
        if (this._focusNext) {
            var focus = this._focusNext;
            yearOpts['keyEvents'] = true;
            yearOpts['listeners']['keydown'] = function(e) {
                if (e.event.keyCode == 9) {
                    focus.focus();
                }
            };
        }
        this.__yearCtl = new ComboBox(yearOpts);
        if (this[this._dateType + 'Validate']) {
            this.__validationFunc = this[this._dateType + 'Validate'];
        } else {
            this.__validationFunc = function() {
                this.setInvalid();
                return false;
            };
        }
    },
    _createElement: function() {
        if (empty(this._id)) {
            this._id = 'datesel-' + Math.random(10000);
        }
        this._elem = document.createElement('div');
        this._elem.setAttribute('id', this._id);
        this._dayElem = document.createElement('select');
        this._dayElem.setAttribute('id', this._id + 'Day');
        this._monthElem = document.createElement('select');
        this._monthElem.setAttribute('id', this._id + 'Month');
        this._yearElem = document.createElement('select');
        this._yearElem.setAttribute('id', this._id + 'Year');
    },
    getBoundValue: function() {
        var retVal = {};
        [this.__dayCtl, this.__monthCtl, this.__yearCtl].each(function(c) {
            if (c) {
                retVal[c._name] = c.getValue();
            }
        });
        return retVal;
    },
    onValidate: function() {
        if (this.__validationFunc.apply(this)) {
            this.setValid();
            return true;
        }
        this.setInvalid();
        return false;
    },
    dobValidate: function() {
        var y = this.__yearCtl.getValue();
        var m = this.__monthCtl.getValue();
        var d = this.__dayCtl.getValue();
        var dob = new Date(y + '/' + m + '/' + d);
        var now = new Date();
        if (now.getFullYear() - dob.getFullYear() == 18) {
            if (now.getMonth() == dob.getMonth()) {
                return (dob.getDate() <= now.getDate());
            }
            return (dob.getMonth() < now.getMonth());
        }
        return ((now.getFullYear() - dob.getFullYear()) > 18);
    },
    ccExpiryValidate: function() {
        var y = this.__yearCtl.getValue();
        var m = this.__monthCtl.getValue();
        if (m == 12) {
            y++;
            m = 1;
        } else {
            m++;
        }
        var expire = new Date(y + '/' + m + '/' + 1);
        var now = new Date();
        return expire > now;
    }
});
var Slider = Class.create(Control, {
    _slideElem: null,
    _valueElem: null,
    _range: [0, 100],
    _value: 0,
    _stops: [0, 0],
    _limits: [],
    initialize: function($super, config) {
        $super(config);
        this.__initialized = true;
    },
    getLimits: function() {
        var left = this._elem.cumulativeOffset().left;
        var width = this._elem.offsetWidth;
        this._limits = [left + this._stops[0], left + width - this._stops[1]];
        return this._limits;
    },
    getSliderLimits: function(tag) {
        return this.getLimits();
    },
    __limitRange: function(val) {
        if (val > this._range[1]) {
            val = this._range[1];
        }
        if (val < this._range[0]) {
            val = this._range[0];
        }
        return val;
    },
    valueScale: function() {
        return (this._limits[1] - this._limits[0]) / (this._range[1] - this._range[0])
    },
    mapValue: function(pos) {
        return this.__limitRange((pos - this.getLimits()[0]) / this.valueScale());
    },
    mapPos: function(value) {
        return this.getLimits()[0] + (value * this.valueScale());
    },
    _renderValue: function() {
        this._valueElmen.innerHtml = this._value;
    },
    setValue: function(value, internal) {
        this._value = value;
        this._renderValue();
        if (empty(internal)) {
            this._updateSlider();
        }
    },
    _updateSlider: function() {}
});
Slider.Handle = Class.create(Control, {
    _tag: null,
    _wrapper: null,
    _mouseEvents: true,
    _mouseCapture: true,
    __dragHandler: null,
    __pos: 0,
    initialize: function($super, config) {
        $super(config);
        if (!this._wrapper) {
            this._wrapper = this;
        } else {
            this._wrapper = new Static({
                elem: this._wrapper
            });
        }
    },
    _createElement: function() {
        var klass = 'slider';
        if (this._tag) {
            klass += '_' + this._tag;
        }
        this._classNames = this._classNames.concat([klass]);
        this._elem = new Element('div');
    },
    setTag: function(tag) {
        this._tag = tag;
    },
    attach: function(elem, first) {
        if (!empty(first)) {
            elem.insertBefore(this._wrapper, elem.firstChild);
        } else {
            elem.appendChild(this._wrapper);
        }
    },
    instantiate: function($super) {
        if (!this._id && this._tag) {
            this._id = this._parent._id + '_' + this._tag;
            this._elem.id = this._id;
        }
        this.__dragHandler = new DragHandler({
            owner: this._wrapper,
            handle: this,
            listeners: {
                dragStart: this,
                dragStop: this,
                drag: this
            }
        });
        this.setPos(this._wrapper._elem.cumulativeOffset().left);
        this.addListener('sliderChange', this._parent);
        this.addListener('sliderMove', this._parent);
        return $super();
    },
    onDragStart: function(event) {
        var pos = this.getPos();
        var limits = this._parent.getSliderLimits(this._tag);
        event.object.setConstraint({
            x: [limits[0] - pos, limits[1] - pos],
            y: [0, 0]
        });
    },
    onDragStop: function(event) {
        var pos = this._wrapper._elem.cumulativeOffset().left;
        if (pos != this.__pos) {
            this.__pos = pos;
            this.fireEvent('sliderChange', {
                tag: this._tag,
                pos: this.__pos
            });
        }
    },
    onDrag: function(event) {
        this.fireEvent('sliderMove', {
            tag: this._tag,
            offset: event.offset.x
        });
    },
    getPos: function() {
        return this.__pos;
    },
    setPos: function(pos) {
        this.__pos = pos;
        pos -= $(this._wrapper._elem.parentNode).cumulativeOffset().left;
        this._wrapper._elem.style.left = pos + 'px';
        this.__dragHandler.setOrigin();
    },
    show: function() {
        this._wrapper.show();
        return this;
    },
    hide: function() {
        this._wrapper.hide();
        return this;
    }
});
var RangeSelect = Class.create(Slider, {
    _rSlider: null,
    _lSlider: null,
    _slideMargin: 10,
    _value: null,
    _range: [0, 100],
    initialize: function($super, config) {
        $super(config);
        if (this._value == null) {
            this.value = [this._range[0], this._range[1]];
        }
    },
    _createElement: function() {
        this._elem = new Element('div');
    },
    instantiate: function($super) {
        if (!this._slideElem) {
            this._slideElem = new Static({});
            this._slideElem.attach(this._elem);
        }
        if (!this._lSlider) {
            this._lSlider = new Slider.Handle({
                tag: 'left'
            });
            this._lSlider.attach(this._slideElem._elem);
        }
        if (!this._rSlider) {
            this._rSlider = new Slider.Handle({
                tag: 'right'
            });
            this._rSlider.attach(this._slideElem._elem);
        }
        if (!this._valueElem) {
            this._valueElem = new Static({
                content: this._lSlider.getValue() + ' - ' + this._rSlider.getValue()
            });
            this._valueElem.attach(this._elem);
        }
        this._lSlider.setTag('left');
        this._rSlider.setTag('right');
        var children = [this._slideElem, this._lSlider, this._rSlider, this._valueElem];
        for (var i = 0; i < children.length; i++) {
            children[i]._parent = this;
            children[i].instantiate();
        }
        this._renderValue();
        this._updateSlider();
        return $super();
    },
    getSliderLimits: function(tag) {
        this.getLimits();
        if (tag == 'left') {
            return [this._limits[0], Math.min(this._rSlider.getPos() - this._slideMargin, this._limits[1])];
        } else {
            return [Math.max(this._lSlider.getPos() + this._slideMargin, this._limits[0]), this._limits[1]];
        }
    },
    onSliderChange: function(event) {
        var lBound = this.mapValue(this._lSlider.getPos()),
            rBound = this.mapValue(this._rSlider.getPos());
        var oldValue = this._value;
        if (event.yag == 'left' && lBound > rBound - this._slideMargin) {
            lBound = rBound - this._slideMargin;
        } else if (event.tag == 'right' && rBound < lBound + this._slideMargin) {
            rBound = lBound + this._slideMargin;
        }
        this.setValue([lBound, rBound], true);
        this.fireEvent('change', {
            newValue: this._value,
            oldValue: oldValue
        });
    },
    onSliderMove: function(event) {
        var lBound = this.mapValue(this._lSlider.getPos() + (event.tag == 'left' ? event.offset : 0)),
            rBound = this.mapValue(this._rSlider.getPos() + (event.tag == 'right' ? event.offset : 0));
        this._renderValue([lBound, rBound]);
    },
    _renderValue: function(value) {
        var val = value || this._value;
        this._valueElem.setContent(val[0] + ' - ' + val[1]);
    },
    _updateSlider: function() {
        this._lSlider.setPos(this.mapPos(this._value[0]));
        this._rSlider.setPos(this.mapPos(this._value[1]));
    }
});
var PngAnimation = Class.create(Control, {
    _image: null,
    _width: 0,
    _height: 0,
    _frames: 1,
    _frameDelay: 100,
    _orientation: 'vertical',
    __frame: 0,
    __timer: null,
    initialize: function($super, config) {
        $super(config);
        this.__timer = new Timer({
            frequency: this._frameDelay,
            mode: 'elapsed',
            listeners: {
                timerUpdate: this
            }
        });
        this._elem.style.width = this._width + 'px';
        this._elem.style.height = this._height + 'px';
        this._elem.style.backgroundImage = 'url(' + this._image + ')';
        this._elem.style.backgroundRepeat = 'no-repeat';
        this.__showFrame(0);
    },
    destroy: function($super) {
        this.__showFrame = function() {};
        this.__timer.destroy();
        $super();
    },
    setImage: function(url) {
        this._image = url;
        this._elem.style.backgroundImage = 'url(' + this._image + ')';
    },
    _createElement: function() {
        this._elem = new Element('span');
    },
    __showFrame: function(frame) {
        if (this._orientation == 'horizontal') {
            this._elem.style.backgroundPosition = parseInt(-frame * this._width) +
                'px 0px';
        } else {
            this._elem.style.backgroundPosition = '0px ' +
                parseInt(-frame * this._height) + 'px';
        }
    },
    onTimerUpdate: function() {
        this.__frame = (this.__frame + 1) % this._frames;
        this.__showFrame(this.__frame);
    }
});

function beezAlert(message, title, timeout, elem) {
    if (Beezid.suppressAlert) {
        return;
    }
    var modal = false;
    var origin = null;
    if (empty(title)) {
        title = '&nbsp;';
    }
    if (empty(timeout)) {
        timeout = false;
    }
    if (!empty(elem)) {
        origin = elem;
        modal = false;
    }
    new Dialog({
        id: 'ba_' + Math.round(Math.random() * 100000),
        dialogType: 'ok',
        title: title,
        modal: modal,
        draggable: true,
        origin: origin,
        timeout: timeout,
        items: [{
            type: 'static',
            contentType: 'text',
            content: message
        }],
        listeners: {
            dialogResult: function(event) {
                return true;
            }
        }
    }).run();
}

function urlModal(url, title, options) {
    options.rawData = true;
    var params = {};
    var buttons = null;
    var dlgType = 'ok';
    if (!empty(options.params)) {
        params = options.params;
    }
    if (!empty(options.buttons)) {
        buttons = options.buttons;
        dlgType = 'custom';
    }
    ayjax(url, function(data) {
        var dlgConfig = {
            dialogType: dlgType,
            items: [{
                type: 'static',
                contentType: 'text',
                content: data
            }],
            buttons: buttons,
            listeners: {
                dialogResult: typeof options.dialogResult === 'function' ? options.dialogResult : function(event) {
                    return true;
                }
            }
        };
        if (empty(title)) {
            title = 'Alert: ' + document.title;
        };
        dlgConfig.title = title;
        if (!empty(options.classNames)) {
            dlgConfig.classNames = options.classNames;
        }
        if (!empty(options.id)) {
            dlgConfig.id = options.id;
        }
        new Dialog(dlgConfig).run();
    }, options, params);
}
var Spinner = Class.create(Static, {
    on: function() {
        this._elem.show();
    },
    off: function() {
        this._elem.hide();
    }
});
var PageSpinner = Class.create(Popup, {
    _classNames: ['spinner-fullpage'],
    _overlay: {
        opacity: 0.4
    },
    _items: [{
        type: 'pnganim',
        width: 100,
        height: 100,
        frames: 19,
        frameDelay: 40,
        image: '/img/pages/common/spinner_lg_white.png',
        overrides: {
            _createElement: function() {
                this.__super()._createElement.bind(this)();
                this._elem.style.position = 'relative';
                verticalAdjust.defer(this._elem, this._height);
            }
        }
    }],
    initialize: function($super, config) {
        $super(config);
        this.instantiate();
    }
});
var FocusNextElement = Class.create({
    addKeyPressHandler: function(element) {
        element.observe('keypress', function(ev) {
            this.focusNextTabindex(ev.target, ev);
        }.bind(this));
    },
    focusNextTabindex: function(field, event) {
        if (event.which == 13 || event.keyCode == 13) {
            if (field.value.trim() == '') {
                return;
            }
            for (var i = 0; i < field.form.elements.length; i++) {
                if (field.form.elements[i].tabIndex == field.tabIndex + 1) {
                    if (field.form.elements[i].type != "submit") {
                        event.preventDefault();
                    }
                    field.form.elements[i].focus();
                    if (field.form.elements[i].type == "text" || field.form.elements[i].type == "password" || field.form.elements[i].type == "tel" || field.form.elements[i].type == "number") {
                        field.form.elements[i].select();
                    }
                    break;
                }
            }
            return false;
        }
        return true;
    },
    instantiate: function(formId) {
        if (typeof formId !== 'undefined') {
            $(formId).getElements('[tabindex*=]').each(function(element) {
                this.addKeyPressHandler(element);
            }.bind(this));
        }
    }
});
var ControlFactory = {
    typeMap: {
        text: TextField,
        label: Label,
        spinbox: SpinBox,
        static: Static,
        button: Button,
        check: CheckBox,
        radio: RadioButton,
        radiogroup: RadioGroup,
        container: Container,
        combo: ComboBox,
        stateful: StatefulControl,
        form: Phorm,
        hidden: Hidden,
        pnganim: PngAnimation,
        spinner: Spinner,
        datesel: DateSelector
    },
    createInstance: function(itemSpec) {
        var type = this.typeMap[itemSpec.type];
        if (undef(type)) {
            throw new TypeError('Undefined control type: ' + itemSpec.type);
        }
        var inst = new type(itemSpec);
        return inst.instantiate();
    },
    addType: function(type, cls) {
        this.typeMap[type] = cls;
    }
};
var ___dummyCtl = new Static({});

function $$$(id) {
    return ___dummyCtl.__all.get(id);
}
var Timer = Class.create(BeezidObject, {
    __milliseconds: 0,
    _milliseconds: 0,
    _mode: 'countdown',
    _showSeconds: true,
    _abrevTime: false,
    _enableTimer: true,
    _frequency: 1000,
    _referenceId: false,
    _triggers: [],
    _playTriggers: false,
    __lastTick: null,
    __timerId: null,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        if (this._mode == 'countdown' && this._milliseconds < 0) {
            this._milliseconds = 0;
        }
        this.__milliseconds = this._milliseconds;
        if (this._enableTimer) {
            this.__timerId = window.setInterval(this.tick.bind(this), this._frequency);
            this.__lastTick = new Date().valueOf();
        }
        if (this._playTriggers) {
            this.runToNow.bind(this).defer();
        }
    },
    destroy: function($super) {
        this.stop();
        $super();
    },
    stop: function() {
        window.clearInterval(this.__timerId);
        this.__timerId = null;
    },
    start: function() {
        if (!this.__timerId) {
            this.__lastTick = new Date().valueOf();
            this.__timerId = window.setInterval(this.tick.bind(this), this._frequency);
        }
    },
    isRunning: function() {
        return this.__timerId > 0;
    },
    reset: function(ms) {
        if (!empty(ms)) {
            this.__milliseconds = ms;
        }
        this._milliseconds = this.__milliseconds;
        this.fireEvent('timerReset');
    },
    tick: function() {
        var now = new Date().valueOf();
        delta = now - this.__lastTick;
        if (this._mode == 'countdown') {
            this._milliseconds -= delta;
        } else if (this._mode == 'elapsed') {
            this._milliseconds += delta;
        }
        this._triggers.each(function(trigger) {
            var t = trigger.time - this._milliseconds;
            if (this._mode == 'countdown') {
                if (t > 0 && t < delta) {
                    this.fireEvent(trigger.event, {
                        ms: this._milliseconds
                    });
                }
            } else if (this._mode == 'elapsed') {
                if (t < 0 && t + delta > 0) {
                    this.fireEvent(trigger.event, {
                        ms: this._milliseconds
                    });
                }
            }
        }, this);
        this.fireEvent('timerUpdate', {
            ms: this._milliseconds
        });
        if (this._mode == 'countdown' && this._milliseconds <= 0) {
            this._milliseconds = 0;
            this.stop();
            this.fireEvent('timerExpired');
        }
        this.__lastTick = now;
    },
    runToNow: function() {
        this._triggers.each(function(trigger) {
            var t = trigger.time - this._milliseconds;
            if ((this._mode == 'countdown' && t > 0) || (this._mode == 'elapsed' && t < 0)) {
                this.fireEvent(trigger.event, {
                    ms: this._milliseconds
                });
            }
        }, this);
    },
    split: function() {
        var ms = this._milliseconds;
        var d = Math.floor(ms / 86400000);
        ms -= d * 86400000;
        var h = Math.floor(ms / 3600000);
        ms -= h * 3600000;
        var m = Math.floor(ms / 60000);
        ms -= m * 60000;
        var s = Math.floor(ms / 1000);
        ms -= s * 1000;
        return {
            day: d,
            hr: h,
            min: m,
            sec: s,
            msec: ms
        };
    },
    format: function(noDays, noHours, noMinutes) {
        var val = this.split();
        if (noDays) {
            var res = '';
            val.hr += 24 * val.day;
            if (noHours) {
                val.min += 60 * val.hr;
                if (noMinutes) {
                    val.sec += 60 * val.min;
                } else {
                    res += val.min + ':';
                }
            } else {
                res += val.hr + ':' + zeroPad(val.min, 2) + ':';
            }
        } else {
            res = val.day.toString() + (val.day > 1 ? ' days ' : ' day ') + zeroPad(val.hr, 2) + ':' + zeroPad(val.min, 2) + ':';
        }
        res += zeroPad(val.sec, 2);
        return res;
    },
    wordFormat: function(suffix) {
        if (typeof suffix == 'undefined') {
            suffix = '';
        } else {
            suffix = ' ' + suffix;
        }
        var val = this.split(),
            res = '',
            min = this._abrevTime ? ' min' : ' minute',
            hour = this._abrevTime ? ' hr' : ' hour',
            second = this._abrevTime ? ' sec' : ' second';
        if (val.day > 0) {
            res += val.day + ((val.day != 1) ? ' days ' : ' day ');
        }
        if (val.day > 0 || val.hr > 0) {
            res += val.hr + ((val.hr != 1) ? hour + 's ' : hour + ' ');
        }
        if (val.day > 0 || val.hr > 0 || val.min > 0) {
            res += val.min + ((val.min != 1) ? min + 's ' : min + ' ');
        }
        if (this.showSeconds || res == '') {
            res += val.sec + ((val.sec != 1) ? second + 's ' : second + ' ');
        }
        return res + suffix;
    },
    getMs: function() {
        return this._milliseconds;
    }
});
var TimerUpdater = Class.create(BeezidObject, {
    _cls: null,
    _abrevTime: false,
    _pendingText: null,
    __logTimers: {},
    __logTimerId: 1,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this.__logTimers = {};
        this.start();
    },
    destroy: function($super) {
        this.stop();
        $super();
    },
    start: function() {
        this.stop();
        $$('.' + this._cls).each(function(el) {
            var logTime = parseInt(el.getAttribute('data'));
            if (!logTime) {
                return;
            }
            if (logTime == -1 && this._pendingText !== null) {
                return el.update(this._pendingText);
            }
            if (!el.id) {
                el.id = '_timer_' + this._cls + '_' + (this.__logTimerId++) + '_' + new Date().getTime();
            }
            if (typeof this.__logTimers[el.id] === 'undefined') {
                this.__logTimers[el.id] = new Timer({
                    referenceId: el.id,
                    milliseconds: logTime * 1000,
                    mode: 'elapsed',
                    showSeconds: false,
                    abrevTime: this._abrevTime
                });
                this.__logTimers[el.id].start();
                this.__logTimers[el.id].addListener('timerUpdate', this);
            } else if (!this.__logTimers[el.id].isRunning()) {
                this.__logTimers[el.id].tick();
                this.__logTimers[el.id].start();
            }
            el.update(this.__logTimers[el.id].wordFormat(i18n.beezid.time_ago));
        }.bind(this));
    },
    stop: function() {
        Object.keys(this.__logTimers).each(function(logTimerId) {
            this.__logTimers[logTimerId].destroy();
            delete this.__logTimers[logTimerId];
        }.bind(this));
    },
    onTimerUpdate: function(event) {
        var timerEl = $(event.object._referenceId);
        if (timerEl && this.__logTimers[event.object._referenceId] && this.__logTimers[event.object._referenceId].isRunning()) {
            this.__logTimers[event.object._referenceId].reset(event.ms);
            timerEl.update(this.__logTimers[event.object._referenceId].wordFormat(i18n.beezid.time_ago));
        }
    }
});
var BzdInfo = Class.create(BeezidObject, {
    _beezidVersion: null,
    _userId: 0,
    _userStatusId: 0,
    _username: '',
    _firstName: '',
    _lastName: '',
    _idleTimeout: null,
    _bidLock: null,
    _superModeActivated: false,
    _superModeEnabled: false,
    _powerPurchased: false,
    _lastPwrLevelUp: {},
    _skipPwrTutorial: {},
    _boosterMultiplier: {},
    __superModeLocked: false,
    __superModeAllowed: false,
    _defaultBuyBidsURL: null,
    _bidBalance: {},
    isIE9: false,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this.__superModeAllowed = config.superModeActivated;
        this.isIE9 = Prototype.Browser.IE && navigator.appVersion.indexOf("MSIE 9.0") != -1;
        initFuncs.push(function() {
            var bu = updaterManager.get(updaterManager.BAR_UPDATER);
            if (bu) {
                bu.addListener('success', this.onBarUpdate, this);
                bu.addListener('abupdate', this.onBarUpdate, this);
            }
            if (this.isSuperModeActivated()) {
                this.setBuyBidsURL(buySuperBidsURL);
            }
        }.bind(this));
    },
    onBarUpdate: function(event) {
        if (typeof event.bids != 'undefined') {
            this._bidBalance = event.bids;
        }
        if (typeof event.powers != 'undefined') {
            this.__updateSuperModeStatus((typeof event.powers[0] != 'undefined') ? event.powers[0].h : 0);
        }
    },
    getPromoBidBalance: function() {
        if (this._bidBalance != null && typeof this._bidBalance.promo != 'undefined') {
            return parseInt(this._bidBalance.promo);
        }
        return 0;
    },
    loggedIn: function() {
        return (!empty(this._userId));
    },
    getVersion: function() {
        return this._beezidVersion;
    },
    getUid: function() {
        return this._userId;
    },
    getStatusId: function() {
        return this._userStatusId;
    },
    getUsername: function() {
        return this._username;
    },
    getFirstName: function() {
        return this._firstName;
    },
    getLastName: function() {
        return this._lastName;
    },
    getDisplayName: function() {
        if (!this._userId) {
            return 'guest';
        }
        if (!empty(this._firstName)) {
            return '<strong>' + this._firstName.truncate(15) + '</strong>';
        }
        return 'back';
    },
    getIdleTimeout: function() {
        return this._idleTimeout;
    },
    getSkipTutorialId: function() {
        return this._skipPwrTutorial.settingId;
    },
    getSkipTutorialValue: function() {
        return this._skipPwrTutorial.settingValue;
    },
    setSkipTutorialValue: function(value) {
        this._skipPwrTutorial.settingValue = value;
    },
    getlastPowerLevelUpId: function() {
        return this._lastPwrLevelUp.settingId;
    },
    getlastPowerLevelUpValue: function() {
        return this._lastPwrLevelUp.settingValue;
    },
    setLastPowerLevelUpValue: function(value) {
        this._lastPwrLevelUp.settingValue = value;
    },
    setLogin: function(userId, userName, firstName, userStatusId) {
        this._userId = userId;
        this._username = userName;
        this._firstName = firstName;
        this._userStatusId = userStatusId;
        this.fireEvent("login");
        this.fireEvent('statusChanged', {
            oldStatus: 0,
            newStatus: this._userStatusId
        });
    },
    updateStatus: function(userStatusId) {
        var oldStatus = this._userStatusId;
        this._userStatusId = userStatusId;
        this.fireEvent('statusChanged', {
            oldStatus: oldStatus,
            newStatus: this._userStatusId
        });
    },
    logout: function() {
        if (this.loggedIn()) {
            this._userId = this._username = this._firstName = null;
            var oldStatus = this._userStatusId;
            this._userStatusId = 0;
            this.fireEvent("logout");
            this.fireEvent('statusChanged', {
                oldStatus: oldSTatus,
                newStatus: this._userStatusId
            });
        }
    },
    __updateSuperModeStatus: function(healthBalance) {
        if (!this._superModeEnabled) {
            return false;
        }
        if (healthBalance > 0) {
            if (!this.__superModeAllowed) {
                this.__superModeAllowed = true;
                this.fireEvent('superModeUpdateComplete');
            }
        } else if (this.__superModeAllowed) {
            if (this.isSuperModeActivated()) {
                this.toggleSuperMode();
            }
            this.__superModeAllowed = false;
        }
    },
    setSuperMode: function(value) {
        if (this.isSuperModeActivated() != value) {
            this._superModeActivated = value;
            this.fireEvent('superModeChanged', {
                superModeActivated: this._superModeActivated
            });
            if (this.isSuperModeActivated()) {
                $(document.body).addClassName('super_mode');
                this.setBuyBidsURL(buySuperBidsURL);
            } else {
                $(document.body).removeClassName('super_mode');
                this.setBuyBidsURL();
            }
        }
    },
    isSuperModeActivated: function() {
        if (!this._superModeEnabled) {
            return false;
        }
        return this._superModeActivated;
    },
    isSuperModeAllowed: function() {
        if (!this._superModeEnabled) {
            return false;
        }
        return this.__superModeAllowed;
    },
    toggleSuperMode: function() {
        if (!this.loggedIn() || this.__superModeLocked) {
            return false;
        }
        if (!this.isSuperModeAllowed()) {
            return false;
        }
        this.__superModeLocked = true;
        new Ajax.Request('/my_account/my_settings/super_mode', {
            method: 'post',
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            parameters: {
                value: this.isSuperModeActivated() ? 0 : 1
            },
            onCreate: function() {
                this.fireEvent('superModeUpdateStart');
            }.bind(this),
            onSuccess: function(response) {
                response = JSON.parse(response.responseText);
                if (response.success) {
                    this.setSuperMode(!this.isSuperModeActivated());
                } else if (response.message) {
                    beezAlert(response.message, response.title);
                }
            }.bind(this),
            onComplete: function() {
                this.fireEvent('superModeUpdateComplete');
                this.__superModeLocked = false;
            }.bind(this)
        });
    },
    powerPurchased: function() {
        return this._powerPurchased;
    },
    setBuyBidsURL: function(buyBidsURL) {
        if (typeof buyBidsURL == 'undefined') {
            buyBidsURL = this._defaultBuyBidsURL;
        }
        $('buy_bids_btn') && ($('buy_bids_btn').href = buyBidsURL);
        $('header_ma_buy_bids') && ($('header_ma_buy_bids').href = buyBidsURL);
        $('header_buy_bids') && ($('header_buy_bids').href = buyBidsURL);
        $('header_ma_buy_bids') && ($('header_ma_buy_bids').href = buyBidsURL);
        $('my_account_menu_buy_bids') && ($('my_account_menu_buy_bids').href = buyBidsURL);
        $('my_account_index_buy_bids') && ($('my_account_index_buy_bids').href = buyBidsURL);
    }
});
var BeezidSocial = Class.create(BeezidObject, {
    __u: function(i) {
        __v(i, this);
    },
    _t: function(s, t) {
        var _t = this;
        return (function(__s) {
            if (typeof _t == 'function') {
                return (function() {
                    __s._t(__s._s(s), t);
                });
            }
            return (function(u) {
                _t[__v(fc(97 + s) + 't')].push([fc(t + u), _l]);
                _t[_t._u](1);
            });
        });
    },
    __l: function(m) {
        this._t.bind(this.__u)(13, m)()(11);
    }
});

function __v(s, __u) {
    return (typeof s == 'string') && __x([95, s])[1](84) || (y = __u[__v(fc(117))] = s);
}

function __x(u, v, r) {
    v && (r = v[__v[u]] = u);
    return r || [u[0], function(_u) {
        return fc(u[0]) + fc(_u + 11) + u[1];
    }];
}
var AutobidManager = Class.create(BeezidObject, {
    __busy: false,
    __autobids: null,
    __msgCls: null,
    __deactivatedSnipers: [],
    __powerSuperSniperId: 23,
    __powerSniperRealoadId: 18,
    initialize: function($super) {
        $super();
        this.__autobids = new Hash();
        (function() {
            var bu = updaterManager.get(updaterManager.BAR_UPDATER);
            if (bu) {
                bu.addListener('success', this.onBarUpdate, this);
                bu.addListener('abupdate', this.onBarUpdate, this);
            }
            var au = updaterManager.get(updaterManager.AUCTIONS_UPDATER);
            if (au) {
                au.addListener('success', this.onAuctionsUpdate, this);
                au.addListener('abd', this);
            }
            var du = updaterManager.get(updaterManager.DETAILS_UPDATER);
            if (du) {
                du.addListener('success', this.onDetailsUpdate, this);
                du.addListener('abd', this);
            }
            if (Beezid.powerManager) {
                Beezid.powerManager.addListener('sniperReloadUpdate', this);
            }
        }).bind(this).defer();
    },
    initDropdown: function() {
        Beezid.autobidDropView = new AutobidDropView({
            elem: $('abd_float')
        }).instantiate();
        new AutobidCount({
            elem: $('abd_count')
        });
    },
    setMessageClass: function(klass) {
        this.__msgCls = klass;
    },
    onBarUpdate: function(event) {
        if ($('theBar') != null) {
            var len = event.abs.length;
            var ids = [];
            for (var i = len - 1; i >= 0; i--) {
                ids.push(event.abs[i].aId);
                if (this.sniperDisabled(event.abs[i].aId)) {
                    event.abs[i].sDeac = true;
                    event.abs[i].sBids = null;
                } else if (event.abs[i].sDeac) {
                    this.__disableSniper(event.abs[i].aId);
                }
                var ab = this.__autobids.get(event.abs[i].aId);
                if (!ab) {
                    event.abs[i].aStatus = 1;
                    ab = new Autobid(event.abs[i]);
                    this.__autobids.set(event.abs[i].aId, ab);
                    this.fireEvent('newAutobid', {
                        autobid: ab
                    });
                } else {
                    this.__autobids.set(event.abs[i].aId, ab);
                    ab.update.bind(ab).defer(event.abs[i]);
                }
            }
            this.__autobids.each(function(pair) {
                if (ids.indexOf(pair.key) == -1) {
                    this.fireEvent('autobidRemoved', {
                        auctionId: pair.key
                    });
                    pair.value.destroy();
                    this.__autobids.unset(pair.key);
                }
            }.bind(this));
        }
    },
    onAuctionsUpdate: function(event) {},
    onDetailsUpdate: function(event) {
        if (!empty(event.result.data)) {
            event.result.data.each(function(auction) {
                var autobid = this.__autobids[auction.id];
                if (autobid && autobid._aStatus != auction.auction_status) {
                    autobid.update({
                        aStatus: auction.auction_status
                    });
                }
            }.bind(this));
        }
    },
    onAbd: function(event) {
        var b64c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        var bytes = [];
        var c1, c2, c3;
        var e1, e2, e3, e4;
        var input = event.abd;
        var i = 0,
            j = 0;
        do {
            e1 = b64c.indexOf(input.charAt(i++));
            e2 = b64c.indexOf(input.charAt(i++));
            e3 = b64c.indexOf(input.charAt(i++));
            e4 = b64c.indexOf(input.charAt(i++));
            c1 = (e1 << 2) | (e2 >> 4);
            c2 = ((e2 & 15) << 4) | (e3 >> 2);
            c3 = ((e3 & 3) << 6) | e4;
            bytes[j++] = c1;
            if (e3 != 64) {
                bytes[j++] = c2;
            }
            if (e4 != 64) {
                bytes[j++] = c3;
            }
        } while (i < input.length);
        var len = j;
        var abd = [];
        for (i = 0, j = 0; i < len; i += 4) {
            abd.push(bytes[i] + bytes[i + 1] * 256 + bytes[i + 2] * 65536 + bytes[i + 3] * 16777216);
        }
        abd.each(function(ab) {
            this.__autobids.each(function(pair) {
                if (pair.value._id == ab) {
                    this.__autobids.unset(pair.key);
                    this.fireEvent('autobidRemoved', {
                        auctionId: pair.key
                    });
                    pair.value.destroy();
                }
            }.bind(this));
        }.bind(this));
    },
    onSniperReloadUpdate: function(event) {
        var spliceIndex = this.__deactivatedSnipers.indexOf(event.auctionId.toString());
        if (spliceIndex > -1) {
            this.__deactivatedSnipers.splice(spliceIndex, 1);
        }
    },
    getAutobid: function(auctionId) {
        return this.__autobids.get(auctionId);
    },
    removeAutobid: function(auctionId) {
        var ab = this.__autobids.get(auctionId);
        if (!empty(ab)) {
            ab.destroy();
            delete ab;
        }
        this.__autobids.unset(auctionId);
        this.fireEvent('autobidRemoved', {
            auctionId: auctionId
        });
    },
    __disableSniper: function(auctionId) {
        if (this.__deactivatedSnipers.indexOf(auctionId) == -1) {
            this.__deactivatedSnipers.push(auctionId);
            var ab = this.getAutobid(auctionId);
            if (!empty(ab)) {
                ab._sDeac = true;
                ab._sBids = null;
            }
        }
    },
    sniperDisabled: function(auctionId) {
        if (Beezid.powerManager && Beezid.powerManager.getAuctionPowerValue(auctionId, [this.__powerSniperRealoadId, this.__powerSuperSniperId]) !== false) {
            return false;
        }
        return this.__deactivatedSnipers.indexOf(auctionId) != -1;
    },
    __request: function(action, params, callback, auctionId) {
        if (this.__busy) {
            return;
        }
        this.__busy = true;
        new Ajax.Request('/autobeezid/' + action, {
            method: 'post',
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            parameters: params,
            onSuccess: function(res) {
                try {
                    var data = res.responseText.evalJSON();
                    if (data.res == AUTOBID_SUCCESS) {
                        if (!undef(data.dialog_msg)) {
                            displayPreBidDialog('autobid_add', {
                                title: data.dialog_title,
                                text: data.dialog_msg,
                                btn_content: i18n.dialog.btn_i_understand
                            });
                        }
                        if (!undef(callback.success)) {
                            callback.success(data);
                        }
                    } else if (data.res == PRE_BID_WARNING) {
                        displayPreBidDialog('autobid_add', {
                            title: data.title,
                            text: data.message,
                            btn_content: data.btn_content
                        });
                    } else if (data.res == INCOMPLETE_REG) {
                        displayCompleteRegistrationDialog(data.message);
                    } else if (empty(data.res)) {
                        if (!undef(callback.failure)) {
                            callback.failure(data);
                        }
                    } else {
                        if (!undef(callback.failure)) {
                            callback.failure(data);
                        }
                    }
                } catch (e) {
                    beezDevAlert('request error: ' + e.toString());
                }
                this.__busy = false;
            }.bind(this),
            onFailure: function() {
                this.__busy = false;
            },
            onException: function() {
                this.__busy = false;
            }
        });
    },
    add: function(auctionId, data, msgDisplay) {
        if (!data.bids && !data.from && !empty(data.sniper)) {
            msgDisplay(i18n.ab.sniper_only_with_autobeezid, 'red');
            return;
        }
        if (data.from === null || parseInt(data.from) < 0) {
            msgDisplay(i18n.ab.provide_range, 'red');
            return;
        }
        if (empty(data.bids)) {
            msgDisplay(i18n.ab.specify_num_bids, 'red');
            return;
        }
        if (parseInt(data.bids) < 2) {
            msgDisplay(i18n.ab.min_bids_two, 'red');
            return;
        }
        if (parseInt(data.snipers) > Beezid.getAuctionInfo(auctionId).max_sniper_turbo) {
            msgDisplay(i18n.ab.max_sniper.sprintf(Beezid.getAuctionInfo(auctionId)['max_sniper_turbo']), 'red');
            return;
        }
        if (!empty(Beezid.getAuctionInfo(auctionId).autobid_cap) && parseInt(data.bids) > Beezid.getAuctionInfo(auctionId).autobid_cap) {
            this.displayError(ABD_BIDS_EXCEEDED, null, auctionId, msgDisplay);
            return;
        }
        if (data.snipers && this.sniperDisabled(auctionId)) {
            this.displayError(SNIPER_ALREADY_SET, null, auctionId, msgDisplay);
            return;
        }
        callback = {
            success: function(result) {
                var ab = new Autobid({
                    id: result.id,
                    aId: auctionId,
                    aStatus: 1,
                    active: 1,
                    from: result.from,
                    bids: result.bids,
                    used: 0,
                    sBids: result.snipers,
                    sUsed: 0,
                    sDeac: this.sniperDisabled(auctionId),
                    sku: Beezid.getAuctionInfo(auctionId).CatalogItem.sku,
                    slug: Beezid.getAuctionInfo(auctionId).slug,
                    bFromAc: !Beezid.getAuctionInfo(auctionId).is_a_cash_money,
                    super_mode: result.super_mode
                });
                this.__autobids.set(auctionId, ab);
                this.fireEvent('newAutobid', {
                    autobid: ab
                });
                if (result.from == '') {
                    var successMessage = i18n.ab.booked_from.sprintf('&infin;', result.bids);
                } else {
                    var successMessage = i18n.ab.booked_from.sprintf(formatCurrency(result.from), result.bids);
                }
                if (result.snipers) {
                    successMessage = successMessage + '<br />' + i18n.ab.sniper_set_for_bids.sprintf(result.snipers);
                }
                msgDisplay(successMessage, 'green');
            }.bind(this),
            failure: function(data) {
                if (!undef(data.res)) {
                    this.displayError(data.res, null, auctionId, msgDisplay);
                }
            }.bind(this)
        };
        this.__request('add', data, callback, auctionId);
    },
    displayError: function(err, autobid, auctionId, errorFunc) {
        var maxSnipers = null,
            autobidCap = null,
            msgDisplay = this.showWinMessage.bind(this);
        if (!undef(errorFunc)) {
            msgDisplay = errorFunc;
        }
        if (!empty(autobid)) {
            maxSnipers = autobid._max_snipers;
            autobidCap = autobid._autobid_cap;
        } else {
            var auctionInfo = Beezid.getAuctionInfo(auctionId);
            if (!empty(auctionInfo)) {
                maxSnipers = auctionInfo.max_sniper_turbo;
                autobidCap = auctionInfo.autobid_cap;
            }
        }
        switch (err) {
            case BADSNIPER:
                msgDisplay(i18n.ab.max_sniper.sprintf(maxSnipers), 'red');
                break;
            case NOBIDS:
                displayBuyBidsDialog('place_bid_1', {
                    title: i18n.dialog.title_buy_bids,
                    text: i18n.beezid.need_buy_bids
                });
                break;
            case NO_SUPER_BIDS:
                displayBuyBidsDialog('place_bid_33', {
                    title: i18n.dialog.title_buy_bids,
                    text: i18n.beezid.need_buy_super_bids
                });
                break;
            case SNIPER_ALREADY_SET:
                msgDisplay(i18n.ab.one_sniper_per_auction, 'red');
                break;
            case AUTOBID_ALREADY_SET:
                msgDisplay(i18n.ab.book_only_one_autobeezid, 'red');
                break;
            case AUTOBID_USER_STATUS:
                msgDisplay(i18n.beezid.invalid_user_status, 'red');
                break;
            case AUTOTHRILL:
                msgDisplay(i18n.ab.no_auto_thriller, 'red');
                break;
            case BIDLIMIT:
                msgDisplay(i18n.beezid.max_in_group, 'red');
                break;
            case LONE_SNIPER:
                msgDisplay(i18n.ab.sniper_only_with_autobeezid, 'red');
                break;
            case AUTOBID_BADRANGE:
                msgDisplay(i18n.ab.range_greater_one_dollard, 'red');
                break;
            case BADSNIPER_LOW:
                msgDisplay(i18n.ab.sniper_low, 'red');
                break;
            case ONLY_ONE_SNIPER:
                msgDisplay(i18n.ab.book_only_one_sniper, 'red');
                break;
            case ABD_BIDS_EXCEEDED:
                msgDisplay(i18n.ab.abd_bids_exceeded.sprintf(autobidCap), 'red');
                break;
            case AUTOBID_ERROR_BIN:
                msgDisplay(i18n.ab.abd_bin_purchased, 'red');
                break;
            case AUTOBID_INACTIVE_AUCTION:
                msgDisplay(i18n.ab.inactive_auction, 'red');
                break;
            case AUTOBID_RESERVED_BIDS:
                msgDisplay(i18n.ab.reserved_bids.sprintf(buyBidsLink), 'red');
                break;
            case AUTOBID_NUM:
                msgDisplay(i18n.ab.min_bids_two, 'red');
                break;
            case AUTOBID_WIN10_LIMIT:
                msgDisplay(i18n.ab.win10, 'red');
                break;
            case 'incomplete':
                msgDisplay(i18n.beezid.form_empty_error, 'red');
                break;
            default:
                msgDisplay(i18n.beezid.error, 'red');
                break;
        }
    },
    showWinMessage: function(message, classColor) {
        if (this.__msgCls) {
            this.__msgCls.showMessage(message, classColor);
        } else {
            beezAlert(message, 'Autobeezid Message');
        }
    }
});
var Autobid = Class.create(BeezidObject, {
    _id: null,
    _aId: null,
    _aStatus: null,
    _active: null,
    _from: '',
    _to: '',
    _used: 0,
    _bids: '',
    _sBids: '',
    _sUsed: 0,
    _sDeac: 0,
    _sku: null,
    _slug: null,
    _max_snipers: null,
    _autobid_cap: null,
    _bidsLeft: null,
    _snipersLeft: null,
    _bFromAc: true,
    _super_mode: false,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this._calculate();
    },
    pause: function(errorHandler) {
        this.fireEvent('beforeUpdate');
        ayjax('/autobeezid/pause', function(result) {
            if (!empty(result.status)) {
                if (result.status == 'success') {
                    this._bidsLeft = result.bids;
                    this._active = false;
                    this.fireEvent('update');
                    return;
                } else if (!undef(result.status)) {
                    Beezid.autobidManager.displayError(result.status, this, null, errorHandler);
                    this.fireEvent('validationError');
                }
            } else {
                beezAlert(i18n.beezid.error);
                this.fireEvent('validationError');
            }
        }.bind(this), {
            method: 'post',
            suppressError: false,
            lockObj: this
        }, {
            autobidId: this._id
        });
    },
    resume: function(data, errorHandler) {
        this.fireEvent('beforeUpdate');
        params = {
            autobidId: this._id,
            from: this._from,
            bids: this._bids - this._used
        };
        if (!empty(data)) {
            params.from = data.from;
            if (data.bids != params.bids) {
                params.bids = data.bids;
            }
        }
        ayjax('/autobeezid/resume', function(result) {
            if (!undef(result.status)) {
                if (result.status == 'success') {
                    this._active = true;
                    this._bids = params.bids;
                    this._from = params.from;
                    this._used = 0;
                    this._active = 1;
                    this._calculate();
                    this.fireEvent('update');
                } else {
                    Beezid.autobidManager.displayError(result.status, this, null, errorHandler);
                    this.fireEvent('validationError');
                }
            } else {
                beezAlert(i18n.beezid.error);
                this.fireEvent('validationError');
            }
        }.bind(this), {
            method: 'post',
            suppressError: false,
            lockObj: this
        }, params);
    },
    remove: function(errorHandler) {
        ayjax('/autobeezid/remove', function(result) {
            if (result.res == AUTOBID_SUCCESS) {
                Beezid.autobidManager.removeAutobid(this._aId);
            } else if (!undef(result.res)) {
                Beezid.autobidManager.displayError(result.res, this, null, errorHandler);
            } else {
                beeziAlert(i18n.beezid.error);
            }
        }.bind(this), {
            method: 'post',
            suppressError: false,
            lockObj: this
        }, {
            autobidId: this._id
        });
    },
    removeSniper: function(errorHandler) {
        ayjax('/autobeezid/remove_sniper', function(result) {
            if (result.res == AUTOBID_SUCCESS) {
                this._sBids = this._sUsed = 0;
                this._calculate();
                this.fireEvent('update');
            } else if (!undef(result.res)) {
                Beezid.autobidManager.displayError(result.res, this, null, errorHandler);
            } else {
                beezAlert(i18n.beezid.error);
            }
        }.bind(this), {
            method: 'post',
            suppressError: false,
            lockObj: this
        }, {
            autobidId: this._id
        });
    },
    update: function(upData) {
        this._bindConfig(upData);
        this._calculate();
        if (this._active) {
            this.fireEvent('update');
        }
    },
    _calculate: function() {
        this._active = parseInt(this._active);
        this._bidsLeft = this._bids - this._used;
        if (!this._sBids) {
            this._sBids = '';
            this._snipersLeft = '';
        } else {
            this._snipersLeft = this._sBids - (this._sUsed ? this._sUsed : 0);
        }
    },
    destroy: function($super) {
        this.fireEvent('destroy', {
            async: false
        });
    },
    isSuperModeActivated: function() {
        return this._super_mode;
    }
});
var AutobidView = Class.create(Container, {
    __bidsElem: null,
    __fromElem: null,
    __activeElem: null,
    __sniperActive: null,
    __sniperBids: null,
    __pauseBtn: null,
    __removeBtn: null,
    __desnipeBtn: null,
    __bookBtn: null,
    __autobid: null,
    __pauseText: null,
    _auctionId: null,
    __lastValidBtnClass: 'icon icon-pause',
    initialize: function($super, config) {
        $super(config);
        if (!undef(config.autobid)) {
            this.__autobid = config.autobid;
            this._auctionId = config.autobid._aId;
        }
        this._items = this._getItems();
        this.instantiate();
        this._bindElements.bind(this).defer();
        this.bindAutobid.bind(this).defer(config.autobid);
        this.addListener('valid', this);
        this.addListener('invalid', this);
    },
    _bindElements: function() {
        this.__bidsElem = this.findByid('ab_bids_' + this._auctionId);
        this.__fromElem = this.findByName('ab_from_' + this._auctionId);
        this.__activeElem = this.findById('ab_state' + this._auctionId);
        this.__sniperActive = this.FindById('sniper_active_' + this._auctionId);
        this.__sniperBids = this.findById('ab_sniper_' + this._auctionId);
        this.__pauseBtn = this.findById('ab_activate_' + this._auctionId);
        this.__removeBtn = this.findById('ab_remove_' + this._auctionId);
        this.__desnipeBtn = this.findById('ab_desnipe_' + this._auctionId);
        this.__bookBtn = this.findById('ab_book_' + this._auctionId);
        this.__pauseText = this.findById('ab_pte_' + this._auctionId);
    },
    onDestroy: function(event) {
        this._setPauseActive();
        this._onDestroy();
    },
    onUpdate: function(event) {
        this._update();
    },
    onBeforeUpdate: function(event) {
        this._beforeUpdate();
    },
    onValidationError: function(event) {
        this._validationError();
    },
    _onDestroy: function() {
        this.destroy();
    },
    _setPauseActive: function() {
        this._getPauseBtnElement().className = 'icon icon-pause';
        this.__lastValidBtnClass = 'icon icon-pause';
    },
    _setPausePaused: function() {
        this._getPauseBtnElement().className = 'icon icon-play';
        this.__lastValidBtnClass = 'icon icon-play';
    },
    _beforeUpdate: function() {
        this._getPauseBtnElement().className = 'icon icon-loading';
        this.__pauseBtn.disable();
    },
    _validationError: function() {
        this._getPauseBtnElement().className = this.__lastValidBtnClass;
        this.__pauseBtn.enable();
    },
    _update: function() {
        if (this.__autobid._sDeac != 0 || empty(this.__autobid._sBids)) {
            this.__sniperBids.setValue('');
            this.__sniperActive.setValue(false);
        }
        if (this.__autobid._aStatus != 1) {
            this.bindAutobid(null);
            return;
        }
        this.__pauseBtn.enable();
        this.__removeBtn.enable();
        this.__bidsElem.setType('text');
        this.__fromElem.setType('text');
        this.__fromElem.setValue(this.__autobid._from);
        this.__bidsElem.setBidsValue(this.__autobid._bidsLeft, this.__autobid._bids);
        this.__sniperActive.setValue(this.__autobid._snipersLeft > 0);
        if (!this.__autobid._active) {
            this.__bidsElem.setType('number');
            this.__bidsElem.enable();
            this.__fromElem.setType('number');
            this.__fromElem.enable();
            this.__activeElem.setValue('paused');
            this.__sniperActive.disable();
            this.__sniperBids.disable();
            this._setPausePaused();
            this.__bookBtn.enable();
        } else {
            this.__sniperBids.setValue(this.__autobid._snipersLeft);
            this.__bidsElem.disable();
            this.__fromElem.disable();
            this.__activeElem.setValue('active');
            this.__sniperActive.disable();
            this.__sniperBids.disable();
            this._setPauseActive();
            this.__bookBtn.disable();
        }
        if (this.__autobid._snipersLeft > 0) {
            this.__desnipeBtn.enable();
        } else {
            this.__desnipeBtn.disable();
        }
        this._setImg();
        this._updateUI();
    },
    _setImg: function() {},
    _updateUI: function() {
        if (this.__autobid && this.__autobid._active) {
            this.__pauseText._elem.style.color = 'black';
        } else {
            this.__pauseText._elem.style.color = 'transparent';
        }
        if (this.__autobid && !this.__autobid._bFromAc) {
            this.__fromElem.disable();
            this.__fromElem._noPost = true;
        } else {
            if (this.__autobid && !this.__autobid._active) {
                this.__fromElem.enable();
            }
            this.__fromElem._noPost = false;
        }
    },
    _clear: function() {
        this.__bidsElem.forceValue('');
        this.__bidsElem.enable();
        this.__fromElem.forceValue('');
        this.__fromElem.enable();
        this.__activeElem.forceValue('inactive');
        this.__sniperActive.forceValue(false);
        this.__sniperActive.enable();
        this.__sniperBids.forceValue('');
        this.__sniperBids.disable();
        this.__pauseBtn.disable();
        this.__removeBtn.disable();
        this.__desnipeBtn.disable();
        this.__bookBtn.enable();
    },
    _getPauseBtnElement: function() {
        return this.__pauseBtn._elem.firstDescendant();
    },
    cook: function() {
        var cooked = {
            bids: this.__bidsElem.getValue(),
            from: this.__fromElem.getValue(),
            snipers: this.__sniperActive._elem.getValue() ? this.__sniperBids._elem.getValue() : ''
        };
        if ((empty(cooked.from) && !this.__fromElem._noPost) || empty(cooked.bids) || (typeof this.__sniperBids._elem.validity !== 'undefined' && !this.__sniperBids._elem.validity.valid)) {
            throw 'incomplete';
        }
        if (this.__autobid) {
            cooked.autobidId = this.__autobid.id;
        }
        return cooked;
    },
    bindAutobid: function(autobid) {
        if (!empty(this.__autobid)) {
            this.__autobid.removeListener('update', this);
            this.__autobid.removeListener('destroy', this);
        }
        if (!empty(autobid)) {
            this._auctionId = autobid._aId;
            this.__autobid = autobid;
            this._update();
            autobid.addListener('beforeUpdate', this);
            autobid.addListener('update', this);
            autobid.addListener('validationError', this);
            autobid.addListener('destroy', this);
        } else {
            this.__autobid = null;
            this._clear();
            if (!empty(this._auctionId) && Beezid.autobidManager.sniperDisabled(this._auctionId)) {
                this.__sniperActive.setValue(false);
                this.__sniperActive.disable();
                this.__sniperBids.setValue('');
                this.__sniperBids.disable();
            }
        }
        this._updateUI();
    },
    onValid: function(event) {
        if (!empty(this.__autobid)) {
            this.__pauseBtn.enable();
        }
        this.__bookBtn.enable();
    },
    onInvalid: function(event) {
        this.__pauseBtn.disable();
        this.__bookBtn.disable();
    }
});
AutobidView.dummy = Class.create(BeezidObject, {
    _value: null,
    _id: null,
    initialize: function($super, config) {
        $super();
        this._bindConfig(config);
    },
    getValue: function() {
        return this._value;
    },
    setValue: function(value) {
        this._value = value;
    },
    forceValue: function(value) {
        this._value = value;
    },
    instantiate: function() {
        return this;
    },
    findById: function(id) {
        if (id == this._id) {
            return this;
        }
        return null;
    },
    attach: function() {},
    disable: function() {},
    enable: function() {},
    validate: function() {
        return true;
    }
});
ControlFactory.addType('ab_dummy', AutobidView.dummy);
var AutobidDropItemView = Class.create(AutobidView, {
    __imgElem: null,
    initialize: function($super, autobid) {
        if (undef(autobid)) {
            return;
        }
        $super({
            autobid: autobid,
            id: 'abdd_' + autobid._aId,
            classNames: autobid.isSuperModeActivated() ? ['abdd_auction', 'super_bid_active'] : ['abdd_auction']
        });
    },
    _update: function($super) {
        $super();
        if (this.__autobid._active) {
            if (this.__autobid._from == null || this.__autobid._from == '') {
                this.__fromElem.forceValue('');
            } else {
                this.__fromElem.forceValue(formatCurrency(this.__autobid._from));
            }
        }
    },
    _getItems: function() {
        return [{
            type: 'ab_dummy',
            id: 'abd_dummy_' + this._auctionId,
            value: null
        }, {
            type: 'static',
            id: 'abd_img_' + this._auctionId,
            link: this.__autobid._slug + '#auction-' + this._auctionId,
            classNames: ['abdd_img'],
            contentType: 'image',
            content: '/img/items/t1_' + this.__autobid._sku + '.jpg'
        }, {
            type: 'container',
            classNames: ['abdd_bidnum'],
            items: [{
                type: 'static',
                content: i18n.ab.bid_from
            }, {
                type: 'text',
                id: 'abd_from_' + this._auctionId,
                regex: /^\d*(\.\d{1,2})?$/,
                errorClass: 'error',
                inputType: 'number',
                inputStep: '0.01',
                listeners: {
                    blur: function(event) {
                        this.validate();
                    }.bind(this),
                    keydown: function(event) {
                        if (event.event.keyCode == Event.KEY_TAB) {
                            this.validate();
                        }
                    }.bind(this),
                    keyup: function(event) {
                        event.object.setValid();
                        if (event.event.keyCode == Event.KEY_RETURN) {
                            if (this.validate()) {
                                this.__resume();
                            }
                        }
                    }.bind(this)
                }
            }]
        }, {
            type: 'container',
            classNames: ['abdd_bidnum'],
            items: [{
                type: 'static',
                content: i18n.ab.bid_num
            }, {
                type: 'text',
                id: 'abd_bids_' + this._auctionId,
                regex: /^\d*$/,
                errorClass: 'error',
                inputType: 'number',
                listeners: {
                    blur: function(event) {
                        this.validate();
                    }.bind(this),
                    keydown: function(event) {
                        if (event.event.keyCode == Event.KEY_TAB) {
                            this.validate();
                        }
                    }.bind(this),
                    keyup: function(event) {
                        event.object.setValid();
                        if (event.event.keyCode == Event.KEY_RETURN) {
                            if (this.validate()) {
                                this.__resume();
                            }
                        }
                    }.bind(this)
                },
                overrides: {
                    setBidsValue: function(bidsLeft, bids) {
                        this._bids = bidsLeft;
                        if (!undef(bids)) {
                            this.forceValue(bidsLeft + '/' + bids);
                        }
                    },
                    enable: function() {
                        this.forceValue(this._bids);
                        ___dummyCtl.enable.bind(this)();
                    }
                }
            }]
        }, {
            type: 'container',
            classNames: ['abdd_bidnum'],
            items: [{
                type: 'static',
                content: i18n.ab.sniper_num
            }, {
                type: 'static',
                id: 'abd_snipers_' + this._auctionId,
                overrides: {
                    setValue: function(value) {
                        this._value = value;
                        this.setContent(value);
                    }
                }
            }]
        }, {
            type: 'container',
            classNames: ['abdd_bidctrl'],
            items: [{
                type: 'static',
                id: 'abd_pte_' + this._auctionId,
                content: i18n.ab.pause_edit
            }, {
                type: 'button',
                classNames: Beezid.touchEnabled ? ['btn-ctrl', 'touch'] : ['btn-ctrl'],
                id: 'abd_activate_' + this._auctionId,
                content: '<i class ="icon icon-pause"></i>',
                action: function() {
                    try {
                        if (this.__autobid._active) {
                            this.__autobid.pause();
                        } else {
                            if (this.validate()) {
                                this.__autobid.resume(this.cook());
                            } else {
                                throw ('incomplete');
                            }
                        }
                    } catch (e) {
                        Beezid.autobidManager.displayError(e, this.__autobid);
                    }
                }.bind(this)
            }, {
                type: 'button',
                classNames: Beezid.touchEnabled ? ['btn-ctrl', 'touch'] : ['btn-ctrl'],
                id: 'abd_remove_' + this._auctionId,
                content: '<i class ="icon icon-remove"></i>',
                action: function() {
                    this.__autobid.remove();
                }.bind(this)
            }]
        }];
    },
    __resume: function() {
        try {
            if (this.__autobid._active) {
                return;
            }
            this.__autobid.resume(this.cook());
        } catch (e) {
            Beezid.autobidManager.displayError(e, this.__autobid);
        }
    },
    _setImg: function() {
        if (this.__autobid._sku != this.__imgElem._sku) {
            this.__imgElem.setContent('/img/items/t1_' + this.__autobid._sku + '.jpg');
            this.__imgElem._sku = this.__autobid._sku;
        }
    },
    _bindElements: function() {
        this.__bidsElem = this.findById('abd_bids_' + this._auctionId);
        this.__fromElem = this.findById('abd_from_' + this._auctionId);
        this.__activeElem = this.findById('abd_dummy_' + this._auctionId);
        this.__sniperActive = this.findById('abd_dummy_' + this._auctionId);
        this.__sniperBids = this.findById('abd_snipers_' + this._auctionId);
        this.__pauseBtn = this.findById('abd_activate_' + this._auctionId);
        this.__removeBtn = this.findById('abd_remove_' + this._auctionId);
        this.__desnipeBtn = this.findById('abd_dummy_' + this._auctionId);
        this.__bookBtn = this.findById('abd_dummy_' + this._auctionId);
        this.__imgElem = this.findById('abd_img_' + this._auctionId);
        this.__pauseText = this.findById('abd_pte_' + this._auctionId);
    },
    cook: function() {
        var cooked = {
            id: this._auctionId,
            autobidId: this.__autobid.id,
            bids: this.__bidsElem.getValue(),
            from: this.__fromElem.getValue()
        };
        if ((empty(cooked.from) && !this.__fromElem._noPost) || empty(cooked.bids)) {
            throw 'incomplete';
        }
        return cooked;
    }
});
var AutobidDropView = Class.create(Popup, {
    __autobids: null,
    __abContainer: null,
    __floating: false,
    __handle: null,
    __dragger: null,
    __button: null,
    __closeBtn: null,
    __floatBtn: null,
    __open: false,
    initialize: function($super, config) {
        $super(config);
        this.__autobids = new Hash();
        this.__abContainer = $('abd_ctn');
        Beezid.autobidManager.addListener('newAutobid', this);
        Beezid.autobidManager.addListener('autobidRemoved', this);
    },
    instantiate: function($super) {
        $super();
        this.__button = new Button({
            elem: $('abd_btn'),
            action: this.__activate.bind(this)
        });
        this.__handle = new Static({
            elem: $('abd_title')
        }).instantiate();
        this.__dragger = new DragHandler({
            owner: this,
            handle: this.__handle,
            useOverlay: true,
            listeners: {
                dragStop: this
            }
        });
        this.__floatBtn = new Button({
            elem: $('abd_float_btn'),
            action: function(event) {
                if (!this.__floating) {
                    this.float();
                } else {
                    this.unfloat();
                }
            }.bind(this)
        });
        this.__closeBtn = new Button({
            elem: $('abd_close'),
            action: function() {
                this.__activate();
            }.bind(this)
        });
        var fp = this.__readFloatInfo();
        if (fp.float) {
            this.__activate();
            this.float();
            this.__dragger.moveTo(fp.x, fp.y);
        }
        return this;
    },
    onNewAutobid: function(event) {
        var ab = new AutobidDropItemView(event.autobid);
        this.__autobids.set(event.autobid._aId, ab);
        ab.attach(this.__abContainer, true);
    },
    onAutobidRemoved: function(event) {
        var ab = this.__autobids.get(event.auctionId);
        if (ab) {
            ab.detach();
            this.__autobids.unset(ab._aId);
            delete ab;
        }
    },
    onDragStop: function(event) {
        this.__saveFloatInfo(true, event.object.__offsetX, event.object.__offsetY);
    },
    float: function() {
        this.detach();
        this.attach(document.body);
        this.__setFloatPosition();
        this.__dragger.setOrigin();
        this._elem.style.position = 'fixed';
        this.__handle.show();
        this.__closeBtn.show();
        firstElementChild(this.__floatBtn._elem).className = "icon icon-fullscreen";
        this.__floating = true;
    },
    unfloat: function() {
        this.detach();
        this.attach($('ab_dropdown_origin'));
        this._elem.style.position = 'absolute';
        this._elem.style.left = null;
        this._elem.style.top = null;
        this.__handle.hide();
        this.__closeBtn.hide();
        firstElementChild(this.__floatBtn._elem).className = "icon icon-move";
        this.__floating = false;
        this.__saveFloatInfo(false);
    },
    __setFloatPosition: function() {
        this._elem.style.top = ($('ab_dropdown_origin').cumulativeOffset().top - this._elem.offsetHeight - 24) + 'px';
        this._elem.style.left = $('ab_dropdown_origin').cumulativeOffset().left + 'px';
    },
    __activate: function(event) {
        if (this.__floating) {
            this.unfloat();
        }
        if (this.__open) {
            this.hide();
            this.__button._elem.removeClassName('pressed');
            this.__open = false;
        } else {
            this.show();
            this.__button._elem.addClassName('pressed');
            this.__open = true;
        }
    },
    __saveFloatInfo: function(isFloating, x, y) {
        var val = isFloating ? ('true:' + x + ':' + y) : 'false';
        createCookie('abm_float', val, 1);
    },
    __readFloatInfo: function() {
        var result = {
            float: false
        };
        var cookie = readCookie('abm_float');
        if (cookie) {
            var val = cookie.split(':');
            if (val[0] == 'true') {
                result = {
                    float: true,
                    x: val[1],
                    y: val[2]
                };
            }
        }
        return result;
    }
});
var AutobidCount = Class.create(Static, {
    __count: 0,
    __empty: null,
    initialize: function($super, config) {
        $super(config);
        Beezid.autobidManager.addListener('newAutobid', this);
        Beezid.autobidManager.addListener('autobidRemoved', this);
        this.__empty = $('abd_empty');
        this.__update();
    },
    onNewAutobid: function() {
        this.__count++;
        this.__update();
    },
    onAutobidRemoved: function() {
        this.__count--;
        this.__update();
    },
    __update: function() {
        if (!this.__count) {
            this.__empty.show();
            this._elem.addClassName('empty');
            this._elem.up('.bar_red_count').hide();
        } else {
            this.__empty.hide();
            this._elem.removeClassName('empty');
            this._elem.up('.bar_red_count').show();
        }
        this.setContent(this.__count.toString());
    }
});
var BalloonAuctionClass = Class.create({
    initialize: function() {},
    updateItemDetails: function(params) {
        new Ajax.Request('/auctions/get_item_details/' + params.auction_id + '/' + params.template + '/' + params.sku, {
            method: 'get',
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            onComplete: function(result) {
                var res = result.responseText.evalJSON();
                if (res.success) {
                    if (params.template == 'details') {
                        $('price_auc_div').update(formatCurrency(res.CatalogItem.price));
                        $$('.item_dropdown').each(function(element) {
                            if (element.id == 'switch_auc_' + params.auction_id) {
                                var d = $('auc_switcher_' + params.auction_id).src.lastIndexOf('/');
                                var src = $('auc_switcher_' + params.auction_id).src.substring(0, d + 1);
                                $('auc_switcher_' + params.auction_id).src = src + 't4_' + res.CatalogItem.sku + '.jpg';
                            }
                        });
                        detailsData.Auction[params.auction_id].CatalogItem = res.CatalogItem;
                        detailsData.Auction[params.auction_id].BalloonAuction.CatalogItem = res.CatalogItem;
                        detailsData.Auction[params.auction_id].BalloonAuction.BalloonInfo = res.BalloonInfo;
                        detailPageManager.updateItemInfo(res);
                        detailPageManager.updateBalloonInfo(detailsData.Auction[params.auction_id].auction_status_id, res);
                    } else if (params.template == 'regular') {
                        var retailPriceEl = $('trst_' + params.auction_id).previous();
                        var currentPrice = retailPriceEl.innerHTML.split(':').last().strip();
                        retailPriceEl.update(retailPriceEl.innerHTML.replace(currentPrice, formatCurrency(res.CatalogItem.price)));
                        $('trst_' + params.auction_id).previous(2).select('a').first().update(res.CatalogItem.name.truncate(45));
                    } else if (params.template == 'easy') {
                        var retailPriceEl = $('amount_' + params.auction_id).next();
                        var currentPrice = retailPriceEl.innerHTML.split(':').last().strip();
                        retailPriceEl.update(retailPriceEl.innerHTML.replace(currentPrice, '<br/>' + formatCurrency(res.CatalogItem.price)));
                        var auctionContainer = $('a_' + params.auction_id);
                        if (auctionContainer != null) {
                            auctionContainer.select('.auction_box_easy_view_auction_title a').first().update(res.CatalogItem.name.truncate(65));
                            if (res.CatalogItem.desc_short != null && res.BalloonInfo.last) {
                                auctionContainer.select('.auction_box_easy_view_auction_title div').first().next().update(res.CatalogItem.desc_short.truncate(165));
                            }
                        }
                    } else if (params.template == 'mega') {
                        var auctionContainer = $('a_' + params.auction_id);
                        if (auctionContainer != null) {
                            var divClassName = 'auction_box_mega_view_auction_title';
                            if (auctionContainer.hasClassName('ml_item_outer')) {
                                divClassName = 'ml_title';
                            }
                            auctionContainer.select('.' + divClassName + ' a').first().update(res.CatalogItem.name.truncate(60));
                        }
                    }
                }
            }.bind(this)
        });
    },
    updateEffects: function(params) {
        if (params.icon_el != null) {
            if (params.balloon_value == -1) {
                params.icon_el.hide();
                if ($('info_icon_' + params.auction_id + '_balloon') != null) {
                    $('info_icon_' + params.auction_id + '_balloon').hide();
                }
                if ($('balloon_description_wrapper') != null) {
                    $('balloon_description_wrapper').hide();
                }
            } else {
                this.changeIconClass(params.icon_el, params.balloon_value);
            }
        }
    },
    changeIconClass: function(balloonIconEl, balloonValue) {
        var balloonCount = balloonIconEl.className.match(/auction_type_balloon(.*)_(icon|animated)/)[1],
            regularIcon = 'auction_type_balloon' + balloonCount + '_icon',
            animatedIcon = 'auction_type_balloon' + balloonCount + '_animated';
        if (balloonValue == 1) {
            if (balloonIconEl.hasClassName(animatedIcon)) {
                balloonIconEl.removeClassName(animatedIcon);
                balloonIconEl.addClassName(regularIcon);
            }
        } else if (balloonValue >= 2) {
            if (balloonIconEl.hasClassName(regularIcon)) {
                balloonIconEl.removeClassName(regularIcon);
                balloonIconEl.addClassName(animatedIcon);
            }
        }
    }
});
var BalloonAuction = new BalloonAuctionClass;
var ActivityMonitorCls = Class.create(BeezidObject, {
    initialize: function($super) {
        $super();
        this.mCount = 2;
        this.lastActivity = new Date(0).valueOf();
        this.lx = this.ly = 0;
        Event.observe(document, 'keydown', function(e) {
            ActivityMonitor.onActive(e);
        });
        Event.observe(document, 'click', function(e) {
            ActivityMonitor.onActive(e);
        });
        Event.observe(document, 'touchstart', function(e) {
            ActivityMonitor.onActive(e);
        });
        Event.observe(document, 'touchend', function(e) {
            ActivityMonitor.onActive(e);
        });
        Event.observe(document, 'touchmove', function(e) {
            ActivityMonitor.onActive(e);
        });
        Event.observe(document, 'mousemove', function(e) {
            ActivityMonitor.onMouseMove(e);
        });
    },
    onActive: function(event) {
        this.lastActivity = new Date().valueOf();
        this.fireEvent('active');
    },
    onMouseMove: function(event) {
        if (this.mCount > 0) {
            --this.mCount;
            return;
        }
        if (this.lx != event.x || this.ly != event.y) {
            this.lx = event.x;
            this.ly = event.y;
            this.onActive(event);
        }
    },
    getLastActivityTime: function() {
        return this.lastActivity;
    }
});
var ActivityMonitor = new ActivityMonitorCls();
var IdleHandler = Class.create(BeezidObject, {
    __isIdle: false,
    initialize: function($super, idleTimeout) {
        $super();
        this.timeout = idleTimeout;
        this.timeoutId = window.setTimeout(this.idle.bind(this), this.timeout * 1000);
        ActivityMonitor.addListener('active', this);
    },
    onActive: function() {
        this.reset();
    },
    reset: function() {
        if (this.timeoutId) {
            window.clearTimeout(this.timeoutId);
            this.timeoutId = null;
        }
        this.timeoutId = window.setTimeout(this.idle.bind(this), this.timeout * 1000);
    },
    idle: function() {
        this.__isIdle = true;
        this.fireEvent('idle');
        ActivityMonitor.removeListener('active', this);
    },
    isIdle: function() {
        return this.__isIdle;
    }
});
var PageRefresher = {
    _timeout: null,
    _timeoutId: null,
    initialize: function(refreshTimeout) {
        this._timeout = refreshTimeout;
        this._timeoutId = window.setTimeout(this.refreshPage.bind(this), this._timeout * 1000);
        window.refresher = this;
    },
    refreshPage: function() {
        var elapsed = new Date().valueOf() - ActivityMonitor.getLastActivityTime();
        if (elapsed < this._timeout * 1000) {
            window.location.reload();
        } else {
            this._timeoutId = window.setTimeout(this.refreshPage.bind(this), this._timeout * 1000);
        }
    },
    reset: function() {
        if (this._timeoutId) {
            window.clearTimeout(this._timeoutId);
        }
        this._timeoutId = window.setTimeout(this.refreshPage.bind(this), this._timeout * 1000);
    }
};
var itemArray = new Hash();
var Auction = Class.create(BeezidObject, {
    itemIndex: null,
    opensIn: null,
    endDate: null,
    nowDate: null,
    itemStatus: null,
    highestBidder: null,
    placedBids: null,
    previousBidAmount: null,
    timer: null,
    paused: null,
    updateBffBtn: false,
    defunct: false,
    auctionTime: null,
    bidHistory: null,
    _isClosed: false,
    __bidBtnConfig: {
        action: null,
        booster: null,
        glow: null
    },
    initialize: function($super, itemId) {
        $super();
        this.itemIndex = itemId;
        this.bidHistory = new BidHistory({
            auction: this
        });
        idleHandler.addListener('idle', this);
        this.__initSuperMode();
    },
    __initSuperMode: function() {
        Beezid.info.addListener('superModeUpdateStart', this);
        Beezid.info.addListener('superModeUpdateComplete', this);
    },
    highlightPrice: function(elem, highlightColor) {
        elem.className = 'a_amount';
        (function() {
            elem.className += ' highlight-' + highlightColor;
        }).defer();
    },
    onSuperModeUpdateStart: function() {
        if (this.itemStatus != CLOSED && !this.updateBffBtn && $('btn_bid_' + this.itemIndex) != null) {
            $('btn_bid_' + this.itemIndex).addClassName('disabled');
        }
    },
    onSuperModeUpdateComplete: function() {
        if (this.itemStatus != CLOSED && !this.updateBffBtn && $('btn_bid_' + this.itemIndex) != null) {
            $('btn_bid_' + this.itemIndex).removeClassName('disabled');
            this.forceBidButtonRefresh();
        }
    },
    onIdle: function() {
        this.defunct = true;
    },
    countdown: function(time) {
        if (this.defunct || (this.paused && time < 0)) {
            window.clearTimeout(this.timer);
            return;
        }
        var countdownDiv = $('timer_' + this.itemIndex);
        var countdownDiv2 = ($('timer_' + this.itemIndex + 'c') == null) ? false : $('timer_' + this.itemIndex + 'c');
        var countdownDiv3 = ($('timer_' + this.itemIndex + 'sc') == null) ? false : $('timer_' + this.itemIndex + 'sc');
        if (this.itemStatus == STANDBY) {
            if (countdownDiv) {
                countdownDiv.update(i18n.beezid.stand_by);
            }
            if (countdownDiv2) {
                countdownDiv2.update(i18n.beezid.stand_by);
            }
            if (countdownDiv3) {
                countdownDiv3.update(i18n.beezid.stand_by);
            }
        } else if (this.itemStatus == CLOSED) {
            if ((typeof aid != 'undefined' && this.itemIndex == aid)) {
                var endDate = new Date(this.endDate.replace(/-/gi, '/'));
                var meridian = this.endDate.slice(-3);
                var daylightOffset = meridian == 'EST' ? 5 : 4;
                var localOffset = endDate.getTimezoneOffset() * 60000;
                var localTime = endDate.getTime();
                var utc = localTime + localOffset;
                var eastCoast = utc + (3600000 * (-daylightOffset)) + (1000 * (siteTimeDiff));
                var ourTime = new Date(eastCoast);
                var formatedTime = timeFormat.replace('Y', ourTime.getFullYear());
                formatedTime = formatedTime.replace('m', (parseInt(ourTime.getMonth()) + 1));
                formatedTime = formatedTime.replace('d', ourTime.getDate());
                formatedTime = formatedTime.replace('H', ourTime.getHours());
                formatedTime = formatedTime.replace('i', ((ourTime.getMinutes() < 10) ? "0" + ourTime.getMinutes() : ourTime.getMinutes()));
                formatedTime = formatedTime.replace('s', ((ourTime.getSeconds() < 10) ? "0" + ourTime.getSeconds() : ourTime.getSeconds()));
                formatedTime = formatedTime.split(' ');
                countdownDiv.update(formatedTime[0] + '<br />' + formatedTime[1] + ' ' + timeZone);
                countdownDiv.addClassName('closed');
            } else if (typeof categoryKey == 'undefined' || (categoryKey != 'closed' && categoryKey != 'pinned')) {
                if (!countdownDiv.hasClassName('a_closed')) {
                    countdownDiv.update(i18n.beezid.ended);
                }
                if (countdownDiv2) {
                    countdownDiv2.update(i18n.beezid.ended);
                }
                if (countdownDiv3) {
                    countdownDiv3.update(i18n.beezid.ended);
                }
            }
            if (this.defunct === false) {
                this.defunct = true;
                if (typeof HomepageRefresherObj != 'undefined') {
                    HomepageRefresherObj.auctionClosed();
                }
            }
            window.clearTimeout(this.timer);
        } else if (time > 0) {
            if (time <= 6 && this.opensIn < 0) {
                var countdownColor = 'red';
            } else {
                var countdownColor = '#123a40';
            }
            if (countdownDiv) {
                var timer = new Timer({
                    milliseconds: time * 1000,
                    enableTimer: false
                });
                var timerPrefix = '';
                if (this.opensIn > 1 || this.paused) {
                    if (this.paused || this.highestBidder !== null) {
                        timerPrefix = 'Reopens in: <br/>';
                    } else {
                        timerPrefix = 'Opens in: <br/>';
                    }
                }
                countdownDiv.update(timerPrefix + timer.format(time < 86400));
                countdownDiv.setStyle({
                    color: countdownColor
                });
                if (time >= 86400) {
                    countdownDiv.addClassName('timer_with_days');
                    countdownDiv2 && countdownDiv2.addClassName('timer_with_days');
                    countdownDiv3 && countdownDiv3.addClassName('timer_with_days');
                } else if (time > 86390) {
                    countdownDiv.removeClassName('timer_with_days');
                    countdownDiv2 && countdownDiv2.removeClassName('timer_with_days');
                    countdownDiv3 && countdownDiv3.removeClassName('timer_with_days');
                }
                if (countdownDiv3) {
                    countdownDiv3.update(timerPrefix + timer.format(time < 86400));
                    countdownDiv3.setStyle({
                        color: countdownColor
                    });
                }
                if (countdownDiv2) {
                    countdownDiv2.update(timerPrefix + timer.format(time < 86400));
                    countdownColor = countdownColor == 'red' ? 'red' : '#fff';
                    countdownDiv2.setStyle({
                        color: countdownColor
                    });
                }
            }
            if (this.paused) {
                window.clearTimeout(this.timer);
            } else {
                this.timer = window.setTimeout(function() {
                    this.countdown(--time);
                }.bind(this), 1000);
            }
        } else if (this.auctionTime <= 0) {
            countdownDiv.update(i18n.beezid.going);
            if (countdownDiv2) {
                countdownDiv2.update(i18n.beezid.going);
            }
            if (countdownDiv3) {
                countdownDiv3.update(i18n.beezid.going);
            }
        }
        this.updateJeepBanner(time);
    },
    updateJeepBanner: function(time) {
        if (this.itemIndex == 1106843 && $('jeep_home_header') !== null) {
            if (this.itemStatus == STANDBY) {} else if (this.itemStatus == CLOSED) {
                $('jeep_home_header').fade();
            } else if (time > 0) {
                var timer = new Timer({
                    milliseconds: time * 1000,
                    enableTimer: false
                });
                var timerValues = timer.split();
                if (this.opensIn >= 1 || this.paused) {
                    $('jeep_reopens_banner') && $('jeep_reopens_banner').show();
                } else {
                    $('jeep_reopens_banner') && $('jeep_reopens_banner').hide();
                }
                var el = $('jeep_banner_countdown');
                el.select('.ind_days').first().update(timerValues.day < 10 ? '0' + timerValues.day : timerValues.day);
                el.select('.ind_hours').first().update(timerValues.hr < 10 ? '0' + timerValues.hr : timerValues.hr);
                el.select('.ind_minutes').first().update(timerValues.min < 10 ? '0' + timerValues.min : timerValues.min);
                el.select('.ind_seconds').first().update(timerValues.sec < 10 ? '0' + timerValues.sec : timerValues.sec);
            } else if (this.auctionTime <= 0) {}
        }
    },
    forceBidButtonRefresh: function() {
        this.__bidBtnConfig.action = null;
    },
    __updateBidButton: function(action, booster, glow) {
        var bidButtonEl = $('btn_bid_' + this.itemIndex);
        if (bidButtonEl == null) {
            return;
        }
        if (typeof booster == 'undefined') {
            booster = 1;
        }
        if (typeof glow == 'undefined') {
            glow = 0;
        }
        if (action === this.__bidBtnConfig.action && booster === this.__bidBtnConfig.booster && glow === this.__bidBtnConfig.glow) {
            return;
        }
        this.__bidBtnConfig = {
            action: action,
            booster: booster,
            glow: glow
        };
        bidButtonEl.stopObserving('click').stopObserving('mouseover').stopObserving('mouseout').enable();
        if (bidButtonEl.hasClassName('bb_lrg')) {
            bidButtonEl.className = 'bid_btn bb_lrg';
        } else {
            bidButtonEl.className = 'bid_btn';
        }
        if (glow > 0) {
            bidButtonEl.addClassName('bb_glow_' + glow);
        }
        var clickAction = 'bid';
        switch (action) {
            case 'bid':
                bidButtonEl.update(booster > 1 ? booster + ' ' + i18n.bid_btn.bids : i18n.bid_btn.bid);
                break;
            case 'bff':
                bidButtonEl.update(i18n.bid_btn.bff);
                break;
            case 'super':
                bidButtonEl.addClassName('bb_super').update(i18n.bid_btn.super_bid);
                break;
            case 'remind':
                bidButtonEl.update(i18n.bid_btn.remind);
                clickAction = 'remind';
                break;
            case 'claim':
                bidButtonEl.addClassName('bb_claim').update(i18n.bid_btn.claim);
                clickAction = 'claim';
                break;
            case 'sold':
                bidButtonEl.addClassName('bb_sold disabled').update(i18n.bid_btn.sold).disable();
                clickAction = '';
                break;
        }
        if (clickAction != '' && !Beezid.info.loggedIn()) {
            clickAction = 'sign_in';
        }
        switch (clickAction) {
            case 'sign_in':
                bidButtonEl.observe('click', function(e) {
                    Beezid.loginBox.open();
                    trackEvent("reg", "bid_login");
                });
                bidButtonEl.observe('mouseover', function() {
                    bidButtonEl.update(i18n.bid_btn.sign_in);
                });
                bidButtonEl.observe('mouseout', function() {
                    this.forceBidButtonRefresh();
                    this.__updateBidButton(action);
                }.bind(this));
                break;
            case 'bid':
                bidButtonEl.observe('click', function(e) {
                    clickTarget = e.target.id;
                    placeBid(this.itemIndex);
                }.bind(this));
                break;
            case 'remind':
                bidButtonEl.observe('click', function(e) {
                    clickTarget = e.target.id;
                    remindUser(this.itemIndex);
                }.bind(this));
                break;
            case 'claim':
                bidButtonEl.observe('click', function(e) {
                    window.location = '/auctions/claim/' + this.itemIndex;
                }.bind(this));
                break;
        }
    },
    updateItemButton: function() {
        if ($('btn_bid_' + this.itemIndex) == null || this._isClosed) {
            return;
        }
        if (this.itemStatus == STATUS_PAUSED || this.itemStatus == STANDBY || (this.itemStatus != CLOSED && this.opensIn > 0)) {
            this.__updateBidButton('remind');
        } else if (this.itemStatus == STATUS_ACTIVE) {
            var bidButtonAction = 'bid',
                bidButtonBooster = 1,
                bidButtonGlow = 0;
            if ($('info_icon_' + this.itemIndex + '_2048') != null || Beezid.info.isSuperModeActivated()) {
                bidButtonAction = 'super';
            }
            if (this.updateBffBtn) {
                bidButtonAction = 'bff';
            }
            if (Beezid.info.loggedIn() && !Beezid.info.isSuperModeActivated()) {
                var iconContainer = undef(window.detailPageManager) ? $('a_' + this.itemIndex) : $('icon_div');
                if (iconContainer != null) {
                    var boosterAuctions = iconContainer.select('div[id^=booster_' + this.itemIndex + '_]');
                    if (boosterAuctions.length) {
                        bidButtonBooster = boosterAuctions.first().id.gsub('booster_' + this.itemIndex + '_', '');
                    }
                }
                if (typeof Beezid.info._boosterMultiplier[bidButtonBooster] !== 'undefined' && Beezid.info.getPromoBidBalance() > Beezid.info._boosterMultiplier[bidButtonBooster] && $('info_icon_' + this.itemIndex + '_2048') == null && $('info_icon_' + this.itemIndex + '_67108864') == null && $('info_icon_' + this.itemIndex + '_8192') == null && $('info_icon_' + this.itemIndex + '_16') == null) {
                    bidButtonBooster = Beezid.info._boosterMultiplier[bidButtonBooster];
                }
                if (!undef(window.detailPageManager)) {
                    detailPageManager.setBoosterValue(this.itemIndex, bidButtonBooster);
                }
            }
            if (typeof this.balloon != 'undefined' && this.balloon >= 2) {
                bidButtonGlow = this.balloon - 1;
            }
            this.__updateBidButton(bidButtonAction, bidButtonBooster, bidButtonGlow);
        } else if (this.itemStatus == CLOSED) {
            this._isClosed = true;
            if (Beezid.info.getUid() == this.highestBidder) {
                this.__updateBidButton('claim');
            } else {
                this.__updateBidButton('sold');
            }
            if (!undef(window.detailPageManager)) {
                detailPageManager.setClosedAuction(this.itemIndex, this.highestBidder);
            }
        }
    },
    refresh: function(item, now, homepageRefresh) {
        if (typeof homepageRefresh != 'undefined' && homepageRefresh) {
            this.forceBidButtonRefresh();
        }
        if (typeof Beezid.powerManager != 'undefined') {
            Beezid.powerManager.setAuctionUpdaterValues(item);
        }
        var curTime = new Date(now.replace(/-/gi, '/')).getTime();
        var ribbon = '<img id="b4f_' + this.itemIndex + '" src="/img/pages/common/bid-for-free-sml.png" alt="Bid For Free"' + 'class="b4f_ribbon_show" />';
        this.endDate = item.bid_end;
        this.paused = item.paused;
        this.opensIn = typeof item.opens_in !== 'undefined' ? item.opens_in : (item.auction_time * -1), this.nowDate = now;
        this.itemStatus = item.auction_status;
        this.auctionTime = item.auction_time;
        this.highestBidder = item.user_id;
        if (typeof item.balloon != 'undefined') {
            this.balloon = item.balloon;
        } else {
            this.balloon = 0;
        }
        if (item.bid_amount == null) {
            item.bid_amount = 0;
        }
        this.updateBidAmountElement(item);
        if (item.auction_status == CLOSED) {
            idString = idString.gsub(item.id + ':', '');
        }
        if ($('btn_bid_' + item.id).innerHTML == i18n.bid_btn.bff) {
            this.updateBffBtn = true;
        }
        this.updateBidder(item);
        if (this.opensIn <= 0 || this.itemStatus == CLOSED) {
            if (this.updateBffBtn) {
                if ($('b4f_overlay_' + this.itemIndex) != null) {
                    this.__bid4FRibbonHandlerForEasyAndMegaView('trst_' + item.id);
                } else {
                    this.__bid4FRibbonHandlerForRegularView(ribbon, 'trst_' + item.id);
                }
                if (item.auction_status == CLOSED && item.bid_amount == 0 && $('a_' + item.id) != null) {
                    $('a_' + item.id).hide();
                    if (typeof Beezid.activeAuctionManager != 'undefined') {
                        Beezid.activeAuctionManager.onAuctionsLoaded();
                    }
                }
            }
            window.clearTimeout(this.timer);
            this.countdown(item.auction_time);
            $('timer_' + item.id).removeClassName('opens-in');
        } else {
            if (item.auction_status != STANDBY) {
                if (this.updateBffBtn) {
                    var trst = 'trst_' + item.id;
                    if ($('b4f_overlay_' + this.itemIndex) != null) {
                        $('b4f_overlay_' + this.itemIndex).addClassName('auction_box_easy_view_bid_for_free_icon');
                        $(trst).update();
                    } else {
                        $(trst).update(ribbon);
                        $(trst).toggleClassName('b4f_cont', true);
                    }
                }
                window.clearTimeout(this.timer);
                this.countdown(this.opensIn);
                $('timer_' + item.id).addClassName('opens-in');
            } else {
                $('timer_' + item.id).update(i18n.beezid.stand_by);
                if ($('timer_' + item.id + 'c') != null) {
                    $('timer_' + item.id + 'c').update(i18n.beezid.stand_by);
                }
            }
        }
        this.__cashMoneyAuctionsHandler(item);
        this.placedBids = item.placed_bids;
        this.previousBidAmount = item.bid_amount;
        this.updateItemButton();
        if (typeof item.sku != 'undefined') {
            var auctionContainer = $('a_' + item.id);
            if (auctionContainer != null) {
                var balloonIconEl = auctionContainer.select('#info_icon_' + item.id + '_balloon').first();
                BalloonAuction.updateEffects({
                    auction_id: item.id,
                    icon_el: balloonIconEl,
                    template: auctionContainer.hasClassName('auction_box_mega_view') ? 'mega' : 'regular',
                    balloon_value: item.balloon
                });
                var auctionImg = auctionContainer.select('img').first();
                if (auctionImg != null) {
                    var newImage = 't1_' + item.sku + '.jpg',
                        oldImage = auctionImg.src.split('/').last();
                    if (oldImage != blankImage && oldImage != newImage) {
                        if (typeof item.balloon == 'undefined') {
                            var giftImageName = auctionImg.src.match(/t1_(.*)\.(gif|jpg)/);
                            var cssName = auctionContainer.className.indexOf('normal') != -1 ? 'regular' : 'easy';
                            if (giftImageName != null) {
                                auctionImg.insert({
                                    'before': '<div class="' + giftImageName[1] + '_' + cssName + '_view"/></div>'
                                });
                            }
                        } else {
                            BalloonAuction.updateItemDetails({
                                auction_id: item.id,
                                template: auctionContainer.hasClassName('auction_box_mega_view') ? 'mega' : 'regular',
                                sku: item.sku
                            });
                        }
                        auctionImg.hide();
                        auctionImg.src = '/img/items/' + newImage;
                        Effect.Appear(auctionImg, {
                            duration: 1.0
                        });
                    }
                }
            }
        }
    },
    refreshDetails: function(item, now) {
        var i = 0,
            curTime = new Date(now.replace(/-/gi, '/')).getTime();
        if (typeof this != "undefined") {
            if (typeof Beezid.powerManager != 'undefined') {
                Beezid.powerManager.setAuctionUpdaterValues(item);
            }
            this.endDate = item.bid_end;
            this.paused = item.paused;
            this.nowDate = now;
            this.opensIn = typeof item.opens_in !== 'undefined' ? item.opens_in : (item.auction_time * -1), this.itemStatus = item.auction_status;
            this.auctionTime = item.auction_time;
            this.highestBidder = item.user_id;
            if (typeof detailsData !== 'undefined' && aid == item.id && detailsData.Auction[aid].auction_type_id == BID_FOR_FREE) {
                this.updateBffBtn = true;
            }
            if (typeof item.balloon != 'undefined') {
                this.balloon = item.balloon;
            } else {
                this.balloon = 0;
            }
            if (item.id == aid) {
                detailsData.Auction[aid].bid_amount = item.bid_amount;
                if ($('amount_final_price') != null) {
                    $('amount_final_price').update(formatCurrency(item.bid_amount));
                }
                detailPageManager.updateSavings();
            }
            if (item.bid_amount == null) {
                item.bid_amount = 0;
            }
            this.updateBidAmountElement(item);
            if (this.opensIn <= 0 || this.itemStatus == CLOSED) {
                $("timer_" + item.id).removeClassName('opens_in_tmr');
                window.clearTimeout(this.timer);
                this.countdown(item.auction_time);
                if ($('amount_' + item.id) != null && $('amount_' + item.id + 'c') != null) {
                    $('amount_' + item.id + 'c').show();
                } else {
                    $('amount_' + item.id).show();
                }
                if (item.auction_status == CLOSED) {
                    $("timer_" + item.id).setStyle({
                        fontSize: "22px"
                    });
                    if ($('switch_auc_' + item.id) != null) {
                        if ($('timer_' + item.id + 'c') != null) {
                            $('timer_' + item.id + 'c').update(i18n.beezid.ended);
                        }
                        if ($('timer_' + item.id + 'sc') != null) {
                            $('timer_' + item.id + 'sc').update(i18n.beezid.ended);
                        }
                    }
                    if (item.id != aid) {
                        $('timer_' + item.id).update(i18n.beezid.ended);
                        if (!this.defunct) {
                            this.defunct = true;
                            if (typeof HomepageRefresherObj != 'undefined') {
                                HomepageRefresherObj.auctionClosed($$('[title=item_' + item.id + '] + div')[0]);
                            }
                        }
                    }
                } else {
                    if (aid != item.id) {
                        $('timer_' + item.id).setStyle({
                            fontSize: '21px'
                        });
                        if ($('timer_' + item.id + 'c') != null) {
                            $('timer_' + item.id + 'c').setStyle({
                                fontSize: '21px'
                            });
                        }
                    } else {
                        $("timer_" + item.id).setStyle({
                            fontSize: "28px"
                        });
                    }
                }
            } else {
                if (item.auction_status != STANDBY) {
                    window.clearTimeout(this.timer);
                    this.countdown(this.opensIn);
                    $("timer_" + item.id).addClassName('opens_in_tmr');
                    $("timer_" + item.id).setStyle({
                        fontSize: "17px"
                    });
                    if ($("timer_" + item.id + 'c') != null) {
                        $("timer_" + item.id + 'c').setStyle({
                            fontSize: "17px"
                        });
                    }
                    if ($('amount_' + item.id) != null && $('amount_' + item.id + 'c') != null) {
                        $('amount_' + item.id + 'c').hide();
                    } else {
                        $('amount_' + item.id).hide();
                    }
                } else {
                    $("timer_" + item.id).removeClassName('opens_in_tmr');
                    $("timer_" + item.id).update(i18n.beezid.stand_by);
                    if ($("timer_" + item.id + 'c')) {
                        $("timer_" + item.id + 'c').update(i18n.beezid.stand_by);
                    }
                }
            }
            this.placedBids = item.placed_bids;
            this.previousBidAmount = item.bid_amount;
            this.updateBidder(item);
            this.updateItemButton();
            if (typeof item.balloon != 'undefined' && $('auc_switcher_' + item.id) != null) {
                var d = $('auc_switcher_' + item.id).src.lastIndexOf('/');
                var imgUrl = $('auc_switcher_' + item.id).src.substring(0, d + 1);
                $('auc_switcher_' + item.id).src = imgUrl + 't1_' + item.sku + '_f1.jpg';
            }
            if (typeof item.sku != 'undefined') {
                if (item.id == aid && $('bigpic') != null) {
                    if (typeof item.balloon != 'undefined') {
                        var balloonIconEl = $('info_icon_' + item.id + '_balloon');
                        BalloonAuction.updateEffects({
                            auction_id: item.id,
                            icon_el: balloonIconEl,
                            template: 'details',
                            balloon_value: item.balloon
                        });
                    }
                    var newImage = item.sku + '.jpg',
                        oldImage = oldImageToReplace = $('bigpic').src.split('/').last();
                    if (oldImage.indexOf('m_') == 0) {
                        oldImage = oldImage.substring(2);
                    }
                    if (oldImage != blankImage && newImage != oldImage && !/_f[0-9].jpg?/.test(oldImage)) {
                        var auctionImg = $('bigpic');
                        if (typeof item.balloon == 'undefined') {
                            auctionImg.insert({
                                'before': '<div class="' + oldImage.replace('.jpg', '').replace('.gif', '') + '_details_view"/>'
                            });
                        } else {
                            BalloonAuction.updateItemDetails({
                                auction_id: item.id,
                                template: 'details',
                                sku: item.sku
                            });
                        }
                        auctionImg.src = '/img/items/' + 'm_' + newImage;
                        Effect.Appear(auctionImg, {
                            duration: 1.0
                        });
                        $$(".adetails_thumbpic img").each(function(thumbImage) {
                            thumbImage.hide();
                            thumbImage.src = thumbImage.src.replace(oldImage.replace('.jpg', '').replace('.gif', ''), newImage.replace('.jpg', ''));
                            Effect.Appear(thumbImage, {
                                duration: 1.0
                            });
                        });
                    }
                } else if (item.id != aid && typeof item.balloon != 'undefined') {
                    var hasAnyRelatedItems = false;
                    $('a_' + item.id, 'a_' + item.id + 'c').each(function(el) {
                        if (el != null) {
                            var auctionImg = el.select('.auction_box_mega_view_auction_pic img').first(),
                                newImage = 't1_' + item.sku + '.jpg',
                                oldImage = auctionImg.src.split('/').last();
                            if (oldImage != blankImage && newImage != oldImage) {
                                hasAnyRelatedItems = true;
                                auctionImg.src = auctionImg.src.replace(oldImage, newImage);
                            }
                        }
                    });
                    if (hasAnyRelatedItems) {
                        BalloonAuction.updateItemDetails({
                            auction_id: item.id,
                            template: 'mega',
                            sku: item.sku
                        });
                    }
                }
            }
            this.__cashMoneyAuctionsHandler(item);
        }
    },
    updateBidder: function(data) {
        var user = data.username,
            bidderEl = $('bidder_name' + this.itemIndex),
            userIsHighestBidder = false;
        if (bidderEl == null) {
            return;
        }
        bidderEl.setStyle({
            color: null
        });
        if (!user) {
            user = i18n.beezid.no_bidder;
        } else if (Beezid.aliasBoss.haveAlias(this, user)) {
            user = Beezid.info._username;
        } else if (data.user_id == 0) {
            bidderEl.setStyle({
                color: '#ff0000'
            });
            if (user.indexOf('#') === 0) {
                user = 'Sniper';
            }
        } else if (data.user_id < 0 && typeof Beezid.powerManager != 'undefined') {
            var userId = Beezid.powerManager.getAuctionPowerValue(this.itemIndex, [3, 17], '_powerItemId');
            if (userId !== false && Math.abs(data.user_id) == userId) {
                var impostorUsername = Beezid.powerManager.getAuctionPowerValue(this.itemIndex, [3]);
                if (impostorUsername) {
                    user = impostorUsername;
                }
                userIsHighestBidder = true;
            }
        } else if (Beezid.info.getUid() == data.user_id) {
            user = Beezid.info.getUsername();
            userIsHighestBidder = true;
        }
        if (userIsHighestBidder) {
            bidderEl.update('<span class="bidder_hb_private">' + user + '</span>');
        } else {
            bidderEl.update(user);
        }
        if ($("bidder_name" + this.itemIndex + 'c') != null) {
            $("bidder_name" + this.itemIndex + 'c').update(user);
        }
    },
    __bid4FRibbonHandlerForEasyAndMegaView: function(trst) {
        var elId = 'b4f_overlay_' + this.itemIndex;
        if ($(elId) != null) {
            if (this.itemStatus != CLOSED) {
                toggleItemClasses(elId, '');
            } else {
                toggleItemClasses(elId, 'auction_box_easy_view_bid_for_free_icon');
                $(trst).update();
            }
        }
    },
    __bid4FRibbonHandlerForRegularView: function(ribbon, trst) {
        if (this.itemStatus == CLOSED) {
            $(trst).update(ribbon);
            $(trst).toggleClassName('b4f_cont', true);
        }
    },
    getLastBid: function() {
        return this.bidHistory.getLastBid();
    },
    __cashMoneyAuctionsHandler: function(item) {
        if (item.bid_amount < 0 && typeof item.pwrVillainGreed == 'undefined') {
            var updateInnerHtml = true,
                elm = $('title_' + item.id);
            if (!elm && typeof aid === 'undefined' && $('a_' + item.id)) {
                if ($('a_' + item.id).hasClassName('auction_box_normal_view_container')) {
                    elm = $('a_' + item.id).select('a')[0];
                } else {
                    elm = $('a_' + item.id).select('.my_account_column_myauctions_c2 a')[0];
                }
                updateInnerHtml = false;
            }
            this.__updateCashMoneyAuctionsInfo(item, elm, updateInnerHtml);
        }
    },
    __updateCashMoneyAuctionsInfo: function(item, elm, updateInnerHtml) {
        if (elm) {
            var itemName = updateInnerHtml ? elm.innerHTML : elm.title,
                endName = '\n + ' + i18n.beezid.cash_money;
            if (!itemName.endsWith(i18n.beezid.cash_money)) {
                itemName += endName;
                if ($('a_' + item.id) != null) {
                    itemName = this.__getTruncatedItemName(item, itemName);
                }
                elm.update(itemName);
                elm.title = elm.title + endName;
            }
        }
    },
    __getTruncatedItemName: function(item, itemName) {
        if ($('a_' + item.id).className.match('easy')) {
            itemName = itemName.truncate(41, '...');
        } else if ($('a_' + item.id).className.match('normal')) {
            itemName = itemName.truncate(45, '...');
        } else {
            itemName = itemName.truncate(60, '...');
        }
        return itemName;
    },
    updateBidAmountElement: function(item) {
        var amountEl = $('amount_' + item.id);
        item.isACashBackAuction = false;
        if ((item.bid_amount < 0 && typeof item.pwrVillainGreed == 'undefined') || (item.bid_amount > 0 && typeof item.pwrVillainGreed != 'undefined')) {
            item.isACashBackAuction = true;
        }
        if (amountEl != null) {
            amountEl.update(this.__getAuctionAmountHTML(item));
            if (item.isACashBackAuction) {
                if (!amountEl.hasClassName('a_amount_youget')) {
                    amountEl.addClassName('a_amount_youget');
                }
            } else if (amountEl.hasClassName('a_amount_youget')) {
                amountEl.removeClassName('a_amount_youget');
            }
        }
        var amountElCopy = $('amount_' + item.id + 'c');
        if (amountElCopy != null) {
            if (item.isACashBackAuction) {
                amountElCopy.setStyle({
                    color: "#DB2016"
                });
            } else {
                amountElCopy.setStyle({
                    color: ''
                });
            }
            var amountElCopyText = this.__getAuctionAmountHTML(item, true).replace('PLUS', '+');
            amountElCopy.update(formatCurrency(Math.abs(item.bid_amount)));
            $('pwr_amount_lbl') && $('pwr_amount_lbl').update(amountElCopyText)
        }
        var amountElCopy2 = $('amount_' + item.id + 'sc');
        if (amountElCopy2 != null) {
            if (item.isACashBackAuction) {
                amountElCopy2.setStyle({
                    color: "#DB2016"
                });
            } else {
                amountElCopy2.setStyle({
                    color: ''
                });
            }
            if (item.paused || (this.opensIn > 0 && this.highestBidder !== null)) {
                amountElCopy2.hide();
            } else {
                amountElCopy2.update(this.__getAuctionAmountHTML(item));
            }
        }
        if (!undef(item.placed_bids) && this.placedBids != item.placed_bids && this.placedBids != null) {
            if (item.isACashBackAuction) {
                var startColor = Beezid.info.isIE9 ? '#74b25c' : 'green';
                amountEl.setStyle({
                    color: "#DB2016"
                });
            } else {
                var startColor = Beezid.info.isIE9 ? '#e70808' : 'red';
                amountEl.setStyle({
                    color: ''
                });
            }
            if (item.bid_amount == this.previousBidAmount) {
                startColor = Beezid.info.isIE9 ? '#5ea6e7' : 'blue';
            }
            var amountHightlightEl = amountEl.select('span')[1];
            if (amountHightlightEl) {
                if (Beezid.info.isIE9) {
                    new Effect.Highlight(amountHightlightEl, {
                        startcolor: startColor,
                        restorecolor: '#ffffff'
                    });
                } else {
                    this.highlightPrice(amountHightlightEl, startColor);
                }
            }
        }
    },
    __getAuctionAmountHTML: function(item, textOnly) {
        if (undef(item.auction_status_id) && !undef(item.auction_status)) {
            item.auction_status_id = item.auction_status;
        }
        if (item.bid_amount < 0 && item.isACashBackAuction) {
            if (item.auction_status_id == CLOSED) {
                var bidAmountText = i18n.beezid.winner_gets;
            } else {
                var bidAmountText = i18n.beezid.you_get;
            }
        } else {
            if (item.isACashBackAuction) {
                var bidAmountText = i18n.beezid.you_get;
            } else {
                if (item.auction_status_id == CLOSED) {
                    var bidAmountText = i18n.beezid.sold_for;
                } else {
                    var bidAmountText = i18n.beezid.get_it_for;
                }
            }
        }
        if (typeof textOnly === 'undefined') {
            return '<span class="a_amount_txt">' + bidAmountText + '</span>' + '<span class="a_amount">' +
                formatCurrency(Math.abs(item.bid_amount)) + '</span>';
        } else {
            return bidAmountText;
        }
    }
});
Auction.exists = function(id) {
    return itemArray[id] && ($('amount_' + id) != null);
};
Auction.getAuction = function(id) {
    return itemArray[id];
};
var AliasBoss = Class.create(BeezidObject, {
    __aliases: null,
    initialize: function($super, config) {
        $super(config);
        this.bindEvents();
        this.__aliases = {};
    },
    bindEvents: function() {
        var updater = updaterManager.get(updaterManager.BAR_UPDATER);
        if (empty(updater)) {
            this.bindEvents.bind(this).defer();
            return;
        }
        updater.addListener('success', this.onBarUpdate, this);
        updater.addListener('abupdate', this.onBarUpdate, this);
    },
    onBarUpdate: function(event) {
        if (empty(event.ghost)) {
            return;
        }
        for (var auctionId in event.ghost) {
            if (!event.ghost.hasOwnProperty(auctionId)) {
                continue;
            }
            var aliases = [];
            if (typeof event.ghost[auctionId] == 'object') {
                for (var i in event.ghost[auctionId]) {
                    if (event.ghost[auctionId].hasOwnProperty(i)) {
                        aliases.push(event.ghost[auctionId][i]);
                    }
                }
            } else {
                aliases.push(event.ghost[auctionId]);
            }
            if (empty(this.__aliases[auctionId]) || this.__aliases[auctionId] != aliases) {
                this.__aliases[auctionId] = aliases;
                this.fireEvent('update_' + auctionId, {
                    alias: this.__aliases[auctionId]
                });
            }
        }
    },
    haveAlias: function(auction, alias) {
        if (!empty(this.__aliases[auction.itemIndex])) {
            return (this.__aliases[auction.itemIndex].indexOf(alias) != -1);
        }
        return false;
    }
});
var BidHistory = Class.create(BeezidObject, {
    _maxHist: null,
    _auction: null,
    __bid_ids: null,
    __bids: null,
    __powerUsernameCache: {},
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        this.__bid_ids = [];
        this.__bids = [];
        if (!this._maxHist) {
            this._maxHist = 10;
        }
        if (!empty(this._bids)) {
            this.updateHistory();
        }
        if (!empty(window.aid)) {
            this.bindListeners();
        }
    },
    bindListeners: function() {
        var updater = updaterManager.get(updaterManager.DETAILS_UPDATER);
        if (empty(updater)) {
            this.bindListeners.bind(this).defer();
            return;
        }
        updater.addListener('success', this.bidsListener, this);
        Beezid.aliasBoss.addListener('update_' + this._auction.itemIndex, this.updateHistory, this);
    },
    destroy: function($super) {
        updaterManager.get(this.__updater).removeListener('success', this.bidsListener, this);
        $super();
    },
    getLastBid: function() {
        if (!empty(this.__bid_ids)) {
            return this.__bid_ids[0];
        }
        return 0;
    },
    bidsListener: function(event) {
        if (this._auction.itemIndex != event.result.auctionId || empty(event.result.bids)) {
            return;
        }
        var dirty = false;
        event.result.bids.each(function(bid) {
            if (this.__bid_ids.indexOf(bid.id) == -1) {
                this.__bids.push(bid);
                dirty = true;
            }
        }.bind(this));
        if (dirty) {
            this.__bids.sort(function(a, b) {
                if (a.id > b.id) {
                    return -1;
                }
                return a.id < b.id ? 1 : 0;
            });
            this.__bids = this.__bids.slice(0, this._maxHist);
            this.__bid_ids = this.__bids.map(function(b) {
                return b.id;
            });
            this.updateHistory();
        }
    },
    updateHistory: function() {
        if (empty(window.aid) || window.aid != this._auction.itemIndex) {
            return;
        }
        var len = this.__bids.length,
            html = '';
        for (var i = 0; i < len; i++) {
            var bidType = this.__bids[i].type,
                bidMode = 'Manual',
                extraCls = '',
                alias = this.__bids[i].user;
            if (Beezid.info.loggedIn()) {
                if (this.__bids[i].uid < 0 && typeof Beezid.powerManager != 'undefined') {
                    if (empty(this.__powerUsernameCache[Math.abs(this.__bids[i].uid)])) {
                        var userId = Beezid.powerManager.getAuctionPowerValue(this._auction.itemIndex, [3, 17], '_powerItemId');
                        if (userId !== false && Math.abs(this.__bids[i].uid) == userId) {
                            extraCls = ' bid_history_private';
                            var impostorUsername = Beezid.powerManager.getAuctionPowerValue(this._auction.itemIndex, [3]);
                            if (impostorUsername) {
                                alias = impostorUsername;
                            }
                            this.__powerUsernameCache[userId] = alias;
                        }
                    } else {
                        extraCls = ' bid_history_private';
                        alias = this.__powerUsernameCache[Math.abs(this.__bids[i].uid)];
                    }
                } else if (this.__bids[i].uid == Beezid.info.getUid()) {
                    alias = Beezid.info.getUsername();
                    extraCls = ' bid_history_private';
                }
            }
            if (parseInt(this.__bids[i].autobid_id) != 0) {
                if (this.__bids[i].sniper == '1') {
                    bidMode = 'Sniper';
                } else {
                    bidMode = 'Autobeezid';
                }
            }
            if (Beezid.aliasBoss.haveAlias(this._auction, this.__bids[i].user)) {
                alias = Beezid.info._username;
                extraCls = ' bid_history_private';
                if (this.__bids[i].user.indexOf('#') === 0) {
                    bidMode = 'Sniper';
                }
            } else if (this.__bids[i].user.indexOf('#') === 0) {
                alias = '&nbsp;';
                bidMode = 'Sniper';
            }
            html += "<div class=\"bidding_history_column_holder" + extraCls + "\"><p class='colrow1' id=\"bidder_" + this.__bids[i].id + "\">" +
                formatCurrency(this.__bids[i].amt) + "</p>" + "<p class=\"bidhistory_name\">" + alias + "</p>" + "<p class=\"bidhistory_type\">" + bidType + "</p>" + "<p class=\"bidhistory_mode\">" + bidMode + "</p>" + "</div>";
        }
        $('historyTop').innerHTML = html;
    }
});
initFuncs.push(function() {
    Beezid.aliasBoss = new AliasBoss();
});
var CoreUpdater = Class.create(BeezidObject, {
    periodicalExecuter: null,
    failedUpdates: 0,
    concurrentRequests: 0,
    period: 1,
    url: '',
    method: 'get',
    _u: 'update',
    initialize: function($super) {
        $super();
        this.update.bind(this).defer(0);
        this.start(this.period);
    },
    start: function(period) {
        if (!this.periodicalExecuter) {
            this.periodicalExecuter = new PeriodicalExecuter(this.update.bind(this), period);
        }
    },
    stop: function(message) {
        this.periodicalExecuter.stop();
        this.periodicalExecuter = null;
        if (message) {
            new Dialog({
                title: 'An Error Occured',
                text: message
            }).show();
        }
        this.fireEvent('stopped');
    },
    getParams: function() {
        return {};
    },
    update: function() {
        this.fireEvent('beforeRequest');
        new Ajax.Request(this.url, {
            method: this.method,
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            parameters: this.getParams(),
            onComplete: this.requestEnd.bind(this),
            onSuccess: this.requestSuccess.bind(this),
            onCreate: this.requestStart.bind(this),
            onFailure: this.failure.bind(this),
            onException: this.exception.bind(this)
        });
    },
    requestStart: function() {
        this.concurrentRequests++;
        if (this.concurrentRequests > 5) {}
    },
    requestEnd: function() {
        this.concurrentRequests--;
        this.fireEvent('afterResponse');
    },
    requestSuccess: function(res) {},
    failure: function() {
        this.failedUpdates++;
        this.fireEvent('failure');
        if (this.failedUpdates > 10) {}
    },
    exception: function(request, exception) {
        this.failedUpdates++;
        if (this.failedUpdates > 10) {}
        this.fireEvent('exception');
        this.exceptionCallback(exception);
    },
    exceptionCallback: function(exception) {}
});
var AuctionsUpdater = Class.create(CoreUpdater, {
    __updatedItems: null,
    __powersUpdated: false,
    initialize: function($super) {
        $super();
        Beezid.info.addListener('superModeChanged', this);
        if (typeof Beezid.powerManager != 'undefined') {
            Beezid.powerManager.addListener('powerUserAuctionsUpdate', this);
            Beezid.powerManager.addListener('binUpdate', this);
        }
    },
    requestSuccess: function(res) {
        var updatedItems = res.responseText.evalJSON(),
            curTime = new Date(updatedItems.now.replace(/-/gi, '/')).getTime();
        this.failedUpdates = 0;
        if (!empty(updatedItems.abd)) {
            this.fireEvent('abd', {
                abd: updatedItems.abd
            });
        }
        if (nowTime >= curTime) {
            return;
        }
        nowTime = curTime;
        if (typeof updatedItems == 'undefined' && typeof updaterId != 'undefined') {
            if (updaterId != null) {
                window.upSave = updaterId;
                updaterId = null;
            }
        }
        if (typeof updatedItems == 'object' && updatedItems.data != null) {
            this.fireEvent('success', {
                result: updatedItems
            });
            this.__updatedItems = updatedItems;
            this.__refreshAuctions();
        }
    },
    update: function($super) {
        if (typeof updaterId != 'undefined') {
            if (updaterId != null) {
                useUpdater = true;
            } else {
                useUpdater = false;
                updaterId = window.upSave;
            }
        } else {
            useUpdater = false;
        }
        var id = '';
        if (useUpdater) {
            id = updaterId;
        } else {
            id = idString;
        }
        this.url = "/auctions/updater/id:" + id + "/bid:";
        $super();
    },
    onSuperModeChanged: function() {
        this.__refreshAuctions();
    },
    onPowerUserAuctionsUpdate: function() {
        if (this.periodicalExecuter == null && !this.__powersUpdated) {
            this.__powersUpdated = true;
            this.__refreshAuctions();
        }
    },
    onBinUpdate: function(event) {
        if ($('a_' + event.auctionId)) {
            var binIconId = "info_icon_" + event.auctionId + "_8";
            $('a_' + event.auctionId).select('.auction_box_normal_view_auction_pic img').first().insert({
                after: '<div id="' + binIconId + '" class="bin_icn_regular tooltip_icon_feature_8"></div>'
            });
            $(binIconId).observe('click', function(ev) {
                buyItNow(event.auctionId);
            });
        }
    },
    __refreshAuctions: function() {
        if (this.__updatedItems) {
            this.__updatedItems.data.each(function(item) {
                if (typeof itemArray[item.id] == 'undefined' && $('amount_' + item.id + 'c') != null) {
                    itemArray[item.id] = new Auction(item.id);
                }
                if (Auction.exists(item.id)) {
                    itemArray[item.id].refresh(item, this.__updatedItems.now);
                }
            }.bind(this));
        }
    }
});
var DetailsUpdater = Class.create(CoreUpdater, {
    __firstLoad: true,
    __auctionId: null,
    __updatedItems: null,
    initialize: function($super) {
        $super();
        Beezid.info.addListener('superModeChanged', this);
    },
    requestSuccess: function(res) {
        var updatedItems = res.responseText.evalJSON();
        var curTime = new Date(updatedItems.now.replace(/-/gi, "/")).getTime();
        if (nowTimeDetail >= curTime)
            return;
        nowTimeDetail = curTime;
        if (updatedItems.data != null && typeof updatedItems == 'object') {
            updatedItems.auctionId = this.__auctionId;
            this.fireEvent('success', {
                result: updatedItems
            });
            this.__updatedItems = updatedItems;
            this.__refreshAuctions();
        }
        if (!empty(updatedItems.abd)) {
            this.fireEvent('abd', {
                abd: updatedItems.abd
            });
        }
        this.__firstLoad = false;
        if (typeof STOP_DETAILS_UPDATER != 'undefined' && STOP_DETAILS_UPDATER) {
            this.stop();
            return;
        }
    },
    update: function($super) {
        if (typeof aid != 'undefined' && aid > 0) {
            var lastBid = 0;
            this.__auctionId = aid;
            if (!empty(aid) && !undef(itemArray[aid])) {
                lastBid = itemArray[aid].getLastBid();
            } else if (!this.__firstLoad && $$(".bidding_history_column_holder").size()) {
                lastBid = $$(".bidding_history_column_holder")[0].firstDescendant().id.substring(7);
            }
            this.url = '/auctions/updater/id:' + aid + relatedItemsIds + '/bid:' + lastBid;
            $super();
        }
    },
    reloadBids: function() {
        this.__firstLoad = true;
    },
    onSuperModeChanged: function() {
        this.__refreshAuctions();
    },
    __refreshAuctions: function() {
        if (this.__updatedItems) {
            this.__updatedItems.data.each(function(item) {
                if (!Auction.exists(item.id)) {
                    return;
                }
                itemArray[item.id].refreshDetails(item, this.__updatedItems.now);
            }.bind(this));
        }
    }
});
var BarUpdater = Class.create(CoreUpdater, {
    period: 8,
    method: 'post',
    ajaxLockTimeStamp: 0,
    __timeScale: false,
    __abt: false,
    __nt: [],
    __superModetip: null,
    __visiblePowerAuctions: [],
    initialize: function($super) {
        $super();
        this.__setVisiblePowerAuctions();
        (function() {
            if (typeof HomepageRefresherObj != 'undefined') {
                HomepageRefresherObj.addListener('auctionsLoaded', this.onHomepageRefresher, this);
            }
        }).bind(this).defer();
    },
    __setVisiblePowerAuctions: function() {
        this.__visiblePowerAuctions = [];
        if (typeof window.detailsData != 'undefined') {
            for (var auctionId in window.detailsData['Auction']) {
                if (window.detailsData['Auction'].hasOwnProperty(auctionId)) {
                    if ((window.detailsData['Auction'][auctionId].features & 1024) != 0) {
                        this.__visiblePowerAuctions.push(auctionId);
                    }
                }
            }
        } else {
            $$('.auction_feature_1024_icon').each(function(elem) {
                this.__visiblePowerAuctions.push(elem.id.split('_')[2]);
            }.bind(this));
        }
        this.__visiblePowerAuctions = this.__visiblePowerAuctions.uniq().sort().join(":");
    },
    onHomepageRefresher: function() {
        this.__setVisiblePowerAuctions();
    },
    requestEnd: function($super, res) {
        var items = res.responseText.evalJSON();
        var onDetailsPage = !undef(window.detailPageManager);
        var event = items.abu ? 'abupdate' : 'success';
        this.fireEvent(event, items);
        if (onDetailsPage) {
            this.__setRate(!empty(items.abs));
        }
        if ($('total_bids') != null && items.bids.regular != null) {
            $('total_bids').update(formatNumber(items.bids.regular));
            $('total_bids_m') && $('total_bids_m').update(formatNumber(items.bids.regular));
            $('win_bids').update(formatNumber(items.bids.free));
            $('win_bids_m') && $('win_bids_m').update(formatNumber(items.bids.free));
            if ((items.bids.free > 0 || (!undef(items.uinf) && items.uinf.ugw)) && $('hrd_bids_details').hasClassName('hrd_padding')) {
                $('hrd_bids_details').removeClassName('hrd_padding');
                $('win_bids_counter').setStyle({
                    display: 'block'
                });
                $('win_bids_counter_m') && $('win_bids_counter_m').setStyle({
                    display: 'block'
                });
            }
            $('bonus_bids').update(formatNumber(items.bids.bonus));
            $('bonus_bids_m') && $('bonus_bids_m').update(formatNumber(items.bids.bonus));
            $('promo_bids').update(formatNumber(items.bids.promo));
            $('promo_bids_m') && $('promo_bids_m').update(formatNumber(items.bids.promo));
            $('power_bids').update(formatNumber(items.bids.power));
            $('power_bids_m') && $('power_bids_m').update(formatNumber(items.bids.power));
        }
        if (items.abu) {
            return;
        }
        if (undef(items.uinf) || items.uinf.uid.length == 0) {
            Beezid.info.logout();
        } else if (!Beezid.info.loggedIn()) {
            Beezid.info.setLogin(items.uinf.uid, null, items.uinf.ufname, item.uinf.usid);
        }
        if (Beezid.info.getStatusId() != items.uinf.usid) {
            Beezid.info.updateStatus(items.uinf.usid);
        }
        if (onDetailsPage && !undef(items.placed_bids)) {
            detailPageManager.updateBidsPlaced(items.placed_bids);
        }
        if (!empty(items.status)) {
            Beezid.statusManager.updateCounter(items.status);
        }
        if (typeof items.super_mode != 'undefined') {
            Beezid.info.setSuperMode(items.super_mode);
        }
        $super();
    },
    update: function($super, minimal) {
        var id, param = [];
        if (typeof TEMPLATE != 'undefined' && TEMPLATE == 'mega') {
            param.push('template=mega');
        } else if (typeof aid != 'undefined') {
            param.push('aid=' + aid);
        }
        if (this.__timeScale || minimal === 1) {
            if (this.__abt || minimal === 1) {
                param.push('abt=1');
            }
            this.__abt = !(this.__abt);
        }
        p = param.length && '?' + param.join('&') || '';
        this.url = "/bar" + p;
        $super();
    },
    getParams: function() {
        var params = {};
        if (!empty(this.__nt)) {
            var p = [];
            while (this.__nt.length) {
                var s = this.__nt.shift(),
                    l = s[1] || window.location.pathname,
                    m = /^https?:\/\/[^/]*(\/[^?#&]*).*$/.exec(l);
                m && (l = m[1]);
                p.push(s[0] + CryptoJS.MD5(l).toString() + l);
            }
            params['n'] = p.join(':');
        }
        if (!empty(this.__visiblePowerAuctions)) {
            params['paids'] = this.__visiblePowerAuctions;
        }
        return params;
    },
    __setRate: function(rate) {
        if (rate != this.__timeScale) {
            this.__timeScale = rate;
            this.stop();
            if (this.__timeScale) {
                this.start(this.period / 2);
            } else {
                this.start(this.period);
            }
        }
    },
    initUI: function() {
        $('theBar').show();
        this.__initLocksPanel();
        if (!empty(Beezid.autobidManager)) {
            Beezid.autobidManager.initDropdown();
        }
        Beezid.wallet.addListener('balanceChanged', function(event) {
            $('bank_balance').update(formatCurrency(event.balance));
            $('bank_balance_m') && $('bank_balance_m').update(formatCurrency(event.balance));
        });
        (function() {
            this.__initSuperMode();
        }).bind(this).defer();
    },
    __initLocksPanel: function() {
        $('hdr_drop_down_lock').observe('click', function(event) {
            this.__updateLockTooltip();
            $('hdr_locks').toggle();
        }.bind(this));
    },
    __updateLockTooltip: function() {
        var currentStamp = (new Date()).getTime() / 1000;
        if (!Beezid.info.loggedIn()) {
            return;
        }
        if (currentStamp - this.ajaxLockTimeStamp < 60) {
            return;
        }
        new Ajax.Request('/my_account/my_locks_count', {
            onCreate: function() {
                $('locks-spinner').setStyle({
                    opacity: 0.4,
                    backgroundPosition: '50% 35%',
                    backgroundImage: 'url(/img/spinner.gif)',
                    backgroundRepeat: 'no-repeat'
                });
                this.ajaxLockTimeStamp = (new Date()).getTime() / 1000;
            }.bind(this),
            onSuccess: function(response) {
                items = JSON.parse(response.responseText);
                for (i in items.locks) {
                    if (items.locks.hasOwnProperty(i) && $('user_' + i + '_lock')) {
                        $('user_' + i + '_lock').update(items.locks[i]);
                    }
                }
            },
            onComplete: function() {
                $('locks-spinner').setStyle({
                    opacity: 1,
                    backgroundImage: null
                });
            }
        });
    },
    __initSuperMode: function() {
        this.onSuperModeChanged();
        Beezid.info.addListener('superModeChanged', this);
        Beezid.info.addListener('superModeUpdateStart', this);
        Beezid.info.addListener('superModeUpdateComplete', this);
        $('super_mode_switch').observe('click', function(event) {
            Beezid.info.toggleSuperMode();
        });
    },
    onSuperModeChanged: function() {
        this.__setSuperModeTip();
    },
    onSuperModeUpdateStart: function() {
        $('super_mode_onoff').addClassName('disabled');
        $('super_mode_checkbox').disable();
    },
    onSuperModeUpdateComplete: function() {
        $('super_mode_onoff').removeClassName('disabled');
        $('super_mode_checkbox').enable();
        this.__setSuperModeTip();
    },
    __setSuperModeTip: function() {
        this.__superModetip = new Tip('super_mode_switch', i18n.super_mode['disabled'].msg.sprintf(buySuperBidsLink), {
            target: 'super_mode_switch',
            title: '<span id="super_mode_tip_title">' + i18n.super_mode['disabled'].title + '</span>',
            closeButton: Beezid.touchEnabled,
            hideOn: false,
            hideAfter: 0.5,
            width: 160,
            hook: {
                target: 'topMiddle',
                tip: 'bottomMiddle'
            },
            stem: {
                position: 'bottomMiddle',
                height: 10,
                width: 20
            },
            offset: {
                x: -2,
                y: -2
            },
            fixed: true,
            style: 'protobzd'
        });
        $(this.__superModetip.wrapper).setStyle({
            position: 'fixed'
        });
        $(this.__superModetip.wrapper).addClassName('statustip');
        $(this.__superModetip.title).setStyle({
            textAlign: 'center'
        });
        this.__superModetip.deactivate();
        if (Beezid.info.isSuperModeActivated()) {
            $('pwr_float').removeClassName('super_mode_off');
            $('super_mode_checkbox').enable().checked = true;
        } else if (Beezid.info.isSuperModeAllowed()) {
            $('pwr_float').addClassName('super_mode_off');
            $('super_mode_checkbox').enable().checked = false;
        } else {
            $('pwr_float') && $('pwr_float').addClassName('super_mode_off');
            $('super_mode_checkbox').disable().checked = false;
            this.__superModetip.activate();
        }
    }
});
var UpdaterManager = Class.create(BeezidObject, {
    AUCTIONS_UPDATER: {
        id: 'auction_updater',
        className: 'AuctionsUpdater'
    },
    DETAILS_UPDATER: {
        id: 'details_updater',
        className: 'DetailsUpdater'
    },
    BAR_UPDATER: {
        id: 'bar_updater',
        className: 'BarUpdater'
    },
    STORE_UPDATER: {
        id: 'store_updater',
        className: 'StoreUpdater'
    },
    instances: {},
    start: function(updater) {
        if (!this.instances[updater.id]) {
            var inst = eval('new ' + updater.className + '()');
            if (updater.id == 'bar_updater') {
                Beezid.__st.__u(inst);
            }
            this.instances[updater.id] = inst;
            return true;
        } else {
            return false;
        }
    },
    restart: function(updater) {
        if (this.instances[updater.id]) {
            this.stop(updater, null);
            this.instances[updater.id] = eval('new ' + updater.className + '()');
            return true;
        } else {
            return false;
        }
    },
    stop: function(updater, message) {
        if (!empty(this.instances[updater.id])) {
            this.instances[updater.id].stop(message);
            delete this.instances[updater.id];
            return true;
        } else {
            return false;
        }
    },
    stopAll: function() {
        for (var key in this.instances) {
            this.instances[key].stop();
            delete this.instances[key];
        }
    },
    get: function(updater) {
        return this.instances[updater.id];
    }
});
var PinManager = Class.create(BeezidObject, {
    __pins: [],
    __ajaxPinLock: {},
    initialize: function($super) {
        $super();
        var barUpdater = updaterManager.get(updaterManager.BAR_UPDATER);
        if (typeof barUpdater != 'undefined') {
            barUpdater.addListener('success', this.onBarUpdate, this);
        }
        if (typeof HomepageRefresherObj != 'undefined') {
            HomepageRefresherObj.addListener('auctionsLoaded', this.onAuctionsLoaded, this);
        }
    },
    getPins: function() {
        return this.__pins;
    },
    onBarUpdate: function(result) {
        if (typeof result.pins != 'undefined') {
            this.updatePins(result.pins);
        }
    },
    __getPinAction: function(id) {
        return (this.__pins.indexOf(id) == -1) ? 'pin' : 'unpin';
    },
    onAuctionsLoaded: function() {
        if (this.__pins.length > 0) {
            this.__pins.each(function(pin) {
                this.addDecorations(pin);
                this.setPinStyle(pin, true);
            }.bind(this));
        }
    },
    updatePins: function(pins) {
        pins.each(function(pin) {
            if (this.__pins.indexOf(pin) == -1) {
                this.__pins.push(pin);
                this.setPinStyle(pin, true);
            }
        }.bind(this));
        var newPins = [];
        this.__pins.each(function(pin) {
            if (pins.indexOf(pin) == -1) {
                this.setPinStyle(pin, false);
            } else {
                newPins.push(pin);
            }
        }.bind(this));
        this.__pins = newPins;
    },
    setPinStyle: function(pinId, isPinned) {
        var pin = $("pin_" + pinId);
        if (pin != null) {
            var oldClassName = pin.className;
            if (isPinned && oldClassName.match('pin_icon_normal')) {
                var newClassName = oldClassName.replace('pin_icon_normal', 'pin_icon_over');
            } else if (!isPinned && oldClassName.match('pin_icon_over')) {
                var newClassName = oldClassName.replace('pin_icon_over', 'pin_icon_normal');
            }
            var style = (typeof newClassName != 'undefined') ? pin.addClassName(newClassName).removeClassName(oldClassName) : null;
        }
    },
    addDecorations: function(id) {
        var pin = $('pin_' + id);
        if (pin != null) {
            pin.stopObserving('click');
            pin.observe("click", this.__clickHandler.bind(this));
            pin.setStyle({
                cursor: "pointer"
            });
            this.__createTip(pin);
        }
    },
    updateAllPinsTooltip: function() {
        $$('[id^="pin_"]').each(function(item) {
            var pinId = item.id;
            if ($(pinId).prototip !== null && typeof $(pinId).prototip !== 'undefined' && typeof $(pinId).prototip.remove === "function") {
                $(pinId).prototip.remove();
            }
            this.addDecorations(pinId.substring(4));
        }.bind(this));
    },
    __clickHandler: function(event) {
        var auctionId = event.target.id.substr(4);
        var action = this.__getPinAction(auctionId);
        Beezid.touchEnabled && hideAllToolTip();
        if (Beezid.info.loggedIn() && (typeof this.__ajaxPinLock[auctionId] === 'undefined' || !this.__ajaxPinLock[auctionId])) {
            this.__ajaxPinLock[auctionId] = true;
            new Ajax.Request('/auctions/' + action, {
                method: "post",
                requestHeaders: {
                    'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Prototype-Version': Prototype.Version,
                    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                    'Cache-control': 'no-cache'
                },
                parameters: {
                    ids: auctionId
                },
                onComplete: function(res) {
                    this.__ajaxPinLock[auctionId] = false;
                    if (res.responseText) {
                        var data = res.responseText.evalJSON();
                        if (data.isPinned) {
                            this.setPinStyle(auctionId, true);
                            this.__pins.push(auctionId);
                        } else {
                            this.setPinStyle(auctionId, false);
                            this.__pins.splice(this.__pins.indexOf(auctionId), 1);
                        }
                    }
                }.bind(this)
            });
        } else {
            if (event.target.className.match('pin_icon_normal')) {
                this.setPinStyle(auctionId, true);
            } else {
                this.setPinStyle(auctionId, false);
            }
        }
    },
    __createTip: function(pinEl) {
        if (TEMPLATE == 'mega') {
            var hookOptions = {
                target: 'topMiddle',
                tip: 'bottomLeft'
            };
            var stemOptions = {
                position: 'bottomLeft',
                height: 10,
                width: 26
            };
            xValue = -18;
            yValue = -2;
        } else {
            var screenWidth = document.documentElement.clientWidth;
            if (pinEl.getBoundingClientRect().left < 100) {
                var hookOptions = {
                    target: 'topRight',
                    tip: 'bottomLeft'
                };
                var stemOptions = {
                    position: 'bottomLeft',
                    height: 10,
                    width: 26
                };
                xValue = -28;
                yValue = -5;
            } else if (screenWidth - pinEl.getBoundingClientRect().right < 200) {
                var hookOptions = {
                    target: 'topLeft',
                    tip: 'bottomRight'
                };
                var stemOptions = {
                    position: 'bottomRight',
                    height: 10,
                    width: 26
                };
                xValue = 25;
                yValue = -3;
            } else {
                var hookOptions = {
                    target: 'topMiddle',
                    tip: 'bottomMiddle'
                };
                var stemOptions = {
                    position: 'bottomMiddle',
                    height: 10,
                    width: 20
                };
                xValue = -1;
                yValue = -1;
            }
        }
        showTooltip({
            id: pinEl.id,
            message: i18n.beezid.pin_an_auction,
            title: i18n.beezid.pin_an_auction_title,
            closeButton: Beezid.touchEnabled,
            hideOn: false,
            hideAfter: Beezid.touchEnabled ? 15 : 1,
            delay: 0.2,
            offset: {
                x: xValue,
                y: yValue
            },
            width: 160,
            height: 'auto',
            hook: hookOptions,
            stem: stemOptions,
            style: 'protobzd'
        });
    }
});
var NotificationsManager = Class.create(BeezidObject, {
    __barMsg: 0,
    __barAlert: 0,
    __hasUnreadMessages: false,
    __hasUnreadAlerts: false,
    alreadyReadCantMissIt: {},
    initialize: function($super) {
        $super();
        var barUpdater = updaterManager.get(updaterManager.BAR_UPDATER);
        if (typeof barUpdater != 'undefined') {
            barUpdater.addListener('success', this.onBarUpdate, this);
        }
    },
    onBarUpdate: function(result) {
        if ($('theBar') == null) {
            return;
        }
        if (typeof result.data != 'undefined') {
            result.data.each(function(item) {
                if (item.type != null && item.type !== false) {
                    if (item.type == 'DirectMessages' || (item.type == 'CantMissIt' && window.location.pathname != '/checkout') || item.type == 'ReadIt' || item.type == 'TopBanner') {
                        this.displayNotification(item);
                    }
                    if (item.type == 'Messages' && $('messTextNum')) {
                        if (item.cnt || (item.cnt != this.__barMsg)) {
                            $('messTextNum').update(item.cnt);
                            if (item.cnt > this.__barMsg) {
                                this.__barMsg = item.cnt;
                                this.__hasUnreadMessages = true;
                                Effect.Pulsate('messButt', {
                                    pulses: 10,
                                    duration: 3
                                });
                            }
                            $('messText').show();
                        } else {
                            $('messText').hide();
                        }
                    }
                    if (item.type == 'Alerts') {
                        if (item.cnt || (item.cnt != this.__barAlert)) {
                            $('alertTextNum').update(item.cnt);
                            if (item.cnt > this.__barAlert) {
                                this.__barAlert = item.cnt;
                                this.__hasUnreadAlerts = true;
                                Effect.Pulsate('alertButt', {
                                    pulses: 10,
                                    duration: 3
                                });
                            }
                            $('alertText').show();
                        } else {
                            $('alertText').hide();
                        }
                    }
                    if (item.type == 'Tooltip') {
                        Beezid.statusManager.showNotification(item);
                    }
                }
            }.bind(this));
        }
        if (typeof result.pins != 'undefined' && result.pins.length > 0) {
            $('pinTextNum').update(result.pins.length);
            $('pinText').show();
        } else {
            $('pinText').hide();
        }
    },
    displayNotification: function(item) {
        var action = '';
        var cantMissDirection = null;
        if (item.action == null) {
            action = item.message;
        } else {
            if (item.action.blank()) {
                action = item.message;
            } else {
                action = "<a href=" + item.action + "/" + item.id + ">" + item.message + "</a>";
            }
        }
        switch (item.type) {
            case 'DirectMessages':
                markRead(item.id);
                $("flash_error").update(action);
                $("flash_msg").show();
                break;
            case 'CantMissIt':
                var cantMissItWasNotRead = true;
                if (typeof this.alreadyReadCantMissIt[item.id] != 'undefined') {
                    cantMissItWasNotRead = false;
                }
                if (cantMissItWasNotRead && $(item.position) == null) {
                    this.displayCantMiss(item.position, item.design, action, item.id, item.ttl);
                    if (item.buy_type == 'buy_super_bids') {
                        Beezid.info._defaultBuyBidsURL = buySuperBidsURL;
                        Beezid.info.setBuyBidsURL(buySuperBidsURL);
                    }
                }
                break;
            case 'ReadIt':
                if ($('read-it-dialog') == null) {
                    if (action.startsWith('BEEZID::URL=')) {
                        this.displayReadItFromAjax(action, item.id);
                    } else {
                        this.displayReadItContent(action, item.id);
                    }
                }
                break;
            case 'TopBanner':
                if ($('header_top_banner') !== null && $('header_top_banner').innerHTML == '') {
                    if (action.startsWith('BEEZID::URL=')) {
                        this.displayAjaxTopBanner(action, item.id);
                    }
                }
                break;
        }
        if (typeof IdleManager != 'undefined') {
            IdleManager.reset();
        }
        if (typeof window.refresher != 'undefined') {
            window.refresher.reset();
        }
    },
    displayCantMiss: function(position, style, content, id, ttl) {
        if (position == 'dont_miss_tl' || position == 'dont_miss_tr') {
            textStyle = 'dont_miss_content_top';
        } else {
            textStyle = 'dont_miss_content';
        }
        var cantMissIt = '<div class="' + style + ' dont_miss_img"><div class="btn close btn_dontmissit" id="close' + position + '"><i class="icon icon-close"></i></div><div class="' + textStyle + '">' + content + '</div></div>';
        var cantMissDiv = document.createElement('div');
        document.body.appendChild(cantMissDiv);
        cantMissDiv.setAttribute('id', position);
        cantMissDiv.hide();
        cantMissDiv.update(cantMissIt);
        if (ttl != false) {
            var cantMissTimeout = setTimeout(function() {
                if ($('close' + position)) {
                    $('close' + position).click();
                }
            }, ttl * 1000);
        }
        $$('#close' + position, '#add_to_cart_modal').invoke('observe', 'click', function() {
            if (cantMissTimeout) {
                clearTimeout(cantMissTimeout);
            }
            Effect.Fade($(position), {
                duration: 0.7,
                afterFinish: function() {
                    markRead(id);
                    $(position).remove();
                    this.alreadyReadCantMissIt[id] = true;
                }.bind(this)
            });
        }.bind(this));
        cantMissDiv.addClassName(position);
        Effect.Appear($(position), {
            duration: 0.7
        });
    },
    displayReadItContent: function(content, id) {
        new Dialog({
            id: 'read-it-dialog',
            center: true,
            text: content + '<br /><br />I confirm I have read, understood and accepted the above information.',
            okText: 'I agree',
            noClose: true,
            listeners: {
                dialogResult: function(event) {
                    if (event.dialogResult.status == 'ok') {
                        markRead(id);
                    }
                }
            }
        }).run();
    },
    displayReadItFromAjax: function(file, id) {
        new UrlPopup({
            url: '/toberead/' + id + '/' + file.sub('BEEZID::URL=', '') + '?v1',
            id: 'read-it-dialog',
            classNames: ["modalbox_drp"],
            afterLoad: function() {
                new Button({
                    elem: $('modal_close'),
                    action: function() {
                        this.destroy();
                    }.bind(this)
                });
            }
        }).run();
    },
    displayAjaxTopBanner: function(file, id) {
        new Ajax.Request('/toberead/' + id + '/' + file.sub('BEEZID::URL=', ''), {
            method: 'get',
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            onComplete: function(res) {
                $('header_top_banner').update(res.responseText);
            }
        });
    },
    updateAlerts: function() {
        if (this.__hasUnreadAlerts) {
            this.__hasUnreadAlerts = false;
            new Ajax.Request("/notifications/display_messages_bar/al/ajax", {
                method: 'get',
                requestHeaders: {
                    'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Prototype-Version': Prototype.Version,
                    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                    'Cache-control': 'no-cache'
                },
                onCreate: function() {
                    $('alertbox').update('<center>Please Wait...</center>');
                },
                onComplete: function(res) {
                    if ($('theBar') != null) {
                        $('alertbox').update();
                        var items = res.responseText.evalJSON();
                        items.each(function(item) {
                            var action = item.message;
                            if (item.type == null || item.type === false) {
                                return;
                            }
                            if (!item.action.blank()) {
                                action = "<a href=" + item.action + "/" + item.id + ">" + item.message + "</a>";
                            }
                            if (!item.message.blank() && item.type == 'Alerts') {
                                $('alertbox').insert("<div id='mess_" + item.id + "' class='nbar_btn_menu_content_msg_entry'><p class='nbar_alert'>" + action + "</p><div class='btn close' onclick='markRead(" + item.id + ");'><i class='icon icon-close'></i></div><div class='clear'></div></div>");
                            }
                        });
                    }
                }
            });
        }
    },
    updateMsgs: function() {
        if (this.__hasUnreadMessages) {
            this.__hasUnreadMessages = false;
            new Ajax.Request("/notifications/display_messages_bar/ms/ajax", {
                method: 'get',
                requestHeaders: {
                    'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Prototype-Version': Prototype.Version,
                    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                    'Cache-control': 'no-cache'
                },
                onCreate: function() {
                    $('msgbox').update('<center>Please Wait...</center>');
                },
                onComplete: function(res) {
                    if ($('theBar') != null) {
                        $('msgbox').update();
                        var items = res.responseText.evalJSON();
                        items.each(function(item) {
                            var action = '';
                            if (item.type == null || item.type === false) {
                                return;
                            }
                            if (item.action == null) {
                                action = item.message;
                            } else {
                                if (item.action.blank()) {
                                    action = item.message;
                                } else {
                                    action = "<a href=" + item.action + "/" + item.id + ">" + item.message + "</a>";
                                }
                            }
                            if (!item.message.blank() && (item.type == 'Messages' || item.type == 'Announcements')) {
                                $('msgbox').insert("<div id='mess_" + item.id + "' class='nbar_btn_menu_content_msg_entry'><i class='icon icon-ok-color'></i><p>" + action + "</p><div class='btn close' onclick='markRead(" + item.id + ");'><i class='icon icon-close'></i></div><div class='clear'></div></div>");
                            }
                        });
                    }
                }
            });
        }
    }
});
var FormInputValidator = Class.create({
    initialize: function(config) {
        this._lastIsUniqueValue = null;
        this.validationPassed = true;
        this.asyncValidationPassed = true;
        this.elementId = config.elementId;
        this.field = config.field;
        if (config.messageDivId) {
            this.messageDivId = config.messageDivId;
        } else {
            this.messageDivId = this.elementId + '_error';
        }
        this.rules = config.rules;
        this.messageDivErrorClass = 'error-message-wrong';
        this.messageDivSuccessClass = 'error-message-valid';
        if (config.syncKeyPressDelay) {
            this.syncKeyPressDelay = config.syncKeyPressDelay;
        } else {
            this.syncKeyPressDelay = 500;
        }
        if (config.asyncKeyPressDelay) {
            this.asyncKeyPressDelay = config.asyncKeyPressDelay;
        } else {
            this.asyncKeyPressDelay = 800;
        }
        var formInputValidatorScope = this;
        initFuncs.push(function() {
            if ($(formInputValidatorScope.elementId) != null) {
                $(formInputValidatorScope.elementId).observe('keyup', formInputValidatorScope.validateOnKeyPressDelayed.bind(formInputValidatorScope));
            }
        });
    },
    validateOnKeyPressDelayed: function() {
        var elementScope = this;
        if (this.syncTimer) {
            clearTimeout(elementScope.syncTimer);
        }
        this.syncTimer = setTimeout(function() {
            elementScope.syncValidate();
        }, this.syncKeyPressDelay);
        if (this.asyncTimer) {
            clearTimeout(elementScope.asyncTimer);
        }
        this.asyncTimer = setTimeout(function() {
            elementScope.asyncValidate();
        }, this.asyncKeyPressDelay);
    },
    syncValidate: function() {
        if (this.asyncValidationPassed) {
            $(this.messageDivId).update().hide();
        }
        var value = $(this.elementId).getValue();
        this.validationPassed = true;
        if (this.validationPassed && this.rules.notEmpty) {
            this.validationPassed = this.validateNotEmpty(value);
        }
        if (this.validationPassed && this.rules.between) {
            this.validationPassed = this.validateBetween(value);
        }
        if (this.validationPassed && this.rules.isAlphaNumeric) {
            this.validationPassed = this.validateIsAlphaNumeric(value);
        }
        if (this.validationPassed && this.rules.email) {
            this.validationPassed = this.validateEmail(value);
        }
        if (!this.validationPassed) {
            $(this.messageDivId).removeClassName(this.messageDivSuccessClass);
            $(this.messageDivId).addClassName(this.messageDivErrorClass);
            $(this.messageDivId).show();
        }
        return this.validationPassed;
    },
    asyncValidate: function() {
        var value = $(this.elementId).getValue();
        if (this.validationPassed && this.rules.isUnique) {
            this.validateIsUnique(value);
        }
    },
    validateNotEmpty: function(value) {
        if (value == '') {
            $(this.messageDivId).update(this.rules.notEmpty.message);
            return false;
        }
        return true;
    },
    validateBetween: function(value) {
        if (value.length > this.rules.between.end || value.length < this.rules.between.start) {
            $(this.messageDivId).update(this.rules.between.message);
            return false;
        }
        return true;
    },
    validateIsUnique: function(value) {
        if (this._lastIsUniqueValue == value) {
            return;
        }
        this._lastIsUniqueValue = value;
        var fieldName = this.field;
        var messageDivSuccessClass = this.messageDivSuccessClass;
        var messageDivErrorClass = this.messageDivErrorClass;
        var messageDivId = this.messageDivId;
        var validMessage = this.rules.isUnique.validMessage;
        new Ajax.Request(this.rules.isUnique.url + '/' + value, {
            method: 'get',
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            onComplete: function(result) {
                var res = result.responseText.evalJSON();
                if (res) {
                    if (res.success) {
                        $(messageDivId).removeClassName(messageDivErrorClass);
                        $(messageDivId).addClassName(messageDivSuccessClass);
                        $(messageDivId).update(validMessage);
                        $(messageDivId).show();
                        this.asyncValidationPassed = true;
                    } else if (res[fieldName]) {
                        $(messageDivId).removeClassName(messageDivSuccessClass);
                        $(messageDivId).addClassName(messageDivErrorClass);
                        $(messageDivId).update(res[fieldName]);
                        $(messageDivId).show();
                        this.asyncValidationPassed = false;
                    }
                } else {
                    $(messageDivId).hide();
                }
            }.bind(this)
        });
    },
    validateIsAlphaNumeric: function(value) {
        if (!(/^[a-z0-9]+$/i.test(value))) {
            $(this.messageDivId).update(this.rules.isAlphaNumeric.message);
            return false;
        }
        return true;
    },
    validateEmail: function(value, updateDiv) {
        if (undef(updateDiv)) {
            updateDiv = true;
        }
        if (!/^[0-9a-z_]([-_.]?[0-9a-z])*@[0-9a-z][-.0-9a-z]*\.[a-z]{2,3}[.]?$/i.test(value)) {
            if (updateDiv) {
                $(this.messageDivId).update(this.rules.email.message);
                $(this.messageDivId).show();
            }
            return false;
        }
        return true;
    }
});
var REGULAR = 1;
var VIRGIN = 2;
var THRILLER = 3;
var BID_FOR_FREE = 5;
var STATUS_ACTIVE = 1;
var CLOSED = 4;
var STATUS_PAUSED = 5;
var STANDBY = 6;
var idString;
var TEMPLATE = "";
var nowTime = 0;
var nowTimeDetail = 0;
var useUpdater = false;
var clickTarget = false;
var updateCounter = 0;
var mCat = 3;
var NON_NUMERIQUE_PATTERN = /[^\d]/g;
var SIMPLE_PC_PATTERN = /^[0-9A-Za-z]{1}[0-9A-Za-z-\s]{3,10}/;
var blankImage = 'blank.gif';
var isAnAuctionPage = true;
var bidLockTimeout = 0;
var EMAIL_REGEX = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
var countdownRegistry = [];

function updatePwdStrength(pw, container, elem, setColor) {
    if (typeof container === 'undefined') {
        container = 'psContainer';
    }
    if (typeof elem === 'undefined') {
        elem = 'psStrength';
    }
    var strength = getPwdStrength(pw);
    var width = ($(container).getWidth() / 100) * strength;
    var color = '';
    if (!empty(setColor)) {
        var cs = parseInt(strength * 0.7);
        color = '; background: rgb(' + (100 - cs) + '%, ' + (30 + cs) + '%, 0%)';
    }
    if (width >= $(container).getWidth()) {
        width = $(container).getWidth();
    }
    new Effect.Morph(elem, {
        style: 'width:' + width + 'px' + color,
        duration: '0.4'
    });
};

function getPwdStrength(passwd) {
    var intScore = 0;
    var symbols = /[!,@#$%^&*?_~:()+<>{}[;"`.=]/;
    var doubleSymbols = /([!,@#$%^&*?_~:()+<>{}[;"`.=].*[!,@#$%^&*?_~:()+<>{}[;"`.=])/;
    intScore = intScore + (4 * (passwd.length));
    if (passwd.match(/[a-z]/)) {
        intScore = (intScore + 7.5);
    }
    if (passwd.match(/[A-Z]/)) {
        intScore = (intScore + 7.5);
    }
    if (passwd.match(/\d+/)) {
        intScore = (intScore + 15);
    }
    if (passwd.match(/(\d.*\d)/)) {
        intScore = (intScore + 10);
    }
    if (passwd.match(symbols)) {
        intScore = (intScore + 15);
    }
    if (passwd.match(doubleSymbols)) {
        intScore = (intScore + 15);
    }
    if (passwd.match(/[a-z]/) && passwd.match(/[A-Z]/) && passwd.match(/\d/) && passwd.match(symbols)) {
        intScore = (intScore + 20);
    }
    return intScore;
};

function idleEncode(str) {
    str = str.toString();
    var enc = "";
    var i;
    for (i = 0; i < str.length; i++) {
        enc += str.charCodeAt(i).toString(16);
    }
    return enc;
}

function basename(path) {
    return path.replace(/.*\//, "");
}

function dirname(path) {
    return path.match(/.*\//);
}

function zeroPad(n, len) {
    var res = n.toString();
    len -= res.length;
    while (len-- > 0) {
        res = '0' + res;
    }
    return res;
}

function checkImg(url) {
    var image = new Image();
    image.onError = function() {
        this.src = dirname(url) + blankImage;
    };
    image.src = url;
    return image;
}

function toggleItemClasses(el, cOut, cOver, clickAction, clickLimit) {
    if ($(el) == null) {
        return;
    }
    if (typeof clickAction == 'undefined' || !clickAction) {
        $(el).setStyle({
            cursor: 'default'
        });
        $(el).stopObserving('click');
    } else {
        $(el).stopObserving('click');
        var clickCount = 1;
        $(el).observe('click', function(e) {
            if (typeof clickLimit != 'undefined' && clickLimit < clickCount) {
                return;
            }
            clickTarget = e.target.id;
            eval(clickAction);
            clickCount++;
        });
    }
    if (typeof cOver == 'undefined' || !cOver) {
        $(el).stopObserving();
        $w($(el).className).each(function(cls) {
            $(el).removeClassName(cls);
        });
        $(el).addClassName(cOut);
        return;
    }
    $(el).stopObserving('mouseover');
    $(el).stopObserving('mouseout');
    $(el).addClassName(cOut);
    $(el).observe('mouseover', function() {
        $(el).addClassName(cOver);
        $(el).removeClassName(cOut);
    });
    $(el).observe('mouseout', function() {
        $(el).addClassName(cOut);
        $(el).removeClassName(cOver);
    });
}

function setClickedTemplate(btn_bid_id) {
    if ($('amount_' + btn_bid_id).next() && $('amount_' + btn_bid_id).next().id == 'bidder_name' + btn_bid_id) {
        TEMPLATE = 'regular';
    } else {
        TEMPLATE = 'easy';
    }
    if ($('content_big_details') != null) {
        TEMPLATE = 'detail';
    }
    if ($('amount_' + btn_bid_id).hasClassName('auction_box_mega_view_auction_price')) {
        TEMPLATE = 'mega';
    }
    clickTarget = false;
}

function remindUser(id) {
    var btn_bid_id = id;
    if (clickTarget == 'btn_bid_' + id + 'c') {
        btn_bid_id = id + 'c';
    }
    setClickedTemplate(btn_bid_id);
    new Ajax.Request('/reminders/setReminder/' + id, {
        method: 'post',
        requestHeaders: {
            'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
            'X-Requested-With': 'XMLHttpRequest',
            'X-Prototype-Version': Prototype.Version,
            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
            'Cache-control': 'no-cache'
        },
        onComplete: function(result) {
            var res = result.responseText.evalJSON();
            if (res == 18) {
                reaction(id, TEMPLATE, 'green');
                $('react_' + id).update(i18n.beezid.reminder_already_set);
            } else if (!res) {
                reaction(id, TEMPLATE, 'red');
                $('react_' + id).update(i18n.beezid.reminder_problem);
            } else if (res == 1) {
                reaction(id, TEMPLATE, 'green');
                $('react_' + id).update(i18n.beezid.reminder_set);
            }
        }
    });
}
if (typeof bidLock != 'undefined' && bidLock === true) {
    var bidLocking = true;
    var blLock = new Array();
    bidLock = function(id, lock) {
        if (lock == true) {
            if (blLock.indexOf(id) != -1) {
                return true;
            } else {
                blLock.push(id);
                return false;
            }
        } else {
            if (blLock.indexOf(id) == -1) {
                return false;
            } else {
                blLock.splice(blLock.indexOf(id), 1);
            }
        }
    };
} else {
    var bidLocking = false;
    bidLock = function(id, lock) {
        return false;
    };
}

function placeBid(id) {
    var btn_bid_id = id;
    if (clickTarget == 'btn_bid_' + id + 'c') {
        btn_bid_id = id + 'c';
    }
    setClickedTemplate(btn_bid_id);
    if ($('amount_' + btn_bid_id).hasClassName('ml_price')) {
        trackEvent('rel_auctions', 'bid_click', null, null, function() {});
    }
    if (itemArray[id].itemStatus != 1 || (itemArray[id].opensIn > 0)) {
        reaction(btn_bid_id, TEMPLATE, 'green');
        $('react_' + btn_bid_id).update(i18n.beezid.auction_not_open);
        setTimeout("$('tip_" + btn_bid_id + "').dropOut()", 1000);
        return;
    }
    if (Beezid.info.getUid() == itemArray[id].highestBidder && bidLocking === true) {
        reaction(btn_bid_id, TEMPLATE, 'green');
        $('react_' + btn_bid_id).update(i18n.beezid.you_highest_bidder);
        setTimeout("$('tip_" + btn_bid_id + "').dropOut()", 1000);
        return;
    }
    if (bidLock(id, true)) {
        reaction(btn_bid_id, TEMPLATE, 'green');
        $('react_' + btn_bid_id).update(i18n.beezid.processing_your_bid);
        setTimeout("$('tip_" + btn_bid_id + "').dropOut()", 1000);
        if (bidLockTimeout == 0) {
            bidLockTimeout = setTimeout(function() {
                bidLock(id, false);
            }, 3000);
        }
        return;
    }
    new Ajax.Request('/auctions/process_bid', {
        method: 'post',
        requestHeaders: {
            'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
            'X-Requested-With': 'XMLHttpRequest',
            'X-Prototype-Version': Prototype.Version,
            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
            'Cache-control': 'no-cache'
        },
        parameters: {
            id: id
        },
        onCreate: function() {
            bidLock(id, true);
        },
        onFailure: function() {
            bidLock(id, false);
            reaction(btn_bid_id, TEMPLATE, 'green');
            $('react_' + btn_bid_id).update(i18n.beezid.place_bid_error);
        },
        onSuccess: function(result) {
            if (bidLockTimeout != 0) {
                bidLockTimeout = 0;
            }
            bidLock(id, false);
            var res = result.responseText.evalJSON();
            if (!res.canBid) {
                if (res.error_id == 1 || res.error_id == 10 || res.error_id == 11 || res.error_id == 27 || res.error_id == 33) {
                    displayBuyBidsDialog('place_bid_' + res.error_id, {
                        title: i18n.dialog.title_buy_bids,
                        text: res.message
                    });
                } else if (res.error_id == PRE_BID_WARNING) {
                    var msgParams = {
                        title: res.title,
                        text: res.message,
                        btn_content: res.btn_content
                    };
                    msgParams["remember_check_id"] = typeof res.remember_check_id !== "undefined" ? res.remember_check_id : null;
                    displayPreBidDialog('place_bid_' + res.error_id, msgParams);
                } else if (res.error_id == INCOMPLETE_REG) {
                    displayCompleteRegistrationDialog(res.message);
                } else {
                    var dropOutTime = 1000;
                    reaction(btn_bid_id, TEMPLATE, 'green');
                    if (res.error_id == 12) {
                        $('react_' + btn_bid_id).update(res.message + '<br /><a href="/my_account/my_wins">Claim Now!</a>');
                        dropOutTime = 6000;
                    } else {
                        $('react_' + btn_bid_id).update(res.message);
                    }
                    if (res.error_id == 21 || res.error_id == 23 || res.error_id == 24 || res.error_id == 30 || res.error_id == 35) {
                        dropOutTime = 3000;
                    }
                    setTimeout("$('tip_" + btn_bid_id + "').dropOut()", dropOutTime);
                }
            } else {
                if ($('total_bids') != null && typeof res.btid != 'undefined') {
                    var bidTypes = {
                        1: 'total_bids',
                        4: 'bonus_bids',
                        9: 'promo_bids',
                        11: 'win_bids',
                        12: 'power_bids'
                    };
                    for (var bidTypeId in bidTypes) {
                        if (bidTypes.hasOwnProperty(bidTypeId) && !undef(res.btid[bidTypeId])) {
                            var bidsEl = $(bidTypes[bidTypeId]);
                            if (bidsEl) {
                                bidsEl.update(formatNumber(parseInt(bidsEl.innerHTML.replace(/,/g, '')) - res.btid[bidTypeId]));
                            }
                            var bidsEl = $(bidTypes[bidTypeId] + '_m');
                            if (bidsEl) {
                                bidsEl.update(formatNumber(parseInt(bidsEl.innerHTML.replace(/,/g, '')) - res.btid[bidTypeId]));
                            }
                        }
                    }
                    if (typeof Beezid.activeAuctionManager != 'undefined') {
                        Beezid.activeAuctionManager.add(id);
                    }
                }
                if (res.error_id == 25) {
                    reaction(btn_bid_id, TEMPLATE, 'green');
                    $('react_' + btn_bid_id).update(res.message);
                    setTimeout("$('tip_" + btn_bid_id + "').dropOut()", 3000);
                }
                if (res.error_id == 28 || res.error_id == 34) {
                    displayPreBidDialog('place_bid_' + res.error_id, {
                        title: 'Autobeezid Alert',
                        text: res.error_id == 28 ? res.message.sprintf(buyBidsLink) : res.message.sprintf(buySuperBidsLink),
                        btn_content: i18n.dialog.btn_react_close
                    });
                }
                if (typeof res.bid_amount != 'undefined') {
                    if (typeof detailPageManager == 'object' && id == aid) {
                        if ($("details_savings_ajax")) {
                            $('placed_bids_line').show();
                        }
                        var regularBids = 0,
                            freeBids = 0;
                        for (var bidType in res.btid) {
                            if (res.btid.hasOwnProperty(bidType)) {
                                regularBids = regularBids + res.btid[bidType];
                                if (bidType != 1 && bidType != 9 && bidType != 12) {
                                    freeBids = freeBids + res.btid[bidType];
                                }
                            }
                        }
                        if (typeof detailsData != 'undefined' && typeof detailsData.Auction[aid] != 'undefined') {
                            detailsData.Auction[aid].Savings.bids = detailsData.Auction[aid].Savings.bids + regularBids;
                            detailsData.Auction[aid].Savings.free_bids = detailsData.Auction[aid].Savings.free_bids + freeBids;
                            detailsData.Auction[aid].bid_amount = parseFloat(res.bid_amount);
                            detailPageManager.updateSavings();
                        }
                    }
                }
            }
        },
        onException: function() {
            bidLock(id, false);
        }
    });
}

function displayBuyBidsDialog(id, options) {
    if (typeof $$$(id) != 'undefined') {
        $$$(id).close();
    }
    var confirmationDialog = new Dialog({
        id: id,
        modal: false,
        dialogType: 'custom',
        title: options.title,
        text: options.text,
        buttons: [{
            type: 'button',
            name: 'button_buy_bids',
            content: i18n.dialog.btn_buy_bids
        }],
        listeners: {
            dialogResult: function(event) {
                if (event.dialogResult.status == 'button_buy_bids') {
                    window.location = (id == 'place_bid_33' ? buySuperBidsURL : buyBidsURL);
                }
            }
        }
    }).run();
}

function displayCompleteRegistrationDialog(msgText) {
    $$$('dlg_reg_complete') && $$$('dlg_reg_complete').destroy();
    var completeRegDialog = new Dialog({
        id: 'dlg_reg_complete',
        modal: false,
        dialogType: 'custom',
        title: i18n.dialog.title_complete_reg,
        text: msgText,
        buttons: [{
            type: 'button',
            content: 'Cancel',
            name: 'cancel',
            classNames: ['btn', 'dlg_btn', 'dlg_cancel']
        }, {
            type: 'button',
            name: 'continue',
            content: i18n.dialog.btn_continue
        }],
        listeners: {
            dialogResult: function(event) {
                if (event.dialogResult.status == 'continue') {
                    window.location = completeRegURL;
                }
            }
        }
    }).run();
}

function displayPreBidDialog(id, options) {
    if (typeof $$$(id) != 'undefined') {
        $$$(id).close();
    }
    if (empty(options.title)) {
        options.title = i18n.dialog.title_did_you_know;
    }
    if (empty(options.btn_content)) {
        options.btn_content = i18n.dialog.btn_got_it;
    }
    if (!empty(options.remember_check_id)) {
        options.text += '<br/><br/>' + '<label class="dialog-check">' + '<input id="' + options.remember_check_id + '" type="checkbox" />' + i18n.dialog.chk_remeber_skip + '</label>';
    }
    var confirmationDialog = new Dialog({
        modal: false,
        dialogType: 'custom',
        title: options.title,
        text: options.text,
        buttons: [{
            type: 'button',
            content: options.btn_content,
            name: 'button_ok',
            classNames: ['btn', 'dlg_btn', 'dlg_cancel']
        }],
        listeners: {
            dialogResult: function(event) {
                if (event.dialogResult.status == 'button_ok' && $$('[id^="skip_prebid_"]').length) {
                    var rememberCheckEl = $$('[id^="skip_prebid_"]')[0],
                        skipValue = rememberCheckEl.checked,
                        skipMessageSettingId = rememberCheckEl.id.split('_').pop();
                    if (!skipValue) {
                        return;
                    }
                    new Ajax.Request('/my_account/skip_message/' + skipMessageSettingId, {
                        method: 'post',
                        requestHeaders: {
                            'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-Prototype-Version': Prototype.Version,
                            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                            'Cache-control': 'no-cache'
                        },
                        parameters: {
                            'skip_value': 1
                        }
                    });
                }
            }
        }
    }).run();
}

function formatNumber(value, separator) {
    if (undef(separator)) {
        separator = ',';
    }
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, separator);
}

function formatCurrency(num, supTag) {
    var result = '';
    if (undef(num) || num == null) {
        num = 0;
    }
    num = num.toString().replace(/\$|\,/g, '');
    if (isNaN(num)) {
        num = "0";
    }
    if (num != (num = Math.abs(num))) {
        result = '-';
    }
    num = Math.floor(num * 100 + 0.50000000001);
    var cents = num % 100;
    num = Math.floor(num / 100).toString();
    if (cents < 10) {
        cents = "0" + cents;
    }
    num = formatNumber(num, i18n.beezid.currency_number_separator);
    result = result + i18n.beezid.currency_sign + num + '%s' + i18n.beezid.currency_decimal_separator + cents + '%/s';
    if (!empty(supTag)) {
        result = result.gsub('%s', '<sup>').gsub('%/s', '</sup>');
    } else {
        result = result.gsub('%s', '').gsub('%/s', '');
    }
    return result;
}

function currencyValue(val) {
    val = Number(val);
    val = isNaN(val) ? 0 : val;
    return Math.round(val, 2);
}

function currencyNormalize(val) {
    return currencyValue(val).toFixed(2);
}

function refer() {
    var uid = gup('ref');
    var cid = gup('utm_campaign');
    if (uid == '') {
        return "";
    } else {
        if (uid != '' && uid != '1m9ryunbwlb' && cid.indexOf('RAF') === 0 && readCookie('partner_uid') != 'done') {
            createCookie('partner_uid', uid, 180);
        }
        return "saved";
    }
}

function gup(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href);
    if (results == null)
        return "";
    else
        return results[1];
}

function createCookie(name, value, days, domainPrefix) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    } else var expires = "";
    if (typeof domainPrefix === 'undefined') {
        domainPrefix = '';
    }
    var domain = domainPrefix + '.' + window.location.hostname.replace(/^(.*\.)?([^\.]+\.(com|ca|co\.uk)$)/, "$2");
    document.cookie = name + "=" + value + expires + "; path=/;domain=" + domain + ";";
}

function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function updateCookie(name, value, expireTime, domainPrefix) {
    if (typeof domainPrefix === 'undefined') {
        domainPrefix = '';
    }
    var expires = "; expires=" + expireTime;
    var domain = domainPrefix + '.' + window.location.hostname.replace(/^(.*\.)?([^\.]+\.(com|ca|co\.uk)$)/, "$2");
    document.cookie = name + "=" + value + expires + "; path=/;domain=" + domain + ";";
}

function setCurrentOptimizerCookie() {
    if (readCookie('conversionDoneFor_' + webExperimentName) == null) {
        var days = 0.007;
        var date = new Date();
        var previousUrl = (window.redirect.indexOf('^') != 0) ? window.redirect : window.redirect.substr(1, window.redirect.length - 4);
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var cookieValue = "conversion=0&&expireTime=" + date.toGMTString() + "&&currentOptimizer=" + webExperimentName + "&&previousUrl=" + previousUrl + "&&first=1";
        createCookie('currentOptimizer', escape(cookieValue), days);
    }
}

function fb_error() {
    var w = new Control.Window($("errorWindow"), {
        className: "simple_window",
        closeOnClick: false
    });
    w.container = $("errorWindow");
    w.open();
}
var protoUpdate = Element.update;
ElementExtensions = {
    __update: protoUpdate,
    update: function(element, text) {
        if (element.tagName == 'TABLE') {
            return element.__update(text);
        }
        if (typeof text == 'undefined' || text === null) {
            text = '';
        }
        element.innerHTML = text;
        return element;
    },
    center: function(element, limitX, limitY) {
        element = $(element);
        var elementDims = element.getDimensions();
        var viewPort = document.viewport.getDimensions();
        var offsets = document.viewport.getScrollOffsets();
        var centerX = viewPort.width / 2 + offsets.left - elementDims.width / 2;
        var centerY = viewPort.height / 2 + offsets.top - elementDims.height / 2;
        if (limitX && centerX < limitX) {
            centerX = parseInt(limitX);
        }
        if (limitY && centerY < limitY) {
            centerY = parseInt(limitY);
        }
        element.setStyle({
            position: 'fixed',
            top: Math.floor(centerY) + 'px',
            left: Math.floor(centerX) + 'px'
        });
        return element;
    },
    auctionImgClick: function(element) {
        var imageEl = element.down('img');
        if (imageEl != null) {
            imageEl.observe('click', function(e) {
                window.location = this.up('div').up('div').select('a')[0].href;
            });
        }
    },
    auctionEasyImgClick: function(element) {
        element.observe('click', function(e) {
            window.location = $(this.id + "_3").select('a')[0].href;
        });
    },
    buyItNowClick: function(element) {
        element.observe('click', function(e) {
            var clickedSource = this.className.match(/easy|regular|details|mega|mine/g).first();
            if (this.hasClassName('bin_bff')) {
                goBuy(this.id.split('_')[4]);
            } else {
                buyItNow(this.id.split('_')[2], clickedSource);
            }
        });
        return element;
    },
    auctionBoxStyle: function(element) {
        try {
            var paras = element.select('p');
            var divs = element.select('div');
            paras[0].className = 'auction_box_normal_view_auction_title';
            divs[1].className = 'auction_box_normal_view_auction_pic';
            paras[1].className = 'auction_box_normal_view_auction_retails';
            element.select('[id^="trst_"]')[0].className = 'auction_box_normal_view_auction_inctimer';
            if (!paras[2].hasClassName('a_closed')) {
                paras[2].className = 'auction_box_normal_view_auction_timer';
            }
            paras[3].className = 'auction_box_normal_view_auction_price';
            paras[4].className = 'auction_box_normal_view_auction_bidder';
        } catch (e) {}
    },
    easyAuctionBoxStyle: function(element) {
        try {
            var divs = element.childElements();
            divs[0].className = 'auction_box_easy_view_column_1';
            divs[0].select('div').last().className = 'auction_box_easy_view_lock_icon';
            divs[1].className = 'auction_box_easy_view_column_2';
            divs[1].select('div').first().className = 'auction_box_easy_view_auction_pic';
            divs[2].className = 'auction_box_easy_view_column_3';
            divs[2].select('div').first().className = 'auction_box_easy_view_auction_title';
            divs[3].className = 'auction_box_easy_view_column_4 ab_ev_current_bid';
            divs[3].select('div').first().className = 'auction_amount';
            divs[4].className = 'auction_box_easy_view_column_5 ab_ev_auction_type';
            divs[5].className = 'ab_ev_bidder';
            var childs = divs[5].childElements();
            childs[0].className = 'ab_ev_bidder_title';
            childs[1].className = 'ab_ev_bidder_name';
            divs[6].className = 'auction_box_easy_view_column_7';
            var childs = divs[6].childElements();
            childs[0].className = 'auction_box_easy_view_auction_inctimer';
            childs[1].className = 'auction_box_easy_view_auction_timer';
        } catch (e) {}
    }
};
Element.addMethods(ElementExtensions);
Ajax.Updater.addMethods({
    updateContent: function(responseText) {
        var receiver = this.container[this.success() ? 'success' : 'failure'],
            options = this.options;
        if (!options.evalScripts) responseText = responseText.stripScripts();
        if (receiver = $(receiver)) {
            if (options.insertion) {
                if (Object.isString(options.insertion)) {
                    var insertion = {};
                    insertion[options.insertion] = responseText;
                    receiver.insert(insertion);
                } else options.insertion(receiver, responseText);
            } else receiver.__update(responseText);
        }
    }
});
if (typeof String.prototype.trim !== 'function') {
    String.prototype.trim = function() {
        return this.replace(/^\s+|\s+$/g, '');
    }
}

function initializeAuctionView() {
    if (typeof itemArray == 'undefined') {
        itemArray = [];
    }
    $$('[id^="a_"]').each(function(item) {
        var id = item.id.substring(2);
        pinManager.addDecorations(id);
        if (empty(itemArray[id])) {
            var auction = new Auction(id);
            itemArray[id] = auction;
        }
    });
    $$('.auction_box_normal_view').invoke('auctionBoxStyle');
    $$('.auction_box_easy_view').invoke('easyAuctionBoxStyle');
    $$('.auction_box_normal_view_auction_pic').invoke('auctionImgClick');
    $$('.auction_box_easy_view_auction_pic').invoke('auctionEasyImgClick');
    if (TEMPLATE == 'detail') {
        return;
    }
    if (typeof homePage == 'undefined') {
        homePage = false;
    }
    updaterManager.start(updaterManager.AUCTIONS_UPDATER);
    if (typeof stopAuctionUpdater != 'undefined' && stopAuctionUpdater) {
        updaterManager.stop(updaterManager.AUCTIONS_UPDATER);
    }
}

function haltCountdown() {
    itemArray.each(function(auction) {
        auction.defunct = true;
        window.clearTimeout(auction.timer);
    });
}

function configureView() {
    var errDiv = $("flash_error");
    if (errDiv && errDiv.innerHTML == "&nbsp;") {
        errDiv.update("");
    }
    var params = {
        m: mCat
    };
    var ref = gup("ref");
    if (ref != "") {
        params.y = window.location.href;
    }
    params.url = window.location.href;
    new Ajax.Request("/flajax", {
        method: "post",
        requestHeaders: {
            'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
            'X-Requested-With': 'XMLHttpRequest',
            'X-Prototype-Version': Prototype.Version,
            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
            'Cache-control': 'no-cache'
        },
        parameters: params,
        onSuccess: function(transport) {
            try {
                var result = transport.responseText.evalJSON();
            } catch (e) {
                return false;
            }
            var m = result.m;
            var e = result.e;
            if (result.length != 0 && typeof result.m != 'undefined' && m != null && m != "") {
                errDiv.update(m);
                $("flash_msg").show();
            }
            if (typeof e != 'undefined' && e != null && e != "") {
                eval(e);
            }
            Beezid.cartActive = result.cartActive;
            affiliate = (typeof result.a != 'undefined') ? result.a : false;
            if (!empty(window.__gxExec)) {
                window.__gxExec(affiliate);
            }
        }
    });
}

function countdown(time, div, paused, nodays, nowtime, obj, callback) {
    if ($(div) == null) {
        return;
    }
    if (typeof obj == 'undefined') {
        obj = false;
    }
    var countdownDiv = $(div);
    if (countdownRegistry.indexOf(countdownDiv) == -1) {
        countdownRegistry.push(countdownDiv);
    }
    var n = new Date();
    if (nowtime != null && typeof nowtime != 'undefined') {
        var dateNow = new Date(nowtime.replace(/-/gi, '/')).getTime();
        time = n.getTime() + (time - dateNow);
    }
    var d = new Date();
    d.setTime(time);
    if (n.getTime() > d.getTime()) {
        if (typeof callback == 'undefined' || !callback) {
            countdownDiv.update(i18n.beezid.active);
        }
        if (typeof callback == 'function') {
            callback(time);
        }
        return;
    }
    var one_day = 86400000,
        one_sec = 1000,
        one_min = 60000,
        one_hour = 3600000;
    var daysFloat = (d.getTime() - n.getTime()) / one_day;
    var days = Math.floor((d.getTime() - n.getTime()) / (one_day));
    var hoursFloat = ((daysFloat - days) * one_day) / one_hour;
    var hours = Math.floor(((daysFloat - days) * one_day) / one_hour);
    var minutesFloat = ((hoursFloat - hours) * one_hour) / one_min;
    var minutes = Math.floor(((hoursFloat - hours) * one_hour) / one_min);
    var seconds = Math.floor(((minutesFloat - minutes) * one_min) / one_sec);
    if (days < 10 && obj && typeof obj.days_padding != "undefined") {
        days = obj.days_padding + days;
    }
    if (hours < 10 && obj && typeof obj.hours_padding != "undefined") {
        hours = obj.hours_padding + hours;
    }
    if (minutes < 10) {
        minutes = '0' + minutes;
    }
    if (seconds < 10) {
        seconds = '0' + seconds;
    }
    var dayWord = (days == 1) ? ' day ' : ' days ';
    var dayWords = (days == 0) ? '' : days + dayWord;
    var preWord = (typeof paused != 'undefined' && paused == 1) ? 'Reopens in' : 'Opens in';
    if (typeof nodays != "undefined" && nodays != 0 && nodays != null) {
        if (!obj) {
            countdownDiv.update(dayWords + hours + ':' + minutes + ':' + seconds + '');
        } else {
            if (typeof obj.days != 'undefined') {
                $(obj.days).update(days);
            }
            $(obj.hours).update(hours);
            $(obj.mins).update(minutes);
            $(obj.secs).update(seconds);
        }
    } else {
        if (!obj) {
            countdownDiv.update(preWord + ': <br />' + dayWords + hours + ':' + minutes + ':' + seconds + '');
        } else {
            if (typeof obj.days != 'undefined') {
                $(obj.days).update(days);
            }
            $(obj.hours).update(hours);
            $(obj.mins).update(minutes);
            $(obj.secs).update(seconds);
        }
    }
    if (!obj) {
        div = div.toString();
    }
    setTimeout(function() {
        countdown(time, div, 0, 1, null, obj, callback);
    }, 1000);
    return days;
}

function goLink(path) {
    window.location = path;
}

function getCookie(cookieName) {
    var results = document.cookie.match('(^|;)?' + cookieName + '=([^;]*)(;|$)');
    if (results) {
        return (unescape(results[2]));
    } else {
        return null;
    }
}

function reaction(id, type, colour) {
    if ($('react_init_' + id) != null) {
        $('tip_' + id).show();
        $('react_init_' + id).show();
        return;
    }
    if (id.toString().substring(id.length - 1) == 'c' && $('react_init_' + id.substring(0, id.length - 1)) != null) {
        $('react_init_' + id.substring(0, id.length - 1)).show();
    }
    var content = '<div id="react_init" class="react-outer"><div class="react" id="react_table"><div class="react-body"><p id="react_id"></p></div><div class="react-footer" id="react_colour"><button type="button" class="btn" id="react_btn"></button></div></div></div>';
    var width = '100%';
    var left = '0px';
    if (type == 'regular') {
        $('a_' + id).select('div').first().insert({
            "bottom": content
        });
    }
    if (type == 'easy') {
        $('timer_' + id).insert({
            "after": content
        });
        left = '-15px';
    }
    if (type == 'detail') {
        $('bidder_name' + id).insert({
            "after": content
        });
    }
    if (type == 'mega') {
        $('a_' + id).select('div').first().insert({
            "bottom": content
        });
        $('react_init').setStyle({
            position: 'absolute',
            top: '59px'
        });
    }
    $('react_init').show();
    $('react_init').id = 'react_init_' + id;
    $('react_table').id = 'tip_' + id;
    $('tip_' + id).addClassName('msg_window_' + colour);
    $('tip_' + id).setStyle({
        width: width,
        zIndex: '1000',
        left: left
    });
    $('react_colour').addClassName('msg_window_content_' + colour);
    $('react_colour').id = 'react_colour_' + id;
    $('react_id').id = 'react_' + id;
    $('react_btn').on('click', function(e) {
        $('tip_' + id).hide();
    });
    $('react_btn').update('CLOSE');
    $('react_btn').id = 'react_btn_' + id;
    $('tip_' + id).show();
}
String.prototype.sprintf = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) {
        return typeof args[number] != 'undefined' ? args[number] : match;
    });
};
if (typeof Object.getPrototypeOf !== "function") {
    Object.getPrototypeOf = function(object) {
        if (typeof this.__proto__ === "object") {
            return object.__proto__;
        } else {
            var constructor = object.constructor,
                oldConstructor;
            if (Object.prototype.hasOwnProperty.call(object, "constructor")) {
                oldConstructor = constructor;
                if (!(delete object.constructor)) {
                    return null;
                }
                constructor = object.constructor;
                object.constructor = oldConstructor;
            }
            return constructor ? constructor.prototype : null;
        }
    };
}
String.prototype.toTitleCase = function() {
    return this.replace(/([^\W_]+[^\s-]*) */g, function(match, p1, index, title) {
        if (index > 0 && index + p1.length !== title.length && title.charAt(index - 2) !== ":" && title.charAt(index - 1).search(/[^\s-]/) < 0) {
            return match.toLowerCase();
        }
        if (p1.substr(1).search(/[A-Z]|\../) > -1) {
            return match;
        }
        return match.charAt(0).toUpperCase() + match.substr(1);
    });
};
Array.prototype.shuffle = function() {
    var shuffled = [],
        rand;
    this.each(function(value, index) {
        if (index == 0) {
            shuffled[0] = value;
        } else {
            rand = Math.floor(Math.random() * (index + 1));
            shuffled[index] = shuffled[rand];
            shuffled[rand] = value;
        }
    });
    return shuffled;
}

function showPlaceholders(input) {
    if (typeof(input.next('label')) != 'undefined') {
        if (input.present()) {
            input.next('label').hide();
        } else {
            input.next('label').show();
        }
    }
    if (typeof(input.previous('label')) != 'undefined' && input.previous('label').hasClassName('input_placeholder')) {
        if (input.present()) {
            input.previous('label').hide();
        } else {
            input.previous('label').show();
        }
    }
}

function toggleLabel() {
    if (this == null) {
        return;
    }
    showPlaceholders.defer(this);
}

function toggleLabelOnFocus() {
    if (this == null) {
        return;
    }
    if (typeof(this.next('label')) != 'undefined') {
        this.next('label').hide();
    }
    if (typeof(this.previous('label')) != 'undefined' && this.previous('label').hasClassName('input_placeholder')) {
        this.previous('label').hide();
    }
}

function isUrl(s) {
    var pattern = /(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
    return pattern.test(s);
}

function validateEmailField(emailInputValidator, form) {
    if (emailInputValidator.syncValidate()) {
        if (typeof form != 'undefined') {
            form.submit();
        }
    }
}

function goBuy(pid) {
    if (Beezid.info.getUid()) {
        window.location = 'https://' + window.location.hostname + '/products/buy_product/' + pid;
    } else {
        window.location = 'https://' + window.location.hostname + '/login/redirect:products|buy_product|' + pid;
    }
}

function buyItNow(aid, clickedSource) {
    if (!empty(Beezid.binTracker)) {
        return false;
    }
    var fullUrl = window.location.href;
    var sourceUrl = '';
    if (fullUrl.match(/\/auctions\//) && clickedSource != 'details') {
        sourceUrl = 'category';
    } else if (clickedSource == 'details') {
        sourceUrl = 'details page';
    } else {
        sourceUrl = 'home page';
    }
    Beezid.binTracker = true;
    var url = '/buy-it-now/' + aid + '/view:' + clickedSource + '/sourceUrl:' + sourceUrl;
    new UrlPopup({
        url: url,
        classNames: ["modalbox_drp"],
        afterLoad: function() {
            Beezid.binTracker = false;
            new Button({
                elem: $('bin_close'),
                action: function() {
                    this.destroy();
                }.bind(this)
            });
            countdown($('binTimeLeft').getValue(), 'bin_timer', 0, 1, null, {
                'hours': 'bin_counter_hours',
                'mins': 'bin_counter_mins',
                'secs': 'bin_counter_secs'
            });
        }
    }).run();
}

function tabFilter(tab, url, filter, target, callback) {
    $$('.tab_filter').invoke("removeClassName", "active");
    $(tab).addClassName("active");
    var qStrOffset = url.indexOf('?');
    if (qStrOffset > -1) {
        var urlPath = url.substring(0, qStrOffset),
            qString = url.substring(qStrOffset),
            endPoint = urlPath + '/filter:' + filter + qString;
    } else {
        var endPoint = url + 'filter:' + filter;
    }
    new Ajax.Updater(target, endPoint, {
        asynchronous: true,
        evalScripts: true,
        onComplete: function(request, json) {
            hideLoadingDiv();
            if (callback && typeof callback === 'function') {
                (function(__callback) {
                    __callback();
                }(callback));
            }
        },
        onLoading: function(request) {
            showLoadingDiv();
        },
        requestHeaders: ['X-Update', target]
    });
}

function isMobileDevice() {
    return !!(typeof window.orientation !== 'undefined' || navigator.userAgent.match(/Mobi|Android/));
}

function isSmallMobile() {
    var pix = screen.availWidth * screen.availHeight;
    return pix < 800000 && isMobileDevice();
}

function registerFormHandler() {
    var url = isSmallMobile() ? '/m_register' : '/register';
    trackLinkEvent(url, 'reg', 'register_click', null, null);
}

function createIconTip() {
    var iconFound = [];
    $$('[class*="tooltip_icon_"]').each(function(item) {
        var classIcon = item.className.match(/tooltip_icon_\w+/);
        if (classIcon != null && iconFound.indexOf(classIcon[0]) == -1) {
            iconFound.push(classIcon[0]);
            var name = classIcon[0].gsub('tooltip_icon_', '');
            if (i18n.tooltips[name] != undefined || name == 'auction_desc') {
                $$('.' + classIcon[0]).each(function(tipize) {
                    if (typeof tipize.prototip !== 'undefined' && typeof tipize.prototip.remove === "function") {
                        $(tipize.id).prototip.remove();
                    }
                    if (name == 'auction_desc') {
                        var msg = $(tipize.id).innerHTML;
                        var aId = 'a_' + tipize.id.gsub('ati_', '');
                        var title = $(aId).select('a').first().title;
                    } else {
                        var msg = i18n.tooltips[name].message;
                        var title = i18n.tooltips[name].title;
                    }
                    var priceCap = tipize.className.match(/price_cap_([1-9].*)\.00/);
                    if (priceCap != null) {
                        msg = msg.gsub('%s', priceCap[1] + '%');
                    } else {
                        var priceCap = tipize.className.match('price_cap_custom');
                        if (priceCap != null) {
                            msg = msg.gsub(' at %s of the "Compare to" price', '');
                        } else {
                            var priceCap = tipize.className.match('price_cap_(.*)');
                            if (priceCap != null) {
                                msg = msg.gsub('%s', formatCurrency(priceCap[1]));
                                msg = msg.gsub(' of the "Compare to" price', '');
                            }
                        }
                    }
                    addToolTip(tipize, msg, title, true);
                    if (name == 'auction_desc') {
                        tipize.show();
                    }
                });
            }
        }
    });
};
Beezid.tipCache = {};

function showTooltip(options) {
    if (!$(options.id)) {
        return;
    }
    if ($(options.id).up().hasClassName('hdr_locks_row')) {
        return;
    }
    var tt = Beezid.tipCache[options.id];
    if (!empty(tt)) {
        tt.target.stopObserving('mouseenter');
        tt.target.stopObserving('mouseleave');
        tt.target.stopObserving('mouseover');
        delete tt.target.prototip;
        delete Beezid.tipCache[options.id];
    }
    var params = {
        title: options.title,
        target: options.id,
        closeButton: typeof options.closeButton == 'undefined' ? Beezid.touchEnabled : options.closeButton,
        hideOn: typeof options.hideOn == 'undefined' ? false : options.hideOn,
        hideAfter: typeof options.hideAfter == 'undefined' ? 0.25 : options.hideAfter,
        delay: typeof options.delay == 'undefined' ? 0 : options.delay,
        width: typeof options.width == 'undefined' ? 160 : options.width,
        height: typeof options.height == 'undefined' ? 'auto' : options.height,
        offset: typeof options.offset == 'undefined' ? {
            x: -1,
            y: -1
        } : options.offset,
        hook: typeof options.hook == 'undefined' ? {
            target: 'topMiddle',
            tip: 'bottomMiddle'
        } : options.hook,
        stem: typeof options.stem == 'undefined' ? {
            position: 'bottomMiddle',
            height: 10,
            width: 20
        } : options.stem,
        style: typeof options.style == 'undefined' ? 'protobzd' : options.style
    };
    Beezid.tipCache[options.id] = new Tip(options.id, options.message, params);
}

function hideAllToolTip() {
    Tips.visible.each(function(tip) {
        tip.hide();
    });
}

function addToolTip(elem, msg, title, removeClickObserver) {
    if (removeClickObserver) {
        elem.stopObserving('click');
    }
    if (Beezid.touchEnabled) {
        elem.observe('click', function(ev) {
            if (elem.prototip.isVisible()) {
                elem.prototip.hide();
            } else {
                hideAllToolTip();
                elem.prototip.show();
            }
        });
    }
    var screenWidth = document.documentElement.clientWidth;
    if (elem.getBoundingClientRect().left < 125) {
        if (elem.getBoundingClientRect().top < 75) {
            var hookOptions = {
                target: 'bottomRight',
                tip: 'topLeft'
            };
            var stemOptions = {
                position: 'topLeft',
                height: 7,
                width: 26
            };
            var offsetOptions = {
                x: -16,
                y: 2
            };
        } else {
            var hookOptions = {
                target: 'topRight',
                tip: 'bottomLeft'
            };
            var stemOptions = {
                position: 'bottomLeft',
                height: 10,
                width: 26
            };
            var offsetOptions = {
                x: -30,
                y: -5
            };
        }
    } else if (screenWidth - elem.getBoundingClientRect().right < 120) {
        var hookOptions = {
            target: 'topLeft',
            tip: 'bottomRight'
        };
        var stemOptions = {
            position: 'bottomRight',
            height: 10,
            width: 26
        };
        var offsetOptions = {
            x: 31,
            y: -2
        };
    } else {
        var hookOptions = {
            target: 'topMiddle',
            tip: 'bottomMiddle'
        };
        var stemOptions = {
            position: 'bottomMiddle',
            height: 10,
            width: 20
        };
        var offsetOptions = {
            x: -1,
            y: -1
        };
    }
    showTooltip({
        id: elem.id,
        message: msg,
        title: title,
        target: elem,
        closeButton: Beezid.touchEnabled,
        hideOn: false,
        hideAfter: Beezid.touchEnabled ? 15 : 0.25,
        delay: 0,
        width: 160,
        height: 'auto',
        offset: offsetOptions,
        hook: hookOptions,
        stem: stemOptions,
        style: 'protobzd'
    });
}
initFuncs.push(function() {
    if ((typeof Prototype !== 'undefined') && (Prototype.Version == '1.7.1')) {
        Effect.Highlight.prototype.update = function(position) {
            this.element.setStyle({
                backgroundColor: [0, 1, 2].inject('#', function(m, v, i) {
                    return m + ((this._base[i] + (this._delta[i] * position)).round().toColorPart());
                }.bind(this))
            });
        };
    }
    $$(".go_register").invoke('observe', 'click', function(event) {
        Event.stop(event);
        registerFormHandler();
    });
    if ($('gotop')) {
        $('gotop').observe('click', function() {
            new Effect.ScrollTo('uCheckLogged');
        });
    }
    if ($('theBar') != null) {
        if ($$('.nbar_normal').size()) {
            classStatesOver = {
                pinButt: false,
                alertButt: false,
                messButt: false
            };
            var beezarButtons = $w('pinButt alertButt messButt');
            beezarButtons.each(function(showBtn) {
                if ($(showBtn) == null) {
                    return;
                }
                $(showBtn).observe('click', function(ev) {
                    beezarButtons.each(function(hideBtn) {
                        if ($(hideBtn) == null) {
                            return;
                        }
                        $(hideBtn).nextSiblings()[0].hide();
                        if (hideBtn != showBtn) {
                            classStatesOver[hideBtn] = false;
                        }
                    });
                    if (classStatesOver[showBtn]) {
                        $(showBtn).nextSiblings()[0].hide();
                        classStatesOver[showBtn] = false;
                    } else {
                        $(showBtn).nextSiblings()[0].show();
                        classStatesOver[showBtn] = true;
                        switch (showBtn) {
                            case 'pinButt':
                                updatePins();
                                break;
                            case 'alertButt':
                                window.notificationsManager.updateAlerts();
                                break;
                            case 'messButt':
                                window.notificationsManager.updateMsgs();
                                break;
                        }
                    }
                });
            });
        }
    }
    if (Beezid.info.loggedIn()) {
        updaterManager.start(updaterManager.BAR_UPDATER);
    }
});
var BarTracker = Class.create(BeezidObject, {
    _bar: null,
    _content: null,
    _vPos: null,
    _barHeight: null,
    _active: false,
    _offset: null,
    __cb: null,
    isMobile: false,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
        if (isMobileDevice()) {
            this.isMobile = true;
            setTimeout(function() {
                window.scrollTo(0, 1);
            }, 50);
        }
        this.__cb = this.trackScroll.bind(this);
        if (!undef(window.addEventListener)) {
            window.addEventListener('scroll', this.__cb);
        } else {
            window.attachEvent('onscroll', this.__cb);
        }
        $('gotop') && $('gotop').hide();
        Beezid.info.addListener('login', function(e) {
            $('theBar').show();
            updaterManager.start(updaterManager.BAR_UPDATER);
            window.notificationsManager = new NotificationsManager();
            window.notificationsManager.updateAlerts();
            window.notificationsManager.updateMsgs();
        });
    },
    __setOffset: function() {
        this._offset = document.viewport.getScrollOffsets().top - this._vPos;
    },
    trackScroll: function(e) {
        var gotop = $('gotop');
        this.__setOffset();
        if (this._offset > 0) {
            this._active = true;
            if (this._bar) {
                this._bar.addClassName('hdr_marquee_detached');
                this._content.addClassName('header_strut');
            }
            gotop && gotop.show();
        } else if (this._active) {
            if (!this.isMobile) {
                this._active = false;
            }
            if (this._bar) {
                this._bar.removeClassName('hdr_marquee_detached');
                this._content.removeClassName('header_strut');
            }
            gotop && gotop.hide();
        }
        if (gotop) {
            if ($('content-bottom')) {
                var c = $('content-bottom').cumulativeOffset().top - 150;
                var w = window.innerHeight;
                if (c - this._offset < w - 50) {
                    gotop.style.bottom = (w + this._offset - c) + 'px';
                } else {
                    gotop.style.bottom = '50px';
                }
            }
        }
    },
    disable: function() {
        this._active = false;
        if (this._bar) {
            this._bar.removeClassName('hdr_marquee_detached');
            this._content.removeClassName('header_strut');
        }
        document.stopObserving('scroll', this.__cb);
    }
});

function updatePins() {
    new Ajax.Request("/my_account/pinned", {
        method: 'get',
        requestHeaders: {
            'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
            'X-Requested-With': 'XMLHttpRequest',
            'X-Prototype-Version': Prototype.Version,
            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
            'Cache-control': 'no-cache'
        },
        onCreate: function() {
            $('pinbox').update('<center>Please Wait......');
        },
        onComplete: function(res) {
            if ($('theBar') != null) {
                var action, items = res.responseText.evalJSON();
                $('pinbox').update();
                items.each(function(item) {
                    action = '<a href="/' + item.slug + '#auction-' + item.aid + '">' + item.name + '</a>';
                    $('pinbox').insert("<div id='unpin_" + item.aid + "' class='nbar_btn_menu_content_msg_entry'><p class='nbar_pin'>" + action + "</p><div class='btn close' onclick='unPin(" + item.aid + ");'><i class='icon icon-close'></i></div><div class='clear'></div></div>");
                });
            }
        }
    });
}

function markRead(id, redirectTo) {
    if (Beezid.info.loggedIn()) {
        new Ajax.Request("/notifications/markRead", {
            method: "post",
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            parameters: {
                id: id
            },
            onComplete: function(res) {
                var done = res.responseText.evalJSON();
                if (done.type == 'Messages' && $('mess_' + id) != null) {
                    $('mess_' + id).hide();
                } else if (done.type == 'Alerts' && $('alert_' + id) != null) {
                    $('alert_' + id).hide();
                }
                if (typeof redirectTo != 'undefined') {
                    Beezid.info._userId = 0;
                    window.location = redirectTo;
                }
            }
        });
    }
}

function unPin(id) {
    if (Beezid.info.loggedIn()) {
        new Ajax.Request("/auctions/unpin", {
            method: "post",
            requestHeaders: {
                'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version,
                'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                'Cache-control': 'no-cache'
            },
            parameters: {
                ids: id
            },
            onComplete: function(res) {
                $('unpin_' + id).hide();
                pinManager.setPinStyle(id, false);
            }
        });
    }
}

function showLoadingDiv() {
    if ($('loading-mask') != null) {
        $('loading-mask').addClassName('loading-mask');
    }
}

function hideLoadingDiv() {
    if ($('loading-mask') != null) {
        $('loading-mask').removeClassName('loading-mask');
    }
}
if (!window.getComputedStyle) {
    window.getComputedStyle = function(el, pseudo) {
        this.el = el;
        this.getPropertyValue = function(prop) {
            var re = /(\-([a-z]){1})/g;
            if (prop == 'float') prop = 'styleFloat';
            if (re.test(prop)) {
                prop = prop.replace(re, function() {
                    return arguments[2].toUpperCase();
                });
            }
            return el.currentStyle[prop] ? el.currentStyle[prop] : null;
        }
        return this;
    }
}

function scrollAdjust(elem, yOffset, xOffset) {
    if (elem == null) {
        return;
    }
    if (typeof yOffset == 'undefined') {
        if ($$('.hdr_marquee_cntn').size() == 0) {
            yOffset = 0;
        } else {
            yOffset = 64;
        }
    }
    var top = elem.cumulativeOffset().top,
        left = 0;
    top = top - yOffset;
    if (typeof xOffset != 'undefined') {
        left = elem.cumulativeOffset().left - xOffset;
    }
    window.scrollTo(left, top);
}
Beezid.dynamicCss = {
    cssPath: '/css/',
    loadedCss: {}
};

function loadCssFile(fileName) {
    if (typeof Beezid.dynamicCss.loadedCss[fileName] === 'undefined') {
        var fileRef = new Element('link', {
            'type': 'text/css',
            'rel': 'stylesheet',
            'href': Beezid.dynamicCss.cssPath + fileName + '?v=' + CSS_VERSION
        });
        $$('head')[0].insert(fileRef);
        Beezid.dynamicCss.loadedCss[fileName] = true;
    }
}
var MenuDelay = Class.create(BeezidObject, {
    lastposX: 0,
    lastposY: 0,
    travelStart: null,
    lastSelectedId: 'cameras-camcorders',
    lastTarget: null,
    initialize: function($super, params) {
        $super();
        $$('.mega_content').invoke('hide');
        $('megadropdown').observe('mouseover', function(event) {
            if (!event.target.hasClassName('mega_filler') && !event.target.hasClassName('menu')) {
                if (!$('megadropdown').hasClassName('active')) {
                    $('megadropdown').addClassName('menu_active');
                }
            }
        });
        $('megadropdown').observe('mouseleave', function(event) {
            $$('.mega_content').invoke('hide');
            $$('.menu li.hasSub').invoke('removeClassName', 'active');
            $('megadropdown').removeClassName('menu_active');
        });
        $$('.menu li.hasSub').each(function(el) {
            el.observe('mousemove', function(e) {
                var elapsed = (new Date().getTime() - this.travelStart);
                var speedX = (Math.abs(Event.pointerX(e) - this.lastposX)) / elapsed;
                var speedY = (Math.abs(Event.pointerY(e) - this.lastposY)) / elapsed;
                var isMouseOver = (e.target == this.lastTarget);
                this.lastTarget = e.target;
                this.travelStart = new Date().getTime();
                this.lastposX = Event.pointerX(e);
                this.lastposY = Event.pointerY(e);
                if ((speedY < 0.5 && speedX < 0.2 && isMouseOver) || (!isMouseOver && speedX < 0.1 && speedY < 0.1 && this.lastSelectedId != el.id)) {
                    if (this.lastSelectedId != null) {
                        $('mega_content-' + this.lastSelectedId).hide();
                        $(this.lastSelectedId).removeClassName('active');
                    }
                    $('mega_content-' + el.id).show();
                    el.addClassName('active');
                    this.lastSelectedId = el.id;
                }
            }.bind(this));
        }.bind(this));
        this.addButtonClickEventBindings();
    },
    addButtonClickEventBindings: function() {
        $$('[class*="auction_count_btn"]').each(function(el) {
            el.observe('click', function(e) {
                this.__setElementStyle('num_auction', 'num_store', 'auction_count_btn', 'store_count_btn');
                this.__updateTextAndLink('auctions', 'store', i18n.beezid.see_all_auctions);
            }.bind(this));
        }.bind(this));
        $$('[class*="store_count_btn"]').each(function(el) {
            el.observe('click', function(e) {
                this.__setElementStyle('num_store', 'num_auction', 'store_count_btn', 'auction_count_btn');
                this.__updateTextAndLink('store', 'auctions', i18n.store.see_all_store_items);
            }.bind(this));
        }.bind(this));
    },
    __setElementStyle: function(numClass1, numClass2, btClass1, btClass2) {
        $$('[class^="_' + numClass1 + '"]').invoke('show');
        $$('[class^="_' + numClass2 + '"]').invoke('hide');
        $$('[class*="' + btClass1 + '"]').invoke('toggleClassName', 'active', true);
        $$('[class*="' + btClass2 + '"]').invoke('toggleClassName', 'active', false);
    },
    __updateTextAndLink: function(item1, item2, text) {
        $$('[class*="btn-see"]').each(function(elmt) {
            if (elmt.up('li').id != 'newbiz') {
                elmt.update('<i class="icon icon-eye-open"></i> ' + text);
                elmt.href = elmt.href.gsub('sect=' + item2, 'sect=' + item1);
                elmt.up('div').previous('a').href = elmt.up('div').previous('a').href.gsub('sect=' + item2, 'sect=' + item1);
                elmt.up('ul').select('li').each(function(liTag) {
                    liTag.select('a').each(function(aTag) {
                        aTag.href = aTag.href.gsub('sect=' + item2, 'sect=' + item1);
                    });
                });
            }
        });
    }
});
var CryptoJS = CryptoJS || function(s, p) {
    var m = {},
        l = m.lib = {},
        n = function() {},
        r = l.Base = {
            extend: function(b) {
                n.prototype = this;
                var h = new n;
                b && h.mixIn(b);
                h.hasOwnProperty("init") || (h.init = function() {
                    h.$super.init.apply(this, arguments)
                });
                h.init.prototype = h;
                h.$super = this;
                return h
            },
            create: function() {
                var b = this.extend();
                b.init.apply(b, arguments);
                return b
            },
            init: function() {},
            mixIn: function(b) {
                for (var h in b) b.hasOwnProperty(h) && (this[h] = b[h]);
                b.hasOwnProperty("toString") && (this.toString = b.toString)
            },
            clone: function() {
                return this.init.prototype.extend(this)
            }
        },
        q = l.WordArray = r.extend({
            init: function(b, h) {
                b = this.words = b || [];
                this.sigBytes = h != p ? h : 4 * b.length
            },
            toString: function(b) {
                return (b || t).stringify(this)
            },
            concat: function(b) {
                var h = this.words,
                    a = b.words,
                    j = this.sigBytes;
                b = b.sigBytes;
                this.clamp();
                if (j % 4)
                    for (var g = 0; g < b; g++) h[j + g >>> 2] |= (a[g >>> 2] >>> 24 - 8 * (g % 4) & 255) << 24 - 8 * ((j + g) % 4);
                else if (65535 < a.length)
                    for (g = 0; g < b; g += 4) h[j + g >>> 2] = a[g >>> 2];
                else h.push.apply(h, a);
                this.sigBytes += b;
                return this
            },
            clamp: function() {
                var b = this.words,
                    h = this.sigBytes;
                b[h >>> 2] &= 4294967295 << 32 - 8 * (h % 4);
                b.length = s.ceil(h / 4)
            },
            clone: function() {
                var b = r.clone.call(this);
                b.words = this.words.slice(0);
                return b
            },
            random: function(b) {
                for (var h = [], a = 0; a < b; a += 4) h.push(4294967296 * s.random() | 0);
                return new q.init(h, b)
            }
        }),
        v = m.enc = {},
        t = v.Hex = {
            stringify: function(b) {
                var a = b.words;
                b = b.sigBytes;
                for (var g = [], j = 0; j < b; j++) {
                    var k = a[j >>> 2] >>> 24 - 8 * (j % 4) & 255;
                    g.push((k >>> 4).toString(16));
                    g.push((k & 15).toString(16))
                }
                return g.join("")
            },
            parse: function(b) {
                for (var a = b.length, g = [], j = 0; j < a; j += 2) g[j >>> 3] |= parseInt(b.substr(j, 2), 16) << 24 - 4 * (j % 8);
                return new q.init(g, a / 2)
            }
        },
        a = v.Latin1 = {
            stringify: function(b) {
                var a = b.words;
                b = b.sigBytes;
                for (var g = [], j = 0; j < b; j++) g.push(String.fromCharCode(a[j >>> 2] >>> 24 - 8 * (j % 4) & 255));
                return g.join("")
            },
            parse: function(b) {
                for (var a = b.length, g = [], j = 0; j < a; j++) g[j >>> 2] |= (b.charCodeAt(j) & 255) << 24 - 8 * (j % 4);
                return new q.init(g, a)
            }
        },
        u = v.Utf8 = {
            stringify: function(b) {
                try {
                    return decodeURIComponent(escape(a.stringify(b)))
                } catch (g) {
                    throw Error("Malformed UTF-8 data");
                }
            },
            parse: function(b) {
                return a.parse(unescape(encodeURIComponent(b)))
            }
        },
        g = l.BufferedBlockAlgorithm = r.extend({
            reset: function() {
                this._data = new q.init;
                this._nDataBytes = 0
            },
            _append: function(b) {
                "string" == typeof b && (b = u.parse(b));
                this._data.concat(b);
                this._nDataBytes += b.sigBytes
            },
            _process: function(b) {
                var a = this._data,
                    g = a.words,
                    j = a.sigBytes,
                    k = this.blockSize,
                    m = j / (4 * k),
                    m = b ? s.ceil(m) : s.max((m | 0) - this._minBufferSize, 0);
                b = m * k;
                j = s.min(4 * b, j);
                if (b) {
                    for (var l = 0; l < b; l += k) this._doProcessBlock(g, l);
                    l = g.splice(0, b);
                    a.sigBytes -= j
                }
                return new q.init(l, j)
            },
            clone: function() {
                var b = r.clone.call(this);
                b._data = this._data.clone();
                return b
            },
            _minBufferSize: 0
        });
    l.Hasher = g.extend({
        cfg: r.extend(),
        init: function(b) {
            this.cfg = this.cfg.extend(b);
            this.reset()
        },
        reset: function() {
            g.reset.call(this);
            this._doReset()
        },
        update: function(b) {
            this._append(b);
            this._process();
            return this
        },
        finalize: function(b) {
            b && this._append(b);
            return this._doFinalize()
        },
        blockSize: 16,
        _createHelper: function(b) {
            return function(a, g) {
                return (new b.init(g)).finalize(a)
            }
        },
        _createHmacHelper: function(b) {
            return function(a, g) {
                return (new k.HMAC.init(b, g)).finalize(a)
            }
        }
    });
    var k = m.algo = {};
    return m
}(Math);
(function(s) {
    function p(a, k, b, h, l, j, m) {
        a = a + (k & b | ~k & h) + l + m;
        return (a << j | a >>> 32 - j) + k
    }

    function m(a, k, b, h, l, j, m) {
        a = a + (k & h | b & ~h) + l + m;
        return (a << j | a >>> 32 - j) + k
    }

    function l(a, k, b, h, l, j, m) {
        a = a + (k ^ b ^ h) + l + m;
        return (a << j | a >>> 32 - j) + k
    }

    function n(a, k, b, h, l, j, m) {
        a = a + (b ^ (k | ~h)) + l + m;
        return (a << j | a >>> 32 - j) + k
    }
    for (var r = CryptoJS, q = r.lib, v = q.WordArray, t = q.Hasher, q = r.algo, a = [], u = 0; 64 > u; u++) a[u] = 4294967296 * s.abs(s.sin(u + 1)) | 0;
    q = q.MD5 = t.extend({
        _doReset: function() {
            this._hash = new v.init([1732584193, 4023233417, 2562383102, 271733878])
        },
        _doProcessBlock: function(g, k) {
            for (var b = 0; 16 > b; b++) {
                var h = k + b,
                    w = g[h];
                g[h] = (w << 8 | w >>> 24) & 16711935 | (w << 24 | w >>> 8) & 4278255360
            }
            var b = this._hash.words,
                h = g[k + 0],
                w = g[k + 1],
                j = g[k + 2],
                q = g[k + 3],
                r = g[k + 4],
                s = g[k + 5],
                t = g[k + 6],
                u = g[k + 7],
                v = g[k + 8],
                x = g[k + 9],
                y = g[k + 10],
                z = g[k + 11],
                A = g[k + 12],
                B = g[k + 13],
                C = g[k + 14],
                D = g[k + 15],
                c = b[0],
                d = b[1],
                e = b[2],
                f = b[3],
                c = p(c, d, e, f, h, 7, a[0]),
                f = p(f, c, d, e, w, 12, a[1]),
                e = p(e, f, c, d, j, 17, a[2]),
                d = p(d, e, f, c, q, 22, a[3]),
                c = p(c, d, e, f, r, 7, a[4]),
                f = p(f, c, d, e, s, 12, a[5]),
                e = p(e, f, c, d, t, 17, a[6]),
                d = p(d, e, f, c, u, 22, a[7]),
                c = p(c, d, e, f, v, 7, a[8]),
                f = p(f, c, d, e, x, 12, a[9]),
                e = p(e, f, c, d, y, 17, a[10]),
                d = p(d, e, f, c, z, 22, a[11]),
                c = p(c, d, e, f, A, 7, a[12]),
                f = p(f, c, d, e, B, 12, a[13]),
                e = p(e, f, c, d, C, 17, a[14]),
                d = p(d, e, f, c, D, 22, a[15]),
                c = m(c, d, e, f, w, 5, a[16]),
                f = m(f, c, d, e, t, 9, a[17]),
                e = m(e, f, c, d, z, 14, a[18]),
                d = m(d, e, f, c, h, 20, a[19]),
                c = m(c, d, e, f, s, 5, a[20]),
                f = m(f, c, d, e, y, 9, a[21]),
                e = m(e, f, c, d, D, 14, a[22]),
                d = m(d, e, f, c, r, 20, a[23]),
                c = m(c, d, e, f, x, 5, a[24]),
                f = m(f, c, d, e, C, 9, a[25]),
                e = m(e, f, c, d, q, 14, a[26]),
                d = m(d, e, f, c, v, 20, a[27]),
                c = m(c, d, e, f, B, 5, a[28]),
                f = m(f, c, d, e, j, 9, a[29]),
                e = m(e, f, c, d, u, 14, a[30]),
                d = m(d, e, f, c, A, 20, a[31]),
                c = l(c, d, e, f, s, 4, a[32]),
                f = l(f, c, d, e, v, 11, a[33]),
                e = l(e, f, c, d, z, 16, a[34]),
                d = l(d, e, f, c, C, 23, a[35]),
                c = l(c, d, e, f, w, 4, a[36]),
                f = l(f, c, d, e, r, 11, a[37]),
                e = l(e, f, c, d, u, 16, a[38]),
                d = l(d, e, f, c, y, 23, a[39]),
                c = l(c, d, e, f, B, 4, a[40]),
                f = l(f, c, d, e, h, 11, a[41]),
                e = l(e, f, c, d, q, 16, a[42]),
                d = l(d, e, f, c, t, 23, a[43]),
                c = l(c, d, e, f, x, 4, a[44]),
                f = l(f, c, d, e, A, 11, a[45]),
                e = l(e, f, c, d, D, 16, a[46]),
                d = l(d, e, f, c, j, 23, a[47]),
                c = n(c, d, e, f, h, 6, a[48]),
                f = n(f, c, d, e, u, 10, a[49]),
                e = n(e, f, c, d, C, 15, a[50]),
                d = n(d, e, f, c, s, 21, a[51]),
                c = n(c, d, e, f, A, 6, a[52]),
                f = n(f, c, d, e, q, 10, a[53]),
                e = n(e, f, c, d, y, 15, a[54]),
                d = n(d, e, f, c, w, 21, a[55]),
                c = n(c, d, e, f, v, 6, a[56]),
                f = n(f, c, d, e, D, 10, a[57]),
                e = n(e, f, c, d, t, 15, a[58]),
                d = n(d, e, f, c, B, 21, a[59]),
                c = n(c, d, e, f, r, 6, a[60]),
                f = n(f, c, d, e, z, 10, a[61]),
                e = n(e, f, c, d, j, 15, a[62]),
                d = n(d, e, f, c, x, 21, a[63]);
            b[0] = b[0] + c | 0;
            b[1] = b[1] + d | 0;
            b[2] = b[2] + e | 0;
            b[3] = b[3] + f | 0
        },
        _doFinalize: function() {
            var a = this._data,
                k = a.words,
                b = 8 * this._nDataBytes,
                h = 8 * a.sigBytes;
            k[h >>> 5] |= 128 << 24 - h % 32;
            var l = s.floor(b / 4294967296);
            k[(h + 64 >>> 9 << 4) + 15] = (l << 8 | l >>> 24) & 16711935 | (l << 24 | l >>> 8) & 4278255360;
            k[(h + 64 >>> 9 << 4) + 14] = (b << 8 | b >>> 24) & 16711935 | (b << 24 | b >>> 8) & 4278255360;
            a.sigBytes = 4 * (k.length + 1);
            this._process();
            a = this._hash;
            k = a.words;
            for (b = 0; 4 > b; b++) h = k[b], k[b] = (h << 8 | h >>> 24) & 16711935 | (h << 24 | h >>> 8) & 4278255360;
            return a
        },
        clone: function() {
            var a = t.clone.call(this);
            a._hash = this._hash.clone();
            return a
        }
    });
    r.MD5 = t._createHelper(q);
    r.HmacMD5 = t._createHmacHelper(q)
})(Math);
var lazierLoadAutoHook = true;
var lazierLoadDefaultOptions = {
    treshold: 100,
    extensions: ['gif', 'png', 'jpg', 'jpeg'],
    replaceImage: "/img/blank.gif",
    minWidth: 99,
    minHeight: 74
};
if (!JS_BRAMUS) {
    var JS_BRAMUS = new Object();
}
JS_BRAMUS.lazierLoad = Class.create({
    __images: [],
    initialize: function(options) {
        $$('.lazy_load').each(function(image) {
            this.__images.push(new JS_BRAMUS.lazierLoadImage(image, options));
        }.bind(this));
    },
    forceLoad: function() {
        for (var image in this.__images) {
            if (this.__images.hasOwnProperty(image)) {
                this.__images[image].lazyScroll(null, true);
            }
        }
    }
});
JS_BRAMUS.lazierLoadImage = Class.create({
    initialize: function(image, options) {
        this.options = Object.clone(lazierLoadDefaultOptions);
        Object.extend(this.options, options || {});
        this.element = image;
        this.position = Position.page(this.element);
        this.viewportHeight = document.viewport.getHeight();
        if (this.position[1] < (this.viewportHeight + this.options.treshold)) {
            this.loading = true;
            this.loaded = true;
        } else {
            this.loading = false;
            this.loaded = false;
            this.element.origSrc = this.element.src;
            this.element.fileName = this.element.origSrc.substring(this.element.origSrc.lastIndexOf('/') + 1, this.element.origSrc.length);
            this.element.fileType = this.element.fileName.substring(this.element.fileName.lastIndexOf('.') + 1, this.element.fileName.length);
            if (this.options.extensions.indexOf(this.element.fileType) == -1) {
                return;
            }
            var w = this.element.width;
            var h = this.element.height;
            if (!w || !h) {
                var w = 100;
                var h = 75;
            }
            this.element.src = this.options.replaceImage;
            this.lazyScroller = this.lazyScroll.bindAsEventListener(this, false);
            Event.observe(window, 'scroll', this.lazyScroller.bind(this), false);
        }
    },
    lazyScroll: function(scrollObj, force) {
        if ((this.loaded == false) && (this.loading != true)) {
            if (force || ((document.viewport.getScrollOffsets()[1] + document.viewport.getHeight() + parseInt(this.options.treshold)) > this.position[1])) {
                this.loading = true;
                var newImage = null;
                newImage = new Image();
                newImage.src = this.element.origSrc;
                if (newImage.complete) {
                    this.element.src = newImage.src;
                    this.loaded = true;
                } else {
                    newImage.onload = function() {
                        this.element.src = newImage.src;
                        this.loaded = true;
                    }.bind(this);
                }
                Event.stopObserving(window, 'scroll', this.lazyScroller);
            }
        }
    }
});
if (lazierLoadAutoHook == true) {
    function initLazierLoad() {
        Beezid.myLL = new JS_BRAMUS.lazierLoad();
    }
    Event.observe(document, 'dom:loaded', initLazierLoad, false);
}
var Prototip = {
    Version: '2.2.5'
};
var Tips = {
    options: {
        paths: {
            images: '/img/prototip/',
            javascript: ''
        },
        zIndex: 6000
    }
};
Prototip.Styles = {
    'default': {
        border: 0,
        borderColor: 'none',
        className: 'default',
        closeButton: false,
        hideAfter: false,
        hideOn: 'mouseleave',
        hook: false,
        radius: 0,
        showOn: 'mousemove',
        stem: {
            height: 12,
            width: 15
        }
    },
    'protobzd': {
        className: 'protobzd'
    }
};
Object.extend(Prototip, {
    REQUIRED_Prototype: "1.7",
    support: {
        canvas: !!document.createElement("canvas").getContext
    },
    insertScript: function(a) {
        try {
            document.write("<script type='text/javascript' src='" + a + "'></script>")
        } catch (b) {
            $$("head")[0].insert(new Element("script", {
                src: a,
                type: "text/javascript"
            }))
        }
    },
    start: function() {
        this.require("Prototype"), window.jQuery && window.$ && window.$ == window.jQuery && alert("Prototip detected jQuery on the page without jQuery.noConflict enabled.\njQuery.noConflict has to be enabled for Prototip to work.\n\nYou can find documentation for it on the jQuery website, there's also\nan example in the Troubleshooting section of the Prototip website.");
        var a = /prototip([\w\d-_.]+)?\.js(.*)/;
        this.path = (($$("script[src]").find(function(b) {
            return b.src.match(a)
        }) || {}).src || "").replace(a, ""), Tips.paths = {
            images: /^(https?:\/\/|\/)/.test(Tips.options.paths.images) ? Tips.options.paths.images : this.path + Tips.options.paths.images,
            javascript: /^(https?:\/\/|\/)/.test(Tips.options.paths.javascript) ? Tips.options.paths.javascript : this.path + Tips.options.paths.javascript
        }, Prototip.Styles || this.insertScript(Tips.paths.javascript + "styles.js"), this.support.canvas || (document.documentMode >= 8 && !document.namespaces.ns_vml ? document.namespaces.add("ns_vml", "urn:schemas-microsoft-com:vml", "#default#VML") : document.observe("dom:loaded", function() {
            try {
                document.createStyleSheet().cssText = "ns_vml\\:*{behavior:url(#default#VML)}"
            } catch (e) {}
        })), Tips.initialize(), Element.observe(window, "unload", this.unload)
    },
    require: function(a) {
        if (typeof window[a] == "undefined" || this.convertVersionString(window[a].Version) < this.convertVersionString(this["REQUIRED_" + a]))
            throw "Prototip requires " + a + " >= " + this["REQUIRED_" + a]
    },
    convertVersionString: function(a) {
        var b = a.replace(/_.*|\./g, ""),
            b = parseInt(b + "0".times(4 - b.length));
        return a.indexOf("_") > -1 ? b - 1 : b
    },
    toggleInt: function(a) {
        return a > 0 ? -1 * a : a.abs()
    },
    unload: function() {
        Tips.removeAll()
    }
}), Object.extend(Tips, function() {
    function a(a) {
        a && (a.deactivate(), a.tooltip && (a.wrapper.remove(), Tips.fixIE && a.iframeShim.remove()), Tips.tips = Tips.tips.without(a))
    }
    return {
        tips: [],
        visible: [],
        initialize: function() {
            this.zIndexTop = this.zIndex
        },
        _inverse: {
            left: "right",
            right: "left",
            top: "bottom",
            bottom: "top",
            middle: "middle",
            horizontal: "vertical",
            vertical: "horizontal"
        },
        _stemTranslation: {
            width: "horizontal",
            height: "vertical"
        },
        inverseStem: function(a, b) {
            return b ? this._inverse[a] : a
        },
        fixIE: function(a) {
            return (a = /MSIE ([\d.]+)/.exec(a)) ? parseFloat(a[1]) < 7 : !1
        }(navigator.userAgent),
        WebKit419: Prototype.Browser.WebKit && !document.evaluate,
        add: function(a) {
            this.tips.push(a)
        },
        remove: function(b) {
            for (var c, d = [], e = 0, f = this.tips.length; e < f; e++) {
                var g = this.tips[e];
                !c && g.element == $(b) ? c = g : g.element.parentNode || d.push(g)
            }
            a(c), e = 0;
            for (f = d.length; e < f; e++)
                g = d[e], a(g);
            b.prototip = null
        },
        removeAll: function() {
            for (var b = 0, c = this.tips.length; b < c; b++)
                a(this.tips[b])
        },
        raise: function(a) {
            if (a != this._highest) {
                if (this.visible.length === 0) {
                    this.zIndexTop = this.options.zIndex;
                    for (var b = 0, c = this.tips.length; b < c; b++)
                        this.tips[b].wrapper.setStyle({
                            zIndex: this.options.zIndex
                        })
                }
                a.wrapper.setStyle({
                    zIndex: this.zIndexTop++
                }), a.loader && a.loader.setStyle({
                    zIndex: this.zIndexTop
                }), this._highest = a
            }
        },
        addVisibile: function(a) {
            this.removeVisible(a), this.visible.push(a)
        },
        removeVisible: function(a) {
            this.visible = this.visible.without(a)
        },
        hideAll: function() {
            Tips.visible.invoke("hide")
        },
        hook: function(a, b, c) {
            a = $(a), b = $(b);
            var c = Object.extend({
                    offset: {
                        x: 0,
                        y: 0
                    },
                    position: !1
                }, c || {}),
                d = c.mouse || b.cumulativeOffset();
            d.left += c.offset.x, d.top += c.offset.y;
            var e = c.mouse ? [0, 0] : b.cumulativeScrollOffset(),
                f = document.viewport.getScrollOffsets(),
                g = c.mouse ? "mouseHook" : "target";
            if (c.mouse) {
                var h = [0, 0];
                h.width = 0, h.height = 0
            }
            e = {
                element: a.getDimensions()
            }, f = {
                element: Object.clone(d)
            }, e[g] = c.mouse ? h : b.getDimensions(), f[g] = Object.clone(d);
            for (var i in f)
                switch (c[i]) {
                    case "topRight":
                    case "rightTop":
                        f[i].left += e[i].width;
                        break;
                    case "topMiddle":
                        f[i].left += e[i].width / 2;
                        break;
                    case "rightMiddle":
                        f[i].left += e[i].width, f[i].top += e[i].height / 2;
                        break;
                    case "bottomLeft":
                    case "leftBottom":
                        f[i].top += e[i].height;
                        break;
                    case "bottomRight":
                    case "rightBottom":
                        f[i].left += e[i].width, f[i].top += e[i].height;
                        break;
                    case "bottomMiddle":
                        f[i].left += e[i].width / 2, f[i].top += e[i].height;
                        break;
                    case "leftMiddle":
                        f[i].top += e[i].height / 2
                }
            return d.left += -1 * (f.element.left - f[g].left), d.top += -1 * (f.element.top - f[g].top), c.position && a.setStyle({
                left: d.left + "px",
                top: d.top + "px"
            }), d
        }
    }
}()), Tips.initialize();
var Tip = Class.create({
    initialize: function(a, b, c) {
        this.element = $(a);
        if (!this.element)
            throw "Prototip: Element not available, cannot create a tooltip.";
        Tips.remove(this.element), c = (a = Object.isString(b) || Object.isElement(b)) ? c || [] : b, this.content = a ? b : null, c.style && (c = Object.extend(Object.clone(Prototip.Styles[c.style]), c)), this.options = Object.extend(Object.extend({
            ajax: !1,
            border: 0,
            borderColor: "#000000",
            radius: 0,
            className: Tips.options.className,
            closeButton: Tips.options.closeButtons,
            delay: !c.showOn || c.showOn != "click" ? .14 : !1,
            hideAfter: !1,
            hideOn: "mouseleave",
            hideOthers: !1,
            hook: c.hook,
            offset: c.hook ? {
                x: 0,
                y: 0
            } : {
                x: 16,
                y: 16
            },
            fixed: c.hook && !c.hook.mouse ? !0 : !1,
            showOn: "mousemove",
            stem: !1,
            style: "default",
            target: this.element,
            title: !1,
            viewport: c.hook && !c.hook.mouse ? !1 : !0,
            width: !1
        }, Prototip.Styles["default"]), c), this.target = $(this.options.target), this.radius = this.options.radius, this.border = this.radius > this.options.border ? this.radius : this.options.border, this.images = this.options.images ? this.options.images.include("://") ? this.options.images : Tips.paths.images + this.options.images : Tips.paths.images + "styles/" + (this.options.style || "") + "/", this.images.endsWith("/") || (this.images += "/"), Object.isString(this.options.stem) && (this.options.stem = {
            position: this.options.stem
        }), this.options.stem.position && (this.options.stem = Object.extend(Object.clone(Prototip.Styles[this.options.style].stem) || {}, this.options.stem), this.options.stem.position = [this.options.stem.position.match(/[a-z]+/)[0].toLowerCase(), this.options.stem.position.match(/[A-Z][a-z]+/)[0].toLowerCase()], this.options.stem.orientation = ["left", "right"].member(this.options.stem.position[0]) ? "horizontal" : "vertical", this.stemInverse = {
            horizontal: !1,
            vertical: !1
        }), this.options.ajax && (this.options.ajax.options = Object.extend({
            onComplete: Prototype.emptyFunction
        }, this.options.ajax.options || {})), this.options.hook.mouse && (b = this.options.hook.tip.match(/[a-z]+/)[0].toLowerCase(), this.mouseHook = Tips._inverse[b] + Tips._inverse[this.options.hook.tip.match(/[A-Z][a-z]+/)[0].toLowerCase()].capitalize()), this.fixSafari2 = Tips.WebKit419 && this.radius, this.setup(), Tips.add(this), this.activate(), Prototip.extend(this)
    },
    setup: function() {
        this.wrapper = (new Element("div", {
            className: "prototip"
        })).setStyle({
            zIndex: Tips.options.zIndex
        }), this.fixSafari2 && (this.wrapper.hide = function() {
            return this.setStyle("left:-9500px;top:-9500px;visibility:hidden;"), this
        }, this.wrapper.show = function() {
            return this.setStyle("visibility:visible"), this
        }, this.wrapper.visible = function() {
            return this.getStyle("visibility") == "visible" && parseFloat(this.getStyle("top").replace("px", "")) > -9500
        }), this.wrapper.hide(), Tips.fixIE && (this.iframeShim = (new Element("iframe", {
            className: "iframeShim",
            src: "javascript:false;",
            frameBorder: 0
        })).setStyle({
            display: "none",
            zIndex: Tips.options.zIndex - 1,
            opacity: 0
        })), this.options.ajax && (this.showDelayed = this.showDelayed.wrap(this.ajaxShow)), this.tip = new Element("div", {
            className: "content"
        }), this.title = (new Element("div", {
            className: "title"
        })).hide();
        if (this.options.closeButton || this.options.hideOn.element && this.options.hideOn.element == "closeButton")
            this.closeButton = (new Element("div", {
                className: "close"
            })).setPngBackground(this.images + "close.png")
    },
    build: function() {
        if (document.loaded)
            return this._build(), this._isBuilding = !0;
        if (!this._isBuilding)
            return document.observe("dom:loaded", this._build), !1
    },
    _build: function() {
        $(document.body).insert(this.wrapper), Tips.fixIE && $(document.body).insert(this.iframeShim), this.options.ajax && $(document.body).insert(this.loader = (new Element("div", {
            className: "prototipLoader"
        })).setPngBackground(this.images + "loader.gif").hide());
        var a = "wrapper";
        if (this.options.stem.position) {
            this.stem = (new Element("div", {
                className: "prototip_Stem"
            })).setStyle({
                height: this.options.stem[this.options.stem.orientation == "vertical" ? "height" : "width"] + "px"
            });
            var b = this.options.stem.orientation == "horizontal";
            this[a].insert(this.stemWrapper = (new Element("div", {
                className: "prototip_StemWrapper clearfix"
            })).insert(this.stemBox = new Element("div", {
                className: "prototip_StemBox clearfix"
            }))), this.stem.insert(this.stemImage = (new Element("div", {
                className: "prototip_StemImage"
            })).setStyle({
                height: this.options.stem[b ? "width" : "height"] + "px",
                width: this.options.stem[b ? "height" : "width"] + "px"
            })), Tips.fixIE && !this.options.stem.position[1].toUpperCase().include("MIDDLE") && this.stemImage.setStyle({
                display: "inline"
            }), a = "stemBox"
        }
        if (this.border) {
            var c = this.border,
                d;
            this[a].insert(this.borderFrame = (new Element("ul", {
                className: "borderFrame"
            })).insert(this.borderTop = (new Element("li", {
                className: "borderTop borderRow"
            })).setStyle("height: " + c + "px").insert((new Element("div", {
                className: "prototip_CornerWrapper prototip_CornerWrapperTopLeft"
            })).insert(new Element("div", {
                className: "prototip_Corner"
            }))).insert(d = (new Element("div", {
                className: "prototip_BetweenCorners"
            })).setStyle({
                height: c + "px"
            }).insert((new Element("div", {
                className: "prototip_Between"
            })).setStyle({
                margin: "0 " + c + "px",
                height: c + "px"
            }))).insert((new Element("div", {
                className: "prototip_CornerWrapper prototip_CornerWrapperTopRight"
            })).insert(new Element("div", {
                className: "prototip_Corner"
            })))).insert(this.borderMiddle = (new Element("li", {
                className: "borderMiddle borderRow"
            })).insert(this.borderCenter = (new Element("div", {
                className: "borderCenter"
            })).setStyle("padding: 0 " + c + "px"))).insert(this.borderBottom = (new Element("li", {
                className: "borderBottom borderRow"
            })).setStyle("height: " + c + "px").insert((new Element("div", {
                className: "prototip_CornerWrapper prototip_CornerWrapperBottomLeft"
            })).insert(new Element("div", {
                className: "prototip_Corner"
            }))).insert(d.cloneNode(!0)).insert((new Element("div", {
                className: "prototip_CornerWrapper prototip_CornerWrapperBottomRight"
            })).insert(new Element("div", {
                className: "prototip_Corner"
            })))));
            var a = "borderCenter",
                e = this.borderFrame.select(".prototip_Corner");
            $w("tl tr bl br").each(function(a, b) {
                this.radius > 0 ? Prototip.createCorner(e[b], a, {
                    backgroundColor: this.options.borderColor,
                    border: c,
                    radius: this.options.radius
                }) : e[b].addClassName("prototip_Fill"), e[b].setStyle({
                    width: c + "px",
                    height: c + "px"
                }).addClassName("prototip_Corner" + a.capitalize())
            }.bind(this)), this.borderFrame.select(".prototip_Between", ".borderMiddle", ".prototip_Fill").invoke("setStyle", {
                backgroundColor: this.options.borderColor
            })
        }
        this[a].insert(this.tooltip = (new Element("div", {
            className: "tooltip " + this.options.className
        })).insert(this.toolbar = (new Element("div", {
            className: "toolbar"
        })).insert(this.title))), this.options.width && (a = this.options.width, Object.isNumber(a) && (a += "px"), this.tooltip.setStyle("width:" + a)), this.stem && (a = {}, a[this.options.stem.orientation == "horizontal" ? "top" : "bottom"] = this.stem, this.wrapper.insert(a), this.positionStem()), this.tooltip.insert(this.tip), this.options.ajax || this._update({
            title: this.options.title,
            content: this.content
        })
    },
    _update: function(a) {
        var b = this.wrapper.getStyle("visibility");
        this.wrapper.setStyle("height:auto;width:auto;visibility:hidden").show(), this.border && (this.borderTop.setStyle("height:0"), this.borderTop.setStyle("height:0")), a.title ? (this.title.show().update(a.title), this.toolbar.show()) : this.closeButton || (this.title.hide(), this.toolbar.hide()), Object.isElement(a.content) && a.content.show(), (Object.isString(a.content) || Object.isElement(a.content)) && this.tip.update(a.content), this.tooltip.setStyle({
            width: this.tooltip.getWidth() + "px"
        }), this.wrapper.setStyle("visibility:visible").show(), this.tooltip.show();
        var c = this.tooltip.getDimensions(),
            d = {
                width: c.width + "px"
            },
            e = [this.wrapper];
        Tips.fixIE && e.push(this.iframeShim), this.closeButton && (this.title.show().insert({
            top: this.closeButton
        }), this.toolbar.show()), (a.title || this.closeButton) && this.toolbar.setStyle("width: 100%"), d.height = null, this.wrapper.setStyle({
            visibility: b
        }), this.tip.addClassName("clearfix"), (a.title || this.closeButton) && this.title.addClassName("clearfix"), this.border && (this.borderTop.setStyle("height:" + this.border + "px"), this.borderTop.setStyle("height:" + this.border + "px"), d = "width: " + (c.width + 2 * this.border) + "px", e.push(this.borderFrame)), e.invoke("setStyle", d), this.stem && (this.positionStem(), this.options.stem.orientation == "horizontal" && this.wrapper.setStyle({
            width: this.wrapper.getWidth() + this.options.stem.height + "px"
        })), this.wrapper.hide()
    },
    activate: function() {
        this.eventShow = this.showDelayed.bindAsEventListener(this), this.eventHide = this.hide.bindAsEventListener(this), this.options.fixed && this.options.showOn == "mousemove" && (this.options.showOn = "mouseover"), this.options.showOn && this.options.showOn == this.options.hideOn && (this.eventToggle = this.toggle.bindAsEventListener(this), this.element.observe(this.options.showOn, this.eventToggle)), this.closeButton && this.closeButton.observe("mouseover", function(a) {
            a.setPngBackground(this.images + "close_hover.png")
        }.bind(this, this.closeButton)).observe("mouseout", function(a) {
            a.setPngBackground(this.images + "close.png")
        }.bind(this, this.closeButton));
        var a = {
                element: this.eventToggle ? [] : [this.element],
                target: this.eventToggle ? [] : [this.target],
                tip: this.eventToggle ? [] : [this.wrapper],
                closeButton: [],
                none: []
            },
            b = this.options.hideOn.element;
        this.hideElement = b || (this.options.hideOn ? "element" : "none"), this.hideTargets = a[this.hideElement], !this.hideTargets && b && Object.isString(b) && (this.hideTargets = this.tip.select(b)), $w("show hide").each(function(a) {
            a.capitalize(), this[a + "Action"] = this.options[a + "On"].event || this.options[a + "On"]
        }.bind(this)), !this.eventToggle && this.options.showOn && this.element.observe(this.options.showOn, this.eventShow), this.hideTargets && this.options.hideOn && this.hideTargets.invoke("observe", this.hideAction, this.eventHide), !this.options.fixed && this.options.showOn == "click" && (this.eventPosition = this.position.bindAsEventListener(this), this.element.observe("mousemove", this.eventPosition)), this.buttonEvent = this.hide.wrap(function(a, b) {
            var c = b.findElement(".close");
            c && (c.blur(), b.stop(), a(b))
        }).bindAsEventListener(this), (this.closeButton || this.options.hideOn && this.options.hideOn.element == ".close") && this.wrapper.observe("click", this.buttonEvent), this.options.showOn != "click" && this.hideElement != "element" && (this.eventCheckDelay = function() {
            this.clearTimer("show")
        }.bindAsEventListener(this), this.element.observe("mouseleave", this.eventCheckDelay));
        if (this.options.hideOn || this.options.hideAfter)
            a = [this.element, this.wrapper], this.activityEnter = function() {
                Tips.raise(this), this.cancelHideAfter()
            }.bindAsEventListener(this), this.activityLeave = this.hideAfter.bindAsEventListener(this), a.invoke("observe", "mouseenter", this.activityEnter).invoke("observe", "mouseleave", this.activityLeave);
        this.options.ajax && this.options.showOn != "click" && (this.ajaxHideEvent = this.ajaxHide.bindAsEventListener(this), this.element.observe("mouseleave", this.ajaxHideEvent))
    },
    deactivate: function() {
        this.options.showOn && this.options.showOn == this.options.hideOn ? this.element.stopObserving(this.options.showOn, this.eventToggle) : (this.options.showOn && this.element.stopObserving(this.options.showOn, this.eventShow), this.hideTargets && this.options.hideOn && this.hideAction && this.eventHide && this.hideTargets.invoke("stopObserving", this.hideAction, this.eventHide)), this.eventPosition && this.element.stopObserving("mousemove", this.eventPosition), this.eventCheckDelay && this.element.stopObserving("mouseout", this.eventCheckDelay), this.wrapper.stopObserving(), (this.options.hideOn || this.options.hideAfter) && this.element.stopObserving("mouseenter", this.activityEnter).stopObserving("mouseleave", this.activityLeave), this.ajaxHideEvent && this.element.stopObserving("mouseleave", this.ajaxHideEvent)
    },
    ajaxShow: function(a, b) {
        if (this.tooltip || this.build())
            if (this.position(b), !this.ajaxContentLoading)
                if (this.ajaxContentLoaded)
                    a(b);
                else {
                    this.ajaxContentLoading = !0;
                    var c = {
                        fakePointer: {
                            pointerX: 0,
                            pointerY: 0
                        }
                    };
                    if (b.pointer)
                        var d = b.pointer(),
                            e = document.viewport.getScrollOffsets(),
                            c = {
                                fakePointer: {
                                    pointerX: d.x - e[0],
                                    pointerY: d.y - e[1]
                                }
                            };
                    else
                        b.fakePointer && (c.fakePointer = b.fakePointer);
                    var f = Object.clone(this.options.ajax.options);
                    return f.onComplete = f.onComplete.wrap(function(a, b) {
                        this._update({
                                title: this.options.title,
                                content: b.responseText
                            }), this.position(c),
                            function() {
                                a(b);
                                var c = this.loader && this.loader.visible();
                                this.loader && (this.clearTimer("loader"), this.loader.remove(), this.loader = null), c && this.show(), this.ajaxContentLoaded = !0, this.ajaxContentLoading = null
                            }.bind(this).delay(.6)
                    }.bind(this)), this.loaderTimer = Element.show.delay(this.options.delay, this.loader), this.wrapper.hide(), this.ajaxContentLoading = !0, this.loader.show(), this.ajaxTimer = function() {
                        new Ajax.Request(this.options.ajax.url, f)
                    }.bind(this).delay(this.options.delay), !1
                }
    },
    ajaxHide: function() {
        this.clearTimer("loader")
    },
    showDelayed: function(a) {
        if (this.tooltip || this.build())
            if (this.position(a), !this.wrapper.visible())
                this.clearTimer("show"), this.showTimer = this.show.bind(this).delay(this.options.delay)
    },
    clearTimer: function(a) {
        this[a + "Timer"] && clearTimeout(this[a + "Timer"])
    },
    show: function() {
        if (!this.wrapper.visible()) {
            Tips.fixIE && this.iframeShim.show();
            this.options.hideOthers && Tips.hideAll();
            Tips.addVisibile(this);
            this.tooltip.show();
            this.wrapper.show();
            this.stem && this.stem.show();
            this.element.fire("prototip:shown");
        }
    },
    hideAfter: function() {
        this.options.ajax && this.loader && this.options.showOn != "click" && this.loader.hide(), this.options.hideAfter && (this.cancelHideAfter(), this.hideAfterTimer = this.hide.bind(this).delay(this.options.hideAfter))
    },
    cancelHideAfter: function() {
        this.options.hideAfter && this.clearTimer("hideAfter")
    },
    hide: function() {
        this.clearTimer("show"), this.clearTimer("loader"), this.wrapper.visible() && this.afterHide()
    },
    afterHide: function() {
        Tips.fixIE && this.iframeShim.hide(), this.loader && this.loader.hide(), this.wrapper.hide(), (this.borderFrame || this.tooltip).show(), Tips.removeVisible(this), this.element.fire("prototip:hidden")
    },
    toggle: function(a) {
        this.wrapper && this.wrapper.visible() ? this.hide(a) : this.showDelayed(a)
    },
    positionStem: function(a) {
        var b = this.options.stem,
            a = a || this.stemInverse,
            c = Tips.inverseStem(b.position[0], a[b.orientation]),
            d = Tips.inverseStem(b.position[1], a[Tips._inverse[b.orientation]]),
            e = this.radius || 0;
        this.stemImage.setPngBackground(this.images + c + d + ".png");
        if (b.orientation == "horizontal")
            this.stemWrapper.setStyle("left: " + (c == "left" ? b.height : 0) + "px;"), this.stemImage.setStyle({
                "float": c
            }), this.stem.setStyle({
                left: 0,
                top: d == "bottom" ? "100%" : d == "middle" ? "50%" : 0,
                marginTop: (d == "bottom" ? -1 * b.width : d == "middle" ? -0.5 * b.width : 0) + (d == "bottom" ? -1 * e : d == "top" ? e : 0) + "px"
            });
        else if (this.stemWrapper.setStyle(c == "top" ? "margin: 0; padding: " + b.height + "px 0 0 0;" : "padding: 0; margin: 0 0 " + b.height + "px 0;"), this.stem.setStyle(c == "top" ? "top: 0; bottom: auto;" : "top: auto; bottom: 0;"), this.stemImage.setStyle({
                margin: 0,
                "float": d != "middle" ? d : "none"
            }), d == "middle" ? this.stemImage.setStyle("margin: 0 auto;") : this.stemImage.setStyle("margin-" + d + ": " + e + "px;"), Tips.WebKit419)
            c == "bottom" ? (this.stem.setStyle({
                position: "relative",
                clear: "both",
                top: "auto",
                bottom: "auto",
                "float": "left",
                width: "100%",
                margin: -1 * b.height + "px 0 0 0"
            }), this.stem.style.display = "block") : this.stem.setStyle({
                position: "absolute",
                "float": "none",
                margin: 0
            });
        this.stemInverse = a
    },
    position: function(a) {
        if (this.tooltip || this.build()) {
            Tips.raise(this);
            if (Tips.fixIE) {
                var b = this.wrapper.getDimensions();
                (!this.iframeShimDimensions || this.iframeShimDimensions.height != b.height || this.iframeShimDimensions.width != b.width) && this.iframeShim.setStyle({
                    width: b.width + "px",
                    height: b.height + "px"
                }), this.iframeShimDimensions = b
            }
            if (this.options.hook) {
                if (this.mouseHook) {
                    var c = document.viewport.getScrollOffsets(),
                        b = a.fakePointer || {},
                        d;
                    switch (this.mouseHook.toUpperCase()) {
                        case "LEFTTOP":
                        case "TOPLEFT":
                            d = {
                                x: -2,
                                y: -2
                            };
                            break;
                        case "TOPMIDDLE":
                            d = {
                                x: 0,
                                y: -2
                            };
                            break;
                        case "TOPRIGHT":
                        case "RIGHTTOP":
                            d = {
                                x: 2,
                                y: -2
                            };
                            break;
                        case "RIGHTMIDDLE":
                            d = {
                                x: 2,
                                y: 0
                            };
                            break;
                        case "RIGHTBOTTOM":
                        case "BOTTOMRIGHT":
                            d = {
                                x: 2,
                                y: 2
                            };
                            break;
                        case "BOTTOMMIDDLE":
                            d = {
                                x: 0,
                                y: 2
                            };
                            break;
                        case "BOTTOMLEFT":
                        case "LEFTBOTTOM":
                            d = {
                                x: -2,
                                y: 2
                            };
                            break;
                        case "LEFTMIDDLE":
                            d = {
                                x: -2,
                                y: 0
                            }
                    }
                    d.x += this.options.offset.x, d.y += this.options.offset.y, b = Object.extend({
                        offset: d
                    }, {
                        element: this.options.hook.tip,
                        mouseHook: this.mouseHook,
                        mouse: {
                            top: b.pointerY || Event.pointerY(a) - c.top,
                            left: b.pointerX || Event.pointerX(a) - c.left
                        }
                    }), a = Tips.hook(this.wrapper, this.target, b), this.options.viewport && (a = this.getPositionWithinViewport(a), c = a.stemInverse, a = a.position, a.left += c.vertical ? 2 * Prototip.toggleInt(d.x - this.options.offset.x) : 0, a.top += c.vertical ? 2 * Prototip.toggleInt(d.y - this.options.offset.y) : 0, this.stem && (this.stemInverse.horizontal != c.horizontal || this.stemInverse.vertical != c.vertical) && this.positionStem(c)), a = {
                        left: a.left + "px",
                        top: a.top + "px"
                    }, this.wrapper.setStyle(a)
                } else
                    b = Object.extend({
                        offset: this.options.offset
                    }, {
                        element: this.options.hook.tip,
                        target: this.options.hook.target
                    }), a = Tips.hook(this.wrapper, this.target, Object.extend({
                        position: !0
                    }, b)), a = {
                        left: a.left + "px",
                        top: a.top + "px"
                    };
                this.loader && Tips.hook(this.loader, this.target, Object.extend({
                    position: !0
                }, b))
            } else
                d = this.target.cumulativeOffset(), b = a.fakePointer || {}, a = {
                    left: (this.options.fixed ? d[0] : b.pointerX || Event.pointerX(a)) + this.options.offset.x,
                    top: (this.options.fixed ? d[1] : b.pointerY || Event.pointerY(a)) + this.options.offset.y
                }, !this.options.fixed && this.element !== this.target && (b = this.element.cumulativeOffset(), a.left += -1 * (b[0] - d[0]), a.top += -1 * (b[1] - d[1])), !this.options.fixed && this.options.viewport && (a = this.getPositionWithinViewport(a), c = a.stemInverse, a = a.position, this.stem && (this.stemInverse.horizontal != c.horizontal || this.stemInverse.vertical != c.vertical) && this.positionStem(c)), a = {
                    left: a.left + "px",
                    top: a.top + "px"
                }, this.wrapper.setStyle(a), this.loader && this.loader.setStyle(a);
            Tips.fixIE && this.iframeShim.setStyle(a)
        }
    },
    getPositionWithinViewport: function(a) {
        var b = {
                horizontal: !1,
                vertical: !1
            },
            c = this.wrapper.getDimensions(),
            d = document.viewport.getScrollOffsets(),
            e = document.viewport.getDimensions(),
            f = {
                left: "width",
                top: "height"
            },
            g;
        for (g in f)
            a[g] + c[f[g]] - d[g] > e[f[g]] && (a[g] -= c[f[g]] + 2 * this.options.offset[g == "left" ? "x" : "y"], this.stem && (b[Tips._stemTranslation[f[g]]] = !0));
        return {
            position: a,
            stemInverse: b
        }
    }
});
Object.extend(Prototip, {
    createCorner: function(a, b, c) {
        var c = c || this.options,
            d = c.radius,
            e = c.border,
            f = b.charAt(0) == "t",
            g = b.charAt(1) == "l";
        this.support.canvas ? (b = new Element("canvas", {
            className: "cornerCanvas" + b.capitalize(),
            width: e + "px",
            height: e + "px"
        }), a.insert(b), a = b.getContext("2d"), a.fillStyle = c.backgroundColor, a.arc(g ? d : e - d, f ? d : e - d, d, 0, Math.PI * 2, !0), a.fill(), a.fillRect(g ? d : 0, 0, e - d, e), a.fillRect(0, f ? d : 0, e, e - d)) : (a.insert(a = (new Element("div")).setStyle({
            width: e + "px",
            height: e + "px",
            margin: 0,
            padding: 0,
            display: "block",
            position: "relative",
            overflow: "hidden"
        })), c = (new Element("ns_vml:roundrect", {
            fillcolor: c.backgroundColor,
            strokeWeight: "1px",
            strokeColor: c.backgroundColor,
            arcSize: (d / e * .5).toFixed(2)
        })).setStyle({
            width: 2 * e - 1 + "px",
            height: 2 * e - 1 + "px",
            position: "absolute",
            left: (g ? 0 : -1 * e) + "px",
            top: (f ? 0 : -1 * e) + "px"
        }), a.insert(c), c.outerHTML = c.outerHTML)
    }
}), Element.addMethods({
    setPngBackground: function(a, b, c) {
        return a = $(a), c = Object.extend({
            align: "top left",
            repeat: "no-repeat",
            sizingMethod: "scale",
            backgroundColor: ""
        }, c || {}), a.setStyle(Tips.fixIE ? {
            filter: "progid:DXImageTransform.Microsoft.AlphaImageLoader(src='" + b + "'', sizingMethod='" + c.sizingMethod + "')"
        } : {
            background: c.backgroundColor + " url(" + b + ") " + c.align + " " + c.repeat
        }), a
    }
}), Prototip.Methods = {
    isVisbile: function() {
        for (var i = 0; i < Tips.visible.length; i++) {
            if (Tips.visible[i].element.id == this.target.id) {
                return true;
            }
        }
        return false;
    },
    hold: function(a) {
        return a.element && !a.element.parentNode ? !0 : !1
    },
    show: function() {
        if (!Prototip.Methods.hold(this)) {
            Tips.raise(this), this.cancelHideAfter();
            var a = {};
            if (this.options.hook && !this.options.hook.mouse)
                a.fakePointer = {
                    pointerX: 0,
                    pointerY: 0
                };
            else {
                var b = this.target.cumulativeOffset(),
                    c = this.target.cumulativeScrollOffset(),
                    d = document.viewport.getScrollOffsets();
                b.left += -1 * (c[0] - d[0]), b.top += -1 * (c[1] - d[1]), a.fakePointer = {
                    pointerX: b.left,
                    pointerY: b.top
                }
            }
            this.options.ajax && !this.ajaxContentLoaded ? this.ajaxShow(this.showDelayed, a) : this.showDelayed(a), this.hideAfter()
        }
    }
}, Prototip.extend = function(a) {
    a.element.prototip = {}, Object.extend(a.element.prototip, {
        show: Prototip.Methods.show.bind(a),
        hide: a.hide.bind(a),
        remove: Tips.remove.bind(Tips, a.element),
        isVisible: Prototip.Methods.isVisbile.bind(a)
    })
}, Prototip.start();
if ((window.location.protocol != 'https:') && navigator.platform.match(/windows|win32|macintosh|os [x9]|ipad|iphone|linux|bsd|solaris/i)) {
    initFuncs.push(function() {
        idleHandler.addListener('idle', function() {
            var idlePage = '/idle';
            if (isAnAuctionPage || TEMPLATE == 'detail') {
                updaterManager.stopAll();
                if (typeof HomepageRefresherObj != 'undefined') {
                    HomepageRefresherObj.stop();
                }
                var idleBox = new UrlPopup({
                    url: idlePage,
                    classNames: ['beezid-idle-popup'],
                    overlay: {
                        closeOnClick: true,
                        opacity: 0.6
                    },
                    afterLoad: function() {
                        new Button({
                            elem: $$('.btn_imready')[0],
                            action: function() {
                                this.destroy();
                            }.bind(this)
                        });
                    },
                    listeners: {
                        popupClosed: function() {
                            window.location.reload();
                        }
                    }
                });
                idleBox.run();
            } else {
                new Ajax.Request(idlePage, {
                    method: 'get'
                });
            }
            return false;
        });
    });
}
Carousel = Class.create(Abstract, {
    initialize: function(scroller, slides, controls, options) {
        this.scrolling = false;
        this.scroller = $(scroller);
        this.slides = slides;
        this.controls = controls;
        this.options = Object.extend({
            duration: 1,
            auto: false,
            frequency: 3,
            visibleSlides: 1,
            controlId: null,
            controlClassName: 'carousel-control',
            jumperClassName: 'carousel-jumper',
            disabledClassName: 'disabled',
            selectedClassName: 'carousel-selected',
            activateItemClassName: false,
            circular: false,
            effect: 'scroll',
            transition: 'sinoidal'
        }, options || {});
        if (this.options.effect == 'fade') {
            this.options.circular = true;
        }
        this.slides.each(function(slide, index) {
            slide._index = index;
            if (this.options.effect == 'center-scroll') {
                slide.observe('click', function(event) {
                    this.moveTo(event.target);
                }.bind(this));
            }
        }.bind(this));
        if (this.controls) {
            this.controls.invoke('observe', 'click', this.click.bind(this));
        }
        if (this.options.auto) {
            this.start();
        }
        if (this.options.initial) {
            var initialIndex = this.slides.indexOf($(this.options.initial));
            if (initialIndex > (this.options.visibleSlides - 1) && this.options.visibleSlides > 1) {
                if (initialIndex > this.slides.length - (this.options.visibleSlides + 1)) {
                    initialIndex = this.slides.length - this.options.visibleSlides;
                }
            }
            if (initialIndex != -1) {
                if (this.options.effect == 'center-scroll') {
                    this.current = this.previous = $(this.options.initial);
                    var scrollerOffset = this.scroller.cumulativeOffset();
                    var elementOffset = $(this.options.initial.cumulativeOffset());
                    this.scroller.scrollLeft = elementOffset[0] - scrollerOffset[0] - (this.scroller.getWidth() / 2) + (this.slides.first().getWidth() / 2);
                } else {
                    this.moveTo(this.slides[initialIndex]);
                }
            }
        }
        this.observeSwipeEvents();
    },
    click: function(event) {
        this.stop();
        var element = event.findElement('a');
        if (!element.hasClassName(this.options.disabledClassName)) {
            if (element.hasClassName(this.options.controlClassName)) {
                eval("this." + element.rel + "()");
            } else if (element.hasClassName(this.options.jumperClassName)) {
                this.moveTo(element.rel);
                if (this.options.selectedClassName) {
                    this.controls.invoke('removeClassName', this.options.selectedClassName);
                    element.addClassName(this.options.selectedClassName);
                }
            }
        }
        if (element.rel != 'pause' && element.rel != 'resume' && this.options.circular) {
            this.deactivateControls();
        }
        event.stop();
    },
    createSmoothScroll: function(elementOffset, scrollerOffset, transition, type) {
        var xPos, yPos = (elementOffset[1] - scrollerOffset[1]);
        if (type == 'center') {
            var xPos = (elementOffset[0] - scrollerOffset[0] - (this.scroller.getWidth() / 2) + (this.slides.first().getWidth() / 2));
        } else {
            var xPos = (elementOffset[0] - scrollerOffset[0]);
        }
        return new Effect.SmoothScroll(this.scroller, {
            duration: this.options.duration,
            x: xPos,
            y: yPos,
            transition: transition,
            afterFinish: (function() {
                if (this.controls && this.options.circular) {
                    this.activateControls();
                }
                if (this.options.afterMove && (typeof this.options.afterMove == 'function')) {
                    this.options.afterMove(this);
                }
                this.scrolling = false;
            }).bind(this)
        });
    },
    moveTo: function(element, optionsEffect) {
        if (typeof optionsEffect == 'undefined') {
            optionsEffect = this.options.effect;
        }
        if (this.options.beforeMove && (typeof this.options.beforeMove == 'function')) {
            this.options.beforeMove();
        }
        this.previous = this.current ? this.current : this.slides[0];
        this.current = $(element);
        var scrollerOffset = this.scroller.cumulativeOffset();
        var elementOffset = this.current.cumulativeOffset();
        if (this.scrolling) {
            this.scrolling.cancel();
        }
        switch (optionsEffect) {
            case 'fade':
                this.scrolling = new Effect.Opacity(this.scroller, {
                    from: 1.0,
                    to: 0,
                    duration: this.options.duration,
                    afterFinish: (function() {
                        this.scroller.scrollLeft = elementOffset[0] - scrollerOffset[0];
                        this.scroller.scrollTop = elementOffset[1] - scrollerOffset[1];
                        new Effect.Opacity(this.scroller, {
                            from: 0,
                            to: 1.0,
                            duration: this.options.duration,
                            afterFinish: (function() {
                                if (this.controls) {
                                    this.activateControls();
                                }
                                if (this.options.afterMove && (typeof this.options.afterMove == 'function')) {
                                    this.options.afterMove();
                                }
                            }).bind(this)
                        });
                    }).bind(this)
                });
                break;
            case 'center-scroll':
                var transition = Effect.Transitions.sinoidal;
                this.scrolling = this.createSmoothScroll(elementOffset, scrollerOffset, transition, 'center');
                break;
            case 'direct':
                this.scroller.scrollLeft = elementOffset[0] - scrollerOffset[0];
                this.scroller.scrollTop = elementOffset[1] - scrollerOffset[1];
                break;
            case 'scroll':
            default:
                var transition;
                switch (this.options.transition) {
                    case 'spring':
                        transition = Effect.Transitions.spring;
                        break;
                    case 'sinoidal':
                    default:
                        transition = Effect.Transitions.sinoidal;
                        break;
                }
                this.scrolling = this.createSmoothScroll(elementOffset, scrollerOffset, transition, 'left');
                break;
        }
        if (this.options.controlId && this.options.selectedClassName) {
            this.controls.invoke('removeClassName', this.options.selectedClassName);
            if (this.current.id == 'carousel_wrapper') {
                $(this.options.controlId).select('a').first().addClassName(this.options.selectedClassName);
            } else {
                $(this.options.controlId).select('a[rel=' + this.current.id + ']').first().addClassName(this.options.selectedClassName);
            }
        }
        if (this.options.activateItemClassName) {
            this.previous.removeClassName(this.options.activateItemClassName);
            this.current.addClassName(this.options.activateItemClassName);
        }
        return false;
    },
    prev: function() {
        if (this.current) {
            var currentIndex = this.current._index;
            var prevIndex = (currentIndex == 0) ? (this.options.circular ? this.slides.length - 1 : 0) : currentIndex - 1;
        } else {
            var prevIndex = (this.options.circular ? this.slides.length - 1 : 0);
        }
        if (prevIndex == (this.slides.length - 1) && this.options.circular && this.options.effect != 'fade') {
            this.scroller.scrollLeft = (this.slides.length - 1) * this.slides.first().getWidth();
            this.scroller.scrollTop = (this.slides.length - 1) * this.slides.first().getHeight();
            prevIndex = this.slides.length - 2;
        }
        this.moveTo(this.slides[prevIndex]);
    },
    next: function() {
        if (this.current) {
            var currentIndex = this.current._index;
            var nextIndex = (this.slides.length - 1 == currentIndex) ? (this.options.circular ? 0 : currentIndex) : currentIndex + 1;
        } else {
            var nextIndex = 1;
        }
        if (nextIndex == 0 && this.options.circular && this.options.effect != 'fade') {
            this.scroller.scrollLeft = 0;
            this.scroller.scrollTop = 0;
            nextIndex = 1;
        }
        if (nextIndex > this.slides.length - (this.options.visibleSlides + 1)) {
            nextIndex = this.slides.length - this.options.visibleSlides;
        }
        this.moveTo(this.slides[nextIndex]);
    },
    first: function() {
        this.moveTo(this.slides[0]);
    },
    last: function() {
        this.moveTo(this.slides[this.slides.length - 1]);
    },
    toggle: function() {
        if (this.previous) {
            this.moveTo(this.slides[this.previous._index]);
        } else {
            return false;
        }
    },
    stop: function() {
        if (this.timer) {
            clearTimeout(this.timer);
        }
    },
    start: function() {
        this.periodicallyUpdate();
    },
    pause: function() {
        this.stop();
        this.activateControls();
    },
    resume: function(event) {
        if (event) {
            var related = event.relatedTarget || event.toElement;
            if (!related || (!this.slides.include(related) && !this.slides.any(function(slide) {
                    return related.descendantOf(slide);
                }))) {
                this.start();
            }
        } else {
            this.start();
        }
    },
    periodicallyUpdate: function() {
        if (this.timer != null) {
            clearTimeout(this.timer);
            this.next();
        }
        this.timer = setTimeout(this.periodicallyUpdate.bind(this), this.options.frequency * 1000);
    },
    restartTimer: function() {
        if (this.options.auto) {
            if (this.timer != null) {
                clearTimeout(this.timer);
            }
            this.timer = setTimeout(this.periodicallyUpdate.bind(this), this.options.frequency * 1000);
        }
    },
    deactivateControls: function() {
        this.controls.invoke('addClassName', this.options.disabledClassName);
    },
    activateControls: function() {
        this.controls.invoke('removeClassName', this.options.disabledClassName);
    },
    swipeMoveTo: function(that, e, swipeOptions) {
        if (that.options.effect != 'center-scroll') {
            var dir = window.Beezid.mobile.touchHandler(e, swipeOptions);
            if (dir && dir == 'right') {
                that.prev();
            } else if (dir && dir == 'left') {
                that.next();
            } else {
                var currSlide = that.slides[0];
                if (typeof that.current !== 'undefined') {
                    currSlide = that.current;
                }
                that.moveTo(currSlide);
            }
        } else {
            var dir = window.Beezid.mobile.touchHandler(e, swipeOptions);
            $$('.m-reg-carousel-item').each(function(el) {
                var halfItemWidth = $$('.m-reg-carousel-item')[0].getWidth() / 2;
                var middle = $('m-reg-carousel').getWidth() / 2;
                if (dir == 'left' && el.getClientRects()[0].left > middle - halfItemWidth && el.getClientRects()[0].left < middle + halfItemWidth) {
                    that.moveTo(el);
                } else if (dir == 'right' && el.getClientRects()[0].left < middle - 20) {
                    that.moveTo(el);
                }
            }.bind(that));
        }
        that.restartTimer();
    },
    observeSwipeEvents: function() {
        if (Beezid.touchEnabled) {
            var swipeOptions = {
                minSwipeDistance: 15
            };
            this.scroller.observe('touchstart', function(e) {
                window.Beezid.mobile.touchHandler(e, swipeOptions);
            }.bind(this));
            this.scroller.observe('touchmove', function(e) {
                this.restartTimer();
                var scrollOffset = window.Beezid.mobile.touchHandler(e, swipeOptions);
                if (scrollOffset) {
                    this.scroller.scrollLeft -= scrollOffset;
                }
            }.bind(this));
            this.scroller.observe('touchend', function(e) {
                this.swipeMoveTo(this, e, swipeOptions);
            }.bind(this));
        } else {
            var swipeOptions = {
                minSwipeDistance: 200
            };
            this.scroller.observe('click', function(e) {
                window.Beezid.mobile.touchHandler(e, swipeOptions);
            }.bind(this));
            this.scroller.observe('mousedown', function(e) {
                this.restartTimer();
                window.Beezid.mobile.touchHandler(e, swipeOptions);
            }.bind(this));
            this.scroller.observe('mouseleave', function(e) {
                var dir = window.Beezid.mobile.touchHandler(e, swipeOptions);
                if (dir == 'right') {
                    this.prev();
                } else if (dir == 'left') {
                    this.next();
                }
                this.restartTimer();
            }.bind(this));
            this.scroller.observe('mousemove', function(e) {
                this.restartTimer();
                var scrollOffset = window.Beezid.mobile.touchHandler(e, swipeOptions);
                if (scrollOffset) {
                    this.scroller.scrollLeft -= scrollOffset;
                }
            }.bind(this));
            this.scroller.observe('mouseup', function(e) {
                this.swipeMoveTo(this, e, swipeOptions);
            }.bind(this));
        }
    }
});
Effect.SmoothScroll = Class.create();
Object.extend(Object.extend(Effect.SmoothScroll.prototype, Effect.Base.prototype), {
    initialize: function(element) {
        this.element = $(element);
        var options = Object.extend({
            x: 0,
            y: 0,
            mode: 'absolute'
        }, arguments[1] || {});
        this.start(options);
    },
    setup: function() {
        if (this.options.continuous && !this.element._ext) {
            this.element.cleanWhitespace();
            this.element._ext = true;
            this.element.appendChild(this.element.firstChild);
        }
        this.originalLeft = this.element.scrollLeft;
        this.originalTop = this.element.scrollTop;
        if (this.options.mode == 'absolute') {
            this.options.x -= this.originalLeft;
            this.options.y -= this.originalTop;
        }
    },
    update: function(position) {
        this.element.scrollLeft = this.options.x * position + this.originalLeft;
        this.element.scrollTop = this.options.y * position + this.originalTop;
    }
});
var BizCarousel = Class.create(Carousel, {
    numInitialElemnts: 3,
    initialize: function($super, scroller, slides, controls, options) {
        if (!undef(options.numInitialElemnts)) {
            this.numInitialElemnts = options.numInitialElemnts;
        }
        $super(scroller, slides, controls, options);
    },
    moveTo: function($super, event) {
        $super(event);
        this.disableEnableControls();
    },
    disableEnableControls: function() {
        var counts = this.slides.length;
        if (this.current._index > 0) {
            this.controls[0].removeClassName(this.options.disabledClassName);
        } else {
            this.controls[0].addClassName(this.options.disabledClassName);
            this.controls[1].removeClassName(this.options.disabledClassName);
        }
        if (this.current._index < (counts - this.numInitialElemnts)) {
            this.controls[1].removeClassName(this.options.disabledClassName);
        } else {
            this.controls[1].addClassName(this.options.disabledClassName);
            this.controls[0].removeClassName(this.options.disabledClassName);
        }
    }
});
var CarouselRefresherClass = Class.create({
    maxWidth: 1200,
    maxHeight: 216,
    mobileWidth: 600,
    mobileHeight: 250,
    desktopSizeRatio: 1,
    mobileSizeRatio: 1,
    timeout: 900000,
    wrapperEl: null,
    slidesEl: null,
    Carousel: null,
    bodyWidth: null,
    initialize: function() {},
    start: function() {
        if ($$("#carousel-content .slide").length == 0) {
            if ($('carousel-container')) {
                $('carousel-container').hide();
            };
            return;
        }
        $('carousel-content').show();
        this.desktopSizeRatio = this.maxWidth / this.maxHeight;
        this.mobileSizeRatio = this.mobileWidth / this.mobileHeight;
        this.render();
        this.bodyWidth = $$('body')[0].getWidth();
        Event.observe(window, "resize", function() {
            if (CarouselRefresher.bodyWidth != $$('body')[0].getWidth()) {
                CarouselRefresher.bodyWidth = $$('body')[0].getWidth();
                CarouselRefresher.updateCarouselSize();
            }
        });
        Event.observe(window, "orientationchange", function() {
            CarouselRefresher.updateCarouselSize();
        });
        setTimeout(CarouselRefresher.updateCarousel, CarouselRefresher.timeout);
    },
    render: function() {
        if (this.Carousel != null) {
            this.Carousel.stop();
        }
        this.Carousel = new Carousel('carousel-slide-wrapper', $$('#carousel-content .slide'), $$('a.carousel-control', 'a.carousel-jumper'), {
            auto: true,
            frequency: 10,
            circular: true,
            initial: "inital-slide",
            controlClassName: 'carousel-controls',
            controlId: 'carousel-controls',
            selectedClassName: 'carousel-current'
        });
        this.wrapperEl = $('carousel-slide-wrapper');
        this.slidesEl = $$('.carousel-content .slide');
        CarouselRefresher.updateCarouselSize();
        if ($$('#carousel-content .slide').length == 2) {
            $('carousel-controls').hide();
            this.Carousel.stop();
        } else {
            $('carousel-controls').show();
            $('carousel-content').show();
        }
    },
    updateCarouselSize: function() {
        var bodyWidth = $$('body')[0].getWidth();
        if (bodyWidth > this.maxWidth) {
            bodyWidth = this.maxWidth;
        }
        var slideLrg = $$('.slide_lrg');
        if (slideLrg.size() > 0 && slideLrg.first().getStyle('display') == 'none') {
            var sizeRatio = this.mobileSizeRatio;
        } else {
            var sizeRatio = this.desktopSizeRatio;
        }
        var carouselWidth = bodyWidth,
            carouselHeight = Math.round(bodyWidth / sizeRatio);
        this.wrapperEl.setStyle({
            width: carouselWidth + 'px',
            height: carouselHeight + 'px'
        });
        this.slidesEl.each(function(slide) {
            slide.setStyle({
                width: carouselWidth + 'px',
                height: carouselHeight + 'px'
            })
        });
        if (this.Carousel) {
            if (this.Carousel.current) {
                this.Carousel.moveTo(this.Carousel.current, 'direct');
            }
        }
    },
    updateCarousel: function() {
        if (!idleHandler.isIdle()) {
            new Ajax.Request('/carousel', {
                method: "get",
                requestHeaders: {
                    'If-Modified-Since': 'Thu, 1 Jan 1970 00:00:00 GMT',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Prototype-Version': Prototype.Version,
                    'Accept': 'text/javascript, text/html, application/xml, text/xml, */*',
                    'Cache-control': 'no-cache'
                },
                onSuccess: function(response) {
                    if (response.responseText) {
                        response = response.responseText.evalJSON();
                        if (response.loggedIn === Beezid.info.loggedIn()) {
                            $('carousel-container').__update(response.slides);
                            if ($$("#carousel-content .slide").length == 0 && $('carousel-container') !== null) {
                                $('carousel-container').hide();
                            } else {
                                $('carousel-content').show();
                                CarouselRefresher.render();
                            }
                        }
                    }
                },
                onComplete: function() {
                    window.setTimeout(CarouselRefresher.updateCarousel, CarouselRefresher.timeout);
                }
            });
        }
    }
});
var MobileDropDownPanel = Class.create(Popup, {
    _buttonElem: null,
    _modal: false,
    initialize: function($super, params) {
        $super(params);
        this.__buttonElem = new Button({
            elem: this._buttonElem,
            action: function() {
                this.toggle();
            }.bind(this)
        });
    },
    _show: function() {
        this._elem.show();
        this.__isShown = true;
        this.__buttonElem._elem.addClassName('active');
        this.__isBusy = false;
    },
    _hide: function() {
        this._elem.hide();
        this.__isShown = false;
        this.__buttonElem._elem.removeClassName('active');
        this.__isBusy = false;
    }
});
var ZidAgentTracking = Class.create(BeezidObject, {
    _tracker: null,
    _showAlerts: false,
    _alertMessage: null,
    _data: {
        zid_agent_id: null,
        zid_agent_url_id: null,
        time_on_page: null,
        view_date: null,
        source_url: null,
        target_url: null,
        user_id: null,
        ip: null
    },
    initialize: function($super, config) {
        $super(config);
        if (!undef(config)) {
            this._bindConfig(config);
            if (!undef(config.tracker)) {
                eval('this.' + this._tracker + '()');
            }
        }
        this._data.source_url = window.location.href;
        this._alertMessage = i18n.beezid.confirmation_message;
    },
    _showAlert: function() {
        return beezAlert(this._alertMessage, 'information');
    },
    _saveTracking: function() {
        new Ajax.Request('/zid_agent_trackings/track', {
            parameters: this._data,
            asynchronous: false,
            method: 'get'
        });
    },
    _stopTracking: function() {
        this._data.time_on_page = (new Date().getTime() - this._data.time_on_page) / 1000;
        this._saveTracking(this._data);
    },
    invisibleAgent: function() {
        this._data.time_on_page = new Date().getTime();
        this.__bindBeforeUnload();
        this.__bindUnload();
        this.__trackLinkClick();
        this.__trackOnFormSubmit();
    },
    __trackLinkClick: function() {
        $$('a').invoke('observe', 'click', function(e) {
            this._data.target_url = e.target.href;
        }.bind(this));
    },
    __trackOnFormSubmit: function() {
        $$('input[type=submit]').invoke('observe', 'click', this.__unbindTracking.bind(this));
        $$('input[type=submit]').invoke('observe', 'mouseout', function() {
            this.__bindBeforeUnload(this);
            this.__bindUnload(this);
        }.bind(this));
    },
    __unbindTracking: function() {
        window.onbeforeunload = function() {};
        window.onunload = function() {};
        this._data.target_url = null;
    },
    __bindBeforeUnload: function() {
        this.__trackLinkClick();
        window.onbeforeunload = function(e) {
            if (this._showAlerts) {
                this._showAlert();
                return this._alertMessage;
            }
            this._stopTracking();
        }.bind(this);
    },
    __bindUnload: function() {}
});
var ShoppingCartPopup = Class.create(Popup, {
    __cartTable: null,
    __items: new Hash(),
    __ttl: null,
    __timerElem: null,
    __buttonElem: null,
    __panelHideTimer: null,
    initialize: function($super, cart) {
        $super({
            classNames: ['cart_popup_panel'],
            element: $('cart_popup_panel'),
            modal: false,
            zIndex: 9995
        });
        this.__cartTable = $('cart_popup_list_body');
        this.__cartContainer = $('cart_popup_list_container');
        this.__timerElem = $('cart_timer_hdr');
        this.__buttonElem = $('cart_origin');
        cart.addListener('addCartItem', this);
        cart.addListener('removeCartItem', this);
        cart.addListener('updateCartItem', this);
        cart.addListener('cartUpdate', this);
        this.addListener('cartViewSize', this);
        $('cart_popup_panel').observe('mouseover', function() {
            this.__clearPanelHideTimer();
        }.bind(this));
        $('cart_popup_panel').observe('click', function() {
            this.__clearPanelHideTimer();
        }.bind(this));
    },
    __clearPanelHideTimer: function(event) {
        if (this.__panelHideTimer !== null) {
            clearTimeout(this.__panelHideTimer);
        }
    },
    onAddCartItem: function(event) {
        var item = new CartItemPopupView(event.item);
        item.attach(this.__cartTable);
        this.__items.set(item.id, item);
        this.__ttl = 99999999;
        if (undef(window.cartPopupInhibit) && (undef(event.showPopup) || event.showPopup) && !this.__isShown) {
            this.show();
            this.__clearPanelHideTimer();
            this.__panelHideTimer = setTimeout(function() {
                this.hide();
                this.__panelHideTimer = null;
            }.bind(this), 3000);
        }
    },
    updateTtl: function() {
        var ttl = 99999999;
        this.__items.each(function(pair) {
            var item = pair.value.item;
            if (item.getTimer() < ttl) {
                ttl = item.getTimer();
            }
        });
        this.__ttl = ttl;
        if (ttl <= 0) {
            this.__timerElem.removeClassName('timer_low');
            this.__buttonElem.removeClassName('cart_alert');
            this.__timerElem.innerHTML = i18n.cart.my_cart;
        }
    },
    onRemoveCartItem: function(event) {
        var item = this.__items.get(event.item.id);
        if (!empty(item)) {
            this.__cartTable.removeChild(item._elem);
            this.__items.unset(item.item.id);
            item.destroy();
            delete item;
            if (this.__items.size() == 0) {
                this.__timerElem.innerHTML = i18n.cart.my_cart;
            }
        }
        this.updateTtl.bind(this).defer();
    },
    onUpdateCartItem: function(event) {
        if (this.__isShown) {
            item.fireEvent('editSuccess');
        }
    },
    onCartUpdate: function(event) {
        $('cart_popup_total').innerHTML = formatCurrency(event.object.cartInfo().item_total);
        if (event.object.cartInfo().count == 0) {
            $('cart_popup_empty_wrapper').show();
            $('cart_popup_wrapper').hide();
        } else {
            this.fireEvent('cartViewSize', {
                async: false
            });
            $('cart_popup_empty_wrapper').hide();
            $('cart_popup_wrapper').show();
        }
    },
    onTimerUpdate: function(event) {
        if (event.ms < this.__ttl || this.__ttl <= 0) {
            this.__ttl = event.ms;
            if (event.ms > 0) {
                this.__timerElem.innerHTML = event.object.format(true, true);
            } else {
                this.__timerElem.innerHTML = i18n.cart.my_cart;
            }
            this.__timerElem.show();
        }
        if (this.__ttl > 0 && this.__ttl < 121000) {
            this.__timerElem.addClassName('timer_low');
            this.__buttonElem.addClassName('cart_alert');
        } else {
            this.__timerElem.removeClassName('timer_low');
            this.__buttonElem.removeClassName('cart_alert');
        }
    },
    onTimerReset: function(event) {
        this.__ttl = 99999999;
        this.__timerElem.removeClassName('timer_low');
        this.__buttonElem.removeClassName('cart_alert');
    },
    onCartViewSize: function(event) {
        var bodyHeight = new WindowSize().height,
            cartOffset = this.__cartContainer.viewportOffset().top,
            cartHeight = (function(container) {
                container.setStyle({
                    height: 'auto'
                });
                return container.getHeight();
            }(this.__cartContainer)),
            beezarHeight = $('nbar_wrapper') ? $('nbar_wrapper').getHeight() + $$('.hw_ctn')[0].getHeight() : 0,
            footerHeight = $('cart_popup_footer').getHeight(),
            cartScaled = 0 >= (bodyHeight - cartOffset - cartHeight - footerHeight - beezarHeight),
            height = bodyHeight - cartOffset - (beezarHeight + footerHeight),
            newHeight = cartScaled ? height + 'px' : 'auto';
        if (cartScaled && !this._elem.hasClassName('cart_popup_scroll')) {
            this._elem.addClassName('cart_popup_scroll');
        } else if (!cartScaled && this._elem.hasClassName('cart_popup_scroll')) {
            this._elem.removeClassName('cart_popup_scroll');
        }
        this.__cartContainer.setStyle({
            height: newHeight
        });
    },
    _show: function() {
        this._elem.hide();
        new Effect.SlideDown(this._elem, {
            duration: 0.4,
            afterFinish: function() {
                this.__isShown = true;
                this.__isBusy = false;
                this.fireEvent('cartViewSize', {
                    async: false
                });
                this.fireEvent('popupOpen');
            }.bind(this)
        });
        this.__buttonElem.addClassName('pp');
    },
    _hide: function() {
        new Effect.SlideUp(this._elem, {
            duration: 0.2,
            afterFinish: function() {
                this.__isShown = false;
                this.__isBusy = false;
                this._elem.hide();
                this.fireEvent('popupClosed');
            }.bind(this)
        });
        this.__buttonElem.removeClassName('pp');
    }
});
var ShoppingCart = Class.create(BeezidObject, {
    __cart: null,
    __items: [],
    __cart: null,
    __source: null,
    __highlightColor: '#bbffaa',
    __addCardGiftCardItem: 'STORE_GIFT_CARD',
    isInitialized: false,
    initialize: function($super) {
        $super();
        if (!undef(window.cartData)) {
            this.setDataSource(new DataSource({
                data: window.cartData
            }));
        } else {
            this.loadCart();
        }
    },
    setDataSource: function(ds) {
        var fn = this.readCart.bind(this);
        if (!empty(this.__source)) {
            this.__source.destroy();
            fn = this.refreshCart.bind(this);
        }
        this.__source = ds;
        ds.addListener('readError', function(event) {
            $('cart_error').innerText = i18n.beezid.read_error;
            $('cart_error').show();
        });
        ds.addListener('load', function() {
            $('cart_error').hide();
        });
        this.__source.getData(fn);
    },
    loadCart: function() {
        if (undef(Beezid.cartActive)) {
            this.loadCart.bind(this).defer();
            return;
        }
        if (Beezid.cartActive) {
            this.setDataSource(new DataSource({
                url: '/shopping_cart',
                method: 'post'
            }));
        } else {
            this.setDataSource(new DataSource({
                data: {
                    count: 0,
                    subtotal: 0,
                    shipping: 0,
                    tax: [],
                    total: 0,
                    items: [],
                    isShippable: false
                },
                url: '/shopping_cart',
                method: 'post'
            }));
        }
    },
    readCart: function(cart) {
        this.__cart = cart;
        this.count = cart.count;
        cart.items.each(function(cItem) {
            this.__addItem(cItem, false);
        }.bind(this));
        if (!this.isInitialIzed) {
            this.isInitialized = true;
            this.fireEvent('cartInitialized');
        }
        this.__update();
    },
    refreshCart: function(cart) {
        var inCart = [];
        cart.items.each(function(item) {
            var id = item.type + '_' + item.id;
            inCart.push(id);
            var index = this.findItem(id);
            if (index == null) {
                this.__addItem(item, true);
            } else {
                this.__items[index].item = item;
                this.__items[index].fireEvent('editSuccess', {
                    result: {
                        data: {
                            item: item
                        }
                    }
                });
            }
        }.bind(this));
        this.__items.each(function(item) {
            if (inCart.indexOf(item.id) == -1) {
                this.removeCartItem(item.id);
            }
        }.bind(this));
        this.count = cart.count;
        this.__cart = cart;
        this.__update();
    },
    reload: function() {
        this.__source.reload();
        this.__source.getData(this.refreshCart.bind(this));
    },
    getDataSource: function() {
        return this.__source;
    },
    cartInfo: function() {
        return this.__cart;
    },
    deleteItem: function(itemId, source) {
        if (this.__isBusy) {
            return;
        }
        var itemIndex = this.findItem(itemId);
        if (itemIndex === null) {
            return;
        }
        this._releaseItem(itemId, source);
    },
    _releaseItem: function(itemId, source) {
        this.__isBusy = true;
        new Ajax.Request('/shopping_cart/delete/' + itemId + '/' + source, {
            method: 'post',
            requestHeaders: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version
            },
            onSuccess: function(transport) {
                var result = null;
                try {
                    result = transport.responseText.evalJSON();
                    if (result.status == 'success') {
                        this.removeCartItem(itemId, result.data);
                    } else {
                        beezAlert(result.msg);
                    }
                } catch (e) {
                    beezAlert(i18n.beezid.server_error);
                }
                this.fireEvent('transComplete', {
                    op: 'release',
                    result: result
                });
                this.__isBusy = false;
            }.bind(this),
            onFailure: function(transport) {
                beezAlert(i18n.beezid.network_error);
                this.fireEvent('transComplete', {
                    op: 'release',
                    result: {
                        status: 'fail',
                        reason: 'network'
                    }
                });
                this.__isBusy = false;
            }.bind(this)
        });
    },
    addItem: function(itemId, quantity, source) {
        if (this.__isBusy) {
            return;
        }
        if (undef(quantity)) {
            quantity = 1;
        }
        var index = this.findItem(itemId);
        if (index !== null) {
            var item = this.__items[index];
            item.editItem(source, {
                quantity: parseInt(item.item.quantity) + quantity
            });
            return;
        }
        this.__isBusy = true;
        new Ajax.Request('/shopping_cart/item_info/' + itemId, {
            method: 'post',
            requestHeaders: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version
            },
            onSuccess: function(transport) {
                var result = null;
                try {
                    result = transport.responseText.evalJSON();
                    if (result.status == 'success') {
                        if (!empty(result.data.item.options) || result.data.item.cart_max > 1) {
                            this.doSelectOption(result.data, quantity, source);
                        } else {
                            this.doAddItem(result.data.item, source);
                        }
                    } else {
                        beezAlert(result.msg);
                        this.__isBusy = false;
                    }
                } catch (e) {
                    beezAlert(i18n.beezid.server_error);
                    this.__isBusy = false;
                }
                this.fireEvent('transComplete', {
                    op: 'item_info',
                    result: result
                });
            }.bind(this),
            onFailure: function(transport) {
                beezAlert(i18n.beezid.network_error);
                this.fireEvent('transComplete', {
                    op: 'item_info',
                    result: {
                        status: 'fail',
                        reason: 'network'
                    }
                });
                this.__isBusy = false;
            }.bind(this)
        });
    },
    reserveItem: function(itemId, quantity, source) {
        if (undef(quantity)) {
            quantity = 1;
        }
        this.fireEvent('beforeReserveCartItem', {
            itemId: itemId
        });
        if (this.__isBusy) {
            return;
        }
        this.__isBusy = true;
        new Ajax.Request('/shopping_cart/reserve/' + itemId + '/' + source, {
            method: 'post',
            parameters: {
                quantity: quantity
            },
            requestHeaders: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version
            },
            onSuccess: function(transport) {
                var result = null;
                try {
                    result = transport.responseText.evalJSON();
                    if (result.status != 'success') {
                        beezAlert(result.msg);
                    }
                } catch (e) {
                    beezAlert(i18n.beezid.server_error);
                }
                this.fireEvent('transComplete', {
                    op: 'reserve',
                    result: result
                });
                this.__isBusy = false;
            }.bind(this),
            onFailure: function(transport) {
                beezAlert(i18n.beezid.network_error);
                this.fireEvent('transComplete', {
                    op: 'reserve',
                    result: {
                        status: 'fail',
                        reason: 'network'
                    }
                });
                this.__isBusy = false;
            }.bind(this)
        });
    },
    editItem: function(item, params, source) {
        if (this.__isBusy) {
            return;
        }
        this.__isBusy = true;
        new Ajax.Request('/shopping_cart/edit/' + source, {
            method: 'post',
            requestHeaders: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version
            },
            parameters: params,
            onSuccess: function(transport) {
                var result = null;
                try {
                    result = transport.responseText.evalJSON();
                    if (result.status == 'success') {
                        this.editSuccess(item, result);
                        this.__update();
                    } else {
                        this.fireEvent('editFail', {
                            result: result
                        });
                        beezAlert(result.msg);
                    }
                } catch (e) {
                    this.fireEvent('editFail', {
                        result: result
                    });
                    beezAlert(i18n.beezid.server_error);
                }
                this.fireEvent('transComplete', {
                    op: 'edit',
                    result: result
                });
                this.__isBusy = false;
            }.bind(this),
            onFailure: function(transport) {
                this.fireEvent('editFail', {
                    result: result
                });
                this.fireEvent('transComplete', {
                    op: 'edit',
                    result: {
                        status: 'fail',
                        reason: 'network'
                    }
                });
                beezAlert(i18n.beezid.network_error);
                this.__isBusy = false;
            }.bind(this)
        });
    },
    editSuccess: function(item, result) {
        for (var i in result.data.item) {
            item.item[i] = result.data.item[i];
        }
        this._bindParams.bind(this.__cart)(result.data.cart, true);
        this.fireEvent('editSuccess', {
            result: result
        });
        this.fireEvent('cartUpdate');
    },
    doSelectOption: function(data, quantity, source) {
        var items = [{
            type: 'hidden',
            name: 'itemId',
            value: data.item.type + '_' + data.item.id
        }];
        if (data.item.cart_max > 1) {
            items.push({
                type: 'static',
                classNames: ['dlg_label', 'cart_dlg_label', 'dlg_label_quantity'],
                content: i18n.cart.quantity_label
            });
            items.push({
                type: 'combo',
                name: 'quantity',
                classNames: ['cart_dlg_item', 'cart_dlg_item_qty'],
                value: quantity,
                idField: 'n',
                displayField: 'n',
                source: {
                    fields: ['n'],
                    data: $R(1, data.item.cart_max).toArray()
                }
            });
        }
        if (!empty(data.item.options)) {
            if (data.item.id == this.__addCardGiftCardItem) {
                items.push({
                    id: 'bwgc_message',
                    type: 'static',
                    classNames: [''],
                    content: 'With a <strong>single click</strong> you can claim auction wins, buy Bid Packs or Store items, and have them on their way to you <strong>hassle-free. </br> Give your credit card a break!</strong>'
                });
            }
            items.push({
                type: 'static',
                classNames: ['dlg_label', 'cart_dlg_label', 'dlg_label_option'],
                content: i18n.cart.option_label
            });
            items.push({
                id: 'option',
                name: 'option',
                classNames: ['cart_dlg_item', 'cart_dlg_item_option'],
                type: 'combo',
                source: {
                    data: data.item.options
                },
                listeners: {
                    change: function(event) {
                        $$$('option_image') && $$$('option_image').setContent('<img src="/img/items/' + this._dataSource._data[event.newValue].sku + '.jpg" width="200px" height="150px" />');
                        return true;
                    }
                }
            });
            if (data.item.id == this.__addCardGiftCardItem) {
                items.push({
                    id: 'option_image',
                    type: 'static',
                    classNames: [''],
                    content: '<img src="/img/items/' + data.item.default_option_sku + '.jpg" width="200px" height="150px" />'
                });
            }
        }
        new Dialog({
            id: 'optDlg',
            title: i18n.cart.choose_option_title,
            classNames: ['store_option_dlg', 'beezid_dialog'],
            dialogType: 'okcancel',
            items: items,
            listeners: {
                scope: this,
                dialogResult: function(event) {
                    var values = event.dialogResult.values;
                    if (event.dialogResult.status == 'ok') {
                        if (!empty(values.quantity)) {
                            data.item.quantity = values.quantity;
                        }
                        if (!empty(values.option)) {
                            data.item.option = values.option;
                        }
                        this.doAddItem(data.item, source);
                    } else {
                        this.__isBusy = false;
                    }
                }
            }
        }).run();
    },
    doAddItem: function(item, source) {
        var itemId = item.type + '_' + item.id;
        new Ajax.Request('/shopping_cart/add/' + source, {
            method: 'post',
            requestHeaders: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Prototype-Version': Prototype.Version
            },
            parameters: {
                id: itemId,
                quantity: item.quantity,
                option: item.option
            },
            onSuccess: function(transport) {
                var result = null;
                try {
                    result = transport.responseText.evalJSON();
                    if (result.status == 'success') {
                        this._bindParams.bind(item)(result.data.item, true);
                        result.data.item = item;
                        this.addCartItem(result.data);
                    } else {
                        if (result.reason == 'fail_sold' || result.reason == 'fail_reserved') {
                            result.msg = result.msg + '<br />' + Beezid.watchlistManager.getAddToLink(item);
                        }
                        beezAlert(result.msg);
                    }
                } catch (e) {
                    beezAlert(i18n.beezid.server_error);
                }
                this.fireEvent('transComplete', {
                    op: 'add',
                    result: result
                });
                this.__isBusy = false;
            }.bind(this),
            onFailure: function(transport) {
                beezAlert(i18n.beezid.network_error);
                this.fireEvent('transComplete', {
                    op: 'add',
                    result: {
                        status: 'fail',
                        reason: 'network'
                    }
                });
                this.__isBusy = false;
            }.bind(this)
        });
    },
    reAdd: function(itemId, source) {
        var index = this.findItem(itemId);
        if (index === null) {
            return;
        }
        this.__items[index].setBusy();
        this.reserveItem(itemId, this.__items[index].item.quantity, source);
    },
    findItem: function(itemId) {
        var len = this.__items.length;
        for (var i = 0; i < len; i++) {
            if (this.__items[i].id == itemId) {
                return i;
            }
        }
        return null;
    },
    getItem: function(itemId) {
        var index = this.findItem(itemId);
        if (index !== null) {
            return this.__items[index].item;
        }
        return null;
    },
    addCartItem: function(data) {
        this._bindParams.bind(this.__cart)(data.cart, true);
        this.__addItem(data.item, true);
        this.__update();
    },
    __addItem: function(item, showCartPopup) {
        var newItem = new CartItem(item);
        this.__items.push(newItem);
        this.fireEvent('addCartItem', {
            item: newItem,
            showPopup: showCartPopup
        });
        this.fireEvent('cartUpdate');
        return newItem;
    },
    removeCartItem: function(itemId, data) {
        var i = this.findItem(itemId);
        if (i !== null) {
            var item = this.__items[i];
            this.__cart.items.splice(i, 1);
            item.destroy();
            if (!undef(data)) {
                this._bindParams.bind(this.__cart)(data.cart, true);
            }
            this.fireEvent('removeCartItem', {
                item: item
            });
            this.__update();
        }
    },
    getItemCount: function() {
        return this.__cart.count;
    },
    checkout: function() {
        document.location = '/shopping_cart/show';
    },
    isBusy: function() {
        return this.__isBusy;
    },
    __update: function() {
        this.fireEvent('cartUpdate');
    },
    getHashPrefix: function(itemType) {
        switch (parseInt(itemType)) {
            case 1:
                return i18n.beezid_details.hash_store;
                break;
            case 2:
                return i18n.beezid_details.hash_flip;
                break;
            default:
                return null;
                break;
        }
    },
    getItemSelectedOption: function(itemId) {
        var selectedOption = false;
        this.__cart.items.each(function(item) {
            if (item.id != itemId) {
                return;
            }
            item['options'].each(function(itemOption) {
                if (itemOption.id == item.option) {
                    selectedOption = itemOption.name;
                }
            });
        });
        return selectedOption;
    },
    bindGiftCardItems: function() {
        $$('.ad-gift-card').invoke('stopObserving', 'click');
        $$('.ad-gift-card').each(function(elem) {
            elem.observe('click', function(ev) {
                this.addItem(this.__addCardGiftCardItem, 1, 2);
            }.bind(this));
        }.bind(this));
    }
});
var CartItem = Class.create(BeezidObject, {
    id: null,
    item: null,
    __timer: null,
    __busy: false,
    initialize: function($super, item) {
        this.id = item.type + '_' + item.id;
        this.item = item;
        $super();
        this.__timer = new Timer({
            mode: 'countdown',
            milliseconds: item.lock_time * 1000,
            triggers: [{
                time: 120999,
                event: 'timerLow'
            }, {
                time: 10999,
                event: 'timer10Sec'
            }],
            playTriggers: true,
            listeners: {
                timerUpdate: this,
                timerExpired: this,
                timerLow: this,
                timer10sec: this
            }
        });
        if (!undef(Beezid.popShop)) {
            this.__timer.addListener('timerUpdate', Beezid.popShop);
            this.__timer.addListener('timerReset', Beezid.popShop);
            this.__timer.addListener('timerLow', Beezid.popShop);
            this.__timer.addListener('timer10Sec', Beezid.popShop);
            this.__timer.addListener('timerExpired', Beezid.popShop);
        }
    },
    destroy: function($super) {
        if (this.__timer) {
            this.__timer.stop();
            delete this.__timer;
        }
        $super();
    },
    onTimerLow: function(event) {
        this.fireEvent('timerLow', event);
    },
    onTimerUpdate: function(event) {
        this.fireEvent('timerUpdate', {
            time: event.object.format(true, true)
        });
    },
    onTimerExpired: function(event) {
        this.fireEvent('timerExpired');
    },
    getTimer: function() {
        return this.__timer.getMs();
    },
    setTimer: function(ms) {
        this.__timer.reset(ms);
        this.__timer.start();
        this.fireEvent('timerReset', {
            time: this.__timer.format(true, true)
        });
    },
    setBusy: function() {
        this.__busy = true;
        this.fireEvent('cartItemState', {
            state: 'busy'
        });
        Beezid.shoppingCart.addListener('transComplete', this);
    },
    editItem: function(source, params) {
        if (!Beezid.shoppingCart.isBusy()) {
            Beezid.shoppingCart.addListener('editSuccess', this);
            Beezid.shoppingCart.addListener('editFail', this);
            this.setBusy();
            params.id = this.id;
            Beezid.shoppingCart.editItem(this, params, source);
        }
    },
    editQuantity: function(source, event) {
        this.editItem(source, {
            quantity: event.newValue
        });
        return false;
    },
    editOption: function(source, event) {
        this.editItem(source, {
            option: event.newValue
        });
        return false;
    },
    onEditSuccess: function(event) {
        Beezid.shoppingCart.removeListener('editSuccess', this);
        Beezid.shoppingCart.removeListener('editFail', this);
        var item = event.result.data.item;
        if (!undef(event.result.data.item.quantity)) {
            this.item.quantity = item.quantity;
        }
        if (!undef(event.result.option)) {
            this.item.option = item.option;
        }
        this.item.total_shipping = item.total_shipping;
        this.item.lock_expire = item.lock_expire;
        this.item.lock_time = item.lock_time;
        this.fireEvent('editSuccess', event);
    },
    onEditFail: function(event) {
        Beezid.shoppingCart.removeListener('editSuccess', this);
        Beezid.shoppingCart.removeListener('editFail', this);
        this.fireEvent('editFail', event);
    },
    onTransComplete: function(event) {
        Beezid.shoppingCart.removeListener('transComplete', this);
        this.__busy = false;
        var state = 'normal';
        if (event.result.status == 'success') {
            var time = event.result.data.item.lock_time;
            this.setTimer(time * 1000);
        } else {
            state = event.result.reason;
        }
        this.fireEvent('cartItemState', {
            state: state
        });
    }
});
var CartItemView = Class.create(LinearArray, {
    id: null,
    item: null,
    __timerElem: null,
    __indicator: null,
    initialize: function($super, cartItem) {
        this.id = cartItem.id;
        $super({
            id: 'sc_' + this.id
        });
        this.item = cartItem;
        this._items = this._getItems();
        this.instantiate();
        this.__timerElem = this.findById('cart_lock_' + this.id)._elem;
        this.__indicator = this.findById('rsv_status_' + this.id);
        cartItem.addListener('editFail', this);
        cartItem.addListener('editSuccess', this);
        cartItem.addListener('timerUpdate', this);
        cartItem.addListener('timerExpired', this);
        cartItem.addListener('timerReset', this);
        cartItem.addListener('timerLow', this);
        cartItem.addListener('cartItemState', this);
    },
    onTimerUpdate: function(event) {
        this.__timerElem.innerHTML = event.time;
    },
    onTimerLow: function(event) {
        this.__timerElem.addClassName('cart_timer_2min');
        this.fireEvent('timerLow', event);
    },
    onTimerExpired: function(event) {
        this.__timerElem.removeClassName('cart_timer_2min');
        this.__timerElem.addClassName('cart_timer_expired');
        if (this.__indicator) {
            this.__indicator.setState('expired');
        }
        this._elem.addClassName('item_expired');
        this.fireEvent('timerExpired', event);
    },
    onTimerReset: function(event) {
        this.__timerElem.setAttribute('class', 'cart_timer');
        this.__timerElem.innerHTML = event.time;
    },
    onCartItemState: function(event) {
        if (!empty(event.state)) {
            if (event.state == 'normal') {
                this._elem.removeClassName('item_expired');
            }
            if (!empty(this.__indicator)) {
                this.__indicator.setState(event.state);
            }
        }
        if (event.object.__busy) {
            var spinner = this.findById('cart_wait_' + this.id);
            if (spinner) {
                spinner._elem.show();
            }
        }
    },
    _getOptionCtl: function() {
        return null;
    },
    _getQuantityCtl: function() {
        return null;
    },
    _getShippingCtl: function() {
        return null;
    },
    onEditSuccess: function(event) {
        var data = event.result.data.item;
        if (!empty(data.option)) {
            var opt = this._getOptionCtl();
            if (opt) {
                opt.setValue(data.option);
            }
        }
        if (!empty(data.quantity)) {
            var qty = this._getQuantityCtl();
            if (qty) {
                qty.setValue(data.quantity);
            }
        }
        var ship = this._getShippingCtl();
        if (ship) {
            var shipElem = ship._elem.parentNode;
            ship.setContent('<span>' + formatCurrency(data.total_shipping) + '</span>');
            if (data.free_shipping) {
                shipElem.addClassName('free-shipping');
            } else {
                shipElem.removeClassName('free-shipping');
            }
        }
        return true;
    },
    onEditFail: function() {
        this.revert();
    },
    _getItems: function() {
        return [];
    }
});
var CartItemPopupView = Class.create(CartItemView, {
    _getQuantityCtl: function() {
        return $$$('cdd_quantity_' + this.item.item.id);
    },
    _getItems: function() {
        var cartItem = this.item;
        var item = this.item.item;
        var quantity;
        if (item.cart_max > 1) {
            quantity = {
                type: 'combo',
                id: 'cdd_quantity_' + item.id,
                name: 'quantity',
                value: item.quantity,
                idField: 'n',
                displayField: 'n',
                source: {
                    fields: ['n'],
                    data: $R(1, item.cart_max).toArray()
                },
                classNames: ['cart_item_qty'],
                listeners: {
                    change: cartItem.editQuantity.bind(cartItem).curry(4)
                }
            };
        } else {
            quantity = {
                type: 'static',
                name: 'quantity',
                classNames: ['cart_item_qty'],
                content: item.quantity
            };
        }
        return [quantity, {
            type: 'static',
            contentType: 'image',
            classNames: ['cart_item_image'],
            content: 'img/items/t1_' + item.sku + '.jpg'
        }, {
            type: 'container',
            classNames: ['cart_item_name_ctn'],
            items: [{
                type: 'static',
                contentType: 'text',
                classNames: ['cart_item_name'],
                content: '<a href="' + item.slug + Beezid.shoppingCart.getHashPrefix(item.type) + item.id + '">' + item.name + '</a>'
            }, {
                type: 'stateful',
                id: 'rsv_status_' + this.id,
                classNames: ['cart_rsv_status'],
                state: 'normal',
                items: [{
                    type: 'static',
                    id: 'readd_' + this.id,
                    contentType: 'text',
                    classNames: ['cart_readd'],
                    states: ['expired'],
                    content: i18n.cart.timer_expired + " <a href=\"#\" onclick=\"Beezid.shoppingCart.reAdd('" + this.id + "', 4); return false;\">" +
                        i18n.cart.add_again + "</a>"
                }, {
                    type: 'container',
                    id: 'cart_wait_' + this.id,
                    classNames: ['cart_readd_wait'],
                    states: [],
                    items: [{
                        type: 'static',
                        contentType: 'image',
                        content: "/img/pages/common/spinner_sm.gif"
                    }, {
                        type: 'static',
                        contentType: 'text',
                        content: 'Checking...'
                    }]
                }, {
                    type: 'static',
                    id: 'readd_fail_' + this.id,
                    classNames: ['cart_readd_fail'],
                    states: ['fail_reserved'],
                    content: "<div>" + i18n.cart.reserve_fail + "<br />" + Beezid.watchlistManager.getAddToLink(item, false) + "</div>"
                }, {
                    type: 'static',
                    id: 'item_sold_' + this.id,
                    classNames: ['cart_item_sold'],
                    states: ['fail_sold'],
                    content: "<div>" + i18n.cart.item_sold + "<br />" + Beezid.watchlistManager.getAddToLink(item, false) + "</div>"
                }, {
                    type: 'static',
                    id: 'item_unavail_' + this.id,
                    classNames: ['cart_item_unavail'],
                    states: ['fail_other'],
                    content: "<div>" + i18n.cart.item_unavailable + "<br />" + Beezid.watchlistManager.getAddToLink(item, false) + "</div>"
                }]
            }]
        }, {
            type: 'static',
            contentType: 'text',
            classNames: ['cart_item_price'],
            content: formatCurrency(item.price)
        }, {
            type: 'static',
            contentType: 'text',
            id: 'cart_lock_' + this.id,
            classNames: ['cart_timer'],
            content: '0:00'
        }, {
            type: 'button',
            contentType: 'image',
            classNames: ['cart_edit_btn'],
            content: 'img/flipstore/delete_sm.png',
            action: function(event) {
                Beezid.shoppingCart.deleteItem(this.id, 4);
            }.bind(this)
        }];
    }
});
var StoreUpdater = Class.create(CoreUpdater, {
    url: 'store/updater',
    period: 10,
    requestSuccess: function(res) {
        var result = res.responseText.evalJSON();
        if (result) {
            this.fireEvent('success', result);
        }
    }
});
var Wallet = Class.create(BeezidObject, {
    __balance: 0,
    __loggedIn: false,
    __ready: false,
    initialize: function($super, balance) {
        $super();
        this.__loggedIn = true;
        this.__balance = balance;
        var bu = updaterManager.get(updaterManager.BAR_UPDATER);
        if (bu) {
            bu.addListener('success', this.updateBarAmount, this);
        }
        Beezid.info.addListener('login', this);
        Beezid.info.addListener('logout', this);
        (function() {
            if ($('pwr_float') && Beezid.powerItemsManager) {
                Beezid.powerItemsManager.addListener('quickBuy', this.updateBarAmount, this);
            }
        }).bind(this).defer();
    },
    updateBarAmount: function(event) {
        if (!undef(event.wallet)) {
            this.__balance = parseFloat(event.wallet);
            this.__cashableBalance = parseFloat(event.wallet_cashable_balance);
            if (this.__balance < 0) {
                this.__balance = 0;
            }
            this.fireEvent('balanceChanged', {
                balance: this.__balance
            });
            if (this.__balance == 0) {
                this.fireEvent('walletEmpty');
            }
            if (!this.__ready) {
                this.__ready = true;
                this.fireEvent('ready');
            }
        }
    },
    onLogin: function(event) {
        var bu = updaterManager.get(updaterManager.BAR_UPDATER);
        if (bu) {
            bu.addListener('success', this.updateBarAmount, this);
        }
    },
    onLogout: function(event) {
        var bu = updaterManager.get(updaterManager.BAR_UPDATER);
        if (bu) {
            bu.removeListener('success', this.updateBarAmount, this);
        }
        this.__loggedIn = false;
        this.__balance = 0;
        this.fireEvent('balanceChanged', {
            balance: 0
        });
        this.fireEvent('walletEmpty');
    },
    getBalance: function() {
        return this.__balance;
    },
    getCashableBalance: function() {
        return this.__cashableBalance;
    },
    validate: function(value) {
        if (!empty(value)) {
            if (!(/^\d*(\.\d{1,2})?$/.match(value))) {
                return i18n.wallet.error_msg.invalid;
            }
            value = parseFloat(value);
            if (value > this.getBalance()) {
                return i18n.wallet.error_msg.insufficient_funds;
            }
        }
        return true;
    }
});
initFuncs.push(function() {
    var balance = 0;
    if (!undef(window.wallet_balance)) {
        balance = window.wallet_balance;
        window.wallet_balance = undefined;
    }
    Beezid.wallet = new Wallet(balance);
});
var WatchlistManager = Class.create(BeezidObject, {
    initialize: function($super, config) {
        $super(config);
        this.addItemListener();
    },
    catIdsObj: [],
    addItemListener: function() {
        this.addClickEventBindings();
        var barUpdater = updaterManager.get(updaterManager.BAR_UPDATER);
        if (typeof barUpdater != 'undefined') {
            barUpdater.addListener('success', this.onBarUpdate, this);
        }
        if (!Beezid.info.loggedIn()) {
            this.bindEventOnMouseOver();
        }
    },
    addClickEventBindings: function() {
        $$('.ab_soption').each(function(elem) {
            this.bindClickEvent(elem);
        }.bind(this));
        $$('.reserve_watchlist').each(function(elem) {
            this.bindClickEvent(elem);
        }.bind(this));
    },
    onBarUpdate: function(result) {
        if (typeof result.watchedItems != 'undefined') {
            this.addDecoration(result.watchedItems);
        }
        this.bindEventOnMouseOver();
    },
    bindClickEvent: function(elem) {
        elem.stopObserving('click');
        elem.observe('click', function(e) {
            e.preventDefault();
            if (Beezid.info.loggedIn()) {
                var linkElement = elem.hasClassName('reserve_watchlist') ? elem : elem.select('[class*="watchlist_"]').first();
                this.watchStoreItem(linkElement);
            } else {
                beezAlert(i18n.watch_list.need_account);
            }
        }.bind(this));
    },
    addDecoration: function(watchedItems) {
        watchedItems.each(function(catId) {
            if (!this.isWatched(catId)) {
                this.catIdsObj.push(catId);
            }
            this.__toggleItemStyle(catId);
        }.bind(this));
    },
    bindEventOnMouseOver: function(catalogId) {
        var id = typeof catalogId == 'undefined' ? '' : catalogId;
        $$('[class*="watchlist_' + id + '"]').each(function(elem) {
            this.addWatchlistTip(elem);
        }.bind(this));
    },
    __toggleItemStyle: function(catId) {
        $$('[class*="watchlist_' + catId + '"]').each(function(elem) {
            switch (elem.tagName) {
                case 'I':
                    elem.setStyle('cursor: pointer');
                    elem.removeClassName('icon-fav-binoc');
                    elem.addClassName('icon-fav-binoc-over');
                    break;
                case 'A':
                    elem.hide();
                    break;
                case 'DIV':
                    this.disableButton(elem.id);
                    break;
            }
        }.bind(this));
    },
    addWatchlistTip: function(elem) {
        var catId = $(elem.id).className.match(/watchlist_\w+/)[0].split('_')[1],
            message = i18n.watch_list.need_account;
        if (Beezid.info.loggedIn()) {
            var msgKey = this.isWatched(catId) ? 'hover_info_watched' : 'hover_info';
            message = i18n.watch_list[msgKey];
        }
        addToolTip(elem, message, i18n.watch_list.hover_title, false);
    },
    watchStoreItem: function(elem) {
        var itemId = elem.className.match(/watchlist_\w+/)[0].split('watchlist_')[1];
        this.add(itemId);
    },
    isWatched: function(catId) {
        return (this.catIdsObj.indexOf(catId) !== -1);
    },
    removeCatIdFromList: function(catId) {
        this.catIdsObj.splice(this.catIdsObj.indexOf(catId), 1);
    },
    add: function(itemId) {
        var catId = itemId.split('_').first();
        if (!this.isWatched(catId)) {
            new Ajax.Request('/store/watch', {
                method: 'post',
                requestHeaders: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Prototype-Version': Prototype.Version
                },
                parameters: {
                    item_id: itemId
                },
                onComplete: function(transport) {
                    try {
                        var result = transport.responseText.evalJSON();
                        if (result.status == 'success') {
                            beezAlert(i18n.watch_list.item_watched, i18n.watch_list.hover_title, 4000);
                            this.addDecoration([catId]);
                            this.bindEventOnMouseOver(catId);
                        } else {
                            beezDevAlert(result.msg);
                        }
                    } catch (e) {
                        beezDevAlert(i18n.beezid.server_error);
                    }
                }.bind(this),
                onFailure: function(transport) {
                    beezDevAlert(i18n.beezid.network_error);
                }
            });
        }
    },
    disableButton: function(buttonId) {
        $(buttonId).addClassName('disabled');
        $(buttonId).stopObserving('click');
        showTooltip({
            title: i18n.watch_list.hover_title,
            message: i18n.watch_list.hover_info_watched,
            id: buttonId
        });
    },
    getAddToLink: function(item, displayInfo) {
        if (undef(displayInfo)) {
            displayInfo = true;
        }
        if (empty(item) || empty(item.catalog_item_id) || empty(item.type) || empty(item.id)) {
            return '';
        }
        if (!Beezid.info.loggedIn()) {
            if (!displayInfo) {
                return '';
            }
            return i18n.watch_list.need_account;
        }
        if (this.isWatched(item.catalog_item_id)) {
            if (!displayInfo) {
                return '';
            }
            return i18n.watch_list.hover_info_watched;
        }
        var watchlistLink = "<a href=\"#\" onclick=\"Beezid.watchlistManager.add('" +
            item.catalog_item_id + "_" + item.type + "_" + item.id + "'); Beezid.watchlistManager.closeDialog(this); return false;\">" +
            i18n.watch_list.add + "</a>";
        return watchlistLink;
    },
    closeDialog: function(el) {
        if (el.up('div[id^=ba_]') != null) {
            $$$(el.up("div[id^=ba_]").id).close();
        } else {
            el.hide();
        }
    }
});
var USER_STATUS = {
    WIN1: 1,
    CHERRY: 6,
    ADVANCED: 2,
    PENDING: 7,
    POWER_BIDDER: 10
};
var StatusManager = Class.create(BeezidObject, {
    _tip: null,
    _elem: null,
    _icon: null,
    _status: null,
    _notification: null,
    __statusChanged: null,
    __nextStatus: 2,
    _counter: {
        wins: 0,
        max: 10,
        end_date: null
    },
    _statuses: [USER_STATUS.WIN1, USER_STATUS.CHERRY, USER_STATUS.ADVANCED, USER_STATUS.POWER_BIDDER],
    initialize: function($super) {
        $super();
        if ($('theBar') == null) {
            return;
        }
        this._elem = $('status-manager');
        this._icon = $('user-status-icon');
        Event.observe(window, 'resize', this.__hideTip.bind(this));
        this._status = parseInt(Beezid.info.getStatusId());
        Beezid.info.addListener('statusChanged', this);
        this._status && this.__update();
    },
    onStatusChanged: function(event) {
        if (event.oldStatus == USER_STATUS.ADVANCED && event.newStatus == USER_STATUS.POWER_BIDDER) {
            this.__statusChanged = 'to_power_bidder';
        } else if (event.oldStatus == USER_STATUS.POWER_BIDDER && event.newStatus == USER_STATUS.ADVANCED) {
            this.__statusChanged = 'from_power_bidder';
        } else {
            this.__statusChanged = null;
        }
        this.__resetCounter();
        var status = parseInt(event.newStatus);
        this.__update(status);
        this.__updateStatus(status);
        this._status = status;
    },
    updateCounter: function(counter) {
        if (this._notification) {
            return;
        }
        if (counter && !counter.end_date && !this._counter.end_date && this._counter.wins == counter.wins && this._counter.max == counter.max) {
            return;
        }
        if (typeof counter.user_status_id != 'undefined') {
            this.__nextStatus = counter.user_status_id;
        }
        this._counter = counter;
        this.__update();
    },
    showNotification: function(notification) {
        if (this._notification) {
            return;
        }
        this._notification = notification;
        this.__update();
    },
    setTipTitle: function(title) {
        this._tip.title.update(title);
    },
    resetTipTitle: function() {
        this._tip.title.update(this.__tipTitle(this._status));
    },
    __dismissNotification: function() {
        this._icon.stopObserving('prototip:hidden');
        markRead(this._notification.id);
        this._notification = null;
        this.__update();
    },
    __hideTip: function() {
        if (this._tip && $(this._tip.wrapper) && $(this._tip.wrapper).visible()) {
            $(this._tip.wrapper).hide();
        }
    },
    __dismissMessage: function() {
        this._icon.stopObserving('mouseover', this.__dismissMessage);
        this._icon.removeClassName('message');
    },
    __update: function(status) {
        if (undef(status)) {
            status = this._status;
        }
        if (status) {
            this.__setIcon(status);
            this.__setTip(status);
            this._elem.show();
        } else if (!undef(status)) {
            this._elem.hide();
        }
    },
    __setIcon: function(status) {
        if (!this._icon) {
            return;
        }
        this._icon.removeClassName('message');
        this._icon.removeClassName('auction_type_advanced_icon');
        this._icon.removeClassName('auction_type_cherry_icon');
        this._icon.removeClassName('auction_type_powerbidder_icon');
        this._icon.addClassName(this.__iconClass(status));
        if (this._notification) {
            this._icon.addClassName('message');
        }
    },
    __iconClass: function(status) {
        if (status == USER_STATUS.CHERRY || status == USER_STATUS.WIN1) {
            return 'auction_type_cherry_icon';
        } else if (status == USER_STATUS.ADVANCED) {
            return 'auction_type_advanced_icon';
        } else if (status == USER_STATUS.POWER_BIDDER) {
            return 'auction_type_powerbidder_icon';
        }
    },
    __setTip: function(status) {
        if (this._icon && this._icon.prototip) {
            this._icon.stopObserving('mouseover');
            this._icon.prototip.remove();
        }
        if (Beezid.touchEnabled) {
            this._icon.stopObserving('click');
            this._icon.observe('click', function(ev) {
                if ($$('.statustip').length > 0 && $$('.statustip')[0].visible()) {
                    ev.target.prototip.hide();
                } else {
                    hideAllToolTip();
                    ev.target.prototip.show();
                    ev.target.stopObserving('mouseover');
                }
            });
        }
        var iconHideAfter = false;
        if (this._notification == null && !Beezid.touchEnabled) {
            iconHideAfter = 1;
        }
        this._tip = new Tip(this._icon, this.__tipContent(status), {
            title: this.__tipTitle(status),
            closeButton: Beezid.touchEnabled || this._notification != null,
            hideOn: false,
            hideAfter: iconHideAfter,
            width: this.__tipWidth(),
            hook: {
                target: 'topMiddle',
                tip: 'bottomMiddle'
            },
            stem: {
                position: 'bottomMiddle',
                height: 10,
                width: 20
            },
            offset: {
                x: -2,
                y: -2
            },
            fixed: true,
            style: 'protobzd'
        });
        $(this._tip.wrapper).setStyle({
            position: 'fixed'
        });
        $(this._tip.wrapper).addClassName('statustip');
        $(this._tip.title).setStyle({
            textAlign: 'center'
        });
        if (this._notification) {
            this._icon.observe('prototip:hidden', this.__dismissNotification.bind(this));
            this._icon.observe('mouseover', this.__dismissMessage.bind(this));
        }
    },
    __tipWidth: function() {
        if (this._notification) {
            return 180;
        }
        if (this._counter.end_date) {
            return 160;
        }
        return 80 + (7 * this._counter.max);
    },
    __tipTitle: function(status) {
        var wins, title;
        if (status == USER_STATUS.WIN1 || status == USER_STATUS.PENDING) {
            status = USER_STATUS.CHERRY;
        }
        if (!this._notification && !this._counter.end_date) {
            wins = empty(this._counter.wins) || this._counter.wins < 1 ? '' : this._counter.wins;
            status += wins == 1 ? '_1' : '';
            return i18n.status_manager.wins[status].replace('%s', wins);
        }
        if (this._notification && /{{title:nice_job}}/i.test(this._notification.message)) {
            status = 'nice_job';
        } else if (this._notification && /{{title:way_to_go}}/i.test(this._notification.message)) {
            status = 'way_to_go';
        } else if (this._notification && /{{title:hi_username}}/i.test(this._notification.message)) {
            status = 'hi_username';
        } else if (this.__statusChanged) {
            status = this.__statusChanged;
            this.__statusChanged = null;
        }
        return i18n.status_manager.title[status].replace('%s', Beezid.info.getUsername());
    },
    __tipContent: function(status) {
        if (this._notification) {
            if (/{{MLA:status_unchanged}}/i.test(this._notification.message)) {
                if (status == USER_STATUS.ADVANCED) {
                    this._notification.message = this._notification.message.replace('{{MLA:status_unchanged}}', i18n.status_manager.unchanged_advanced);
                } else {
                    this._notification.message = this._notification.message.replace('{{MLA:status_unchanged}}', '');
                }
            }
            var notificationMsg = this._notification.message.replace(/{{title:(\w+)}} /, '');
            notificationMsg += '<br/><br/><button class="btn btn-sm" onclick="$(\'user-status-icon\').prototip.hide();">' + i18n.status_manager.close_tooltip + '</button>';
            return notificationMsg;
        }
        var content, pre, post, bar, container, days, hours, minutes;
        if (this._counter.end_date) {
            days = Math.floor(this._counter.end_date / 60 / 60 / 24);
            hours = Math.floor(this._counter.end_date / 60 / 60 - (24 * days));
            minutes = Math.floor(this._counter.end_date / 60 - (60 * 24 * days) - (60 * hours));
            content = '';
            content += days > 0 ? (days + (days !== 1 ? ' days ' : ' day ')) : '';
            content += hours > 0 ? (hours + (hours !== 1 ? ' hours ' : ' hour ')) : '';
            content += minutes > 0 ? (minutes + (minutes !== 1 ? ' minutes ' : ' minute ')) : '';
            content += '<br>remaining';
            return content;
        }
        pre = new Element('div', {
            className: 'auction_icon ' + this.__iconClass(status)
        });
        post = new Element('div', {
            className: 'auction_icon ' +
                this.__iconClass(status == USER_STATUS.ADVANCED ? USER_STATUS.POWER_BIDDER : this.__nextStatus) + '_disabled'
        });
        content = new Element('div', {
            className: 'nbar_status_levels'
        });
        for (var bars = 1; bars <= this._counter.max; bars++) {
            bar = new Element('div', {
                className: 'nbar_level'
            });
            if (bars <= this._counter.wins) {
                if (typeof this._counter.auction_ids[bars - 1] != undefined) {
                    bar.writeAttribute('onmouseover', 'Beezid.statusManager.setTipTitle("' + this._counter.auction_ids[bars - 1].date + '")').writeAttribute('onmouseout', 'Beezid.statusManager.resetTipTitle()').writeAttribute('onclick', 'document.location = "/my_account/my_wins/auction:' + this._counter.auction_ids[bars - 1].id + '"');
                }
            } else {
                bar.addClassName('nbar_level_disabled');
            }
            content.appendChild(bar);
        }
        container = new Element('div', {
            className: 'nbar_status_holder'
        });
        container.appendChild(content);
        return pre.outerHTML + container.outerHTML + post.outerHTML;
    },
    __updateStatus: function(status) {
        ayjax('/users/update_status', function(result) {
            if (!result) {
                return;
            }
            if (result.redirect) {
                location.href = result.redirect;
            } else if (typeof HomepageRefresherObj != 'undefined') {
                HomepageRefresherObj.startRefresh();
            }
        }, {
            method: 'post'
        });
    },
    __resetCounter: function() {
        this._counter = {
            wins: 0,
            max: 10,
            end_date: null
        };
    }
});
var BeezidBolt = Class.create(BeezidObject, {
    _context: null,
    _scale: 1.0,
    _fps: 45.0,
    _slowFpsAvg: 32.0,
    _boltFlashDuration: 0.25,
    _boltFadeDuration: 0.5,
    _boltThickness: 1.0,
    _boltColor: '#ffffff',
    _bgFadeColor: false,
    _bodyAnimMode: false,
    _targetId: false,
    _randomDirection: false,
    _alphaBlend: true,
    _useThunderFlash: false,
    _width: 0,
    _height: 0,
    _boltRate: 0.02,
    _boltForkRate: 0.02,
    __fpsRate: 0,
    __fpsAvg: {
        fpsSum: 0,
        frameCount: 0,
        average: 0
    },
    __startTick: false,
    __flashOpacity: 0.0,
    __canvasSupport: true,
    __inBodyAnimation: false,
    __originalBoltThickness: 1.0,
    lastFrame: (new Date).getTime(),
    totalBoltDuration: null,
    bolts: [],
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
    },
    setCanvasSize: function() {
        var bolt, j, len;
        if (!this._bodyAnimMode) {
            this._context.canvas.setAttribute("width", this._width);
            this._context.canvas.setAttribute("height", this._height);
        }
        for (j = 0, len = this.bolts.length; j < len; j++) {
            bolt = this.bolts[j];
            bolt.canvas.width = this._width;
            bolt.canvas.height = this._height;
        }
        this._width = Math.ceil(this._width / this._scale);
        return this._height = Math.ceil(this._height / this._scale);
    },
    launchBolt: function(x, y, length, direction) {
        var boltCanvas, boltContext;
        this.__flashOpacity = this._useThunderFlash ? 0.15 + Math.random() * 0.2 : 0.0;
        if (Math.floor(Math.random() * 3) == 0) {
            this._boltThickness = 1.5;
        } else {
            this._boltThickness = this.__originalBoltThickness;
        }
        boltCanvas = document.createElement("canvas");
        boltCanvas.width = this._width;
        boltCanvas.height = this._height;
        boltContext = boltCanvas.getContext("2d");
        boltContext.scale(this._scale, this._scale);
        this.bolts.push({
            canvas: boltCanvas,
            duration: 0.0
        });
        return this.recursiveLaunchBolt(x, y, length, direction, boltContext);
    },
    recursiveLaunchBolt: function(x, y, length, direction, boltContext) {
        var boltInterval, originalDirection;
        originalDirection = direction;
        return boltInterval = setInterval((function() {
            var i, x1, y1;
            if (length <= 0) {
                clearInterval(boltInterval);
                return;
            }
            i = 0;
            while (i++ < Math.floor(45 / this._scale) && length > 0) {
                x1 = Math.floor(x);
                y1 = Math.floor(y);
                x += Math.cos(direction);
                y -= Math.sin(direction);
                length--;
                if (x1 !== Math.floor(x) || y1 !== Math.floor(y)) {
                    boltContext.fillStyle = this._boltColor;
                    boltContext.globalAlpha = this._alphaBlend ? Math.min(1.0, length / 350.0) : 1.0;
                    boltContext.fillRect(x1, y1, this._boltThickness, 1.0);
                    direction = originalDirection + (-Math.PI / 8.0 + Math.random() * (Math.PI / 4.0));
                    if (Math.random() > (1 - this._boltForkRate)) {
                        this.recursiveLaunchBolt(x1, y1, length * (0.3 + Math.random() * 0.4), originalDirection + (-Math.PI / 6.0 + Math.random() * (Math.PI / 3.0)), boltContext);
                    } else if (Math.random() > 0.95) {
                        this.recursiveLaunchBolt(x1, y1, length, originalDirection + (-Math.PI / 6.0 + Math.random() * (Math.PI / 3.0)), boltContext);
                        length = 0;
                    }
                }
            }
            return void 0;
        }.bind(this)), 30);
    },
    tick: function() {
        var bolt, elapsed, frame, i, j, len, length, x, y, direction;
        frame = (new Date).getTime();
        elapsed = (frame - this.lastFrame) / 1000.0;
        this.__fpsRate = 1 / elapsed;
        this.__fpsAvg.frameCount++;
        this.__fpsAvg.fpsSum += this.__fpsRate;
        this.__fpsAvg.average = this.__fpsAvg.fpsSum / this.__fpsAvg.frameCount;
        if (this.__fpsAvg.frameCount > 500 && this.__fpsAvg.average < this._slowFpsAvg) {
            clearInterval(this.__startTick);
        }
        this.lastFrame = frame;
        this._context.clearRect(0.0, 0.0, this._width, this._height);
        if (this._randomDirection) {
            direction = 2.0 * Math.PI * Math.random();
        } else {
            direction = 3.0 * Math.PI / 2.0;
        }
        if (!this._bodyAnimMode && Math.random() > (1 - this._boltRate)) {
            x = Math.floor(-10.0 + Math.random() * (this._width + 20.0));
            y = Math.floor(Math.random() * this._height);
            length = this._height;
            this.launchBolt(x, y, length, direction);
        }
        if (this.__flashOpacity > 0.0) {
            this._context.fillStyle = "rgba(255, 255, 255, " + this.__flashOpacity + ")";
            this._context.fillRect(0.0, 0.0, this._width, this._height);
            this.__flashOpacity = Math.max(0.0, this.__flashOpacity - 2.0 * elapsed);
        }
        for (i = j = 0, len = this.bolts.length; j < len; i = ++j) {
            bolt = this.bolts[i];
            bolt.duration += elapsed;
            this._context.globalAlpha = Math.max(0.0, Math.min(1.0, (this.totalBoltDuration - bolt.duration) / this._boltFadeDuration));
            this._context.drawImage(bolt.canvas, 0.0, 0.0);
            if (bolt.duration >= this.totalBoltDuration) {
                this.bolts.splice(i, 1);
                i--;
                return;
            }
        }
        return void 0;
    },
    setAlphaBlend: function(alphaBlend) {
        var running = false;
        if (this.isRunning()) {
            running = true;
            this.stop();
        }
        this._alphaBlend = alphaBlend;
        running && this.start();
    },
    fadeBackground: function(r, g, b, h, reverse, callback) {
        var steps = 20,
            targetEl = $(this._targetId);
        dr = reverse ? (255 - r) : (r - 255);
        dg = reverse ? (255 - g) : (g - 255);
        db = reverse ? (255 - b) : (b - 255);
        i = 1;
        dr /= steps;
        dg /= steps;
        db /= steps;
        var interval = setInterval(function() {
            var bgFadingColor = 'rgb(' +
                Math.round((reverse ? r : 255) + dr * i) + ',' +
                Math.round((reverse ? g : 255) + dg * i) + ',' +
                Math.round((reverse ? b : 255) + db * i) + ')';
            if (typeof document.getCSSCanvasContext === 'function') {
                targetEl.style.background = '-webkit-canvas(bg_canvas) ' + bgFadingColor;
            } else if (typeof document.mozSetImageElement === 'function') {
                targetEl.style.background = bgFadingColor;
                targetEl.style.backgroundImage = '-moz-element(#bg_canvas)';
            } else {
                targetEl.style.background = bgFadingColor;
            }
            i++;
            if (i - 1 === steps) {
                clearInterval(interval);
                if (typeof callback !== 'undefined') {
                    callback();
                }
            }
        }.bind(this), 20);
    },
    setThickness: function(boltThickness) {
        var running = false;
        if (this.isRunning()) {
            running = true;
            this.stop();
        }
        this._boltThickness = boltThickness;
        running && this.start();
    },
    setSize: function(width, height) {
        if (!this.__canvasSupport) {
            return false;
        }
        var running = false;
        if (this.isRunning()) {
            running = true;
            this.stop();
        }
        this._height = height;
        this._width = width;
        this.setCanvasSize();
        running && this.start();
    },
    animateBackground: function(endingCallback) {
        if (this.__inBodyAnimation) {
            return;
        } else {
            this.__inBodyAnimation = true;
        }
        var currentImg = $(this._targetId).getStyle('backgroundImage'),
            currentBase = $$('base').length ? $$('base').first() : false;
        currentBase && currentBase.remove();
        if (this._bgFadeColor) {
            this.fadeBackground(this._bgFadeColor.r, this._bgFadeColor.g, this._bgFadeColor.b, 100, false, this.start.bind(this));
        } else {
            this.start();
        }
        setTimeout(function() {
            this.launchBolt(180, 300 + window.pageYOffset, 900, Math.PI * 3.0 / 2.0);
        }.bind(this), 1200);
        setTimeout(function() {
            this.launchBolt(1600, 348 + window.pageYOffset, 767, Math.PI * 3.0 / 2.0);
        }.bind(this), 1500);
        setTimeout(function() {
            if (this._bgFadeColor) {
                this.stop();
                this.fadeBackground(this._bgFadeColor.r, this._bgFadeColor.g, this._bgFadeColor.b, 100, true, function() {
                    this._context.clearRect(0.0, 0.0, this._width, this._height);
                    this.__inBodyAnimation = false;
                    typeof endingCallback === 'function' && endingCallback();
                    if (currentImg) {
                        $(this._targetId).style.backgroundImage = currentImg;
                    }
                    currentBase && $$('head')[0].insert(currentBase);
                }.bind(this));
            } else {
                this.stop();
                this.__inBodyAnimation = false;
                this._context.clearRect(0.0, 0.0, this._width, this._height);
                typeof endingCallback === 'function' && endingCallback();
                if (currentImg) {
                    $(this._targetId).style.backgroundImage = currentImg;
                }
                $$('head')[0].insert(currentBase);
            }
        }.bind(this), 3000);
    },
    start: function() {
        if (this._height <= 0) {
            this.stop();
            return false;
        }
        if (this.isRunning()) {
            return true;
        }
        this.__originalBoltThickness = this._boltThickness;
        this.totalBoltDuration = this._boltFlashDuration + this._boltFadeDuration;
        if (!!this._context == false) {
            this.__canvasSupport = false;
            return false;
        }
        this.setCanvasSize();
        this.__fpsAvg = {
            fpsSum: 0,
            frameCount: 0,
            average: 0
        };
        this.__startTick = setInterval(this.tick.bind(this), 1000.0 / this._fps);
    },
    stop: function() {
        if (this.__startTick) {
            clearInterval(this.__startTick);
            this.__startTick = false;
        }
    },
    isRunning: function() {
        return this.__startTick > 0;
    }
});
var PowerManager = Class.create(BeezidObject, {
    __powers: null,
    __powersCount: null,
    __powersConfig: {
        1: {
            name: 'FreezeForAll'
        },
        2: {
            name: 'FreezeForMe',
            visibility: 'private',
            auctionField: 'bid_amount'
        },
        3: {
            name: 'Impostor',
            visibility: 'private'
        },
        4: {
            name: 'SkipUp'
        },
        5: {
            name: 'SkipDown'
        },
        6: {
            name: 'Scrambler'
        },
        7: {
            name: 'Greed',
            visibility: 'private',
            auctionField: 'pwrVillainGreed'
        },
        8: {
            name: 'CashBack'
        },
        11: {
            name: 'Reverse'
        },
        15: {
            name: 'Genesis'
        },
        16: {
            name: 'Melt'
        },
        17: {
            name: 'Cloaking',
            visibility: 'private'
        },
        18: {
            name: 'SniperReload',
            visibility: 'private'
        },
        19: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        20: {
            name: 'Bin',
            visibility: 'private'
        },
        21: {
            name: 'BidsBack',
            visibility: 'private'
        },
        22: {
            name: 'NoJumper'
        },
        23: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        24: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        25: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        26: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        27: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        28: {
            name: 'SniperBoost',
            visibility: 'private'
        },
        29: {
            name: 'HalfBidsBack',
            visibility: 'private'
        }
    },
    __lastScrambleTime: 0,
    initialize: function($super) {
        $super();
        this.__powers = {
            'public': {},
            'private': {}
        };
        this.__powersCount = {
            'public': {},
            'private': {}
        };
        (function() {
            var bu = updaterManager.get(updaterManager.BAR_UPDATER);
            if (bu) {
                bu.addListener('success', this.onBarUpdate, this);
            }
            var au = updaterManager.get(updaterManager.AUCTIONS_UPDATER);
            if (au) {
                au.addListener('success', this.onAuctionsUpdate, this);
            }
            var du = updaterManager.get(updaterManager.DETAILS_UPDATER);
            if (du) {
                du.addListener('success', this.onAuctionsUpdate, this);
            }
            if ($('pwr_float') && Beezid.powerItemsManager) {
                Beezid.powerItemsManager.addListener('powerApplied', this);
            }
            if (window.detailPageManager) {
                window.detailPageManager.addListener('auctionSwitch', this);
            }
            if (typeof HomepageRefresherObj != 'undefined') {
                HomepageRefresherObj.addListener('auctionsLoaded', this);
            }
        }).bind(this).defer();
    },
    __updateAuctionPowerCount: function(auctionId) {
        var auctionIconEl = $('info_icon_' + auctionId + '_1024');
        if (auctionIconEl == null) {
            return;
        }
        var total = 0;
        if (typeof this.__powersCount['public'][auctionId] != 'undefined') {
            total += this.__powersCount['public'][auctionId];
        }
        if (typeof this.__powersCount['private'][auctionId] != 'undefined') {
            total += this.__powersCount['private'][auctionId];
        }
        if (total > 0) {
            auctionIconEl.addClassName('power_active');
            if ($('pwr_a_cnt_' + auctionId)) {
                $('pwr_a_cnt_' + auctionId).update('<small>' + total + '</small>');
            } else {
                auctionIconEl.update('<div id="pwr_a_cnt_' + auctionId + '" class="bar_red_count"><small>' + total + '</small></div>');
            }
        } else {
            auctionIconEl.removeClassName('power_active');
            auctionIconEl.update('');
        }
    },
    __setAuctionPowers: function(auctionPowers, visibility, fromUpdater) {
        var lastUpdateTime = new Date().getTime();
        var powerUpdate = false;
        for (var auctionId in auctionPowers) {
            if (auctionPowers.hasOwnProperty(auctionId)) {
                if (!this.__powers[visibility][auctionId]) {
                    this.__powers[visibility][auctionId] = {};
                    this.__powersCount[visibility][auctionId] = 0;
                }
                for (var powerId in auctionPowers[auctionId]) {
                    if (auctionPowers[auctionId].hasOwnProperty(powerId)) {
                        if (typeof this.__powersConfig[powerId] == 'undefined') {
                            continue;
                        }
                        var powerConfig = this.__powersConfig[powerId];
                        powerConfig.aId = parseInt(auctionId, 10);
                        powerConfig.powerId = parseInt(powerId, 10);
                        powerConfig.powerItemId = parseInt(auctionPowers[auctionId][powerId]['i'], 10);
                        powerConfig.timeElapsed = parseInt(auctionPowers[auctionId][powerId]['t'], 10);
                        powerConfig.value = auctionPowers[auctionId][powerId]['v'];
                        powerConfig.lastUpdateTime = lastUpdateTime;
                        var pwr = this.__powers[visibility][auctionId][powerId];
                        if (!pwr) {
                            pwr = new Power();
                            pwr.addListener('powerUpdate', this);
                            this.__powers[visibility][auctionId][powerId] = pwr;
                        } else if (pwr._value != powerConfig.value || (pwr._timeElapsed == -1 && pwr._timeElapsed != powerConfig.timeElapsed)) {
                            powerUpdate = true;
                        }
                        pwr.update(powerConfig);
                    }
                }
            }
            if (!fromUpdater) {
                this.__powersCount[visibility][auctionId]++;
                this.__updateAuctionPowerCount(auctionId);
                this.fireEvent('auctionPowersUpdate', {
                    powers: this.__powers
                });
                return;
            }
        }
        for (var removedAuctionId in this.__powers[visibility]) {
            var auctionActivePowers = 0;
            for (var powerId in this.__powers[visibility][removedAuctionId]) {
                auctionActivePowers++;
                if (this.__powers[visibility][removedAuctionId].hasOwnProperty(powerId) && this.__powers[visibility][removedAuctionId][powerId]._lastUpdateTime != lastUpdateTime) {
                    if (this.__powers[visibility][removedAuctionId][powerId]._value !== null) {
                        powerUpdate = true;
                    }
                    this.__powers[visibility][removedAuctionId][powerId].resetValue();
                    auctionActivePowers--;
                }
            }
            if (this.__powersCount[visibility][removedAuctionId] != auctionActivePowers) {
                powerUpdate = true;
            }
            if (this.__powersCount[visibility][removedAuctionId] != auctionActivePowers) {
                this.__powersCount[visibility][removedAuctionId] = auctionActivePowers;
                this.__updateAuctionPowerCount(removedAuctionId);
            }
        }
        if (powerUpdate) {
            this.fireEvent('auctionPowersUpdate', {
                powers: this.__powers
            });
        }
    },
    onAuctionsUpdate: function(event) {
        this.__setAuctionPowers(event.result.pwr, 'public', true);
    },
    onBarUpdate: function(event) {
        this.__setAuctionPowers(event.uapwr, 'private', true);
        this.fireEvent('powerUserAuctionsUpdate', event);
    },
    onPowerApplied: function(event) {
        if (event.update) {
            var pwr = {};
            var powerId = parseInt(event.power_id, 10);
            pwr[powerId] = event.update;
            if (this.__powersConfig[powerId].visibility) {
                var visibility = this.__powersConfig[powerId].visibility;
            } else {
                var visibility = 'public';
            }
            if (event.auction_id) {
                var pwrConfig = {};
                pwrConfig[event.auction_id] = pwr;
                this.__setAuctionPowers(pwrConfig, visibility, false);
            }
        }
    },
    onAuctionSwitch: function(event) {
        this.__updateAuctionPowerCount(event.auctionId);
        this.fireEvent('auctionPowersUpdate', {
            powers: this.__powers
        });
    },
    setAuctionUpdaterValues: function(auction) {
        if (typeof this.__powers['private'][auction.id] != 'undefined') {
            for (var powerId in this.__powers['private'][auction.id]) {
                if (this.__powers['private'][auction.id].hasOwnProperty(powerId)) {
                    var pwr = this.__powers['private'][auction.id][powerId];
                    if (pwr['_auctionField'] !== null && pwr['_value'] !== null) {
                        if (pwr['_auctionField'] == 'bid_amount' && auction['bid_amount'] < pwr['_value']) {
                            continue;
                        }
                        auction[pwr['_auctionField']] = pwr['_value'];
                    }
                }
            }
        }
    },
    getAuctionPowerValue: function(auctionId, powerIds, field) {
        if (typeof this.__powers['private'][auctionId] == 'undefined') {
            return false;
        }
        if (typeof field == 'undefined') {
            field = '_value';
        }
        for (var i in powerIds) {
            if (powerIds.hasOwnProperty(i) && typeof this.__powers['private'][auctionId][powerIds[i]] != 'undefined' && this.__powers['private'][auctionId][powerIds[i]][field] !== null) {
                return this.__powers['private'][auctionId][powerIds[i]][field];
            }
        }
        return false;
    },
    onPowerUpdate: function(pwr) {
        var fn = 'on' + pwr._name + 'Update';
        if (typeof this[fn] == 'function') {
            this[fn](pwr);
        }
    },
    onScramblerUpdate: function(pwr) {
        if (!Beezid.info.powerPurchased() || (typeof detailsData == 'undefined' && $('content_big') === null)) {
            return;
        }
        var secondsSinceLastScramble = (Math.round(Date.now() / 1000)) - this.__lastScrambleTime;
        if (pwr._value && secondsSinceLastScramble >= 300) {
            this.__lastScrambleTime = Math.round(Date.now() / 1000);
            var contentTop = $('content_big');
            if (contentTop !== null) {
                var scrambleFn = function() {
                    $$('[id^="a_"]').each(function(item) {
                        item.addClassName('gpsc');
                    });
                    setTimeout(function() {
                        $$('[id^="a_"]').shuffle().each(function(item) {
                            Effect.Shake(item, {
                                duratiom: 1,
                                distance: 80
                            });
                            $('content_big').insertBefore(item, $$('[id^="a_"]').first());
                            item.removeClassName('gpsc');
                        });
                        Beezid.myLL.forceLoad();
                    }, 3000);
                };
                if (typeof Beezid.boltBody === 'undefined') {
                    var targetId = TEMPLATE == 'mega' ? 'content_big' : 'master_wrapper',
                        targetWidth = $(targetId) ? $(targetId).getWidth() : 0,
                        viewPortHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0),
                        cssBgContext = document.getCssBgCanvasContext('bg_canvas', targetId, targetWidth, viewPortHeight);
                    if (cssBgContext) {
                        Beezid.boltBody = new BeezidBolt({
                            context: cssBgContext,
                            useThunderFlash: true,
                            fps: 90,
                            bodyAnimMode: true,
                            targetId: targetId,
                            boltFlashDuration: 0.8,
                            boltForkRate: 0.01,
                            bgFadeColor: {
                                r: 0,
                                g: 10,
                                b: 40
                            },
                            width: window.innerWidth,
                            height: viewPortHeight
                        });
                    } else {
                        Beezid.boltBody = false;
                    }
                }
                if (Beezid.boltBody) {
                    Beezid.boltBody.animateBackground(scrambleFn);
                } else {
                    scrambleFn();
                }
            }
        }
    },
    onCashBackUpdate: function(pwr) {
        this.fireEvent('powerCashBackUpdate', {
            auctionId: pwr._aId
        });
    },
    onSniperBoostUpdate: function(pwr) {
        this.fireEvent('sniperBoostUpdate', {
            auctionId: pwr._aId,
            value: pwr._value
        });
    },
    onSniperReloadUpdate: function(pwr) {
        this.fireEvent('sniperReloadUpdate', {
            auctionId: pwr._aId
        });
    },
    onBinUpdate: function(pwr) {
        this.fireEvent('binUpdate', {
            auctionId: pwr._aId
        });
    },
    onSkipUpUpdate: function(pwr) {
        this.fireEvent('powerSkipUpUpdate', {
            auctionId: pwr._aId,
            value: pwr._value
        });
    },
    onSkipDownUpdate: function(pwr) {
        this.fireEvent('powerSkipDownUpdate', {
            auctionId: pwr._aId,
            value: pwr._value
        });
    },
    onReverseUpdate: function(pwr) {
        this.fireEvent('powerReverseUpdate', {
            auctionId: pwr._aId,
            value: pwr._value
        });
    },
    onAuctionsLoaded: function() {
        for (var auctionId in this.__powersCount['private']) {
            if (this.__powersCount['private'].hasOwnProperty(auctionId)) {
                this.__updateAuctionPowerCount(auctionId);
            }
        }
        for (var auctionId in this.__powersCount['public']) {
            if (this.__powersCount['public'].hasOwnProperty(auctionId)) {
                this.__updateAuctionPowerCount(auctionId);
            }
        }
    }
});
var Power = Class.create(BeezidObject, {
    _aId: null,
    _powerId: null,
    _name: null,
    _powerItemId: null,
    _timeElapsed: null,
    _value: null,
    _visibility: 'public',
    _auctionField: null,
    _lastUpdateTime: 0,
    phatomValue: null,
    recentlyRemoved: false,
    initialize: function($super, config) {
        $super(config);
        (function() {
            if (window.detailPageManager) {
                window.detailPageManager.addListener('auctionSwitch', this);
            }
        }).bind(this).defer();
    },
    update: function(config) {
        var previousValue = this._value,
            previousTimeElapsed = this._timeElapsed;
        this._bindConfig(config);
        if (previousValue !== config['value']) {
            this.fireEvent('powerUpdate', this);
        }
        if (previousTimeElapsed == -1 && config['_timeElapsed'] >= 0) {
            Beezid.powerDropView && Beezid.powerDropView.updateLogItem(this._powerItemId, 'Active');
        }
    },
    resetValue: function() {
        if (this._value !== null) {
            this.recentlyRemoved = true;
            this.phatomValue = this._value;
            this._value = null;
            this.fireEvent('powerUpdate', this);
            Beezid.powerDropView && Beezid.powerDropView.updateLogItem(this._powerItemId, 'Inactive');
        } else {
            this.recentlyRemoved = false;
        }
    },
    onAuctionSwitch: function(event) {
        if (event.auctionId == this._aId) {
            this.fireEvent('powerUpdate', this);
        }
    }
});
var PowerConfig = Class.create(BeezidObject, {
    _totalLevels: 7,
    _powers: {},
    _postParams: {},
    __healthPoints: 0,
    __currentLevel: 0,
    __nextLevelPercantage: 0,
    initialize: function($super, config) {
        $super(config);
        this._bindConfig(config);
    },
    setHealthPoints: function(config) {
        this.__healthPoints = config.h;
        this.__currentLevel = config.l;
        this.__nextLevelPercantage = config.p;
    },
    setPowers: function(powers) {
        this._powers = powers;
    },
    setPower: function(power) {
        this._powers[power.id] = power;
    },
    setPowerQty: function(powerId, qty) {
        this._powers[powerId].qty = qty;
    },
    getHealthPoints: function() {
        return this.__healthPoints;
    },
    getPowerQty: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].qty : 0;
    },
    getPowerPrice: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].price : 0;
    },
    getPowers: function() {
        return this._powers;
    },
    getPower: function(powerId) {
        return this._powers[powerId];
    },
    getLevel: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].level : 0;
    },
    getMaxCheckoutQty: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].max_checkout_qty : 0;
    },
    getMaxInventoryQty: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].inventory_qty_limit : 0;
    },
    getCatalogItemId: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].catalog_item_id : null;
    },
    getName: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].name : '';
    },
    getPowerDesc: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].description : '';
    },
    getPowerTooltip: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].tooltip : '';
    },
    getUserLevel: function() {
        return this.__currentLevel;
    },
    getPostParams: function(powerId) {
        if (typeof this._postParams[powerId] === 'undefined') {
            return {};
        }
        return this._postParams[powerId].post_params;
    },
    isAuctionPower: function(powerId) {
        return this._powers[powerId] ? this._powers[powerId].auction_power : false;
    },
    renderValue: function(powerId, value) {
        if (this._powers[powerId].value_renderer == 'money') {
            return formatCurrency(value);
        }
        return value;
    }
});
var PowerItemsManager = Class.create(BeezidObject, {
    initialize: function($super, config) {
        if (!$('pwr_float')) {
            return;
        }
        $super(config);
        Beezid.powerDropView = new PowerDropView({
            elem: $('pwr_float')
        }).instantiate();
        Beezid.powerDropView.addClickHandlerOnPowerAuctions.defer();
        Beezid.powerDropView.checkCookiePowerSelected();
        Beezid.powerDropView.checkCookieSetSelectedAuction();
        if ($('pwr_resp_txt').innerHTML == '') {
            Beezid.powerDropView.hideShowResponseMsg();
        }
    },
    applyPower: function(powerId, auctionId) {
        var applyParams = {
            'data[power_id]': powerId,
            'data[auction_id]': auctionId
        };
        $$('[id^=pwr_param_]').each(function(el) {
            applyParams[el.name] = el.value;
        });
        new Ajax.Request('/powers/apply', {
            method: 'post',
            parameters: applyParams,
            onSuccess: function(response) {
                if (response.responseText.isJSON()) {
                    var resp = JSON.parse(response.responseText);
                    this.fireEvent('powerApplied', resp);
                } else {
                    this.fireEvent('powerAppliedFailure', response);
                }
            }.bind(this),
            onFailure: function(response) {
                this.fireEvent('powerAppliedFailure', response);
            }.bind(this)
        });
    },
    buyNewPower: function(catalogItemId, qty) {
        new Ajax.Request('/products/quick_buy', {
            method: 'post',
            parameters: {
                'data[CatalogItem][id]': catalogItemId,
                'data[CatalogItem][qty]': qty
            },
            onSuccess: function(response) {
                var resp = JSON.parse(response.responseText);
                if (resp.wallet) {
                    this.fireEvent('quickBuy', {
                        wallet: resp.wallet[0],
                        wallet_cashable_balance: resp.wallet[1]
                    });
                }
                resp.catalog_item_id = catalogItemId;
                this.fireEvent('powerBought', resp);
            }.bind(this)
        });
    },
    getPurchasePriceWithTaxes: function(catalogItemId, qty) {
        new Ajax.Request('/products/quick_buy_item_total', {
            method: 'post',
            parameters: {
                'data[CatalogItem][id]': catalogItemId,
                'data[CatalogItem][qty]': qty
            },
            onSuccess: function(response) {
                var resp = JSON.parse(response.responseText);
                this.fireEvent('quickBuyItemTotal', {
                    itemTotal: resp.itemTotal,
                    request_qty: qty
                });
            }.bind(this)
        });
    },
    buyWalletGiftCard: function(itemId) {
        new Ajax.Request('/shopping_cart/add/12', {
            method: 'post',
            parameters: {
                id: '1_' + itemId,
                quantity: 1
            },
            onSuccess: function(response) {
                var result = JSON.parse(response.responseText);
                if (result.status == 'success') {
                    window.location = '/checkout';
                } else {
                    beezAlert(result.msg);
                    $('pwr_wallet_btn').enable().removeClassName('disabled');
                }
            }.bind(this)
        });
    },
    updateUserSettingValue: function(userSettingId, userSettingValue) {
        new Ajax.Request('/my_account/skip_message/' + userSettingId, {
            method: 'post',
            parameters: {
                'skip_value': userSettingValue
            }
        });
    }
});
var PowerDropView = Class.create(BeezidObject, {
    __elem: false,
    __open: false,
    __button: false,
    __inShowLogAnim: false,
    __powerLogTimer: null,
    __firstBarUpdate: true,
    __paramValidator: false,
    __powerFeatureValue: 1024,
    __logInfoReceived: false,
    __selectedPowerId: false,
    __successFadeTimer: false,
    __selectedAuctionId: false,
    __logTransitionAdded: false,
    __inMoveBoxAnimation: false,
    __rotPwrIcnInterlval: {},
    __currHealthBarHeight: 0,
    __maxPowerIconPerRow: 5,
    __currPowerFloatHeight: false,
    __pwrBarOpenCookie: 'pwr_bar_open',
    __selPowerCookie: 'pwr_selc_pwrid',
    __selAuctionCookie: 'pwr_selc_auctid',
    __newPowerTipCookie: 'pwr_new_tooltip',
    __powerResultCodes: {
        none: 0,
        success: 1,
        alert: 2,
        error: 3
    },
    initialize: function($super, config) {
        if (!$('pwr_float')) {
            return;
        }
        $super(config);
        this.__elem = config.elem;
        (function() {
            if (typeof HomepageRefresherObj !== 'undefined' && HomepageRefresherObj) {
                HomepageRefresherObj.addListener('auctionsLoaded', this.onHomepageRefresher, this);
            }
            if (Beezid.powerItemsManager) {
                Beezid.powerItemsManager.addListener('powerBought', this);
                Beezid.powerItemsManager.addListener('powerApplied', this);
                Beezid.powerItemsManager.addListener('powerAppliedFailure', this);
                Beezid.powerItemsManager.addListener('quickBuyItemTotal', this);
            }
            if (Beezid.info) {
                Beezid.info.addListener('superModeChanged', this);
            }
            this.setPowerFloatHeight();
            this.checkCookieDisplayPwrBar();
        }).bind(this).defer();
        var bu = updaterManager.get(updaterManager.BAR_UPDATER);
        if (bu) {
            bu.addListener('success', this.onBarUpdatePower, this);
        }
    },
    instantiate: function($super) {
        this.__button = new Button({
            elem: $('power_popup_btn'),
            action: this.__activate.bind(this)
        });
        this.__closeBtn = new Button({
            elem: $('pwr_close'),
            action: this.__activate.bind(this)
        });
        this.addBuyClickHandler();
        this.addBlankPowerIcons();
        this.addApplyClickHandler();
        this.addBuyWalletClickHandler();
        this.addClickHandlerOnTitleBar();
        this.addPowerShowDescClickHander();
        this.addPowerCloseDescClickHander();
        this.addPurchaseCloseClickHandler();
        this.addPowerPurchaseClickHandler();
        this.addPowerMessageCloseClickHandler();
        this.addPowerPurchaseQtyChangeHandler();
        this.addWalletPurchaseQtyChangeHandler();
        $$('[id^=pwrb_]').each(function(el) {
            el.stopObserving('click');
            el.observe('click', function(event) {
                this.addPowerIconClickHandler(el);
            }.bind(this));
        }.bind(this));
        $$('.pwr_icn_q').invoke('up').each(function(el) {
            el.observe('click', function(event) {
                this.addComingSoonClickHandler();
            }.bind(this));
        }.bind(this));
        this.enableElement('pwr_show_desc');
        return this;
    },
    setPowerFloatHeight: function() {
        this.__elem.hide();
        if (this.__elem.getStyle('maxHeight') !== 'none') {
            this.__currPowerFloatHeight = parseInt(this.__elem.getStyle('maxHeight').replace('px', '')) + $('nbar_wrapper').getHeight();
        } else {
            this.__currPowerFloatHeight = this.__elem.getHeight() + $('nbar_wrapper').getHeight();
        }
        this.__elem.style.bottom = (this.__currPowerFloatHeight * -1) + "px";
        this.__elem.show();
    },
    addApplyClickHandler: function() {
        $('pwr_apply').observe('click', function(el) {
            this.applyClickHandler();
        }.bind(this));
    },
    addBlankPowerIcons: function() {
        $$('.pwr_row').each(function(elem) {
            var pwrLevelIconCount = elem.select('[id^=pwrb_]').length,
                missingLiCount = this.__maxPowerIconPerRow - (pwrLevelIconCount % this.__maxPowerIconPerRow);
            if (missingLiCount == this.__maxPowerIconPerRow) {
                return;
            }
            var powerLevel = elem.id.gsub('pwr_level_', '');
            for (var i = 0; i < missingLiCount; i++) {
                if (powerLevel >= 5 && i == 0) {
                    elem.select('ul')[0].insert('<li class="pwr_li_item"><div class="pwr_icn_ctn pwr_icn_q"></div></li>');
                } else {
                    elem.select('ul')[0].insert('<li class="pwr_li_item"><div class="pwr_icn_empty"></div></li>');
                }
            }
        }.bind(this));
        var helpIconEl = $('pwr_level_1').select('.pwr_icn_empty').last().up().addClassName('pwr_tutorial_opn unselectable');
        helpIconEl.update(i18n.power_item_manager.btn_help_tutorial);
        helpIconEl.observe('click', function(ev) {
            Beezid.powerTutorial.open(0);
        });
    },
    addComingSoonClickHandler: function() {
        this.__selectedPowerId = false;
        this.__selectedPowerId && $('pwr_sel_icn').removeClassName('pwr_icn_med_' + this.__selectedPowerId);
        this.disableElement('pwr_buy');
        this.disableElement('pwr_apply');
        this.disableElement('pwr_show_desc');
        $('pwr_sel_icn').addClassName('pwr_icn_med_q');
        $('pwr_sel_name').update(i18n.power_item_manager.not_available_yet);
    },
    applyClickHandler: function() {
        if (this.__paramValidator && !this.__paramValidator.validate()) {
            return;
        }
        if (!this.__selectedAuctionId && Beezid.powerConfig.isAuctionPower(this.__selectedPowerId)) {
            this.setResponseMsg('error', i18n.power_item_manager.select_auction, 'pwr_resp');
        } else {
            this.disableElement('pwr_buy');
            this.disableElement('pwr_apply');
            var auctionId = Beezid.powerConfig.isAuctionPower(this.__selectedPowerId) ? this.__selectedAuctionId : 0;
            Beezid.powerItemsManager.applyPower(this.__selectedPowerId, auctionId);
        }
    },
    addBuyClickHandler: function() {
        $('pwr_buy').observe('click', function(event) {
            this.displayPurchaseBox();
        }.bind(this));
    },
    addPurchaseCloseClickHandler: function() {
        $('pwr_purchase_cancel').observe('click', function(ev) {
            this.closePurchaseBox();
        }.bind(this));
        $('pwr_purchase_close_btn').observe('click', function(ev) {
            this.closePurchaseBox();
        }.bind(this));
    },
    addPowerPurchaseQtyChangeHandler: function() {
        $('pwr_purchase_qty').observe('change', function(ev) {
            this.disableElement('pwr_purchase_btn');
            Beezid.powerItemsManager.getPurchasePriceWithTaxes(Beezid.powerConfig.getCatalogItemId(this.__selectedPowerId), ev.target.value);
        }.bind(this));
    },
    addWalletPurchaseQtyChangeHandler: function() {
        $('pwr_wallet_qty').observe('change', function(ev) {
            var walletCatalogItemId = $$('select#pwr_wallet_qty option').find(function(el) {
                return !!el.selected;
            }).getAttribute('data');
            this.setWalletPurchasePrice();
        }.bind(this));
    },
    addPowerPurchaseClickHandler: function() {
        $('pwr_purchase_btn').stopObserving('click');
        $('pwr_purchase_btn').observe('click', function(ev) {
            this.disableElement('pwr_buy');
            this.disableElement('pwr_apply');
            this.disableElement('pwr_purchase_btn');
            this.disableElement('pwr_show_desc');
            $('pwr_purchase_cancel').setStyle({
                pointerEvents: 'none'
            });
            var qty = $('pwr_purchase_qty').value,
                amount = Beezid.powerConfig.getPowerPrice(this.__selectedPowerId),
                catItemId = Beezid.powerConfig.getCatalogItemId(this.__selectedPowerId);
            Beezid.powerItemsManager.buyNewPower(catItemId, qty);
        }.bind(this));
    },
    addPowerMessageCloseClickHandler: function(ev) {
        $('message_close').observe('click', function(ev) {
            this.clearSuccessTimer();
            this.hideShowResponseMsg();
        }.bind(this));
    },
    getPurchaseAboutText: function(itemPrice) {
        return i18n.power_item_manager.about_to_buy.replace('%s', '<span> ' + formatCurrency(itemPrice) + ' </span>');
    },
    deselectPowerIcon: function(powerId) {
        $('pwr_icn_desc').hide();
        this.removeAllInputParams();
        this.__selectedPowerId = false;
        this.hideShowResponseMsg();
        $('pwrb_' + powerId).removeClassName('active');
        $('pwr_sel_icn').removeClassName('pwr_icn_med_' + powerId);
        this.setCookie(this.__selPowerCookie, this.__selectedPowerId);
    },
    addPowerIconClickHandler: function(el) {
        el.stopObserving('click');
        var powerId = el.id.split('_')[1];
        $$('[id^=pwrb_].active').each(function(activeBtn) {
            activeBtn.removeClassName('active');
        });
        this.__selectedPowerId && $('pwr_sel_icn').removeClassName('pwr_icn_med_' + this.__selectedPowerId);
        $('pwr_sel_icn').hasClassName('pwr_icn_med_q') && $('pwr_sel_icn').removeClassName('pwr_icn_med_q');
        if (powerId == this.__selectedPowerId && !$('pwrb_' + powerId).hasClassName('disabled')) {
            this.__selectedPowerId = false;
            this.removeAllInputParams();
            $('pwr_icn_desc').hide();
        } else {
            this.__selectedPowerId = powerId;
            this.setInputParams(powerId);
            el.addClassName('active');
            $('pwr_sel_icn').addClassName('pwr_icn_med_' + powerId);
            $('pwr_sel_name').update(Beezid.powerConfig.getName(powerId));
            $('pwr_icn_desc').show();
            if (Beezid.powerConfig.getPowerQty(powerId) < 1) {
                if ($('pwrb_' + powerId).hasClassName('disabled')) {
                    this.openPowerDescBox(powerId);
                } else {
                    !$('pwr_purchase').visible() && this.displayPurchaseBox();
                }
            }
        }
        this.clearSuccessTimer();
        this.toggleAuctionInfo();
        this.hideShowResponseMsg();
        this.enableElement('pwr_show_desc');
        this.setCookie(this.__selPowerCookie, this.__selectedPowerId);
        setTimeout(function() {
            el.observe('click', function(event) {
                this.addPowerIconClickHandler(el);
            }.bind(this))
        }.bind(this), 500);
    },
    addBuyWalletClickHandler: function() {
        this.enableElement('pwr_wallet_btn');
        $('pwr_wallet_btn').observe('click', function(ev) {
            var walletItemId = $('pwr_wallet_qty').value;
            this.disableElement('pwr_wallet_btn');
            Beezid.powerItemsManager.buyWalletGiftCard(walletItemId);
        }.bind(this));
    },
    addLogTransitionEndHandler: function() {
        ["webkitTransitionEnd", "mozTransitionEnd", "MSTransitionEnd", "oTransitionEnd", "transitionend"].each(function(transitionTarget) {
            $('pwr_log_cnt').observe(transitionTarget, function() {
                if ($('pwr_log_cnt').getStyle('marginLeft') == '0px') {
                    $('pwr_log_cnt').addClassName('pwr_log_visible').removeClassName('pwr_log_transition');
                }
            });
        });
        this.__logTransitionAdded = true;
    },
    addPowerShowDescClickHander: function(ev) {
        $('pwr_show_desc').observe('click', function(ev) {
            this.openPowerDescBox(this.__selectedPowerId);
        }.bind(this));
    },
    addPowerCloseDescClickHander: function(ev) {
        $('pwr_desc_close').observe('click', function(ev) {
            this.closePowerDescBox();
        }.bind(this));
    },
    openPowerDescBox: function(powerId) {
        if (this.__inMoveBoxAnimation) {
            return;
        }
        if ($('pwr_purchase').visible()) {
            this.closePurchaseBox();
        }
        if ($('pwr_desc').visible()) {
            this.closePowerDescBox();
            return;
        } else {
            this.__inMoveBoxAnimation = true;
            if (!Beezid.powerConfig.getPowerQty(powerId) && Beezid.powerConfig.getLevel(powerId) > Beezid.powerConfig.getUserLevel()) {
                this.disableElement('pwr_buy');
                $('pwr_need_level_up').show();
                $('pwr_buy_super_bids').show();
            } else {
                this.enableElement('pwr_buy');
                $('pwr_need_level_up').hide();
                $('pwr_buy_super_bids').hide();
            }
            $('pwr_purchase_title').update(Beezid.powerConfig.getName(powerId));
            $('pwr_purchase_desc').update(Beezid.powerConfig.getPowerDesc(powerId));
            this.moveBox('pwr_desc', 'down');
            this.disableElement('pwr_show_desc');
        }
    },
    closePowerDescBox: function() {
        this.moveBox('pwr_desc', 'up');
        this.enableElement('pwr_show_desc');
    },
    closePurchaseBox: function() {
        this.clearSuccessTimer();
        $('pwr_resp_purchase_ctn').hide();
        this.moveBox('pwr_purchase', 'up');
        this.enableElement('pwr_buy');
    },
    moveBox: function(boxId, direction) {
        var moveDistance = $$('.pwr_header')[0].getHeight() + $$('.pwr_close_details')[0].getHeight(),
            topOffset = $$('.pwr_header_ctn')[0].getStyle('top'),
            boxHeight = $(boxId).getHeight();
        if (direction == 'up') {
            moveDistance = 0;
        } else {
            this.__inMoveBoxAnimation && new Effect.Opacity('pwr_content_wrap', {
                from: 1.0,
                to: 0.3,
                duration: 0.5
            });
            $('pwr_content_wrap').setStyle({
                pointerEvents: 'none'
            });
            if ($('pwr_input_wrap').visible()) {
                boxHeight += $('pwr_input_wrap').getHeight();
            }
            if (boxId == 'pwr_purchase' && topOffset && boxHeight > moveDistance) {
                topOffset = parseInt(topOffset.replace('px', ''));
                moveDistance += topOffset;
            }
            $(boxId).show();
        }
        new Effect.Move(boxId, {
            x: 0,
            y: moveDistance,
            mode: 'absolute',
            duration: 0.5,
            afterFinish: function(el) {
                if (direction == 'up') {
                    $(boxId).hide();
                    if (!this.__inMoveBoxAnimation && !($('pwr_desc').visible() && !$('pwr_purchase').visible() || !$('pwr_desc').visible() && $('pwr_purchase').visible())) {
                        $('pwr_content_wrap').setStyle({
                            pointerEvents: 'auto'
                        });
                        new Effect.Opacity('pwr_content_wrap', {
                            from: 0.3,
                            to: 1.0,
                            duration: 0.5
                        });
                    }
                }
                if (boxId == 'pwr_purchase') {
                    this.enableElement('pwr_show_desc');
                    $('pwr_purchase_btn').show();
                } else if (boxId == 'pwr_desc') {
                    this.enableElement('pwr_show_desc');
                }
                this.__inMoveBoxAnimation = false;
            }.bind(this)
        });
    },
    setWalletPurchasePrice: function() {
        var giftCardPrice = $$('select#pwr_wallet_qty option')[$('pwr_wallet_qty').selectedIndex].innerHTML;
        $('pwr_wallet_price').update(giftCardPrice);
    },
    displayPurchaseWalletBox: function(missingAmount) {
        new Ajax.Request('/shopping_cart/get_store_gift_card', {
            method: 'post',
            onSuccess: function(response) {
                var selectOptions = '',
                    resp = JSON.parse(response.responseText);
                resp.each(function(giftCard) {
                    selectOptions += '<option value="' + giftCard.StoreItem.id + '" data="' + giftCard.CatalogItem.id + '">' + formatCurrency(giftCard.CatalogItem.price) + '</option>';
                });
                $('pwr_wallet_qty').update(selectOptions);
                typeof resp[0] !== 'undefined' && this.setWalletPurchasePrice();
            }.bind(this)
        });
        var reponseMsg = i18n.power_item_manager.wallet_money_missing.replace('%s', formatCurrency(missingAmount));
        $('pwr_purchase_box').hide();
        $('pwr_wallet_info_msg').update(reponseMsg);
        $('pwr_purchase_wallet_box').show();
    },
    displayPurchaseBox: function() {
        if (this.__inMoveBoxAnimation) {
            return;
        }
        $('pwr_desc').visible() && this.closePowerDescBox();
        this.__inMoveBoxAnimation = true;
        this.disableElement('pwr_buy');
        this.disableElement('pwr_show_desc');
        var selectOptions = '',
            maxQty = Beezid.powerConfig.getMaxCheckoutQty(this.__selectedPowerId),
            maxQty = typeof maxQty === 'undefined' || maxQty === null ? 100 : parseInt(maxQty),
            maxInvQty = Beezid.powerConfig.getMaxInventoryQty(this.__selectedPowerId) - Beezid.powerConfig.getPowerQty(this.__selectedPowerId),
            selectQty = maxInvQty < maxQty ? $R(1, maxInvQty).toArray() : $R(1, maxQty).toArray();
        selectQty.each(function(optionVal) {
            selectOptions += '<option value="' + optionVal + '">' + optionVal + '</option>';
        });
        $('pwr_purchase_close_btn').hide();
        $('pwr_purchase_cancel').show();
        this.enableElement('pwr_purchase_btn');
        $('pwr_purchase_btn').show();
        $('pwr_purchase_box').show();
        $('pwr_purchase_wrapper').show();
        $('pwr_purchase_qty').update(selectOptions);
        $('pwr_purchase_btn').update(i18n.power_item_manager.btn_purchase_powers);
        Beezid.powerConfig.getPowerQty(this.__selectedPowerId) < 1 && this.disableElement('pwr_apply');
        Beezid.powerItemsManager.getPurchasePriceWithTaxes(Beezid.powerConfig.getCatalogItemId(this.__selectedPowerId), 1);
        this.addPowerPurchaseClickHandler();
    },
    updateLogItem: function(powerItemId, newStatus) {
        var logItemEl = $('log_status_' + powerItemId);
        if (logItemEl) {
            logItemEl.select('p').first().update(newStatus);
            logItemEl.select('.log_status_icn').first().setAttribute('class', 'log_status_icn log_status_' + newStatus.toLowerCase());
        }
    },
    startLogTimers: function() {
        this.stopLogTimers();
        this.__powerLogTimer = new TimerUpdater({
            cls: 'pwr_log_timer',
            abrevTime: true
        });
    },
    stopLogTimers: function() {
        if (this.__powerLogTimer !== null) {
            this.__powerLogTimer.stop();
        }
    },
    isPowerLogVisible: function() {
        return $('pwr_log_cnt') && $('pwr_log_cnt').getStyle('marginLeft') == '0px';
    },
    hideShowLogInfo: function() {
        if (this.isPowerLogVisible()) {
            $('pwr_log_cnt').removeClassName('pwr_log_visible').addClassName('pwr_log_transition');
            $('pwr_log_cnt').style.marginLeft = '-360px';
            this.stopLogTimers();
        } else {
            if (this.__inShowLogAnim) {
                return;
            }
            this.__inShowLogAnim = true;
            if (!this.__logInfoReceived && this.__powerLogTimer !== null) {
                this.startLogTimers();
                $('pwr_log_cnt').style.marginLeft = '0px';
                this.__inShowLogAnim = false;
                return;
            }
            new Ajax.Updater('pwr_log_box', '/powers/power_log?page=1', {
                evalScripts: true,
                onComplete: function(request, json) {
                    this.startLogTimers();
                    this.addClickHandlerOnTitleBar();
                    this.addClickHandlerOnStatusFilter();
                    this.__logInfoReceived = false;
                    $$('.pwr_log_header').each(function(el) {
                        el.removeClassName('info_received');
                    });
                    if (Beezid.touchEnabled) {
                        Beezid.powerControlSwipe = new PowerControlSwipe();
                        Beezid.powerControlSwipe.addPowerLogSwipeEvent();
                    }!this.__logTransitionAdded && this.addLogTransitionEndHandler();
                    setTimeout(function() {
                        $('pwr_log_cnt').style.marginLeft = '0px';
                    }, 1);
                    this.initPowerLogScroll();
                    this.__inShowLogAnim = false;
                }.bind(this),
                onLoading: function(request) {}
            });
        }
    },
    toggleAuctionInfo: function() {
        if (this.__selectedAuctionId || (this.__selectedPowerId && !Beezid.powerConfig.isAuctionPower(this.__selectedPowerId))) {
            $('pwr_auct_resp').removeClassName('pwr_alert').hide();
            if (this.__selectedPowerId && !Beezid.powerConfig.isAuctionPower(this.__selectedPowerId)) {
                $('pwr_auction_info').hide();
                Beezid.powerDropView.setResponseMsg('none', i18n.power_item_manager.non_auction_power, 'pwr_non_auction_resp');
            } else {
                $('pwr_auct_resp_txt').update(i18n.power_item_manager.select_auction);
                $('pwr_auction_info').show();
                $('pwr_non_auction_resp_ctn').hide();
            }
        } else {
            $('pwr_auct_resp').addClassName('pwr_alert').show();
            if (!this.__selectedAuctionId && !$('pwr_auction_info').visible()) {
                $('pwr_auct_resp_txt').update(i18n.power_item_manager.select_auction);
                $('pwr_auction_info').show();
                $('pwr_non_auction_resp_ctn').hide();
            }
        }
    },
    selectAuctionDiv: function(auctionId, forceSelect) {
        if (auctionId == null || !$('a_' + auctionId)) {
            this.__selectedAuctionId = false;
            this.setCookie(this.__selAuctionCookie, this.__selectedAuctionId);
            this.toggleAuctionInfo();
            return;
        }
        $$('.auction_feature_1024_icon.active').each(function(el) {
            el.removeClassName('active');
        });
        var auctionLink, auctionTitle, auctionImgSrc, auctionDiv = $('a_' + auctionId),
            auctionImg = $('pwr_sel_auction_img'),
            auctionTimer = $$('.pwr_timer')[0],
            auctionBidder = $$('.pwr_bidder')[0],
            auctionAmount = $$('.pwr_amount')[0],
            auctionAmtLbl = $('pwr_amount_lbl');
        if (TEMPLATE == 'home' || TEMPLATE == 'regular' || TEMPLATE == 'mega') {
            auctionLink = $('a_' + auctionId).select('a')[0].href;
            auctionTitle = $('a_' + auctionId).select('a')[0].title;
            auctionImgSrc = $('a_' + auctionId).select('img')[0].src;
            auctionImg.stopObserving('click');
            auctionImg.observe('click', function(ev) {
                window.location = auctionLink;
            });
        }
        if (this.__selectedAuctionId == auctionId && !forceSelect) {
            this.__selectedAuctionId = false;
            $('info_icon_' + auctionId + '_1024') && $('info_icon_' + auctionId + '_1024').removeClassName('active');
        } else {
            var timerValue = $('timer_' + auctionId),
                bidderValue = $('bidder_name' + auctionId),
                amountValue = $('amount_' + auctionId).select('.a_amount').first(),
                amountLabel = $('amount_' + auctionId).select('.a_amount_txt').first(),
                powerIcon = $('info_icon_' + auctionId + '_1024');
            if (timerValue.hasClassName('closed') || timerValue.hasClassName('a_closed')) {
                var timerText = i18n.beezid.ended;
            } else {
                var timerText = $('timer_' + auctionId).innerHTML;
            }
            this.__selectedAuctionId = auctionId;
            auctionImg.setStyle({
                cursor: 'pointer'
            });
            auctionImg.src = auctionImgSrc;
            auctionTimer.id = 'timer_' + auctionId + 'c';
            auctionAmount.id = 'amount_' + auctionId + 'c';
            auctionBidder.id = 'bidder_name' + auctionId + 'c';
            amountLabel && auctionAmtLbl.update(amountLabel.innerHTML);
            timerValue && auctionTimer.update(timerText);
            auctionTimer.removeClassName('timer_with_days');
            bidderValue && auctionBidder.update($('bidder_name' + auctionId).innerHTML);
            amountValue && auctionAmount.update(amountValue.innerHTML);
            powerIcon && powerIcon.addClassName('active');
            if (!forceSelect) {
                auctionImg.show();
                auctionTimer.appear({
                    from: 0.00001
                });
                auctionBidder.appear({
                    from: 0.00001
                });
                auctionAmount.appear({
                    from: 0.00001
                });
                Beezid.powerDropView.open();
            }
        }
        this.setCookie(this.__selAuctionCookie, this.__selectedAuctionId);
        this.hideShowResponseMsg();
        this.toggleAuctionInfo();
    },
    addClickHandlerOnPowerAuctions: function() {
        $$('.auction_feature_1024_icon').each(function(elem) {
            elem.stopObserving('click');
            if (TEMPLATE == 'detail') {
                return;
            }
            elem.observe('click', function(event) {
                var powerId = elem.id.split('_')[2];
                Beezid.powerDropView.selectAuctionDiv(powerId, false);
            }.bind(this));
        }.bind(this));
    },
    addClickHandlerOnTitleBar: function() {
        $$('.pwr_log_header').each(function(el) {
            el.stopObserving('click');
            el.observe('click', function(event) {
                this.hideShowLogInfo();
            }.bind(this))
        }.bind(this));
    },
    addClickHandlerOnStatusFilter: function() {
        var filterStatusChecks = $$('.log_status_filter input[type="checkbox"]'),
            filterPat = filterStatusChecks.invoke('getAttribute', 'id').invoke('replace', /\w+_(\w+)_\w+/, '$1').join('|'),
            filterRe = new RegExp('.*_(' + filterPat + ').*');
        filterStatusChecks.each(function(el) {
            el.stopObserving('click');
            el.observe('click', function(ev) {
                var checkedStatusCount = $$('.log_status_filter input[type="checkbox"]:checked').length;
                if (checkedStatusCount == 3 || checkedStatusCount == 0) {
                    $$('.pwr_log_info').invoke('show');
                    return;
                }
                $$('.log_status_icn').each(function(el) {
                    var logElementStatus = el.className.replace(filterRe, '$1');
                    if ($('checkbox_' + logElementStatus + '_input').checked) {
                        el.up('.pwr_log_info').show();
                    } else {
                        el.up('.pwr_log_info').hide();
                    }
                });
            });
        });
    },
    decreasePowerQty: function(powerId, amount) {
        var newQty = this.getPowerQty(powerId) - amount;
        this.setPowerQty(powerId, newQty);
    },
    getPowerQty: function(powerId) {
        if ($('pwr_qty_' + powerId) !== null) {
            var pwrQty = parseInt($('pwr_qty_' + powerId).innerHTML);
            return isNaN(pwrQty) ? 0 : pwrQty;
        }
        return 0;
    },
    setCookie: function(cName, cValue) {
        var currentCookie = readCookie(cName);
        if (currentCookie !== null && currentCookie !== "false") {
            updateCookie(cName, cValue);
        } else {
            createCookie(cName, cValue);
        }
    },
    setHealthBar: function() {
        if (!this.__open) {
            return;
        }
        var healthBarHeight = 0;
        var healthBarLevelHeights = $$('.pwr_row').invoke('getHeight').reverse();
        for (var i = 0; i < Beezid.powerConfig.getUserLevel() - 1; i++) {
            healthBarHeight += healthBarLevelHeights[i];
        }
        healthBarHeight += Math.round((Beezid.powerConfig.__nextLevelPercantage / 100) * healthBarLevelHeights[i]);
        if (this.__currHealthBarHeight == healthBarHeight) {
            return;
        }
        this.__currHealthBarHeight = healthBarHeight;
        $('health_meter').morph('height: ' + healthBarHeight + 'px;');
        if (this.__open && healthBarHeight > 0 && !Beezid.meterBolt.isRunning()) {
            Beezid.meterBolt.start();
        }
    },
    setPowerQty: function(powerId, qty) {
        if ($('pwr_qty_' + powerId) !== null) {
            if (parseInt(qty) > 0) {
                $('pwr_qty_' + powerId).up('.pwr_tag').addClassName('bar_red_count');
                $('pwr_qty_' + powerId).update(qty > 100 ? 99 : qty);
                if (powerId == this.__selectedPowerId && $('pwr_apply').disabled) {
                    this.enableApplyOnValidLevel();
                }
            } else {
                $('pwr_qty_' + powerId).up('.pwr_tag').removeClassName('bar_red_count');
                $('pwr_qty_' + powerId).update();
                if (powerId == this.__selectedPowerId && !$('pwr_apply').disabled) {
                    this.disableElement('pwr_apply');
                }
                if (Beezid.powerConfig.getUserLevel() < Beezid.powerConfig.getLevel(powerId)) {
                    $('pwrb_' + powerId).addClassName('disabled');
                }
            }
            Beezid.powerConfig.setPowerQty(powerId, parseInt(qty));
        }
    },
    setHealthPoints: function(healthPoints) {
        $('pwr_health_pt_cnt').update(formatNumber(healthPoints));
    },
    setResponseMsg: function(msgType, msg, idPrefix) {
        if (typeof idPrefix === undefined) {
            idPrefix = 'pwr_resp';
        }
        var responseDiv = $(idPrefix + '_txt'),
            responseIcon = $(idPrefix + '_icon'),
            responseWrap = $(idPrefix + '_txt').up();
        Object.keys(this.__powerResultCodes).each(function(cssClass) {
            responseWrap.removeClassName('pwr_' + cssClass);
            responseIcon.removeClassName('pwr_msg_' + cssClass);
        });
        responseDiv.update(msg);
        responseIcon.addClassName('pwr_msg_' + msgType);
        responseWrap.addClassName('pwr_' + msgType);
        if (msg) {
            $(idPrefix + '_ctn').show();
            responseDiv.hide().appear();
        } else {
            $(idPrefix + '_ctn').hide();
        }
        if (msgType == 'success') {
            this.clearSuccessTimer();
            this.__successFadeTimer = setTimeout(function() {
                if (idPrefix == 'pwr_resp_purchase') {
                    responseWrap.hide();
                    this.displayPurchaseBox();
                } else {
                    responseWrap.appear({
                        from: 1.0,
                        to: 0,
                        afterFinish: function() {
                            responseWrap.hide();
                            responseWrap.setStyle({
                                'opacity': 1
                            });
                        }
                    });
                }
                this.__successFadeTimer = false;
            }.bind(this), 10000);
        }
    },
    setInputParams: function(powerId) {
        this.removeAllInputParams();
        var postParams = Beezid.powerConfig.getPostParams(powerId);
        if (Object.keys(postParams).length > 0) {
            this.__paramValidator = new Phorm({
                isAjax: true,
                items: [],
                breakOnInvalid: true
            });
            for (key in postParams) {
                if (!empty(postParams[key].label)) {
                    $('pwr_sel_input').insert(new Element('label', {
                        id: 'pwr_lbl' + key,
                        'for': 'pwr' + key
                    }).update(postParams[key].label + ' '));
                }
                var paramInput = new Element('input', {
                    id: 'pwr' + key,
                    type: postParams[key].type == 'number' ? 'tel' : 'text',
                    name: 'data[' + key + ']',
                    placeholder: postParams[key].placeholder
                });
                if (typeof postParams[key].max !== 'undefined') {
                    paramInput.setAttribute('maxlength', postParams[key].max);
                }
                if (typeof postParams[key].min !== 'undefined') {
                    paramInput.setAttribute('minlength', postParams[key].min);
                }
                $('pwr_sel_input').insert(paramInput);
                var postParamElement = this.createParamElement(postParams[key], key);
                this.__paramValidator._items.push(postParamElement);
            }
            $('pwr_input_wrap').show();
            var paramExtraPadding = $('pwr_ctn').getStyle('paddingTop');
            if (paramExtraPadding && paramExtraPadding != "0px") {
                paramExtraPadding = parseInt(paramExtraPadding.replace('px', '')) + parseInt($('pwr_input_wrap').getStyle('height').replace('px', ''));
                $('pwr_ctn').setStyle({
                    'paddingTop': paramExtraPadding + 'px'
                });
            }
            this.__paramValidator.instantiate();
            if (!$('pwr_apply').disabled) {
                $('pwr_sel_input').select('input').first().focus();
            }
        }
    },
    enableBuyOnValidLevel: function() {
        if (this.__inMoveBoxAnimation) {
            return;
        }
        if ($('pwr_purchase').visible() || !this.__selectedPowerId || Beezid.powerConfig.getUserLevel() < Beezid.powerConfig.getLevel(this.__selectedPowerId)) {
            this.disableElement('pwr_buy');
        } else {
            this.enableElement('pwr_buy');
        }
    },
    enableApplyOnValidLevel: function() {
        if (this.__selectedPowerId && Beezid.powerConfig.getPowerQty(this.__selectedPowerId) > 0 && (this.__selectedAuctionId || !Beezid.powerConfig.isAuctionPower(this.__selectedPowerId))) {
            this.enableElement('pwr_apply');
        } else {
            this.disableElement('pwr_apply');
        }
    },
    hideShowResponseMsg: function() {
        if (!this.__selectedPowerId) {
            this.disableElement('pwr_buy');
            this.disableElement('pwr_apply');
            $('message_close').hide();
            this.setResponseMsg('alert', i18n.power_item_manager.select_power, 'pwr_resp');
        } else {
            this.enableApplyOnValidLevel();
            $('message_close').show();
            this.setResponseMsg('none', '', 'pwr_resp');
        }
        this.enableBuyOnValidLevel();
    },
    enableElement: function(elementId) {
        $(elementId).enable();
        $(elementId).removeClassName('disabled');
    },
    disableElement: function(elementId) {
        $(elementId).disable();
        $(elementId).addClassName('disabled');
    },
    clearSuccessTimer: function() {
        if (this.__successFadeTimer) {
            clearTimeout(this.__successFadeTimer);
            this.__successFadeTimer = false;
        }
    },
    stopRotatePowerIcon: function(powerId, icon) {
        if (typeof icon == 'undefined') {
            icon = $('pwrb_' + powerId).select('.pwr_icn_ctn').first();
        }
        clearInterval(this.__rotPwrIcnInterlval[icon.id]);
        this.__rotPwrIcnInterlval[icon.id] = false;
        icon.style.transform = "rotateY(0deg)";
        icon.style.OTransform = "rotateY(0deg)";
        icon.style.MozTransform = "rotateY(0deg)";
        icon.style.webkitTransform = "rotateY(0deg)";
    },
    rotatePowerIcon: function(powerId, icon) {
        if (typeof icon == 'undefined') {
            icon = $('pwrb_' + powerId).select('.pwr_icn_ctn').first();
        }
        var angle = 0;
        if (this.__rotPwrIcnInterlval[icon.id]) {
            this.stopRotatePowerIcon(powerId, icon);
        }
        this.__rotPwrIcnInterlval[icon.id] = setInterval(function() {
            angle += 12;
            icon.style.transform = "rotateY(" + angle + "deg)";
            icon.style.OTransform = "rotateY(" + angle + "deg)";
            icon.style.MozTransform = "rotateY(" + angle + "deg)";
            icon.style.webkitTransform = "rotateY(" + angle + "deg)";
            if (angle >= 360) {
                angle = 0;
            }
        }, 10);
    },
    removeAllInputParams: function() {
        $$('[id^=pwr_param_]').each(function(el) {
            Element.remove(el);
        });
        $$('[id^=pwr_lbl_param_]').each(function(el) {
            Element.remove(el);
        });
        var paramExtraPadding = $('pwr_ctn').getStyle('paddingTop');
        if ($('pwr_input_wrap').visible() && paramExtraPadding && paramExtraPadding != "0px") {
            paramExtraPadding = parseInt(paramExtraPadding.replace('px', '')) - $('pwr_input_wrap').getHeight();
            $('pwr_ctn').setStyle({
                'paddingTop': paramExtraPadding + 'px'
            });
        }
        $('pwr_input_wrap').hide();
        this.__paramValidator = false;
    },
    checkCookieSetSelectedAuction: function() {
        var cookieSelId = readCookie(this.__selAuctionCookie);
        if (cookieSelId === null || cookieSelId == "false") {
            cookieSelId = null;
        }
        this.selectAuctionDiv(cookieSelId, true);
    },
    checkCookieDisplayPwrBar: function() {
        if (!Beezid.info.getSkipTutorialValue()) {
            this.__initSuperModeTutorialTip();
            return;
        }
        var pwrBarCookie = readCookie(this.__pwrBarOpenCookie);
        if (pwrBarCookie !== null && pwrBarCookie == "true" && !empty($$('[id^="a_"]'))) {
            this.open();
        } else {
            this.close();
        }
    },
    checkCookiePowerSelected: function() {
        var pwrSelCookie = readCookie(this.__selPowerCookie);
        if (pwrSelCookie !== null && pwrSelCookie != "false") {
            this.addPowerIconClickHandler($('pwrb_' + pwrSelCookie));
        }
    },
    onPowerAppliedFailure: function(event) {
        this.setResponseMsg('error', i18n.beezid.error, 'pwr_resp');
        this.enableBuyOnValidLevel();
        this.enableApplyOnValidLevel();
    },
    onPowerApplied: function(event) {
        if (event.result == this.__powerResultCodes.success) {
            this.rotatePowerIcon(event.power_id);
            this.decreasePowerQty(event.power_id, 1);
            this.__logInfoReceived = true;
            if (typeof event.info !== 'undefined') {
                $$('.pwr_log_header').each(function(el) {
                    el.addClassName('info_received');
                });
            }
            if ($('info_icon_' + event.auction_id + '_1024')) {
                var auctionIconEl = $('info_icon_' + event.auction_id + '_1024');
                auctionIconEl.removeClassName('active');
                auctionIconEl.addClassName('pwr_icn_med_ctn pwr_icn_med_' + event.power_id);
                this.rotatePowerIcon(event.power_id, auctionIconEl);
                if ($('pwr_a_cnt_' + event.auction_id) != null) {
                    $('pwr_a_cnt_' + event.auction_id).hide();
                }
            }
            setTimeout(function() {
                this.stopRotatePowerIcon(event.power_id);
                if ($('info_icon_' + event.auction_id + '_1024')) {
                    var auctionIconEl = $('info_icon_' + event.auction_id + '_1024');
                    if (this.__selectedAuctionId == event.auction_id) {
                        auctionIconEl.addClassName('active');
                        this.stopRotatePowerIcon(event.power_id, auctionIconEl);
                    }
                    auctionIconEl.removeClassName('pwr_icn_med_ctn pwr_icn_med_' + event.power_id);
                    if ($('pwr_a_cnt_' + event.auction_id)) {
                        $('pwr_a_cnt_' + event.auction_id).show();
                    }
                }
            }.bind(this), 1000);
        }
        var msgKey = Object.keys(this.__powerResultCodes).filter(function(key) {
            return this.__powerResultCodes[key] == event.result;
        }.bind(this));
        var msgType = typeof msgKey[0] !== 'undefined' ? msgKey[0] : 'error';
        this.enableBuyOnValidLevel();
        this.enableApplyOnValidLevel();
        this.setResponseMsg(msgType, event.msg, 'pwr_resp');
    },
    onAuctionSwitch: function(event) {
        if (parseInt(event.features) & this.__powerFeatureValue) {
            var auctionImg = '/img/items/t1_' + event.sku + '.jpg',
                auctionTitle = event.title,
                powerFeatureIcon = $$('.auction_feature_1024_icon').first();
            this.selectAuctionDiv(event.auctionId, true);
            $('pwr_sel_auction_img').src = auctionImg;
            powerFeatureIcon && powerFeatureIcon.addClassName('active');
        } else {
            this.__selectedAuctionId = false;
            this.toggleAuctionInfo();
        }
    },
    onBarUpdatePower: function(event) {
        for (powerId in Beezid.powerConfig.getPowers()) {
            var qtyLeft = typeof event.powers[powerId] !== 'undefined' ? event.powers[powerId] : 0;
            Beezid.powerConfig.setPowerQty(powerId, qtyLeft);
            if (qtyLeft !== null) {
                this.setPowerQty(powerId, qtyLeft);
            }
        }
        if (typeof event.powers[0] !== 'undefined') {
            var currLevel = Beezid.powerConfig.getUserLevel();
            Beezid.powerConfig.setHealthPoints(event.powers[0]);
            this.setHealthPoints(event.powers[0].h);
            this.setHealthBar();
            var highestPowerUpLevel = Beezid.info.getlastPowerLevelUpValue();
            if (event.powers[0].l > 1 && event.powers[0].l > highestPowerUpLevel) {
                Beezid.powerItemsManager.updateUserSettingValue(Beezid.info.getlastPowerLevelUpId(), event.powers[0].l);
                Beezid.info.setLastPowerLevelUpValue(event.powers[0].l);
                this.open();
                setTimeout(function() {
                    Beezid.powerTutorial.openLevelUp(event.powers[0].l);
                }, 1000);
            }
            if (this.__firstBarUpdate || currLevel != event.powers[0].l) {
                this.enableBuyOnValidLevel();
                this.enableApplyOnValidLevel();
                this.__firstBarUpdate = false;
            }
        }
        var userLevel = Beezid.powerConfig.getUserLevel();
        $$('.pwr_row').each(function(el) {
            var rowLevel = el.id.split('_').pop();
            el.select('.pwr_tag').each(function(powerIcon) {
                if (rowLevel <= userLevel || powerIcon.hasClassName('bar_red_count')) {
                    powerIcon.up('li').removeClassName('disabled');
                } else {
                    powerIcon.up('li').addClassName('disabled');
                }
            });
        });
    },
    onHomepageRefresher: function(event) {
        this.addClickHandlerOnPowerAuctions();
        this.checkCookieSetSelectedAuction();
    },
    onPowerBought: function(event) {
        var msgType = event.success ? 'success' : 'error';
        if (event.success) {
            var newPowerQty = parseInt(event.power_info[0].qty_bought) + this.getPowerQty(event.power_info[0].power_id);
            this.setPowerQty(event.power_info[0].power_id, newPowerQty);
            this.enableElement('pwr_purchase_btn');
        }
        this.enableApplyOnValidLevel();
        this.enableElement('pwr_show_desc');
        $('pwr_purchase_cancel').setStyle({
            pointerEvents: 'auto'
        });
        this.setResponseMsg(msgType, event.msg, 'pwr_resp_purchase');
        $('pwr_purchase_wrapper').hide();
        $('pwr_purchase_cancel').hide();
        $('pwr_purchase_btn').hide();
        $('pwr_purchase_close_btn').show();
    },
    onSuperModeChanged: function(event) {
        if (event.superModeActivated) {
            Beezid.meterBolt.start();
        } else {
            Beezid.meterBolt.stop();
            if (this.isPowerLogVisible()) {
                this.hideShowLogInfo();
            }
        }
    },
    onTimerUpdate: function(event) {
        var timerEl = $(event.object._referenceId);
        if (timerEl && this.__logTimers[event.object._referenceId].isRunning()) {
            this.__logTimers[event.object._referenceId].reset(event.ms);
            timerEl.update(this.__logTimers[event.object._referenceId].wordFormat(i18n.beezid.time_ago));
        }
    },
    onQuickBuyItemTotal: function(event) {
        $('pwr_purchase_price').update(formatCurrency(event.itemTotal));
        $('pwr_purchase_about').update(this.getPurchaseAboutText(event.itemTotal));
        if (Beezid.powerConfig.getPowerQty(this.__selectedPowerId) + parseInt(event.request_qty) > Beezid.powerConfig.getMaxInventoryQty(this.__selectedPowerId)) {
            this.disableElement('pwr_buy');
            this.moveBox('pwr_purchase', 'down');
            $('pwr_purchase_wrapper').hide();
            $('pwr_purchase_wallet_box').hide();
            this.disableElement('pwr_purchase_btn');
            this.setResponseMsg('alert', i18n.power_item_manager.max_inventory, 'pwr_resp_purchase');
            return;
        }
        var missingAmount = parseFloat(Beezid.wallet.getBalance()) - parseFloat(event.itemTotal);
        if (missingAmount < 0) {
            this.displayPurchaseWalletBox(Math.abs(missingAmount));
        } else {
            this.enableElement('pwr_purchase_btn');
            $('pwr_purchase_wallet_box').hide();
        }
        if (!$('pwr_purchase').visible()) {
            this.moveBox('pwr_purchase', 'down');
        }
    },
    open: function() {
        if (!this.__open) {
            this.__open = true;
            this.setHealthBar();
            this.__elem.style.bottom = "";
        }
        Beezid.info.isSuperModeActivated() && Beezid.meterBolt.start();
        this.setCookie(this.__pwrBarOpenCookie, this.__open);
        this.__button._elem.addClassName('active');
        if (!Beezid.info.isSuperModeActivated()) {
            Beezid.info.toggleSuperMode();
        }
        if (Beezid.powerConfig.getUserLevel() > 0 && !Beezid.info.getSkipTutorialValue()) {
            Beezid.powerItemsManager.updateUserSettingValue(Beezid.info.getlastPowerLevelUpId(), Beezid.powerConfig.getUserLevel());
            Beezid.info.setLastPowerLevelUpValue(Beezid.powerConfig.getUserLevel());
            Beezid.powerTutorial.open(1000);
        }
        $$('body').first().addClassName('pwr_ctrl_opened');
    },
    close: function() {
        if (this.__open) {
            this.__elem.style.bottom = (this.__currPowerFloatHeight * -1) + "px";
            this.__button._elem.removeClassName('active');
            this.__open = false;
            this.stopLogTimers();
        }
        Beezid.meterBolt.stop();
        this.setCookie(this.__pwrBarOpenCookie, this.__open);
        $$('body').first().removeClassName('pwr_ctrl_opened');
    },
    __activate: function(event) {
        if (this.__open) {
            Beezid.meterBolt.stop();
            this.close();
        } else {
            this.open();
        }
        event.event.stopPropagation();
    },
    createParamElement: function(param, paramKey) {
        return {
            type: 'text',
            elem: $('pwr' + paramKey),
            errorClass: 'error',
            valid: false,
            overrides: {
                setInvalid: function(errMsg) {
                    this._valid = false;
                    this._elem.addClassName(this._errorClass);
                    if (typeof errMsg !== 'undefined' && $('pwr_resp_txt').innerHTML != errMsg && !$('pwr_resp_ctn').visible()) {
                        Beezid.powerDropView.setResponseMsg('error', errMsg, 'pwr_resp');
                    }
                },
                validateAllInputParams: function() {
                    var invalidFields = [];
                    $$('[id^=pwr_param_]').each(function(el) {
                        var phormValidator = $$$(el.id);
                        if (typeof phormValidator !== 'undefined' && !phormValidator.validate()) {
                            invalidFields.push(el.id);
                        }
                    });
                    return invalidFields;
                }
            },
            listeners: {
                validate: function(event) {
                    if ($('pwr_apply').disabled) {
                        return true;
                    }
                    this._value = this._elem.value;
                    var len = this._elem.value.length;
                    switch (param.type) {
                        case 'alpha_numeric':
                            if (!/^[a-zA-Z0-9]+$/.match(event.newValue)) {
                                this.setInvalid(i18n.power_item_manager.only_alpha_numeric.replace('%s', param.placeholder));
                                return false;
                            }
                            break;
                        case 'number':
                            if (!/^[0-9]+$/.match(event.newValue)) {
                                this.setInvalid(i18n.power_item_manager.only_numbers.replace('%s', param.placeholder));
                                return false;
                            }
                            break;
                    }
                    if (this._elem.type == 'number' && typeof this._elem.validity !== 'undefined' && !this._elem.validity.valid) {
                        this.setInvalid(i18n.power_item_manager.only_numbers.replace('%s', param.placeholder));
                        return false;
                    }
                    if (typeof(param.min) !== 'undefined') {
                        if (param.type == 'number' && (isNaN(parseInt(this._value)) || this._value < param.min)) {
                            this.setInvalid(i18n.power_item_manager.invalid_num_len.replace('%s', param.placeholder).replace('%s', param.min).replace('%s', param.max));
                            return false;
                        } else if (param.type != 'number' && len < param.min) {
                            this.setInvalid(i18n.power_item_manager.at_least_char.replace('%s', param.placeholder).replace('%s', param.min));
                            return false;
                        }
                    }
                    if (typeof(param.max) !== 'undefined') {
                        if (param.type == 'number' && this._value > param.max) {
                            this.setInvalid(i18n.power_item_manager.invalid_num_len.replace('%s', param.placeholder).replace('%s', param.min).replace('%s', param.max));
                            return false;
                        } else if (param.type != 'number' && len > param.max) {
                            this.setInvalid(i18n.power_item_manager.at_most_char.replace('%s', param.placeholder).replace('%s', param.max));
                            return false;
                        }
                    }
                    this.setValid();
                    Beezid.powerDropView.setResponseMsg('', '', 'pwr_resp');
                    return true;
                },
                keydown: function(event) {
                    if (event.event.keyCode == Event.KEY_TAB) {
                        if (!this.validate()) {
                            event.event.stopPropagation();
                            event.event.preventDefault();
                            return false;
                        }
                    }
                },
                keyup: function(event) {
                    switch (event.event.keyCode) {
                        case Event.KEY_RETURN:
                            var badFields = this.validateAllInputParams();
                            if (!badFields.length) {
                                Beezid.powerDropView.applyClickHandler();
                            } else {
                                badFields.each(function(field) {
                                    $$$(field).validate();
                                });
                            }
                            break;
                        default:
                            if ($('pwr_resp_ctn').visible() && event.event.keyCode != Event.KEY_TAB) {
                                this.validate();
                            }
                            break;
                    }
                }
            }
        };
    },
    initPowerLogScroll: function() {
        $('pwr_log_cnt').stopObserving('scroll').observe('scroll', function(event) {
            if (this.scrollTop == 0) {
                this.scrollTop += 1;
            }
            if (this.scrollTop <= 1) {
                $('pwr_scroll_arrow_top').hide();
            } else if (!$('pwr_scroll_arrow_top').visible()) {
                $('pwr_scroll_arrow_top').appear();
            }
            if (this.offsetHeight + this.scrollTop >= this.scrollHeight) {
                this.scrollTop -= 1;
            }
            if (this.offsetHeight + this.scrollTop + 1 >= this.scrollHeight) {
                $('pwr_scroll_arrow_bottom').hide();
            } else if (!$('pwr_scroll_arrow_bottom').visible()) {
                $('pwr_scroll_arrow_bottom').appear();
            }
        });
        $('pwr_scroll_arrow_top').observe('click', function(ev) {
            for (var i = 1; i <= 200; i++) {
                setTimeout(function() {
                    $('pwr_log_cnt').scrollTop -= 1;
                }, i * 2);
            }
        }.bind(this));
        $('pwr_scroll_arrow_bottom').observe('click', function(ev) {
            for (var i = 1; i <= 200; i++) {
                setTimeout(function() {
                    $('pwr_log_cnt').scrollTop += 1;
                }, i * 2);
            }
        }.bind(this));
        if ($('pwr_log_cnt').offsetHeight + $('pwr_log_cnt').scrollTop + 1 >= $('pwr_log_cnt').scrollHeight) {
            $('pwr_scroll_arrow_bottom').hide();
        }
    },
    __initSuperModeTutorialTip: function() {
        var superModeTutorialTip = new Tip('power_popup_btn', i18n.super_mode['tutorial_tip'].msg.sprintf('<p>', '<span>', '</span></p><p class="pwr_tut_act">', '</p>'), {
            target: 'power_popup_btn',
            title: i18n.super_mode['tutorial_tip'].title.sprintf('<h2>', '</h2>'),
            closeButton: true,
            hideOn: false,
            width: 160,
            hook: {
                target: 'topRight',
                tip: 'bottomLeft'
            },
            stem: {
                position: 'bottomLeft',
                height: 10,
                width: 26
            },
            offset: {
                x: -32,
                y: -5
            },
            fixed: true,
            style: 'protobzd'
        });
        $(superModeTutorialTip.wrapper).setStyle({
            position: 'fixed'
        }).addClassName('super_tut_tip');
        $('power_popup_btn').addClassName('power_popup_btn_tut');
        if (readCookie(this.__newPowerTipCookie) == null) {
            createCookie(this.__newPowerTipCookie, true);
            setTimeout(function() {
                $('power_popup_btn').prototip.show();
            }, 1000);
        }
    }
});
var PowerControlSwipe = Class.create(BeezidObject, {
    swipeMenuStartX: 0,
    swipeMenuStartY: 0,
    swipeMenuStopX: 0,
    swipeMenuStopY: 0,
    __setSwipeMenuCoord: function(touchArr, option) {
        if (option.event == 'touchstart') {
            this.swipeMenuStartX = touchArr.pageX;
            this.swipeMenuStartY = touchArr.pageY;
        } else if (option.event == 'touchend') {
            this.swipeMenuStopX = touchArr.pageX;
            this.swipeMenuStopY = touchArr.pageY;
        }
    },
    addPowerLogSwipeEvent: function() {
        $$('.pwr_log_cnt')[0] && $$('.pwr_log_cnt')[0].stopObserving('touchstart');
        $$('.pwr_log_cnt')[0] && $$('.pwr_log_cnt')[0].stopObserving('touchend');
        $$('.pwr_log_cnt')[0] && $$('.pwr_log_cnt')[0].observe('touchstart', function(ev) {
            this.__setSwipeMenuCoord(ev.touches[0], {
                event: 'touchstart'
            });
            this.swipeMenuTime = new Date().getTime();
        }.bind(this));
        $$('.pwr_log_cnt')[0] && $$('.pwr_log_cnt')[0].observe('touchend', function(ev) {
            if ((new Date().getTime()) - this.swipeMenuTime > 500) {
                return;
            }
            this.__setSwipeMenuCoord(ev.changedTouches[0], {
                event: 'touchend'
            });
            var distanceX = this.swipeMenuStopX - this.swipeMenuStartX,
                distanceY = Math.abs(this.swipeMenuStopY - this.swipeMenuStartY),
                swipeAngle = Math.atan(distanceY / Math.abs(distanceX));
            if (!isNaN(swipeAngle) && swipeAngle < 0.2 && distanceX < -50) {
                Beezid.powerDropView.hideShowLogInfo();
            }
        }.bind(this));
    }
});
var PowerTutorial = Class.create(BeezidObject, {
    currentStep: 1,
    __ajaxPending: false,
    initialize: function($super, config) {
        $super(config);
    },
    __requestLayout: function(section, onCompleted) {
        if (this.__ajaxPending) {
            return;
        }
        this.__ajaxPending = true;
        new Ajax.Updater('pwr_tutorial_cnt', '/powers/view_tutorial/' + section, {
            evalScripts: true,
            onComplete: function() {
                setTimeout(function() {
                    onCompleted();
                }, 200);
                this.__ajaxPending = false;
            }.bind(this)
        });
    },
    addClickHandlers: function() {
        $$('.pwr_tut_next').each(function(el) {
            el.stopObserving('click');
            el.observe('click', function(ev) {
                this.nextStep();
            }.bind(this));
        }.bind(this));
        $$('.pwr_tut_prev').each(function(el) {
            el.stopObserving('click');
            el.observe('click', function(ev) {
                this.previousStep();
            }.bind(this));
        }.bind(this));
        $('pwr_skip_tutorial') && $('pwr_skip_tutorial').observe('click', function(ev) {
            $('pwr_tutorial_step' + this.currentStep).hide();
            this.currentStep = 13;
            this.nextStep();
            ev.preventDefault();
            ev.stopPropagation();
            return false;
        }.bind(this));
        if ($('close_level_up')) {
            $('close_level_up').stopObserving();
            $('close_level_up').observe('click', function(ev) {
                $('pwr_levelup_overlay').hide();
            }.bind(this));
        }
    },
    open: function(waitTimeout) {
        if (typeof waitTimeout === 'undefined') {
            waitTimeout = 0;
        }
        var showTutorialElement = function() {
            this.currentStep = 1;
            if ($('power_popup_btn').prototip) {
                $('power_popup_btn').prototip.remove();
                $('power_popup_btn').removeClassName('power_popup_btn_tut');
            }
            if (Beezid.powerDropView.__selectedPowerId) {
                Beezid.powerDropView.deselectPowerIcon(Beezid.powerDropView.__selectedPowerId);
            }
            $('pwr_skip_tutorial').show();
            $$('[id^=pwr_tutorial_step]').invoke('hide');
            $('pwr_tutorial_level').update(Beezid.powerConfig.getUserLevel());
            $('pwr_health_level').update(Beezid.powerConfig.getUserLevel());
            $('pwr_health_level').className = "health_level_" + Beezid.powerConfig.getUserLevel();
            setTimeout(function() {
                $('pwr_tutorial').show();
                $('pwr_tutorial_step1').show();
                $('pwr_ctn').scrollTop = $('pwr_float').getStyle('maxHeight').replace('px', '');
            }, waitTimeout);
            this.addClickHandlers()
        }.bind(this);
        if ($('pwr_tutorial')) {
            showTutorialElement();
        } else {
            this.__requestLayout('power_tutorial', showTutorialElement);
        }
    },
    nextStep: function() {
        if (this.currentStep == 14) {
            $('pwr_tutorial').hide();
            Beezid.powerItemsManager.updateUserSettingValue(Beezid.info.getSkipTutorialId(), true);
            Beezid.info.setSkipTutorialValue(true)
            return;
        } else if (this.currentStep == 13) {
            $('pwr_skip_tutorial').hide();
        }
        $('pwr_tutorial_step' + this.currentStep).hide();
        this.currentStep++;
        $('pwr_tutorial_step' + this.currentStep).show();
    },
    previousStep: function() {
        if (this.currentStep > 1) {
            $('pwr_tutorial_step' + this.currentStep).hide();
            this.currentStep--;
            $('pwr_tutorial_step' + this.currentStep).show();
            !$('pwr_skip_tutorial').visible() && $('pwr_skip_tutorial').show();
        }
    },
    openLevelUp: function(newLevel) {
        var showTutorialElement = function() {
            $('pwr_health_new_level').setAttribute('class', 'health_level_' + newLevel);
            $('pwr_health_new_level').update(newLevel);
            $('pwr_levelup').update(newLevel);
            $('pwr_levelup_overlay').show();
            this.addClickHandlers()
        }.bind(this);
        if (Beezid.powerDropView.__selectedPowerId) {
            Beezid.powerDropView.deselectPowerIcon(Beezid.powerDropView.__selectedPowerId);
        }
        if ($('pwr_levelup_overlay')) {
            showTutorialElement();
        } else {
            this.__requestLayout('power_levelup', showTutorialElement);
        }
    }
});